<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Statistical Specifications • bonsaiforest2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Statistical Specifications">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bonsaiforest2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Advanced_Functionalities.html">Advanced Functionalities</a></li>
    <li><a class="dropdown-item" href="../articles/Quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/Statistical_Specifications.html">Statistical Specifications</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openpharma/bonsaiforest2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Statistical Specifications</h1>
                        <h4 data-toc-skip class="author">Miriam Pedrera Gomez, Isaac Gravestock, and Marcel Wolbers</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/bonsaiforest2/blob/main/vignettes/Statistical_Specifications.Rmd" class="external-link"><code>vignettes/Statistical_Specifications.Rmd</code></a></small>
      <div class="d-none name"><code>Statistical_Specifications.Rmd</code></div>
    </div>

    
    
<div class="section level2" number="1">
<h2 id="scope-of-this-document">
<span class="header-section-number">1</span> Scope of this document<a class="anchor" aria-label="anchor" href="#scope-of-this-document"></a>
</h2>
<p>This document describes the statistical methods implemented in the <code>bonsaiforest2</code> R package for Bayesian subgroup analysis of continuous, binary, count, and time-to-event outcomes in randomized clinical trials (RCTs).</p>
<p>The package unable the implementation of both a <strong>global modeling approach</strong> <span class="citation">(<a href="#ref-wolbers2025using">Wolbers et al. 2025</a>)</span>, that estimates all main (prognostic) and interaction (predictive) effects in a single model, and a <strong>One-variable-at a time</strong> <span class="citation">(<a href="#ref-wang2024bayesian">Wang et al. 2024</a>)</span>, that estimates the interaction effects using a different model for each subgrouping variable.</p>
<p>The core features described in this document are:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Flexible Model Specification:</strong> A unified framework to distinguish between:
<ul>
<li>
<strong>Prognostic</strong> (main) vs. <strong>Predictive</strong> (interaction) effects.</li>
<li>
<strong>Shrunk</strong> vs. <strong>Unshrunk</strong> coefficients, allowing exploratory terms to be penalized while pre-specified terms are not.</li>
</ul>
</li>
<li>
<strong>Advanced Shrinkage Priors:</strong> Supports state-of-the-art shrinkage priors, including the <strong>Regularized Horseshoe</strong> <span class="citation">(<a href="#ref-piironen2017sparsity">Piironen and Vehtari 2017</a>; <a href="#ref-wolbers2025using">Wolbers et al. 2025</a>)</span> and <strong>R2D2</strong> <span class="citation">(<a href="#ref-zhang2022bayesian">Zhang et al. 2022</a>)</span>, to provide robust control of false-positive findings while identifying potential heterogeneity.</li>
<li>
<strong>Marginal Effect Estimation:</strong> Use of <strong>standardization (G-computation)</strong> to derive interpretable <em>marginal</em> subgroup treatment effects, which average over the covariate distributions within each subgroup <span class="citation">(<a href="#ref-wolbers2025using">Wolbers et al. 2025</a>)</span>.</li>
</ol>
<p>This document is structured as follows: <a href="#sec-intro">Section 2</a> provides a conceptual introduction to subgroup analysis challenges and the Bayesian shrinkage solution. <a href="#sec-methodology">Section 3</a> details the statistical methodology, including notation, the global and the one-variable at a time models, endpoint-specific likelihoods, prior specifications, and the standardization procedure. <a href="#sec-functions">Section 4</a> maps these statistical methods to the core functions in the <code>bonsaiforest2</code> package.</p>
</div>
<div class="section level2" number="2">
<h2 id="sec-intro">
<span class="header-section-number">2</span> Introduction to Subgroup Analysis and Estimation<a class="anchor" aria-label="anchor" href="#sec-intro"></a>
</h2>
<div class="section level3" number="2.1">
<h3 id="the-challenge-of-subgroup-analysis">
<span class="header-section-number">2.1</span> The Challenge of Subgroup Analysis<a class="anchor" aria-label="anchor" href="#the-challenge-of-subgroup-analysis"></a>
</h3>
<p>Exploratory subgroup analyses are a standard part of RCT reporting, typically visualized in forest plots to assess the consistency of treatment effects. However, their interpretation is notoriously difficult due to several statistical challenges:</p>
<ul>
<li>
<strong>Low Power:</strong> Subgroups have smaller sample sizes, leading to low precision (wide confidence intervals) and an inability to detect true, modest differences in effect.</li>
<li>
<strong>Multiplicity:</strong> Examining many subgroups (e.g., 20 or more) inflates the risk of false-positive findings. Investigators may focus on the most extreme results, which are often spurious.</li>
<li>
<strong>Overfitting:</strong> Standard subgroup-specific estimates (fitting a model only to data within that subgroup) are unbiased but have high variance, leading to an overestimation of heterogeneity.</li>
</ul>
<p>This has led to the common recommendation that the <em>overall</em> treatment effect is often a more reliable estimate for a subgroup than the estimate derived from the subgroup’s data alone.</p>
</div>
<div class="section level3" number="2.2">
<h3 id="prognostic-vs--predictive-effects">
<span class="header-section-number">2.2</span> Prognostic vs. Predictive Effects<a class="anchor" aria-label="anchor" href="#prognostic-vs--predictive-effects"></a>
</h3>
<p>To build a meaningful model, it is crucial to distinguish how a baseline variable relates to the outcome:</p>
<ul>
<li>
<strong>Prognostic Effect</strong>: A variable is <strong>prognostic</strong> if it is associated with the clinical outcome, regardless of the treatment received. It describes the natural course of the disease. In a model, this is a <strong>main effect</strong>.</li>
<li>
<strong>Predictive Effect</strong>: A variable is <strong>predictive</strong> if its value modifies the magnitude or direction of the treatment’s effect. It identifies heterogeneity. In a model, this is a <strong>treatment-by-variable interaction</strong>.</li>
</ul>
<p><code>bonsaiforest2</code> is built to model both types of effects explicitly and apply different modeling strategies (e.g., shrinkage) to each.</p>
</div>
<div class="section level3" number="2.3">
<h3 id="the-role-of-bayesian-shrinkage">
<span class="header-section-number">2.3</span> The Role of Bayesian Shrinkage<a class="anchor" aria-label="anchor" href="#the-role-of-bayesian-shrinkage"></a>
</h3>
<p>Bayesian shrinkage methods directly address the challenges of subgroup analysis by providing a principled compromise between the two extremes of “no pooling” (subgroup-specific estimates) and “full pooling” (overall population estimate).</p>
<p>This compromise, often called <strong>partial pooling</strong>, is achieved using hierarchical models. Subgroup effects are assumed to be <em>exchangeable</em> (drawn from a common distribution). This assumption allows subgroups to “borrow strength” from each other:</p>
<ul>
<li>Subgroups with <strong>small sample sizes</strong> and extreme results are “shrunk” heavily toward the overall mean, reducing their variance.</li>
<li>Subgroups with <strong>large sample sizes</strong> and strong evidence of a real effect are shrunk less, allowing their data to dominate.</li>
</ul>
<p>This results in estimates with a better <strong>bias-variance trade-off</strong>: we accept a small amount of bias (by pulling real effects slightly toward the mean) in exchange for a large reduction in variance, leading to a lower overall error and better control of spurious findings.</p>
</div>
<div class="section level3" number="2.4">
<h3 id="conditional-vs--marginal-estimands">
<span class="header-section-number">2.4</span> Conditional vs. Marginal Estimands<a class="anchor" aria-label="anchor" href="#conditional-vs--marginal-estimands"></a>
</h3>
<p>When covariates are included in a non-linear model (like a logistic or Cox model), the resulting coefficients represent <strong>conditional</strong> effects. For example, the treatment effect is the effect for a patient with a <em>specific set</em> of covariate values (e.g., the reference values).</p>
<p>This is problematic for forest plots, where we want to know the <strong>marginal</strong> effect: “What is the average treatment effect for <em>all patients</em> in the ‘Female’ subgroup, averaging over their different ages, regions, etc.?”.</p>
<p>Because different subgroups have different covariate distributions (e.g., the <code>age &gt;= 65</code> subgroup will have a different health status profile than the <code>age &lt; 65</code> group), these conditional coefficients are not directly comparable.</p>
<p><code>bonsaiforest2</code> solves this by using <strong>Standardization (G-computation)</strong> <span class="citation">(<a href="#ref-wolbers2024shrinkage"><strong>wolbers2024shrinkage?</strong></a>)</span>. This procedure correctly averages over the specific covariate distribution of each subgroup to estimate a valid marginal treatment effect, ensuring all subgroups are compared on the same interpretable scale. (See <a href="#sec-standardization">Section 3.8</a> for a detailed explanation of how this standardization is performed in the package.)</p>
</div>
</div>
<div class="section level2" number="3">
<h2 id="sec-methodology">
<span class="header-section-number">3</span> Statistical Methodology<a class="anchor" aria-label="anchor" href="#sec-methodology"></a>
</h2>
<div class="section level3" number="3.1">
<h3 id="setting-and-notation">
<span class="header-section-number">3.1</span> Setting and Notation<a class="anchor" aria-label="anchor" href="#setting-and-notation"></a>
</h3>
<p>We establish the following notation for the global model:</p>
<ul>
<li>
<span class="math inline">\(i = 1, \dots, N\)</span>: Index for individual patients.</li>
<li>
<span class="math inline">\(y_i\)</span>: The outcome for patient <span class="math inline">\(i\)</span>. We will consider that this variable can only be a binary, count, continuous or time-to-event endpoint.</li>
<li>
<span class="math inline">\(s_i\)</span>: The binary treatment indicator (<span class="math inline">\(s_i=1\)</span> for treatment, <span class="math inline">\(s_i=0\)</span> for control).</li>
<li>
<span class="math inline">\(l = 1, \dots, L\)</span>: Index for an overall subgroup level (e.g., “Male”, “Female”, “EU”, “USA”).</li>
<li>
<span class="math inline">\(x_{il}\)</span>: Indicator (0/1) for patient <span class="math inline">\(i\)</span> belonging to subgroup level <span class="math inline">\(l\)</span> (used for prognostic effects).</li>
<li>
<span class="math inline">\(z_{il} = s_i \cdot x_{il}\)</span>: The interaction between treatment and subgroup level <span class="math inline">\(l\)</span> (used for predictive effects).</li>
<li>
<span class="math inline">\(u_{iv}\)</span>: Value of the <span class="math inline">\(v\)</span>-th additional non-subgroup covariate for patient <span class="math inline">\(i\)</span>. This additional covariates don’t need to be binary or categorical.</li>
<li>
<span class="math inline">\(\boldsymbol{\mu}\)</span>: The <span class="math inline">\(N \times 1\)</span> vector of expected outcomes.</li>
<li>
<span class="math inline">\(g(\cdot)\)</span>: A link function. In <a href="#sec-endpoint">Section x</a> we define the used link function for each type of endpoint.</li>
<li>
<span class="math inline">\(\boldsymbol{\eta}\)</span>: The <span class="math inline">\(N \times 1\)</span> vector of the linear predictor.</li>
</ul>
</div>
<div class="section level3" number="3.2">
<h3 id="design-matrix-considerations">
<span class="header-section-number">3.2</span> Design Matrix Considerations<a class="anchor" aria-label="anchor" href="#design-matrix-considerations"></a>
</h3>
<p>A critical implementation detail is the construction of the design matrix for the subgroup-by-treatment interactions.</p>
<p>We will then follow the same idea as in the <code>bonsaiforest</code> library. We will treat prognostic effects and predictive effects differently, as they serve different purposes in the model:</p>
<ul>
<li><p><strong>For prognostic effects :</strong> The goal is interpretability and avoiding collinearity with the intercept. Here, standard dummy coding is the appropriate choice. For each of the J subgrouping variables, one level is dropped as a reference, resulting in L−J total columns for the subgroup main effects.</p></li>
<li><p><strong>For predictive effects:</strong> The goal is to treat all subgroup levels symmetrically under the assumption of exchangeability. Using one-hot encoding is essential here. This ensures that the shrinkage prior pulls all predictive effects toward a common center without privileging a reference level.</p></li>
</ul>
</div>
<div class="section level3" number="3.3">
<h3 id="the-principle-of-model-hierarchy">
<span class="header-section-number">3.3</span> The Principle of Model Hierarchy<a class="anchor" aria-label="anchor" href="#the-principle-of-model-hierarchy"></a>
</h3>
<p>A fundamental concept in regression modeling is the <strong>principle of model hierarchy</strong> (or marginality). This principle states that if a model includes an interaction term (e.g., <code>A:B</code>), it should also include the corresponding main effects (e.g., <code>A</code> and <code>B</code>).</p>
<p>In the context of <code>bonsaiforest2</code>, this means that any subgrouping variable included as <strong>predictive</strong> (i.e., in an interaction with treatment, like <code>trt:subgroup</code>) <em>must</em> also be included as <strong>prognostic</strong> (i.e., as a main effect, <code>subgroup</code>).</p>
<p>Including the main effect ensures that the interaction term purely captures the <em>modification</em> of the treatment effect, rather than a mix of the main prognostic effect and the interaction, leading to a more stable and interpretable model.</p>
<p>The <code>bonsaiforest2</code> package enforces this principle automatically. The <code>prepare_formula_model</code> function checks if a main effect is specified as prognostic for every variable included in a predictive term. If it is not, the function automatically adds the main effect to the list of unshrunk prognostic terms to ensure the model hierarchy is respected.</p>
</div>
<div class="section level3" number="3.4">
<h3 id="the-global-model">
<span class="header-section-number">3.4</span> The Global Model<a class="anchor" aria-label="anchor" href="#the-global-model"></a>
</h3>
<p>The package enables the implementation of a global model <span class="citation">(<a href="#ref-wolbers2025using">Wolbers et al. 2025</a>)</span> where all effects are estimated in a single, comprehensive regression formula.</p>
<div class="section level4" number="3.4.1">
<h4 id="full-model-equation">
<span class="header-section-number">3.4.1</span> Full Model Equation<a class="anchor" aria-label="anchor" href="#full-model-equation"></a>
</h4>
<p><strong><em>Matrix form:</em></strong></p>
<p>The model for the linear predictor, <span class="math inline">\(\boldsymbol{\eta}\)</span>, for all <span class="math inline">\(N\)</span> patients is given by:</p>
<p><span class="math display">\[g(\boldsymbol{\mu}) = \boldsymbol{\eta} = \underbrace{\mathbf{X_p}\boldsymbol{\beta_{1,p}}}_{\text{Penalized prognostic effects}} +\underbrace{\mathbf{X_n}\boldsymbol{\beta_{1,n}}}_{\text{Non-penalized prognostic effects}} +\underbrace{\mathbf{Z_p}\boldsymbol{\beta_{2,p}}}_{\text{Penalized predictive effects}} +\]</span> <span class="math display">\[ \underbrace{\mathbf{Z_n}\boldsymbol{\beta_{2,n}}}_{\text{Non-penalized predictive effects}}+ \underbrace{\mathbf{U}\boldsymbol{\beta_{3}}}_{\text{Extra prognostic effects}} \]</span></p>
<p>The Bayesian hierarchical structure is applied as follows:</p>
<ul>
<li><p><strong>Penalized Coefficients</strong>: <span class="math inline">\(\boldsymbol{\beta_{1,p}}\)</span> and <span class="math inline">\(\boldsymbol{\beta_{2,p}}\)</span> are given shrinkage priors.</p></li>
<li><p><strong>Non-Penalized Coefficients</strong>: <span class="math inline">\(\boldsymbol{\beta_{1,n}}\)</span> and <span class="math inline">\(\boldsymbol{\beta_{2,n}}\)</span> are given standard, weakly informative priors.</p></li>
<li><p><strong>Extra prognostic effects Coefficients</strong>: <span class="math inline">\(\boldsymbol{\beta_3}\)</span> are given standard, weakly informative priors.</p></li>
</ul>
<p><strong>Components definition:</strong></p>
<ul>
<li>
<p><span class="math inline">\(\mathbf{X}= [\mathbf{X_p} \;\;  \mathbf{X}_n]\)</span> is the <span class="math inline">\(N \times M\)</span> design matrix for the <strong>prognostic effects</strong>. It typically includes:</p>
<ul>
<li><p>An intercept column. In <a href="#sec-intercept">Section x</a> we discuss the inclusion and the prior we give to the intercept in detail</p></li>
<li><p>A column for the main treatment effect.</p></li>
<li>
<p>Columns for the prognostic effects of each subgroup level (using dummy coding, so one reference level per factor is dropped). Each prognostic effect will be contained in <span class="math inline">\(\mathbf{X}_n\)</span> or <span class="math inline">\(\mathbf{X}_p\)</span> depending if we want to shrink or not the effect.</p>
<p>Example:</p>
</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Create your data as a data frame</span></span>
<span><span class="va">design_matrix_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Patient    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  Intercept  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  trt        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  sexF       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  regionUS   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  regionAsia <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Use knitr::kable() to format and print the table</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>  <span class="va">design_matrix_df</span>,</span>
<span>  caption <span class="op">=</span> <span class="st">"An example design matrix for a global subgroup model."</span>,</span>
<span>  align <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'l'</span>, <span class="st">'c'</span>, <span class="st">'c'</span>, <span class="st">'c'</span>, <span class="st">'c'</span><span class="op">)</span> <span class="co"># Align columns (l=left, c=center)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>
<span id="tab:unnamed-chunk-2">Table 3.1: </span>An example design matrix for a global subgroup model.</caption>
<thead><tr class="header">
<th align="left">Patient</th>
<th align="center">Intercept</th>
<th align="center">trt</th>
<th align="center">sexF</th>
<th align="center">regionUS</th>
<th align="left">regionAsia</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="left">0</td>
</tr>
</tbody>
</table>
<p><em>Note:</em> M=1+1+L-J= 1 degree for the intercept+ 1 for the treatment effect + L (Number of subgroups) - J(Number of variables) because we get the reference levels out.</p>
</li>
<li><p><span class="math inline">\(\boldsymbol{\beta_{1,p}}\)</span> is the <span class="math inline">\(P \times 1\)</span> vector of coefficients for the prognostic effects that we want to shrink. We will give an shrinkage prior to this coefficients.</p></li>
<li><p><span class="math inline">\(\boldsymbol{\beta_{1,n}}\)</span> is the <span class="math inline">\((M-P) \times 1\)</span> vector of coefficients for the prognostic effects that we don’t want to shrink.</p></li>
<li><p><span class="math inline">\(\mathbf{Z}= [\mathbf{Z_p} \;\;  \mathbf{Z}_n]\)</span> is the <span class="math inline">\(N \times L\)</span> design matrix for the <strong>predictive effects</strong>. Its columns represent the interaction between the treatment and each of the <span class="math inline">\(L\)</span> subgroup levels across all subgrouping variables. This matrix is constructed without dropping a reference level to treat all subgroups symmetrically.</p></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Manually creating the interaction matrix for clarity</span></span>
<span><span class="va">interaction_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Patient      <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>,</span>
<span>  `trt:sexM`   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  `trt:sexF`   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  `trt:regionEU` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  `trt:regionUS` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  `trt:regionAsia` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Using knitr::kable for a nice output</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>  <span class="va">interaction_matrix</span>,</span>
<span>  align <span class="op">=</span> <span class="st">'c'</span>,</span>
<span>  col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Patient"</span>, <span class="st">"trt x sexM"</span>, <span class="st">"trt x sexF"</span>, <span class="st">"trt x regionEU"</span>, <span class="st">"trt x regionUS"</span>, <span class="st">"trt x regionAsia"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="10%">
<col width="14%">
<col width="14%">
<col width="19%">
<col width="19%">
<col width="21%">
</colgroup>
<thead><tr class="header">
<th align="center">Patient</th>
<th align="center">trt x sexM</th>
<th align="center">trt x sexF</th>
<th align="center">trt x regionEU</th>
<th align="center">trt x regionUS</th>
<th align="center">trt x regionAsia</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">3</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">4</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">5</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">6</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
</tbody>
</table>
<ul>
<li>
<span class="math inline">\(\boldsymbol{\beta_{2,p}}\)</span> is the <span class="math inline">\(R \times 1\)</span> vector of coefficients for the predictive effects that we want to shrink. We will give an shrinkage prior to this coefficients.</li>
<li>
<span class="math inline">\(\boldsymbol{\beta_{2,n}}\)</span> is the <span class="math inline">\((L-R) \times 1\)</span> vector of coefficients for the predictive effects that we don’t want to shrink.</li>
<li>
<span class="math inline">\(U\)</span> is the <span class="math inline">\(N \times V\)</span> design matrix for the extra variables we want to take into account in the fitting of the model. This will also be <strong>unpenalized.</strong>
</li>
<li>
<span class="math inline">\(\boldsymbol{\beta_3}\)</span> is the <span class="math inline">\(V \times 1\)</span> vector of extra prognostic effects coefficients</li>
</ul>
<table style="width:99%;" class="table">
<colgroup>
<col width="22%">
<col width="38%">
<col width="38%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left"><strong>Shrinkage</strong></th>
<th align="left"><strong>Not Shrinkage</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><strong>Prognostic Effect</strong></td>
<td align="left"><span class="math inline">\(\mathbf{X_p}\boldsymbol{\beta_{1,p}}\)</span></td>
<td align="left"><span class="math inline">\(\mathbf{X_n}\boldsymbol{\beta_{1,n}}\)</span></td>
</tr>
<tr class="even">
<td align="left"><strong>Predictive Effect</strong></td>
<td align="left"><span class="math inline">\(\mathbf{Z_p}\boldsymbol{\beta_{2,p}}\)</span></td>
<td align="left"><span class="math inline">\(\mathbf{Z_n}\boldsymbol{\beta_{2,n}}\)</span></td>
</tr>
</tbody>
</table>
<p><strong><em>Linear form:</em></strong></p>
<p>To make it more concrete, the linear predictor for a single patient <span class="math inline">\(i\)</span> can be written as:</p>
<p><span class="math display">\[
\eta_i = \underbrace{\beta_0 + \beta_{\text{treat}}s_i + \underbrace{\sum_{l=1}^{P} \beta^l_{1,p}x^{il}_n}_\text{penalized}+ \underbrace{\sum_{l=P+1}^{M}  \beta^l_{1,n}x^{il}_n}_\text{Not penalized}+\underbrace{\sum_{v=1}^{V} \beta_{3}^vu^{iv}}_{\text{Extra }}}_{\text{Prognostic Effects}} + \underbrace{\underbrace{\sum_{l=1}^{L-R} \beta_{2,p}^l z_p^{il}}_{\text{penalized }} + \underbrace{\sum_{l=L-R+1}^{L} \beta_{2,n}^l z_n^{il}}_{\text{Not penalized}} }_{\text{Predictive effects}}
\]</span></p>
<p><strong>Note</strong>: See that even if <span class="math inline">\(z^{il}=x^{il}\cdot s^{i}\)</span>, as the prognostic effect or the predictive effect of the same subgrouping variable may be penalized or not, we separate it in <span class="math inline">\(x\)</span> and <span class="math inline">\(z\)</span> in the formula.</p>
</div>
<div class="section level4" number="3.4.2">
<h4 id="example">
<span class="header-section-number">3.4.2</span> Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h4>
<p>A randomized, double-blind trial comparing a new drug, <strong>DrugX</strong>, against a <strong>placebo</strong> in patients with hypertension.</p>
<ul>
<li>
<strong>Primary Endpoint (</strong><span class="math inline">\(Y_{i}\)</span>): Change from baseline in systolic blood pressure (SBP) in mmHg at 6 months.</li>
<li>
<strong>Subgroups of Interest</strong>:
<ul>
<li>
<strong>Age Group</strong>: <code>&lt;65</code> vs. <code>≥65</code> years.</li>
<li>
<strong>Sex</strong>: <code>Male</code> vs. <code>Female</code>.</li>
<li>
<strong>Kidney Function</strong>: eGFR <code>&lt;60</code> (impaired) vs. <code>≥60</code> (normal).</li>
</ul>
</li>
<li>
<strong>Covariates</strong>: <code>BaselineSBPᵢ</code>, <code>BMIᵢ</code>, <code>Smokerᵢ</code> (binary).</li>
</ul>
<p><strong>Global Model with Shrinkage</strong></p>
<p>The outcome is assumed to be normally distributed: <span class="math inline">\(Y_{i} \sim N(\mu_{i}, \sigma^2)\)</span>.</p>
<p>The linear predictor <span class="math inline">\(\mu_{i}\)</span> is modeled as:</p>
<p><span class="math display">\[
\mu_{i} = \underbrace{\beta_0}_{\text{Intercept}} + \underbrace{\beta_{\text{treat}} \cdot \text{Treatment}_i}_{\text{Main Trt Effect}} + \underbrace{\sum_{k=1}^{K} \alpha_k \cdot \text{Subgroup}_{ik}}_{\text{Prognostic Subgroup Effects}} + \underbrace{\sum_{k=1}^{K} \gamma_k \cdot (\text{Subgroup}_{ik} \cdot \text{Treatment}_i)}_{\text{Shrunken Predictive Effects}} + \underbrace{\sum_{j=1}^{J} \delta_j \cdot \text{Covariate}_{ij}}_{\text{Extra Prognostic effects}}
\]</span></p>
<p><span class="math display">\[
=\underbrace{\beta_0}_{\text{Intercept}} + \underbrace{\beta_{\text{treat}} \cdot \text{Treatment}_i}_{\text{Main Trt Effect}} + \underbrace{\alpha_1 \cdot \text{Age Group}_i+\alpha_2 \cdot \text{Sex}_i+\alpha_3 \cdot \text{eGFR}_i}_{\text{Prognostic Subgroup Effects}}+
\]</span></p>
<p><span class="math display">\[
+ \underbrace{\gamma_1 \cdot (\text{Age Group}_i\cdot \text{Treatment}_i)+\gamma_2 \cdot (\text{Sex}_i\cdot \text{Treatment}_i)+\gamma_3 \cdot (\text{eGFR}_i\cdot \text{Treatment}_i)}_{\text{Predictive Effects}} + \underbrace{\delta_1 \cdot \text{BaselineSBP}_i+\delta_2 \cdot \text{BMI}_i+\delta_3 \cdot \text{Smoker}_i}_{\text{Extra Prognostic effects}}
\]</span></p>
</div>
</div>
<div class="section level3" number="3.5">
<h3 id="one-variable-at-a-time-model">
<span class="header-section-number">3.5</span> One-Variable-at-a-Time Model<a class="anchor" aria-label="anchor" href="#one-variable-at-a-time-model"></a>
</h3>
<p>The <strong>one-variable-at-a-time model</strong> <span class="citation">(<a href="#ref-wang2024bayesian">Wang et al. 2024</a>)</span> is a Bayesian hierarchical model (BHM) that improves upon standard subgroup analysis by borrowing information across subgroup levels to produce more stable and reliable estimates. Instead of analyzing each subgroup level in isolation, it analyzes all levels <em>within a single subgrouping variable</em> (e.g., all age groups) together in one model.</p>
<p>For example, for the variable <em>Sex</em> (with levels Male and Female), you would fit one hierarchical model. In this single model, the treatment effects for Male (<span class="math inline">\(\beta_{2,\text{sex,male}}\)</span>) and Female (<span class="math inline">\(\beta_{2,\text{sex,female}}\)</span>) are treated as exchangeable and are linked by a common prior distribution. Then, a completely separate hierarchical model would be fit for the variable <em>Region</em>.</p>
<div class="section level4" number="3.5.1">
<h4 id="full-model-equation-1">
<span class="header-section-number">3.5.1</span> Full Model Equation<a class="anchor" aria-label="anchor" href="#full-model-equation-1"></a>
</h4>
<p>For a given subgrouping variable <span class="math inline">\(j\)</span>, we can specify a flexible linear predictor that allows for some covariate effects to be constant across the levels of <span class="math inline">\(j\)</span>, while others are allowed to vary.</p>
<p>Let’s partition the patient-level covariates into two sets:</p>
<ul>
<li><p><span class="math inline">\(\mathbf{u}_i\)</span>: A vector of covariates assumed to have a <strong>constant prognostic effect</strong> across all levels of the subgrouping variable <span class="math inline">\(j\)</span>.</p></li>
<li><p><span class="math inline">\(\mathbf{v}_i\)</span>: A vector of covariates for which there is a strong <em>a priori</em> reason to believe their prognostic effect <strong>varies</strong> across the levels <span class="math inline">\(k\)</span> of the subgrouping variable <span class="math inline">\(j\)</span>.</p></li>
</ul>
<p>The linear predictor for patient <span class="math inline">\(i\)</span> in level <span class="math inline">\(k\)</span> of variable <span class="math inline">\(j\)</span> is then: <span class="math display">\[g(\mu_{i,j,k}) = \beta_{1,j,k} + \beta_{2,j,k}z_i + \boldsymbol{\beta}_{3,j}\mathbf{u}_i + \boldsymbol{\beta}_{4,j,k}\mathbf{v}_i\]</span></p>
<ul>
<li>
<span class="math inline">\(\beta_{2,j,k}\)</span>: The predictive effect for level <span class="math inline">\(k\)</span> of variable <span class="math inline">\(j\)</span>. This is the primary parameter of interest for shrinkage.</li>
<li>
<span class="math inline">\(\boldsymbol{\beta}_{3,j}\mathbf{u}_i\)</span>: The effect of covariates assumed to be <strong>constant</strong> across levels. The coefficient vector <span class="math inline">\(\boldsymbol{\beta}_{3,j}\)</span> does <strong>not</strong> have a <span class="math inline">\(k\)</span> subscript.</li>
<li>
<span class="math inline">\(\boldsymbol{\beta}_{4,j,k}\mathbf{v}_i\)</span>: The effect of covariates assumed to be <strong>level-specific</strong>. The coefficient vector <span class="math inline">\(\boldsymbol{\beta}_{4,j,k}\)</span> <strong>does</strong> have a <span class="math inline">\(k\)</span> subscript, allowing its effect to be different for each subgroup level. This can be seen as an interaction between variable <span class="math inline">\(x_j\)</span> and <span class="math inline">\(v_i\)</span>.</li>
</ul>
<p>Note that for coefficients <span class="math inline">\(\boldsymbol{\beta}_{3,j}\)</span> and <span class="math inline">\(\boldsymbol{\beta}_{4,j,k}\)</span> we can use shrinkage or standard priors depending in our prior beliefs.</p>
</div>
<div class="section level4" number="3.5.2">
<h4 id="example-1">
<span class="header-section-number">3.5.2</span> Example<a class="anchor" aria-label="anchor" href="#example-1"></a>
</h4>
<p>Similarly to the example showed for the Global model. The example below is for the <strong>Age Group</strong> variable, where <span class="math inline">\(k \in \{ \text{&lt;65}, \text{≥65} \}\)</span>.</p>
<p>The outcome for a patient <em>i</em> in age subgroup <em>k</em> is: <span class="math inline">\(Y_{ik} \sim N(\mu_{ik}, \sigma_k^2)\)</span>.</p>
<p>The linear predictor <span class="math inline">\(\mu_{ik}\)</span> is:</p>
<p><span class="math display">\[
\mu_{ik} = \underbrace{\beta_{1,k}}_{\text{Subgroup Intercept}} + \underbrace{\beta_{2,k} \cdot \text{Treatment}_i}_{\text{Predictive Effect}} + \underbrace{\delta_1 \cdot \text{BMI}_i + \delta_2 \cdot \text{Smoker}_i}_{\text{Constant Prognostic Effects}} + \underbrace{\delta_{3,k} \cdot \text{BaselineSBP}_i}_{\text{Varying Prognostic Effect}}
\]</span></p>
<ul>
<li>Here, <span class="math inline">\(\beta_{1,k}\)</span> (subgroup-specific intercept) and <span class="math inline">\(\beta_{2,k}\)</span> (subgroup-specific predictive effect) are given hierarchical priors to borrow information across age groups. For example: <span class="math inline">\(\beta_{2,k} \sim N(\mu_2, \tau_2^2)\)</span>.</li>
<li>The effect of Baseline SBP is also allowed to vary by age group (<span class="math inline">\(\delta_{3,k}\)</span>), while BMI and Smoking effects are assumed constant</li>
</ul>
</div>
</div>
<div class="section level3" number="3.6">
<h3 id="sec-intercept">
<span class="header-section-number">3.6</span> The Logic of the Intercept<a class="anchor" aria-label="anchor" href="#sec-intercept"></a>
</h3>
<p>While the intercept (<span class="math inline">\(\beta_0\)</span>) is not subject to shrinkage (it is a fixed effect within the <code>unprogeffect</code> component), specifying its prior requires care to ensure the model remains weakly informative without introducing bias or numerical instability.</p>
<p><strong>Default Specification:</strong> By default, <code>bonsaiforest</code> assigns a weakly informative Normal prior centered at 0 with a standard deviation of 5: <span class="math display">\[
\beta_0 \sim \mathcal{N}(0, 5^2)
\]</span> This choice is aligned with the methodology in Wolbers et al. (2025), where a standard deviation of 5 on the log-hazard or logit scale covers a wide range of plausible effect sizes (e.g., ratios from 0.08 to 12) while still penalizing extreme, unrealistic values.</p>
<p><strong>Linking Prior Scale to Trial Design:</strong> For a more principled choice, users can adjust the scale parameter (<span class="math inline">\(\sigma_{prior}\)</span>) based on assumptions made during the <strong>trial design and sample size calculation phase</strong>.</p>
<ol style="list-style-type: decimal">
<li>
<strong>For Continuous Endpoints:</strong> The trial protocol typically assumes a population standard deviation, <span class="math inline">\(\sigma_{design}\)</span>, for power calculations.
<ul>
<li>
<strong>Recommendation:</strong> Set the prior standard deviation to a multiple of this design parameter, such as <span class="math inline">\(\sigma_{prior} = 10 \times \sigma_{design}\)</span>. This ensures the prior is wide enough to cover the plausible range of outcomes envisioned during planning.</li>
</ul>
</li>
<li>
<strong>For Count Endpoints (Log Scale):</strong> The intercept represents the log of the baseline event rate (assuming the offset is handled correctly).
<ul>
<li>
<strong>Recommendation:</strong> The default <span class="math inline">\(\mathcal{N}(0, 5^2)\)</span> is generally appropriate, as it covers a vast multiplicative range of event rates. However, if the trial is designed for very rare events (e.g., <span class="math inline">\(&lt; 0.01\)</span> events/year) or very frequent events, centering the prior on the log of the anticipated event rate from the protocol (<span class="math inline">\(\mu_0 = \log(\lambda_{design})\)</span>) rather than 0 can improve convergence.</li>
</ul>
</li>
<li>
<strong>For Binary Endpoints (Logit Scale):</strong>
<ul>
<li>
<strong>Recommendation:</strong> Use a prior scaled to the <strong>Unit Information Standard Deviation (UISD)</strong>, or adhere to the default <span class="math inline">\(\sigma=5\)</span>. A variance of 25 covers the entire range of realistic probabilities without concentrating mass on deterministic outcomes (0 or 1).</li>
</ul>
</li>
</ol>
<p><strong>Special Case: Time-to-Event Endpoints.</strong> For Cox proportional hazards models, the intercept is <strong>not identifiable</strong> and is <strong>omitted</strong> from the linear predictor.</p>
<ul>
<li><p><strong>Mechanism:</strong> The intercept is effectively absorbed into the non-parametric baseline hazard function, <span class="math inline">\(h_0(t)\)</span>.</p></li>
<li><p><strong>Implementation:</strong> The <code>brms</code> backend handles this automatically by estimating the baseline hazard (via <code>bhaz()</code>) rather than a fixed intercept parameter. Therefore, no prior specification for <span class="math inline">\(\beta_0\)</span> is required for survival models.</p></li>
</ul>
</div>
<div class="section level3" number="3.7">
<h3 id="sec-endpoint">
<span class="header-section-number">3.7</span> Endpoint-Specific Models<a class="anchor" aria-label="anchor" href="#sec-endpoint"></a>
</h3>
<p>The package supports four primary endpoint types by specifying the appropriate likelihood and link function for <span class="math inline">\(g(\boldsymbol{\mu}) = \boldsymbol{\eta}\)</span>.</p>
<table style="width:99%;" class="table">
<colgroup>
<col width="9%">
<col width="28%">
<col width="18%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th align="left">Endpoint</th>
<th align="left">Distribution / Model</th>
<th align="left">Link Function</th>
<th align="left">Notes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><strong>Continuous</strong></td>
<td align="left">Normal: <span class="math inline">\(y_i \sim N(\mu_i, \sigma^2)\)</span>
</td>
<td align="left">Identity: <span class="math inline">\(\mu_i = \eta_i\)</span>
</td>
<td align="left">
<span class="math inline">\(\sigma\)</span> can be stratified (e.g., <code>sigma ~ 0 + clinic_site</code>).</td>
</tr>
<tr class="even">
<td align="left"><strong>Binary</strong></td>
<td align="left">Bernoulli: <span class="math inline">\(y_i \sim \text{Bernoulli}(p_i)\)</span>
</td>
<td align="left">Logit: <span class="math inline">\(\text{logit}(p_i) = \eta_i\)</span>
</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left"><strong>Count</strong></td>
<td align="left">Negative Binomial: <span class="math inline">\(y_i \sim \text{NegBin}(\mu_i, \phi)\)</span>
</td>
<td align="left">Log: <span class="math inline">\(\log(\mu_i) = \eta_i\)</span>
</td>
<td align="left">
<span class="math inline">\(\phi\)</span> (overdispersion) can be stratified. Supports <code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset()</a></code>.</td>
</tr>
<tr class="even">
<td align="left"><strong>Time-to-event</strong></td>
<td align="left">Cox Proportional Hazards: <span class="math inline">\(h_i(t) = h_0(t)\exp(\eta_i)\)</span>
</td>
<td align="left">Log (on the hazard)</td>
<td align="left">Intercept is absorbed by the baseline hazard <span class="math inline">\(h_0(t)\)</span>. <span class="math inline">\(h_0(t)\)</span> can be stratified.</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3" number="3.8">
<h3 id="prior-specifications">
<span class="header-section-number">3.8</span> Prior Specifications<a class="anchor" aria-label="anchor" href="#prior-specifications"></a>
</h3>
<div class="section level4" number="3.8.1">
<h4 id="default-priors">
<span class="header-section-number">3.8.1</span> Default Priors<a class="anchor" aria-label="anchor" href="#default-priors"></a>
</h4>
<p>If priors are not specified, the function applies the following defaults (as defined in the <code>fit_brms_model</code> code):</p>
<ul>
<li>
<strong>Prognostic Shrunk:</strong> <code>horseshoe(1)</code>
</li>
<li>
<strong>Prognostic Unshrunk:</strong> <code>normal(0, 5)</code>
</li>
<li>
<strong>Prognostic Intercept:</strong> <code>normal(0, 10)</code>
</li>
<li>
<strong>Predictive Shrunk:</strong> <code>horseshoe(1)</code>
</li>
<li>
<strong>Predictive Unshrunk:</strong> <code>normal(0, 5)</code>
</li>
</ul>
<p><strong>Note:</strong> The intercept prior is <em>not</em> applied for <code>response_type = "survival"</code>, as Cox models do not have a global intercept.</p>
</div>
<div class="section level4" number="3.8.2">
<h4 id="weakly-informative-priors-unshrunk-terms">
<span class="header-section-number">3.8.2</span> Weakly Informative Priors (Unshrunk Terms)<a class="anchor" aria-label="anchor" href="#weakly-informative-priors-unshrunk-terms"></a>
</h4>
<p>For all non-penalized coefficients (<span class="math inline">\(\boldsymbol{\beta_{1,n}}, \boldsymbol{\beta_{2,n}}, \boldsymbol{\beta_{3}}\)</span>), we use weakly informative priors to aid computational stability without strongly influencing the posterior.</p>
<ul>
<li>
<strong>Default:</strong> <code>normal(0, 10)</code>. This is a common, weakly regularizing prior on the linear predictor scale. Users can specify their own, e.g., <code>student_t(3, 0, 2.5)</code>.</li>
</ul>
</div>
<div class="section level4" number="3.8.3">
<h4 id="regularized-horseshoe-prior-shrunk-terms">
<span class="header-section-number">3.8.3</span> Regularized Horseshoe Prior (Shrunk Terms)<a class="anchor" aria-label="anchor" href="#regularized-horseshoe-prior-shrunk-terms"></a>
</h4>
<p>This is the default shrinkage prior in <code>bonsaiforest2</code>, recommended for its excellent adaptive shrinkage properties <span class="citation">(<a href="#ref-wolbers2025using">Wolbers et al. 2025</a>; <a href="#ref-piironen2017sparsity">Piironen and Vehtari 2017</a>)</span>.</p>
<ul>
<li><p><strong>Concept:</strong> A global-local prior. It has an infinitely tall spike at zero (to aggressively shrink noise) and heavy tails (to leave true, large signals unshrunk).</p></li>
<li>
<p><strong>Hierarchical Specification</strong>:</p>
<p><span class="math display">\[\begin{aligned}
\beta_{2,l} &amp;\sim N(0, \tau^2 \tilde{\lambda}_l^2) \\
\tilde{\lambda}_l^2 &amp;= \frac{c^2 \lambda_l^2}{c^2 + \tau^2 \lambda_l^2} \\
\lambda_l &amp;\sim C^+(0, 1) \quad (\text{Local shrinkage}) \\
\tau &amp;\sim C^+(0, \tau_0) \quad (\text{Global shrinkage}) \\
c^2 &amp;\sim \text{Inverse-Gamma}(\nu/2, \nu s^2/2)
\end{aligned}\]</span></p>
</li>
<li>
<p><strong>Hyperparameter Justification</strong>: The package supports two ways to set the crucial global scale <span class="math inline">\(\tau_0\)</span>:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Fixed Default (<code>scale_global</code>):</strong> <code>horseshoe(scale_global = 1)</code>. This is the package default, a robust, general-purpose choice <span class="citation">(<a href="#ref-wolbers2025using">Wolbers et al. 2025</a>)</span>.</li>
<li>
<strong>Elicited Prior (<code>par_ratio</code>):</strong> Sets <span class="math inline">\(\tau_0\)</span> based on the <em>prior</em> belief about the number of effective (non-zero) subgroups, <span class="math inline">\(p_{eff}\)</span>, out of the total <span class="math inline">\(L\)</span> <span class="citation">(<a href="#ref-bornkamp2025benchmarking">Bornkamp 2025</a>; <a href="#ref-piironen2017sparsity">Piironen and Vehtari 2017</a>)</span>. This is specified via <span class="math inline">\(\text{par\_ratio} = \frac{p_{eff}}{L - p_{eff}}\)</span>. This scales the prior based on sample size (<span class="math inline">\(N\)</span>) and the expected sparsity.</li>
</ol>
</li>
</ul>
<p><strong>Regularized Horseshoe Implementation in</strong> <a href="https://paulbuerkner.com/brms/" class="external-link"><code>brms</code></a></p>
<p>The <a href="https://paulbuerkner.com/brms/" class="external-link"><code>brms</code></a> package implements the Regularized Horseshoe prior using the function <a href="https://paulbuerkner.com/brms/reference/horseshoe.html" class="external-link"><code>horseshoe(...)</code></a>. The regularization term (the “slab”) is added to the standard Horseshoe to ensure robustness and improve computational stability in Stan.</p>
<ul>
<li><strong>Horseshoe Function and Key Arguments</strong></li>
</ul>
<p>he Horseshoe prior is set using the function call:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/horseshoe.html" class="external-link">horseshoe</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fl">1</span>, scale_global <span class="op">=</span> <span class="fl">1</span>, df_global <span class="op">=</span> <span class="fl">1</span>, scale_slab <span class="op">=</span> <span class="fl">2</span>, df_slab <span class="op">=</span> <span class="fl">4</span>, par_ratio <span class="op">=</span> <span class="cn">NULL</span>, autoscale <span class="op">=</span> <span class="cn">TRUE</span>, main <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="12%">
<col width="15%">
<col width="71%">
</colgroup>
<thead><tr class="header">
<th align="left">Horseshoe Argument</th>
<th align="left">Theoretical Equivalent</th>
<th align="left">Role and Implication</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\mathbf{scale\_global}\)</span></td>
<td align="left"><span class="math inline">\(\tau_0\)</span></td>
<td align="left">Scale of the <span class="math inline">\(\text{Student-}t\)</span> prior on the global shrinkage parameter <span class="math inline">\(\tau\)</span> Lower values <span class="math inline">\(\implies\)</span> <strong>more aggressive global shrinkage</strong>.</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\mathbf{par\_ratio}\)</span></td>
<td align="left"><span class="math inline">\(\frac{p_{eff}}{L - p_{eff}}\)</span></td>
<td align="left">
<strong>Alternative to</strong> <span class="math inline">\(\mathbf{scale\_global}\)</span>. Specifies the ratio of expected non-zero to zero coefficients, automatically calculating <span class="math inline">\(\tau_0\)</span>.</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\mathbf{df}\)</span></td>
<td align="left">DOF for <span class="math inline">\(\lambda_l\)</span>
</td>
<td align="left">Degrees of freedom of <span class="math inline">\(\text{Student-}t\)</span> prior on local shrinkage parameters (<span class="math inline">\(\lambda_l\)</span>). Default <span class="math inline">\(\mathbf{df=1}\)</span> gives the standard half-Cauchy.</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\mathbf{scale\_slab}\)</span></td>
<td align="left"><span class="math inline">\(s\)</span></td>
<td align="left">Scale of the regularization slab. Default <span class="math inline">\(\mathbf{scale\_slab=2}\)</span> prevents large coefficients from being over-shrunk.</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\mathbf{autoscale}\)</span></td>
<td align="left">Scaling by <span class="math inline">\(\sigma\)</span>
</td>
<td align="left">Logical. If <span class="math inline">\(\mathbf{TRUE}\)</span> (default), the prior is <strong>automatically scaled</strong> using the residual standard deviation (<span class="math inline">\(\sigma\)</span>).</td>
</tr>
</tbody>
</table>
<ul>
<li>
<strong>Relationship to Justification:</strong> The <span class="math inline">\(\mathbf{brms}\)</span> function offers two primary ways to set the global shrinkage level, which controls the overall sparsity of the model:</li>
</ul>
<ol style="list-style-type: decimal">
<li>
<strong>Fixed Global Scale:</strong> Using the <span class="math inline">\(\mathbf{scale\_global}\)</span> argument, often set to <span class="math inline">\(\mathbf{1.0}\)</span> as a general-purpose default. This value is internally multiplied by the residual standard deviation (<span class="math inline">\(\sigma\)</span>) when <code>autoscale = TRUE</code>.</li>
<li>
<strong>Elicited Global Scale (Recommended):</strong> Using the <span class="math inline">\(\mathbf{par\_ratio}\)</span> argument, which allows the user to specify their <strong>prior belief about the sparsity</strong> of the model (i.e., the expected number of true non-zero coefficients, <span class="math inline">\(p_{eff}\)</span>). This is the recommended approach as it accounts for the number of coefficients <span class="math inline">\(L\)</span> and the sample size <span class="math inline">\(N\)</span> to determine the optimal <span class="math inline">\(\tau_0\)</span>.</li>
</ol>
<ul>
<li>
<p><strong>Choosing</strong> <span class="math inline">\(\mathbf{scale\_global}\)</span> <strong>and</strong> <span class="math inline">\(\mathbf{par\_ratio}\)</span>: The choice of <span class="math inline">\(\tau_0\)</span> (controlled by <span class="math inline">\(\mathbf{scale\_global}\)</span> or <span class="math inline">\(\mathbf{par\_ratio}\)</span>) is crucial, as it sets the overall magnitude of shrinkage.</p>
<ul>
<li>
<p><strong>Fixed Default (</strong><span class="math inline">\(\mathbf{scale\_global=1}\)</span>):</p>
<ul>
<li>
<strong>Use when:</strong> You want a simple, robust, general-purpose prior without explicit sparsity knowledge.</li>
<li>
<strong>Caveat:</strong> May result in insufficient shrinkage if the true number of non-zero coefficients is small.</li>
</ul>
</li>
<li>
<p><strong>Elicited Sparsity (</strong><span class="math inline">\(\mathbf{par\_ratio}\)</span>):</p>
<ul>
<li>
<strong>Calculation:</strong> <span class="math inline">\(\text{par\_ratio} = \frac{p_{eff}}{L - p_{eff}}\)</span>, where <span class="math inline">\(p_{eff}\)</span> is the expected number of non-zero coefficients and <span class="math inline">\(L\)</span> is the total number of coefficients.</li>
<li>
<strong>Use when:</strong> You have a strong prior belief about the number of relevant effects. This is generally preferred for adaptive shrinkage as it scales <span class="math inline">\(\tau_0\)</span> appropriately.</li>
</ul>
</li>
</ul>
</li>
</ul>
<table style="width:99%;" class="table">
<colgroup>
<col width="19%">
<col width="20%">
<col width="60%">
</colgroup>
<thead><tr class="header">
<th align="center">
<span class="math inline">\(\mathbf{par\_ratio}\)</span> Value</th>
<th align="left">Expected <span class="math inline">\(p_{eff}\)</span> (Sparsity)</th>
<th align="left">Interpretation of Shrinkage</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><strong>Small (e.g., 0.05)</strong></td>
<td align="left">Very Few Non-Zero Coefficients</td>
<td align="left">
<strong>High Shrinkage:</strong> <span class="math inline">\(\tau_0\)</span> is small, aggressively shrinking coefficients towards zero.</td>
</tr>
<tr class="even">
<td align="center"><strong>Moderate (e.g., 0.2)</strong></td>
<td align="left">A Moderate Fraction is Non-Zero</td>
<td align="left">
<strong>Moderate Shrinkage:</strong> A less aggressive <span class="math inline">\(\tau_0\)</span>, allowing more coefficients to remain unshrunk.</td>
</tr>
<tr class="odd">
<td align="center">
<span class="math inline">\(\mathbf{par\_ratio}\)</span> Ignored</td>
<td align="left">
<span class="math inline">\(\mathbf{scale\_global}\)</span> used</td>
<td align="left">Uses a fixed <span class="math inline">\(\tau_0\)</span> that doesn’t explicitly depend on expected sparsity.</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Recommendation:</strong> While <span class="math inline">\(\mathbf{scale\_global=1}\)</span> is the quick default, specifying <span class="math inline">\(\mathbf{par\_ratio}\)</span> based on expert knowledge of expected sparsity is the <strong>most theoretically sound and adaptive</strong> method for setting the global shrinkage scale.</p>
</blockquote>
</div>
<div class="section level4" number="3.8.4">
<h4 id="r2d2-prior-shrunk-terms">
<span class="header-section-number">3.8.4</span> R2D2 Prior (Shrunk Terms)<a class="anchor" aria-label="anchor" href="#r2d2-prior-shrunk-terms"></a>
</h4>
<ul>
<li><p><strong>Concept:</strong> This prior is uniquely derived by first placing a prior on the model’s coefficient of determination, <span class="math inline">\(R^2\)</span>, which quantifies the proportion of variance explained by the predictors. This is arguably more intuitive than specifying priors directly on coefficients.</p></li>
<li><p><strong>Hierarchical Specification (Marginal Version):</strong> <span class="math display">\[
\begin{aligned}
\beta_{2,l} &amp;\sim DE(\sigma \sqrt{\phi_l \omega / 2}) \quad (\text{Double-Exponential/Laplace kernel}) \\
\boldsymbol{\phi} &amp;= (\phi_1, \dots, \phi_L) \sim \text{Dirichlet}(a_\pi, \dots, a_\pi) \quad (\text{Local shrinkage}) \\
\omega &amp;\sim \text{Beta-Prime}(a, b) \quad (\text{Global shrinkage})
\end{aligned}
\]</span> This is equivalent to assuming that the proportion of variance explained by the interaction terms follows <span class="math inline">\(R^2 = \frac{\omega}{1+\omega} \sim \text{Beta}(a,b)\)</span>.</p></li>
<li>
<p><strong>Justification of Hyperparameters:</strong></p>
<ul>
<li><p><span class="citation">Zhang et al. (<a href="#ref-zhang2022bayesian">2022</a>)</span> provide clear guidance. A fully automatic approach is to set <span class="math inline">\(b=0.5\)</span> to achieve <strong>Cauchy-like heavy tails</strong>.</p></li>
<li><p>The concentration parameter <span class="math inline">\(a_\pi\)</span> controls sparsity. A smaller <span class="math inline">\(a_\pi\)</span> (e.g., 0.2) implies <strong>higher shrinkage</strong>, concentrating the prior variance on fewer coefficients, while a larger <span class="math inline">\(a_\pi\)</span> (e.g., 0.5) spreads the variance more evenly, implying <strong>lower shrinkage</strong>.</p></li>
<li>
<p><strong>Default Recommendation:</strong> Set <span class="math inline">\(b=0.5\)</span> and offer options for the user based on desired shrinkage strength:</p>
<ul>
<li>
<strong>High Shrinkage:</strong> <span class="math inline">\(a_\pi=0.2\)</span>
</li>
<li>
<strong>Low Shrinkage:</strong> <span class="math inline">\(a_\pi=0.5\)</span>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>R2D2 Prior Implementation in</strong> <a href="https://paulbuerkner.com/brms/" class="external-link"><code>brms</code></a></p>
<p>The <a href="https://paulbuerkner.com/brms/" class="external-link"><code>brms</code></a> package implements this prior using the function <a href="https://paulbuerkner.com/brms/reference/R2D2.html" class="external-link"><code>R2D2(...)</code></a>, providing a high-level parametrization that is more intuitive than setting the parameters <span class="math inline">\(a\)</span>, <span class="math inline">\(b\)</span>, and <span class="math inline">\(a_\pi\)</span> directly. This function translates desired <span class="math inline">\(\mathbf{R^2}\)</span> properties and shrinkage strength into the underlying prior distribution’s parameters.</p>
<ul>
<li><strong>R2D2 Function and Key Arguments</strong></li>
</ul>
<p>The R2D2 prior is set using the function call:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/R2D2.html" class="external-link">R2D2</a></span><span class="op">(</span>mean_R2 <span class="op">=</span> <span class="fl">0.5</span>, prec_R2 <span class="op">=</span> <span class="fl">2</span>, cons_D2 <span class="op">=</span> <span class="fl">0.5</span>, autoscale <span class="op">=</span> <span class="cn">TRUE</span>, main <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="10%">
<col width="11%">
<col width="77%">
</colgroup>
<thead><tr class="header">
<th align="left">R2D2 Argument</th>
<th align="left">Theoretical Equivalent</th>
<th align="left">Role and Implication</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\mathbf{mean\_R2}\)</span></td>
<td align="left"><span class="math inline">\(\mathbb{E}[R^2]\)</span></td>
<td align="left">Sets the <strong>prior expected value</strong> for the model’s fixed effect <span class="math inline">\(R^2\)</span>.</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\mathbf{prec\_R2}\)</span></td>
<td align="left">
<span class="math inline">\(a+b\)</span> (Concentration)</td>
<td align="left">Controls the <strong>precision</strong> of the Beta prior on <span class="math inline">\(R^2\)</span>. Lower values mean a flatter prior.</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\mathbf{cons\_D2}\)</span></td>
<td align="left"><span class="math inline">\(a_{\pi}\)</span></td>
<td align="left">The <strong>concentration parameter</strong> for the <span class="math inline">\(\text{Dirichlet}\)</span> distribution on the variance components (local shrinkage). <strong>Lower values imply higher shrinkage/sparsity.</strong>
</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\mathbf{autoscale}\)</span></td>
<td align="left">Scaling by <span class="math inline">\(\sigma\)</span>
</td>
<td align="left">Logical. If <span class="math inline">\(\mathbf{TRUE}\)</span> (default), the prior is <strong>automatically scaled</strong> using the residual standard deviation (<span class="math inline">\(\sigma\)</span>). This ensures the prior is scale-invariant.</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p><strong>Relationship to Justification:</strong> The <a href="https://paulbuerkner.com/brms/" class="external-link"><code>brms</code></a> function parameters are directly related to the justified hierarchical parameters:</p>
<ul>
<li>The <span class="math inline">\(\mathbf{cons\_D2}\)</span> parameter is the direct counterpart to the sparsity parameter <span class="math inline">\(\mathbf{a_{\pi}}\)</span>. The default recommendation <span class="math inline">\(\mathbf{cons\_D2 = 0.5}\)</span> corresponds precisely to the <span class="math inline">\(\mathbf{a_{\pi}=0.5}\)</span> low shrinkagesetting.</li>
<li>The <span class="math inline">\(\mathbf{mean\_R2}\)</span> and <span class="math inline">\(\mathbf{prec\_R2}\)</span> arguments define the <span class="math inline">\(\text{Beta}(a,b)\)</span> prior on <span class="math inline">\(R^2\)</span>, where: <span class="math display">\[a = \text{mean_R2} \times \text{prec_R2}\]</span> <span class="math display">\[b = (1 - \text{mean_R2}) \times \text{prec_R2}\]</span> The choice of <span class="math inline">\(\mathbf{prec\_R2=2}\)</span> (the default) alongside <span class="math inline">\(\mathbf{mean\_R2=0.5}\)</span> results in <span class="math inline">\(a=1\)</span> and <span class="math inline">\(b=1\)</span>, which is a <strong>Uniform prior</strong> on <span class="math inline">\(R^2 \sim \text{Beta}(1, 1)\)</span>, representing a maximally weak prior belief on global fit.</li>
<li>The essential <span class="math inline">\(\mathbf{b=0.5}\)</span> setting for <strong>Cauchy-like heavy tails</strong> (preventing over-shrinkage) is <strong>implicitly</strong> handled by the R2D2 function’s underlying structure and does not require manual specification.</li>
</ul>
</li>
<li>
<p><strong>Choosing</strong> <span class="math inline">\(\mathbf{mean\_R2}\)</span> and <span class="math inline">\(\mathbf{prec\_R2}\)</span> : Choosing these parameters involves quantifying your prior knowledge about the model’s overall predictive power before observing the data. They define a <span class="math inline">\(\text{Beta}(a,b)\)</span> distribution on <span class="math inline">\(R^2\)</span>.</p>
<ul>
<li>
<p>Choosing <span class="math inline">\(\mathbf{mean\_R2}\)</span> (Prior Expected <span class="math inline">\(R^2\)</span>): This sets the <strong>center</strong> of your prior belief.</p>
<ul>
<li><p><strong>Default (0.5):</strong> Use if you have no strong prior knowledge. It implies a neutral expectation that the fixed effects will explain half of the variance.</p></li>
<li><p><strong>Informative Low (e.g., 0.1 to 0.3):</strong> Use if you expect a very weak or noisy relationship.</p></li>
<li><p><strong>Informative High (e.g., 0.7 to 0.9):</strong> Use if you expect a highly predictive model based on strong prior evidence.</p></li>
</ul>
</li>
<li><p>Choosing <span class="math inline">\(\mathbf{prec\_R2}\)</span> (Prior Confidence in <span class="math inline">\(R^2\)</span>): This determines the <strong>concentration</strong> or <strong>certainty</strong> of the Beta prior around the chosen <span class="math inline">\(\text{mean_R2}\)</span>.</p></li>
</ul>
</li>
</ul>
<table style="width:99%;" class="table">
<colgroup>
<col width="11%">
<col width="17%">
<col width="70%">
</colgroup>
<thead><tr class="header">
<th align="center"><span class="math inline">\(\mathbf{prec\_R2}\)</span></th>
<th align="left">
<p>Resulting Beta Parameters</p>
<p>(<span class="math inline">\(\text{mean_R2}=0.5\)</span>)</p>
</th>
<th align="left">Interpretation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><strong>2 (Default)</strong></td>
<td align="left">
<span class="math inline">\(a=1, b=1\)</span> (<span class="math inline">\(\text{Uniform}\)</span>)</td>
<td align="left">
<strong>Weakly Informative:</strong> All <span class="math inline">\(R^2\)</span> values are equally likely.</td>
</tr>
<tr class="even">
<td align="center"><strong>5 to 10</strong></td>
<td align="left">
<span class="math inline">\(a=2.5, b=2.5\)</span> to <span class="math inline">\(a=5, b=5\)</span>
</td>
<td align="left">
<strong>Moderately Informative:</strong> The prior is bell-shaped and centered at 0.5, constraining <span class="math inline">\(R^2\)</span> away from extreme values (0 and 1).</td>
</tr>
<tr class="odd">
<td align="center"><strong>&gt; 20</strong></td>
<td align="left">Highly Peaked</td>
<td align="left">
<strong>Highly Informative:</strong> Use only with very strong external evidence for the <span class="math inline">\(R^2\)</span> value.</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Recommendation:</strong> The <strong>Default</strong> <span class="math inline">\(\mathbf{mean\_R2 = 0.5}\)</span> and <span class="math inline">\(\mathbf{prec\_R2 = 2}\)</span> provides the most flexible, weakly informative setting for <span class="math inline">\(R^2\)</span>, which is generally recommended unless strong prior knowledge dictates otherwise.</p>
</blockquote>
</div>
<div class="section level4" number="3.8.5">
<h4 id="normal-hierarchical-prior-for-one-variable-at-a-time-model">
<span class="header-section-number">3.8.5</span> Normal Hierarchical Prior (for One-Variable-at-a-Time Model)<a class="anchor" aria-label="anchor" href="#normal-hierarchical-prior-for-one-variable-at-a-time-model"></a>
</h4>
<p>This is the standard hierarchical model for subgroup analysis, which assumes that treatment effects for levels within a subgrouping variable are drawn from a common normal distribution. It’s less complex than the Horseshoe or R2D2 priors but provides effective shrinkage, especially when the number of subgroup levels is small.</p>
<ul>
<li>
<strong>Hierarchical Specification:</strong> For a given subgrouping variable <span class="math inline">\(j\)</span> with levels <span class="math inline">\(k=1, \dots, K_j\)</span>:</li>
</ul>
<p><span class="math display">\[\begin{aligned} \beta_{2,j,k} &amp;\sim \mathcal{N}(\mu_{2,j}, \tau^2_{2,j}) \quad (\text{Level-specific treatment effects}) \\
    \mu_{2,j} &amp;\sim \mathcal{N}(0, s^2) \quad (\text{Common mean effect}) \\ \tau_{2,j} &amp;\sim \text{Half-Normal}(a) \quad (\text{Between-subgroup heterogeneity}) \end{aligned}
    \]</span></p>
<ul>
<li>
<strong>Justification of Hyperparameters:</strong> The key is setting the scale parameter a for the Half-Normal prior on the between-subgroup standard deviation, <span class="math inline">\(\tau_{2,j}\)</span>, as this controls the degree of shrinkage. As recommended by <span class="citation">Bornkamp (<a href="#ref-bornkamp2025benchmarking">2025</a>)</span>, this can be linked to the planned treatment effect ( <span class="math inline">\(\delta_{plan}\)</span>) from the trial protocol, making the prior choice interpretable and consistent across different endpoints. The choice of a implies a prior on the plausible difference in treatment effects between any two subgroups.</li>
</ul>
</div>
</div>
<div class="section level3" number="3.9">
<h3 id="estimation-mcmc">
<span class="header-section-number">3.9</span> Estimation (MCMC)<a class="anchor" aria-label="anchor" href="#estimation-mcmc"></a>
</h3>
<p>The joint posterior distribution of all parameters is complex and has no closed-form solution. We use Markov Chain Monte Carlo (MCMC) methods to draw samples from this distribution. Specifically, the package uses the <strong>No-U-Turn Sampler (NUTS)</strong>, an efficient variant of Hamiltonian Monte Carlo (HMC), as implemented in <strong>Stan</strong> via the <code>brms</code> package. The output is a set of posterior samples (e.g., 4000 draws) representing the joint posterior distribution.</p>
</div>
<div class="section level3" number="3.10">
<h3 id="sec-standardization">
<span class="header-section-number">3.10</span> Standardization for Marginal Effects (G-computation)<a class="anchor" aria-label="anchor" href="#sec-standardization"></a>
</h3>
<p>To obtain interpretable <em>marginal</em> effects for each subgroup, the package implements a standardization (G-computation) procedure. This process is repeated for <em>each</em> MCMC draw to generate a full posterior distribution of the marginal effect.</p>
<p><strong>For a single MCMC draw, the step-by-step process is:</strong></p>
<ol style="list-style-type: decimal">
<li><p><strong>Select Parameters:</strong> Take one draw from the joint posterior distribution for all model parameters (all <span class="math inline">\(\boldsymbol{\beta}\)</span>’s, <span class="math inline">\(\sigma\)</span>, <span class="math inline">\(\phi\)</span>, etc.).</p></li>
<li>
<p><strong>Create Counterfactuals:</strong> For <em>every patient</em> <span class="math inline">\(i\)</span> in the original dataset, create two scenarios:</p>
<ul>
<li>Scenario A: Patient <span class="math inline">\(i\)</span>’s covariates, with treatment <span class="math inline">\(s_i=0\)</span> (Control).</li>
<li>Scenario B: Patient <span class="math inline">\(i\)</span>’s covariates, with treatment <span class="math inline">\(s_i=1\)</span> (Treatment).</li>
</ul>
</li>
<li><p><strong>Predict Outcomes:</strong> Use the model formula and the parameters from Step 1 to predict the outcome for <em>every patient</em> under both Scenario A (<span class="math inline">\(\hat{\mu}_{i,0}\)</span>) and Scenario B (<span class="math inline">\(\hat{\mu}_{i,1}\)</span>).</p></li>
<li>
<p><strong>Average within Subgroups:</strong> For a subgroup of interest <span class="math inline">\(l\)</span> (e.g., “Female”):</p>
<ul>
<li>Calculate the average predicted outcome under control: <span class="math inline">\(\hat{\mu}_{l,0} = \text{mean}(\hat{\mu}_{i,0})\)</span> for all <span class="math inline">\(i\)</span> where <span class="math inline">\(x_{il}=1\)</span>.</li>
<li>Calculate the average predicted outcome under treatment: <span class="math inline">\(\hat{\mu}_{l,1} = \text{mean}(\hat{\mu}_{i,1})\)</span> for all <span class="math inline">\(i\)</span> where <span class="math inline">\(x_{il}=1\)</span>.</li>
</ul>
</li>
<li>
<p><strong>Calculate Effect Measure:</strong> Compute the marginal effect for subgroup <span class="math inline">\(l\)</span> from these averaged predictions. This depends on the endpoint type:</p>
<ul>
<li>
<strong>Continuous:</strong> Mean Difference = <span class="math inline">\(\hat{\mu}_{l,1} - \hat{\mu}_{l,0}\)</span>.</li>
<li>
<strong>Binary:</strong> Odds Ratio = <span class="math inline">\(\frac{\hat{\mu}_{l,1} / (1 - \hat{\mu}_{l,1})}{\hat{\mu}_{l,0} / (1 - \hat{\mu}_{l,0})}\)</span> (where <span class="math inline">\(\hat{\mu}\)</span> is the predicted probability).</li>
<li>
<strong>Count:</strong> Rate Ratio = <span class="math inline">\(\hat{\mu}_{l,1} / \hat{\mu}_{l,0}\)</span> (where <span class="math inline">\(\hat{\mu}\)</span> is the predicted rate).</li>
<li>
<strong>Time-to-Event:</strong> Average Hazard Ratio (AHR). This is the most complex, as it requires predicting the full survival curve <span class="math inline">\(S_i(t)\)</span> for each patient. The marginal survival curves <span class="math inline">\(\hat{S}_{l,0}(t)\)</span> and <span class="math inline">\(\hat{S}_{l,1}(t)\)</span> are calculated, and the AHR is computed from them, as the marginal curves may not be proportional.</li>
</ul>
</li>
<li><p><strong>Repeat:</strong> This process (Steps 1-5) is repeated for all MCMC draws, yielding a full posterior distribution (e.g., 4000 values) for the marginal effect of each subgroup. The final point estimate (median) and 95% credible interval are taken from this distribution.</p></li>
</ol>
</div>
</div>
<div class="section level2" number="4">
<h2 id="sec-functions">
<span class="header-section-number">4</span> Mapping of Statistical Methods to <code>bonsaiforest2</code> Functions<a class="anchor" aria-label="anchor" href="#sec-functions"></a>
</h2>
<p>This section connects the statistical methodology (Section 3) to the core package functions.</p>
<ul>
<li>
<p><strong><code><a href="../reference/run_brms_analysis.html">run_brms_analysis()</a></code></strong></p>
<ul>
<li>
<strong>Maps to:</strong> Sections 3.2 (Global Model), 3.3 (Endpoints), 3.4 (Priors), 3.5 (Estimation).</li>
<li>
<strong>Action:</strong> This function is the primary model-fitting engine.
<ul>
<li>It constructs the design matrices <span class="math inline">\(\mathbf{X_n}, \mathbf{X_p}, \mathbf{Z_n}, \mathbf{Z_p}, \mathbf{U}\)</span> based on the formula string arguments (e.g., <code>unshrunk_prognostic_formula_str</code>, <code>shrunk_predictive_formula_str</code>).</li>
<li>It assigns the specified priors (e.g., <code>predictive_effect_priors = list(shrunk = "horseshoe(par_ratio = 0.1)")</code>).</li>
<li>It builds and passes the full <code>brmsformula</code> and data to <code><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brms::brm()</a></code> to run the Stan MCMC sampler.</li>
<li>It handles stratification via the <code>stratification_formula_str</code> argument, which adds terms like <code>bhaz(country)</code> or <code>sigma ~ country</code> to the <code>brmsformula</code>.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><code><a href="../reference/summary_subgroup_effects.html">summary_subgroup_effects()</a></code></strong></p>
<ul>
<li>
<strong>Maps to:</strong> Section 3.6 (Standardization / G-computation).</li>
<li>
<strong>Action:</strong> This function implements the full G-computation procedure.
<ul>
<li>It takes the fitted <code>brms_fit</code> object (containing posterior samples) and the <code>original_data</code>.</li>
<li>It automatically detects the subgroups specified in the model (or uses the <code>subgroup_vars</code> argument).</li>
<li>It iterates through each posterior sample, generates counterfactual predictions, averages within subgroups, and calculates the marginal effect measure (e.g., AHR, OR) based on the <code>response_type</code>.</li>
<li>It returns a <code>subgroup_summary</code> object containing the posterior distributions of the marginal effects.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code></strong></p>
<ul>
<li>
<strong>Maps to:</strong> Final visualization of Section 3.6 results.</li>
<li>
<strong>Action:</strong> This is a method for <code>subgroup_summary</code> objects. It takes the summarized posterior distributions (median and 95% CrI) for the overall and subgroup effects and generates a forest plot.</li>
</ul>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-bornkamp2025benchmarking" class="csl-entry">
Bornkamp, Björn. 2025. <span>“<span class="nocase">Benchmarking Bayesian subgroup shrinkage methods on clinical data</span>.”</span> In <em>PSI Conference 2025</em>. London, UK.
</div>
<div id="ref-piironen2017sparsity" class="csl-entry">
Piironen, J., and A. Vehtari. 2017. <span>“<span class="nocase">Sparsity information and regularization in the horseshoe and other shrinkage priors</span>.”</span> <em>Electronic Journal of Statistics</em> 11: 5018–51.
</div>
<div id="ref-wang2024bayesian" class="csl-entry">
Wang, Yun, Wenda Tu, William Koh, James Travis, Robert Abugov, Kiya Hamilton, Mengjie Zheng, Roberto Crackel, Pablo Bonangelino, and Mark Rothmann. 2024. <span>“<span class="nocase">Bayesian hierarchical models for subgroup analysis</span>.”</span> <em>Pharmaceutical Statistics</em> 23: 1065–83.
</div>
<div id="ref-wolbers2025using" class="csl-entry">
Wolbers, Marcel, Mar Vázquez Rabuñal, Ke Li, Kaspar Rufibach, and Daniel Sabanés Bové. 2025. <span>“<span class="nocase">Using shrinkage methods to estimate treatment effects in overlapping subgroups in randomized clinical trials with a time-to-event endpoint</span>.”</span> <em>Statistical Methods in Medical Research</em>, 1–12.
</div>
<div id="ref-zhang2022bayesian" class="csl-entry">
Zhang, Yan Dora, Brian P. Naughton, Howard D. Bondell, and Brian J. Reich. 2022. <span>“<span class="nocase">Bayesian regression using a prior on the model fit: The R2-D2 shrinkage prior</span>.”</span> <em>Journal of the American Statistical Association</em> 117 (538): 862–74.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Miriam Pedrera Gomez, Isaac Gravestock, Marcel Wolbers.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
