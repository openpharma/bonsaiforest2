<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Advanced Functionalities • bonsaiforest2</title>
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced Functionalities">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bonsaiforest2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Advanced_Functionalities.html">Advanced Functionalities</a></li>
    <li><a class="dropdown-item" href="../articles/Quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/Statistical_Specifications.html">Statistical Specifications</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openpharma/bonsaiforest2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Advanced Functionalities</h1>
                        <h4 data-toc-skip class="author">Miriam Pedrera Gomez, Isaac Gravestock, and Marcel Wolbers</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/bonsaiforest2/blob/main/vignettes/Advanced_Functionalities.Rmd" class="external-link"><code>vignettes/Advanced_Functionalities.Rmd</code></a></small>
      <div class="d-none name"><code>Advanced_Functionalities.Rmd</code></div>
    </div>

    
    
<p>This vignette demonstrates advanced functionalities for Bayesian shrinkage estimation, including specifying an <strong>offset for count data</strong>, customizing <strong>prior distributions</strong>, and using <strong>stratification</strong> to handle heterogeneity in nuisance parameters.</p>
<div class="section level2" number="1">
<h2 id="handling-exposure-in-count-outcomes-with-offsets">
<span class="header-section-number">1</span> Handling Exposure in Count Outcomes with Offsets<a class="anchor" aria-label="anchor" href="#handling-exposure-in-count-outcomes-with-offsets"></a>
</h2>
<p>For count data (like disease exacerbations or event rates), the observed count often depends on the <strong>exposure time</strong> or <strong>follow-up time</strong>. Using an <strong>offset</strong> variable is the standard statistical method to properly account for this time variation by modeling the event <strong>rate</strong> (count per unit time) instead of the raw count.</p>
<p>In <code>bonsaiforest2</code>, you can include the offset directly in the <code>response_formula_str</code> using the standard <code>brms</code> syntax: <code>outcome + offset(log_time) ~ predictors</code>.</p>
<div class="section level3" number="1.1">
<h3 id="example-1-count-outcome-with-offset-disease-exacerbations">
<span class="header-section-number">1.1</span> Example 1: Count Outcome with Offset (Disease Exacerbations)<a class="anchor" aria-label="anchor" href="#example-1-count-outcome-with-offset-disease-exacerbations"></a>
</h3>
<p>This scenario models exacerbation counts using a Negative Binomial distribution and explicitly accounts for the patient’s exposure time.</p>
<p><em>Scenario</em>: Modeling exacerbation counts. Adjust for <code>baseline_severity</code> (unshrunk) and many exploratory <code>biomarkers</code> (shrunk). No interaction terms (overall treatment effect only).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Data Simulation </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">789</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://openpharma.github.io/bonsaiforest2/">bonsaiforest2</a></span><span class="op">)</span></span>
<span><span class="va">n_patients</span> <span class="op">&lt;-</span> <span class="fl">150</span></span>
<span><span class="va">biomarker_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_patients</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">biomarker_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"biomarker_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">count_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  exacerbation_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">rnbinom</a></span><span class="op">(</span><span class="va">n_patients</span>, size <span class="op">=</span> <span class="fl">1.5</span>, mu <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  medication <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="va">n_patients</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  baseline_severity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_patients</span>, <span class="fl">10</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  log_exposure_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_patients</span>, <span class="fl">0.5</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span> <span class="co"># Example offset</span></span>
<span><span class="op">)</span></span>
<span><span class="va">count_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">count_data</span>, <span class="va">biomarker_data</span><span class="op">)</span></span>
<span><span class="va">count_data</span><span class="op">$</span><span class="va">medication</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">count_data</span><span class="op">$</span><span class="va">medication</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create formula string for all biomarkers (Prognostic effects only here)</span></span>
<span><span class="va">shrunk_prog_str</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"~"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">biomarker_data</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model Fitting with Offset</span></span>
<span><span class="va">count_model_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_brms_analysis.html">run_brms_analysis</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">count_data</span>,</span>
<span>  <span class="co"># Include offset(log_exposure_time) directly in the response formula</span></span>
<span>  response_formula_str <span class="op">=</span> <span class="st">"exacerbation_count + offset(log_exposure_time) ~ medication"</span>,</span>
<span>  response_type <span class="op">=</span> <span class="st">"count"</span>,</span>
<span>  unshrunk_prognostic_formula_str <span class="op">=</span> <span class="st">"~ 1 + baseline_severity"</span>,</span>
<span>  shrunk_prognostic_formula_str <span class="op">=</span> <span class="va">shrunk_prog_str</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">1</span>, iter <span class="op">=</span> <span class="fl">200</span>, warmup <span class="op">=</span> <span class="fl">100</span>, cores <span class="op">=</span> <span class="fl">1</span>, refresh <span class="op">=</span> <span class="fl">0</span>, backend <span class="op">=</span> <span class="st">"cmdstanr"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Step 1: Preparing formula and data...</span></span>
<span><span class="co">#&gt; Treatment 'medication' added to unshrunk prognostic terms by default.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Step 2: Fitting the brms model...</span></span>
<span><span class="co">#&gt; Using default priors for unspecified effects:</span></span>
<span><span class="co">#&gt;   - shrunk prognostic (b): horseshoe(1)</span></span>
<span><span class="co">#&gt;   - unshrunk prognostic (b): normal(0, 5)</span></span>
<span><span class="co">#&gt;   - prognostic intercept: normal(0, 5)</span></span>
<span><span class="co">#&gt; Fitting brms model...</span></span>
<span><span class="co">#&gt; Start sampling</span></span>
<span><span class="co">#&gt; Running MCMC with 1 chain...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 WARNING: There aren't enough warmup iterations to fit the </span></span>
<span><span class="co">#&gt; Chain 1          three stages of adaptation as currently configured. </span></span>
<span><span class="co">#&gt; Chain 1          Reducing each adaptation stage to 15%/75%/10% of </span></span>
<span><span class="co">#&gt; Chain 1          the given number of warmup iterations: </span></span>
<span><span class="co">#&gt; Chain 1            init_buffer = 15 </span></span>
<span><span class="co">#&gt; Chain 1            adapt_window = 75 </span></span>
<span><span class="co">#&gt; Chain 1            term_buffer = 10 </span></span>
<span><span class="co">#&gt; Chain 1 finished in 2.5 seconds.</span></span>
<span><span class="co">#&gt; Warning: 1 of 100 (1.0%) transitions hit the maximum treedepth limit of 10.</span></span>
<span><span class="co">#&gt; See https://mc-stan.org/misc/warnings for details.</span></span>
<span><span class="co">#&gt; Loading required namespace: rstan</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Analysis complete.</span></span></code></pre></div>
</div>
</div>
<div class="section level2" number="2">
<h2 id="customizing-prior-distributions">
<span class="header-section-number">2</span> Customizing Prior Distributions<a class="anchor" aria-label="anchor" href="#customizing-prior-distributions"></a>
</h2>
<p>The choice of prior is central to Bayesian shrinkage. <code>bonsaiforest2</code> provides sensible defaults, but it allows for full customization using the <code>prognostic_effect_priors</code> and <code>predictive_effect_priors</code> arguments.</p>
<div class="section level3" number="2.1">
<h3 id="prior-specification-mechanics">
<span class="header-section-number">2.1</span> Prior Specification Mechanics<a class="anchor" aria-label="anchor" href="#prior-specification-mechanics"></a>
</h3>
<p>You specify priors as named lists containing strings, which are then passed to <code><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">brms::set_prior()</a></code>.</p>
<table class="table">
<colgroup>
<col width="25%">
<col width="25%">
<col width="25%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th align="left">Prior Group</th>
<th align="left">Argument</th>
<th align="left">Sub-List Names</th>
<th align="left">Default Prior (Type)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">
<strong>Predictive</strong> (Interaction/Treatment)</td>
<td align="left"><code>predictive_effect_priors</code></td>
<td align="left">
<code>shrunk</code>, <code>unshrunk</code>
</td>
<td align="left">
<code>horseshoe(1)</code> (Shrinkage)</td>
</tr>
<tr class="even">
<td align="left">
<strong>Prognostic</strong> (Covariates)</td>
<td align="left"><code>prognostic_effect_priors</code></td>
<td align="left">
<code>shrunk</code>, <code>unshrunk</code>, <code>intercept</code>
</td>
<td align="left">
<code>horseshoe(1)</code> (Shrinkage)</td>
</tr>
</tbody>
</table>
<div class="section level4" number="2.1.1">
<h4 id="prior-recommendations-for-non-shrunk-terms">
<span class="header-section-number">2.1.1</span> Prior Recommendations for Non-Shrunk Terms<a class="anchor" aria-label="anchor" href="#prior-recommendations-for-non-shrunk-terms"></a>
</h4>
<p>For non-shrunk (fixed) effects, choosing a <strong>weakly informative prior</strong> is critical to stabilize the model without unduly influencing the results. A robust strategy is to scale the priors based on the <strong>standard deviation (SD)</strong> of the outcome variable.</p>
<p><span class="math display">\[\sigma_{outcome} = \text{SD}(\text{Outcome})\]</span></p>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th align="left">Parameter</th>
<th align="left">Recommended Prior Scale</th>
<th align="left">Justification</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><strong>Intercept</strong></td>
<td align="left"><span class="math inline">\(\text{Normal}(0, 10 \times \sigma_{outcome})\)</span></td>
<td align="left">Wide enough to cover the range of outcomes if all predictors are zero.</td>
</tr>
<tr class="even">
<td align="left"><strong>Unshrunk Prognostic</strong></td>
<td align="left"><span class="math inline">\(\text{Normal}(0, \sigma_{outcome})\)</span></td>
<td align="left">Assumes a typical coefficient’s impact is roughly comparable to the magnitude of the outcome’s variability.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level3" number="2.2">
<h3 id="practical-examples-of-prior-setting">
<span class="header-section-number">2.2</span> Practical Examples of Prior Setting<a class="anchor" aria-label="anchor" href="#practical-examples-of-prior-setting"></a>
</h3>
<p>To provide a functional example, we will generate a <strong>synthetic dataset</strong> that mirrors the structure of the <strong>Tirzepatide (SURPASS-2) trial</strong> case study described in Wang et al. (2024). This study used a <strong>continuous endpoint</strong> (change in HbA1c), which fits perfectly with your code snippet calculating the standard deviation (<code>sd</code>).</p>
<div class="section level4" number="2.2.1">
<h4 id="dataset-generation-and-model-preparation-synthetic-surpass-2">
<span class="header-section-number">2.2.1</span> Dataset Generation and Model Preparation (Synthetic SURPASS-2)<a class="anchor" aria-label="anchor" href="#dataset-generation-and-model-preparation-synthetic-surpass-2"></a>
</h4>
<p>This dataset mimics a clinical trial comparing a Treatment (Tirzepatide) vs. Control (Semaglutide), looking at subgroups defined by <strong>Sex</strong>, <strong>Race</strong>, and <strong>Age Group</strong>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prerequisites: Ensure packages used by your function are loaded</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span> <span class="co"># For Surv()</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span>     <span class="co"># For brmsformula objects</span></span>
<span><span class="co">#&gt; Loading required package: Rcpp</span></span>
<span><span class="co">#&gt; Loading 'brms' package (version 2.23.0). Useful instructions</span></span>
<span><span class="co">#&gt; can be found by typing help('brms'). A more detailed introduction</span></span>
<span><span class="co">#&gt; to the package is available through vignette('brms_overview').</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'brms'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:survival':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     kidney</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ar</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://openpharma.github.io/bonsaiforest2/">bonsaiforest2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Create Sample Data (matching your @examples section)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  subgroup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S1"</span>, <span class="st">"S2"</span>, <span class="st">"S3"</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Ensure variables are factors where appropriate</span></span>
<span><span class="va">sim_data</span><span class="op">$</span><span class="va">trt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">$</span><span class="va">trt</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sim_data</span><span class="op">$</span><span class="va">region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">$</span><span class="va">region</span><span class="op">)</span></span>
<span><span class="va">sim_data</span><span class="op">$</span><span class="va">subgroup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">$</span><span class="va">subgroup</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Run prepare_formula_model</span></span>
<span><span class="co"># This transforms the data (creating dummy variables for interactions)</span></span>
<span><span class="co"># and builds the non-linear brms formula.</span></span>
<span><span class="va">prepared_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_formula_model.html">prepare_formula_model</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">sim_data</span>,</span>
<span>  </span>
<span>  <span class="co"># Main response variable and treatment identifier</span></span>
<span>  response_formula_str <span class="op">=</span> <span class="st">"Surv(time, status) ~ trt"</span>,</span>
<span>  </span>
<span>  <span class="co"># Predictive (Interaction) effects to be shrunk</span></span>
<span>  <span class="co"># Note: The function will automatically generate dummy columns for 'subgroup'</span></span>
<span>  shrunk_predictive_formula_str <span class="op">=</span> <span class="st">"~ trt:subgroup"</span>,</span>
<span>  </span>
<span>  <span class="co"># Prognostic (Main) effects: Unshrunk (Fixed)</span></span>
<span>  unshrunk_prognostic_formula_str <span class="op">=</span> <span class="st">"~ age"</span>,</span>
<span>  </span>
<span>  <span class="co"># Prognostic (Main) effects: Shrunk (Regularized)</span></span>
<span>  shrunk_prognostic_formula_str <span class="op">=</span> <span class="st">"~ region"</span>,</span>
<span>  </span>
<span>  <span class="co"># Model type</span></span>
<span>  response_type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>  </span>
<span>  <span class="co"># Stratify the baseline hazard by region</span></span>
<span>  stratification_formula_str <span class="op">=</span> <span class="st">"~ region"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz().</span></span>
<span><span class="co">#&gt; Applying stratification: estimating separate baseline hazards by 'region'.</span></span>
<span><span class="co">#&gt; Treatment 'trt' added to unshrunk prognostic terms by default.</span></span>
<span><span class="co">#&gt; Auto-adding missing prognostic effect for interaction: subgroup</span></span>
<span></span>
<span><span class="co"># 3. Inspect the Results</span></span>
<span></span>
<span><span class="co"># A. The generated brms formula object</span></span>
<span><span class="co"># You should see parts for 'unprogeffect', 'shprogeffect', etc.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">prepared_model</span><span class="op">$</span><span class="va">formula</span><span class="op">)</span></span>
<span><span class="co">#&gt; time | cens(1 - status) + bhaz(Boundary.knots = c(0.02, 99.98), knots = c(24, 46, 69), intercept = FALSE, gr = region) ~ unprogeffect + shprogeffect + shpredeffect </span></span>
<span><span class="co">#&gt; unprogeffect ~ age + trt + subgroup + 0</span></span>
<span><span class="co">#&gt; shprogeffect ~ region + 0</span></span>
<span><span class="co">#&gt; shpredeffect ~ trt_subgroupS1 + trt_subgroupS2 + trt_subgroupS3 + 0</span></span>
<span></span>
<span><span class="co"># B. The processed data</span></span>
<span><span class="co"># You should see new columns like 'subgroup_S1_x_trt', 'subgroup_S2_x_trt', etc.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">prepared_model</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   time status trt      age region subgroup trt_subgroupS1 trt_subgroupS2</span></span>
<span><span class="co">#&gt; 1   29      0   1 57.87739      B       S2              0              1</span></span>
<span><span class="co">#&gt; 2   79      1   1 57.69042      B       S1              1              0</span></span>
<span><span class="co">#&gt; 3   41      1   1 53.32203      B       S3              0              0</span></span>
<span><span class="co">#&gt; 4   88      0   0 39.91623      B       S3              0              0</span></span>
<span><span class="co">#&gt; 5   94      1   1 48.80547      A       S3              0              0</span></span>
<span><span class="co">#&gt; 6    6      1   1 47.19605      A       S2              0              1</span></span>
<span><span class="co">#&gt;   trt_subgroupS3</span></span>
<span><span class="co">#&gt; 1              0</span></span>
<span><span class="co">#&gt; 2              0</span></span>
<span><span class="co">#&gt; 3              1</span></span>
<span><span class="co">#&gt; 4              0</span></span>
<span><span class="co">#&gt; 5              1</span></span>
<span><span class="co">#&gt; 6              0</span></span></code></pre></div>
</div>
<div class="section level4" number="2.2.2">
<h4 id="model-preparation">
<span class="header-section-number">2.2.2</span> Model Preparation<a class="anchor" aria-label="anchor" href="#model-preparation"></a>
</h4>
</div>
<div class="section level4" number="2.2.3">
<h4 id="example-2-using-recommended-weakly-informative-priors">
<span class="header-section-number">2.2.3</span> Example 2: Using Recommended Weakly Informative Priors<a class="anchor" aria-label="anchor" href="#example-2-using-recommended-weakly-informative-priors"></a>
</h4>
<p>This is the easiest example we can have. Just use the recommended priors without any tunning.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_ex3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_brms_model.html">fit_brms_model</a></span><span class="op">(</span></span>
<span>  prepared_model <span class="op">=</span> <span class="va">prepared_model</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">1</span>, iter <span class="op">=</span> <span class="fl">200</span>, warmup <span class="op">=</span> <span class="fl">100</span>, cores <span class="op">=</span> <span class="fl">1</span>, refresh <span class="op">=</span> <span class="fl">0</span>, backend <span class="op">=</span> <span class="st">"cmdstanr"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Using default priors for unspecified effects:</span></span>
<span><span class="co">#&gt;   - shrunk prognostic (b): horseshoe(1)</span></span>
<span><span class="co">#&gt;   - unshrunk prognostic (b): normal(0, 5)</span></span>
<span><span class="co">#&gt;   - shrunk predictive (b): horseshoe(1)</span></span>
<span><span class="co">#&gt; Fitting brms model...</span></span>
<span><span class="co">#&gt; Start sampling</span></span>
<span><span class="co">#&gt; Running MCMC with 1 chain...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 WARNING: There aren't enough warmup iterations to fit the </span></span>
<span><span class="co">#&gt; Chain 1          three stages of adaptation as currently configured. </span></span>
<span><span class="co">#&gt; Chain 1          Reducing each adaptation stage to 15%/75%/10% of </span></span>
<span><span class="co">#&gt; Chain 1          the given number of warmup iterations: </span></span>
<span><span class="co">#&gt; Chain 1            init_buffer = 15 </span></span>
<span><span class="co">#&gt; Chain 1            adapt_window = 75 </span></span>
<span><span class="co">#&gt; Chain 1            term_buffer = 10 </span></span>
<span><span class="co">#&gt; Chain 1 finished in 4.3 seconds.</span></span>
<span><span class="co">#&gt; Warning: 100 of 100 (100.0%) transitions hit the maximum treedepth limit of 10.</span></span>
<span><span class="co">#&gt; See https://mc-stan.org/misc/warnings for details.</span></span></code></pre></div>
</div>
<div class="section level4" number="2.2.4">
<h4 id="example-3-using-the-r2d2-shrinkage-prior">
<span class="header-section-number">2.2.4</span> Example 3: Using the R2D2 Shrinkage Prior<a class="anchor" aria-label="anchor" href="#example-3-using-the-r2d2-shrinkage-prior"></a>
</h4>
<p>The R2D2 prior is useful when you want to control the <em>global</em> shrinkage via the coefficient of determination (<span class="math inline">\(R^2\)</span>) rather than a scale parameter <span class="math inline">\(\tau\)</span>. This is often more interpretable for stakeholders.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use a custom R2D2 string for the shrunk predictive effects (interactions)</span></span>
<span><span class="co"># mean_R2 = 0.5 implies we expect the subgroups to explain 50% of the variance</span></span>
<span><span class="va">r2d2_prior_string</span> <span class="op">&lt;-</span> <span class="st">"R2D2(mean_R2 = 0.5, prec_R2 = 1)"</span> </span>
<span></span>
<span><span class="va">fit_ex4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_brms_model.html">fit_brms_model</a></span><span class="op">(</span></span>
<span>  prepared_model <span class="op">=</span> <span class="va">prepared_model</span>,</span>
<span>  predictive_effect_priors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>shrunk <span class="op">=</span> <span class="va">r2d2_prior_string</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">1</span>, iter <span class="op">=</span> <span class="fl">200</span>, warmup <span class="op">=</span> <span class="fl">100</span>, cores <span class="op">=</span> <span class="fl">1</span>, refresh <span class="op">=</span> <span class="fl">0</span>, backend <span class="op">=</span> <span class="st">"cmdstanr"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Using default priors for unspecified effects:</span></span>
<span><span class="co">#&gt;   - shrunk prognostic (b): horseshoe(1)</span></span>
<span><span class="co">#&gt;   - unshrunk prognostic (b): normal(0, 5)</span></span>
<span><span class="co">#&gt; Fitting brms model...</span></span>
<span><span class="co">#&gt; Start sampling</span></span>
<span><span class="co">#&gt; Running MCMC with 1 chain...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 WARNING: There aren't enough warmup iterations to fit the </span></span>
<span><span class="co">#&gt; Chain 1          three stages of adaptation as currently configured. </span></span>
<span><span class="co">#&gt; Chain 1          Reducing each adaptation stage to 15%/75%/10% of </span></span>
<span><span class="co">#&gt; Chain 1          the given number of warmup iterations: </span></span>
<span><span class="co">#&gt; Chain 1            init_buffer = 15 </span></span>
<span><span class="co">#&gt; Chain 1            adapt_window = 75 </span></span>
<span><span class="co">#&gt; Chain 1            term_buffer = 10 </span></span>
<span><span class="co">#&gt; Chain 1 finished in 4.4 seconds.</span></span>
<span><span class="co">#&gt; Warning: 100 of 100 (100.0%) transitions hit the maximum treedepth limit of 10.</span></span>
<span><span class="co">#&gt; See https://mc-stan.org/misc/warnings for details.</span></span></code></pre></div>
</div>
<div class="section level4" number="2.2.5">
<h4 id="example-4-custom-hierarchical-prior-advanced">
<span class="header-section-number">2.2.5</span> Example 4: Custom Hierarchical Prior (Advanced)<a class="anchor" aria-label="anchor" href="#example-4-custom-hierarchical-prior-advanced"></a>
</h4>
<p>This example demonstrates injecting raw Stan code. This is necessary if you want to implement a hierarchical structure that <code>brms</code> does not support natively, such as linking specific coefficients via a custom global parameter <span class="math inline">\(\tau_{pred}\)</span>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Define a new hyperparameter 'tau_pred' for the Stan code</span></span>
<span><span class="va">stanvars_full_hierarchical</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/stanvar.html" class="external-link">stanvar</a></span><span class="op">(</span></span>
<span>  scode <span class="op">=</span> <span class="st">"  real mu_pred;\n  real&lt;lower=0&gt; sigma_pred;\n"</span>,</span>
<span>  block <span class="op">=</span> <span class="st">"parameters"</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/stanvar.html" class="external-link">stanvar</a></span><span class="op">(</span></span>
<span>    scode <span class="op">=</span> <span class="st">"  // Priors on the hierarchical parameters\n  target += normal_lpdf(mu_pred | 0, 4); \n  target += normal_lpdf(sigma_pred | 0, 1) - normal_lccdf(0 | 0, 1); \n"</span>,</span>
<span>    block <span class="op">=</span> <span class="st">"model"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># </span></span>
<span><span class="va">prior_full_hierarchical</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">set_prior</a></span><span class="op">(</span><span class="st">"normal(mu_pred, sigma_pred)"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Pass both objects to the function</span></span>
<span><span class="va">fit_ex5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_brms_model.html">fit_brms_model</a></span><span class="op">(</span></span>
<span>  prepared_model <span class="op">=</span> <span class="va">prepared_model</span>,</span>
<span>  predictive_effect_priors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>shrunk <span class="op">=</span> <span class="va">prior_full_hierarchical</span><span class="op">)</span>,</span>
<span>  stanvars <span class="op">=</span> <span class="va">stanvars_full_hierarchical</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">1</span>, iter <span class="op">=</span> <span class="fl">200</span>, warmup <span class="op">=</span> <span class="fl">100</span>, cores <span class="op">=</span> <span class="fl">1</span>, refresh <span class="op">=</span> <span class="fl">0</span>, backend <span class="op">=</span> <span class="st">"cmdstanr"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Re-targeting 'brmsprior' object for nlpar: shpredeffect class: b</span></span>
<span><span class="co">#&gt; Using default priors for unspecified effects:</span></span>
<span><span class="co">#&gt;   - shrunk prognostic (b): horseshoe(1)</span></span>
<span><span class="co">#&gt;   - unshrunk prognostic (b): normal(0, 5)</span></span>
<span><span class="co">#&gt; Fitting brms model...</span></span>
<span><span class="co">#&gt; Start sampling</span></span>
<span><span class="co">#&gt; Running MCMC with 1 chain...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 WARNING: There aren't enough warmup iterations to fit the </span></span>
<span><span class="co">#&gt; Chain 1          three stages of adaptation as currently configured. </span></span>
<span><span class="co">#&gt; Chain 1          Reducing each adaptation stage to 15%/75%/10% of </span></span>
<span><span class="co">#&gt; Chain 1          the given number of warmup iterations: </span></span>
<span><span class="co">#&gt; Chain 1            init_buffer = 15 </span></span>
<span><span class="co">#&gt; Chain 1            adapt_window = 75 </span></span>
<span><span class="co">#&gt; Chain 1            term_buffer = 10 </span></span>
<span><span class="co">#&gt; Chain 1 finished in 2.8 seconds.</span></span>
<span><span class="co">#&gt; Warning: 100 of 100 (100.0%) transitions hit the maximum treedepth limit of 10.</span></span>
<span><span class="co">#&gt; See https://mc-stan.org/misc/warnings for details.</span></span></code></pre></div>
<p>#Stratification for Nuisance Parameters</p>
<p>In many trials, parameters like the observation error variance (<span class="math inline">\(\sigma^2\)</span> for continuous outcomes) or the baseline hazard function (<span class="math inline">\(h_0(t)\)</span> for survival outcomes) are known to vary by site, country, or other factors. Stratification models this known heterogeneity by fitting these nuisance parameters separately for each level of a grouping variable.</p>
<p>Use the <code>stratification_formula_str</code> argument to define the grouping factor(s).</p>
</div>
</div>
<div class="section level3" number="2.3">
<h3 id="example-5-stratified-continuous-model">
<span class="header-section-number">2.3</span> Example 5: Stratified Continuous Model<a class="anchor" aria-label="anchor" href="#example-5-stratified-continuous-model"></a>
</h3>
<p><em>Scenario</em>: We model SBP change where the observation <strong>variance</strong> <span class="math inline">\(\sigma^2\)</span> differs by <span class="math inline">\(\text{clinic\_site}\)</span>. This is modeled by stratifying the <span class="math inline">\(\sigma\)</span> parameter in the Normal distribution by the site variable.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">n_patients</span> <span class="op">&lt;-</span> <span class="fl">180</span></span>
<span><span class="va">sigma_by_site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>SiteA <span class="op">=</span> <span class="fl">6</span>, SiteB <span class="op">=</span> <span class="fl">12</span>, SiteC <span class="op">=</span> <span class="fl">18</span><span class="op">)</span></span>
<span><span class="va">sample_data_strat_cont</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_patients</span>,</span>
<span>    clinic_site <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SiteA"</span>, <span class="st">"SiteB"</span>, <span class="st">"SiteC"</span><span class="op">)</span>, <span class="va">n_patients</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sample_data_strat_cont</span><span class="op">$</span><span class="va">trt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="va">n_patients</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sample_data_strat_cont</span><span class="op">$</span><span class="va">baseline_sbp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_patients</span>, mean <span class="op">=</span> <span class="fl">145</span>, sd <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">sample_data_strat_cont</span><span class="op">$</span><span class="va">age_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Under60"</span>, <span class="st">"Over60"</span><span class="op">)</span>, <span class="va">n_patients</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">noise</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_patients</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="va">sigma_by_site</span><span class="op">[</span><span class="va">sample_data_strat_cont</span><span class="op">$</span><span class="va">clinic_site</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">sample_data_strat_cont</span><span class="op">$</span><span class="va">sbp_change</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">5</span> <span class="op">-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">sample_data_strat_cont</span><span class="op">$</span><span class="va">trt</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">8</span> <span class="op">-</span></span>
<span>                                     <span class="fl">0.2</span> <span class="op">*</span> <span class="op">(</span><span class="va">sample_data_strat_cont</span><span class="op">$</span><span class="va">baseline_sbp</span> <span class="op">-</span> <span class="fl">145</span><span class="op">)</span> <span class="op">+</span></span>
<span>                                     <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">sample_data_strat_cont</span><span class="op">$</span><span class="va">trt</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">sample_data_strat_cont</span><span class="op">$</span><span class="va">age_group</span> <span class="op">==</span> <span class="st">"Over60"</span>, <span class="op">-</span><span class="fl">5</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>                                     <span class="va">noise</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model Fitting with Stratified Sigma</span></span>
<span><span class="va">fit_continuous_stratified</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_brms_analysis.html">run_brms_analysis</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">sample_data_strat_cont</span>,</span>
<span>  response_formula_str <span class="op">=</span> <span class="st">"sbp_change ~ trt"</span>,</span>
<span>  response_type <span class="op">=</span> <span class="st">"continuous"</span>,</span>
<span>  unshrunk_prognostic_formula_str <span class="op">=</span> <span class="st">"~ baseline_sbp"</span>,</span>
<span>  shrunk_predictive_formula_str <span class="op">=</span> <span class="st">"~ age_group:trt"</span>,</span>
<span>  stratification_formula_str <span class="op">=</span> <span class="st">"~ clinic_site"</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">1</span>, iter <span class="op">=</span> <span class="fl">200</span>, warmup <span class="op">=</span> <span class="fl">100</span>, cores <span class="op">=</span> <span class="fl">1</span>, refresh <span class="op">=</span> <span class="fl">0</span>, backend <span class="op">=</span> <span class="st">"cmdstanr"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Step 1: Preparing formula and data...</span></span>
<span><span class="co">#&gt; Applying stratification: estimating sigma by 'clinic_site'.</span></span>
<span><span class="co">#&gt; Treatment 'trt' added to unshrunk prognostic terms by default.</span></span>
<span><span class="co">#&gt; Auto-adding missing prognostic effect for interaction: age_group</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Step 2: Fitting the brms model...</span></span>
<span><span class="co">#&gt; Using default priors for unspecified effects:</span></span>
<span><span class="co">#&gt;   - unshrunk prognostic (b): normal(0, 5)</span></span>
<span><span class="co">#&gt;   - prognostic intercept: normal(0, 5)</span></span>
<span><span class="co">#&gt;   - shrunk predictive (b): horseshoe(1)</span></span>
<span><span class="co">#&gt; Fitting brms model...</span></span>
<span><span class="co">#&gt; Start sampling</span></span>
<span><span class="co">#&gt; Running MCMC with 1 chain...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 WARNING: There aren't enough warmup iterations to fit the </span></span>
<span><span class="co">#&gt; Chain 1          three stages of adaptation as currently configured. </span></span>
<span><span class="co">#&gt; Chain 1          Reducing each adaptation stage to 15%/75%/10% of </span></span>
<span><span class="co">#&gt; Chain 1          the given number of warmup iterations: </span></span>
<span><span class="co">#&gt; Chain 1            init_buffer = 15 </span></span>
<span><span class="co">#&gt; Chain 1            adapt_window = 75 </span></span>
<span><span class="co">#&gt; Chain 1            term_buffer = 10 </span></span>
<span><span class="co">#&gt; Chain 1 finished in 2.8 seconds.</span></span>
<span><span class="co">#&gt; Warning: 75 of 100 (75.0%) transitions hit the maximum treedepth limit of 10.</span></span>
<span><span class="co">#&gt; See https://mc-stan.org/misc/warnings for details.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Analysis complete.</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">strat_continuous_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summary_subgroup_effects.html">summary_subgroup_effects</a></span><span class="op">(</span></span>
<span>  brms_fit <span class="op">=</span> <span class="va">fit_continuous_stratified</span>,</span>
<span>  original_data <span class="op">=</span> <span class="va">sample_data_strat_cont</span>,</span>
<span>  trt_var <span class="op">=</span> <span class="st">"trt"</span>,</span>
<span>  response_type <span class="op">=</span> <span class="st">"continuous"</span> <span class="co"># Auto-detects age_group interaction</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; --- Calculating specific subgroup effects... ---</span></span>
<span><span class="co">#&gt; Step 1: Creating counterfactual datasets...</span></span>
<span><span class="co">#&gt; `subgroup_vars` set to 'auto'. Detecting from model data...</span></span>
<span><span class="co">#&gt; ...detected subgroup variable(s): age_group</span></span>
<span><span class="co">#&gt; Step 2: Generating posterior predictions...</span></span>
<span><span class="co">#&gt; ... (predicting expected outcomes)...</span></span>
<span><span class="co">#&gt; Step 3: Calculating marginal effects...</span></span>
<span><span class="co">#&gt; ... processing age_group</span></span>
<span><span class="co">#&gt; Done.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">strat_continuous_summary</span><span class="op">$</span><span class="va">estimates</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">#&gt;   Subgroup           Median CI_Lower CI_Upper</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> age_group: Over60  -<span style="color: #BB0000;">11.2</span>     -<span style="color: #BB0000;">14.5</span>    -<span style="color: #BB0000;">7.69</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> age_group: Under60  -<span style="color: #BB0000;">8.31</span>    -<span style="color: #BB0000;">11.9</span>    -<span style="color: #BB0000;">4.49</span></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">strat_continuous_summary</span>, title <span class="op">=</span> <span class="st">"Stratified Continuous: Subgroup Effects"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Preparing data for plotting...</span></span>
<span><span class="co">#&gt; Generating plot...</span></span>
<span><span class="co">#&gt; Done.</span></span></code></pre></div>
<p><img src="Advanced_Functionalities_files/figure-html/unnamed-chunk-10-1.png"><!-- --></p>
</div>
<div class="section level3" number="2.4">
<h3 id="example-6-stratified-survival-model">
<span class="header-section-number">2.4</span> Example 6: Stratified Survival Model<a class="anchor" aria-label="anchor" href="#example-6-stratified-survival-model"></a>
</h3>
<p><em>Scenario</em>: We model a time-to-event outcome where the <strong>baseline hazard</strong> <span class="math inline">\(h_0(t)\)</span> differs by <span class="math inline">\(\text{country}\)</span>. This is particularly important for multi-regional trials where regional differences in standard of care affect baseline risk.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">n_patients</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">lambda_by_country</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>US <span class="op">=</span> <span class="fl">0.01</span>, EU <span class="op">=</span> <span class="fl">0.03</span><span class="op">)</span></span>
<span><span class="va">surv_data_strat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_patients</span>,</span>
<span>    country <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"US"</span>, <span class="st">"EU"</span><span class="op">)</span>, <span class="va">n_patients</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="va">n_patients</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_patients</span>, <span class="fl">65</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>    biomarker <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Low"</span>, <span class="st">"High"</span><span class="op">)</span>, <span class="va">n_patients</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">lp</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">surv_data_strat</span><span class="op">$</span><span class="va">trt</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">-</span><span class="fl">0.6</span> <span class="op">+</span> <span class="op">(</span><span class="va">surv_data_strat</span><span class="op">$</span><span class="va">age</span> <span class="op">-</span> <span class="fl">65</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.03</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">surv_data_strat</span><span class="op">$</span><span class="va">trt</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">surv_data_strat</span><span class="op">$</span><span class="va">biomarker</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">-</span><span class="fl">0.5</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_patients</span><span class="op">)</span></span>
<span><span class="va">lambda_vec</span> <span class="op">&lt;-</span> <span class="va">lambda_by_country</span><span class="op">[</span><span class="va">surv_data_strat</span><span class="op">$</span><span class="va">country</span><span class="op">]</span></span>
<span><span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fl">1.5</span> <span class="co"># Weibull shape parameter</span></span>
<span><span class="va">true_event_time</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">lambda_vec</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">lp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">gamma</span><span class="op">)</span></span>
<span><span class="va">censoring_time</span> <span class="op">&lt;-</span> <span class="fl">60</span> <span class="co"># Administrative censoring time</span></span>
<span><span class="va">surv_data_strat</span><span class="op">$</span><span class="va">event_status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">true_event_time</span> <span class="op">&lt;=</span> <span class="va">censoring_time</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">surv_data_strat</span><span class="op">$</span><span class="va">event_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">true_event_time</span>, <span class="va">censoring_time</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model Fitting with Stratified Baseline Hazard</span></span>
<span><span class="va">fit_surv_stratified</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_brms_analysis.html">run_brms_analysis</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">surv_data_strat</span>,</span>
<span>  response_formula_str <span class="op">=</span> <span class="st">"Surv(event_time, event_status) ~ trt"</span>,</span>
<span>  response_type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>  unshrunk_prognostic_formula_str <span class="op">=</span> <span class="st">"~ age"</span>,</span>
<span>  shrunk_predictive_formula_str <span class="op">=</span> <span class="st">"~ biomarker:trt"</span>,</span>
<span>  stratification_formula_str <span class="op">=</span> <span class="st">"~ country"</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">1</span>, iter <span class="op">=</span> <span class="fl">200</span>, warmup <span class="op">=</span> <span class="fl">100</span>, cores <span class="op">=</span> <span class="fl">1</span>, refresh <span class="op">=</span> <span class="fl">0</span>, backend <span class="op">=</span> <span class="st">"cmdstanr"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Step 1: Preparing formula and data...</span></span>
<span><span class="co">#&gt; Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz().</span></span>
<span><span class="co">#&gt; Applying stratification: estimating separate baseline hazards by 'country'.</span></span>
<span><span class="co">#&gt; Treatment 'trt' added to unshrunk prognostic terms by default.</span></span>
<span><span class="co">#&gt; Auto-adding missing prognostic effect for interaction: biomarker</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Step 2: Fitting the brms model...</span></span>
<span><span class="co">#&gt; Using default priors for unspecified effects:</span></span>
<span><span class="co">#&gt;   - unshrunk prognostic (b): normal(0, 5)</span></span>
<span><span class="co">#&gt;   - shrunk predictive (b): horseshoe(1)</span></span>
<span><span class="co">#&gt; Fitting brms model...</span></span>
<span><span class="co">#&gt; Start sampling</span></span>
<span><span class="co">#&gt; Running MCMC with 1 chain...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Chain 1 WARNING: There aren't enough warmup iterations to fit the </span></span>
<span><span class="co">#&gt; Chain 1          three stages of adaptation as currently configured. </span></span>
<span><span class="co">#&gt; Chain 1          Reducing each adaptation stage to 15%/75%/10% of </span></span>
<span><span class="co">#&gt; Chain 1          the given number of warmup iterations: </span></span>
<span><span class="co">#&gt; Chain 1            init_buffer = 15 </span></span>
<span><span class="co">#&gt; Chain 1            adapt_window = 75 </span></span>
<span><span class="co">#&gt; Chain 1            term_buffer = 10 </span></span>
<span><span class="co">#&gt; Chain 1 finished in 7.6 seconds.</span></span>
<span><span class="co">#&gt; Warning: 100 of 100 (100.0%) transitions hit the maximum treedepth limit of 10.</span></span>
<span><span class="co">#&gt; See https://mc-stan.org/misc/warnings for details.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Analysis complete.</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">strat_surv_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summary_subgroup_effects.html">summary_subgroup_effects</a></span><span class="op">(</span></span>
<span>  brms_fit <span class="op">=</span> <span class="va">fit_surv_stratified</span>,</span>
<span>  original_data <span class="op">=</span> <span class="va">surv_data_strat</span>,</span>
<span>  trt_var <span class="op">=</span> <span class="st">"trt"</span>,</span>
<span>  response_type <span class="op">=</span> <span class="st">"survival"</span> <span class="co"># Auto-detects biomarker interaction</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; --- Calculating specific subgroup effects... ---</span></span>
<span><span class="co">#&gt; Step 1: Creating counterfactual datasets...</span></span>
<span><span class="co">#&gt; `subgroup_vars` set to 'auto'. Detecting from model data...</span></span>
<span><span class="co">#&gt; ...detected subgroup variable(s): biomarker</span></span>
<span><span class="co">#&gt; Step 2: Generating posterior predictions...</span></span>
<span><span class="co">#&gt; ... (reconstructing baseline hazard and obtaining linear predictors)...</span></span>
<span><span class="co">#&gt; Warning: Dropping 'draws_df' class as required metadata was removed.</span></span>
<span><span class="co">#&gt; Warning: Dropping 'draws_df' class as required metadata was removed.</span></span>
<span><span class="co">#&gt; Step 3: Calculating marginal effects...</span></span>
<span><span class="co">#&gt; ... processing biomarker</span></span>
<span><span class="co">#&gt; Done.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">strat_surv_summary</span><span class="op">$</span><span class="va">estimates</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">#&gt;   Subgroup        Median CI_Lower CI_Upper</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> biomarker: High  0.530    0.377    0.753</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> biomarker: Low   0.398    0.267    0.521</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">strat_surv_summary</span>, title <span class="op">=</span> <span class="st">"Stratified Survival: Subgroup Effects (AHR)"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Preparing data for plotting...</span></span>
<span><span class="co">#&gt; Generating plot...</span></span>
<span><span class="co">#&gt; Done.</span></span></code></pre></div>
<p><img src="Advanced_Functionalities_files/figure-html/ex6-summary-plot-1.png"><!-- --></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Miriam Pedrera Gomez, Isaac Gravestock, Marcel Wolbers.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
