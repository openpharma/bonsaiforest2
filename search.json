[{"path":"https://openpharma.github.io/bonsaiforest2/LICENSE.html","id":null,"dir":"","previous_headings":"","what":"MIT License","title":"MIT License","text":"Copyright (c) 2025 bonsaiforest2 authors Permission hereby granted, free charge, person obtaining copy software associated documentation files (“Software”), deal Software without restriction, including without limitation rights use, copy, modify, merge, publish, distribute, sublicense, /sell copies Software, permit persons Software furnished , subject following conditions: copyright notice permission notice shall included copies substantial portions Software. SOFTWARE PROVIDED “”, WITHOUT WARRANTY KIND, EXPRESS IMPLIED, INCLUDING LIMITED WARRANTIES MERCHANTABILITY, FITNESS PARTICULAR PURPOSE NONINFRINGEMENT. EVENT SHALL AUTHORS COPYRIGHT HOLDERS LIABLE CLAIM, DAMAGES LIABILITY, WHETHER ACTION CONTRACT, TORT OTHERWISE, ARISING , CONNECTION SOFTWARE USE DEALINGS SOFTWARE.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"handling-exposure-in-count-outcomes-with-offsets","dir":"Articles","previous_headings":"","what":"Handling Exposure in Count Outcomes with Offsets","title":"Advanced Functionalities","text":"count data (like disease exacerbations event rates), observed count often depends exposure time follow-time. Using offset variable standard statistical method properly account time variation modeling event rate (count per unit time) instead raw count. bonsaiforest2, can include offset directly response_formula using standard brms syntax: y + offset(log_exposure_time) ~ trt.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-1-count-outcome-with-offset-disease-exacerbations","dir":"Articles","previous_headings":"1 Handling Exposure in Count Outcomes with Offsets","what":"Example 1: Count Outcome with Offset (Disease Exacerbations)","title":"Advanced Functionalities","text":"scenario models exacerbation counts using Negative Binomial distribution explicitly accounts patient’s exposure time. Scenario: Modeling count outcomes exposure-time adjustment. Adjust baseline (unshrunk prognostic effect) multiple exploratory biomarkers (shrunk prognostic effects). Overall treatment effect rate scale.","code":"# Data Simulation  set.seed(789) library(bonsaiforest2) set.seed(789) n <- 200  # Create biomarker data with simple naming biomarker_data <- as.data.frame(matrix(rnorm(n * 8), ncol = 8)) names(biomarker_data) <- paste0(\"B\", 1:8)  # Generate count data with treatment effect heterogeneity count_data <- data.frame(   y = rnbinom(n, size = 1.5, mu = 3),   trt = rep(0:1, length.out = n),   baseline = rnorm(n, 10, 2),   log_exposure_time = log(runif(n, 0.5, 1.5)) )  # Add biomarkers and account for heterogeneous treatment effects count_data <- cbind(count_data, biomarker_data) count_data$y <- rnbinom(n, size = 1.5, mu = exp(0.5 + 0.1 * count_data$baseline +                          count_data$trt * (0.3 + 0.2 * (count_data$B1 > 0))))  # Create formula string for all biomarkers shrunk_prog_str <- paste(\"~ 0 +\", paste(names(biomarker_data), collapse = \" + \")) # Model Fitting with Offset count_model_fit <- run_brms_analysis(   data = count_data,   # Include offset(log_exposure_time) directly in the response formula   response_formula = y + offset(log_exposure_time) ~ trt,   response_type = \"count\",   unshrunk_terms_formula = ~ baseline,   shrunk_prognostic_formula = as.formula(shrunk_prog_str),   intercept_prior = \"normal(0, 5)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_prognostic_prior = \"horseshoe(scale_global = 1)\",   shrunk_predictive_prior = \"horseshoe(scale_global = 1)\",   chains = 2, iter = 1000, warmup = 500, cores = 2, refresh = 0, backend = \"cmdstanr\" ) #> Step 1: Preparing formula and data... #>  #> Step 2: Fitting the brms model... #> Fitting brms model... #> Start sampling #> Running MCMC with 2 parallel chains... #>  #> Chain 2 finished in 2.8 seconds. #> Chain 1 finished in 3.1 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 2.9 seconds. #> Total execution time: 3.2 seconds. #> Warning: 3 of 1000 (0.0%) transitions ended with a divergence. #> See https://mc-stan.org/misc/warnings for details. #> Loading required namespace: rstan #>  #> Analysis complete."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"customizing-prior-distributions","dir":"Articles","previous_headings":"","what":"Customizing Prior Distributions","title":"Advanced Functionalities","text":"choice prior central Bayesian shrinkage. bonsaiforest2 provides sensible defaults, allows full customization using dedicated prior arguments: intercept_prior, unshrunk_prior, shrunk_prognostic_prior, shrunk_predictive_prior.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"prior-specification-mechanics","dir":"Articles","previous_headings":"2 Customizing Prior Distributions","what":"Prior Specification Mechanics","title":"Advanced Functionalities","text":"Priors specified using separate parameters component.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"practical-examples-of-prior-setting","dir":"Articles","previous_headings":"2 Customizing Prior Distributions","what":"Practical Examples of Prior Setting","title":"Advanced Functionalities","text":"following examples demonstrate customize priors using new API. use synthetic survival dataset show different prior specification strategies, simple defaults advanced hierarchical structures.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"dataset-generation-and-model-preparation","dir":"Articles","previous_headings":"2 Customizing Prior Distributions > 2.2 Practical Examples of Prior Setting","what":"Dataset Generation and Model Preparation","title":"Advanced Functionalities","text":"dataset mimics clinical trial treatment effects vary subgroups.","code":"# Load library library(bonsaiforest2)  # 1. Create Sample Data with treatment heterogeneity set.seed(123) n <- 200  sim_data <- data.frame(   time = round(runif(n, 1, 100)),   status = sample(0:1, n, replace = TRUE),   trt = rep(0:1, length.out = n),   age = rnorm(n, 50, 10),   X1 = factor(sample(c(\"A\", \"B\"), n, replace = TRUE)),   X2 = factor(sample(c(\"A\", \"B\", \"C\"), n, replace = TRUE)) )  # Ensure variables are factors sim_data$trt <- factor(sim_data$trt, levels = c(0, 1)) sim_data$X1 <- as.factor(sim_data$X1) sim_data$X2 <- as.factor(sim_data$X2)  # 2. Prepare the model formula prepared_model <- prepare_formula_model(   data = sim_data,   response_formula = Surv(time, status) ~ trt,   shrunk_predictive_formula = ~ 0 + trt:X1,   unshrunk_terms_formula = ~ age,   response_type = \"survival\" ) #> Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz(). #> Note: Marginality principle not followed - interaction term 'X1' is used without its main effect. Consider adding 'X1' to prognostic terms for proper model hierarchy."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-2-using-default-priors","dir":"Articles","previous_headings":"2 Customizing Prior Distributions > 2.2 Practical Examples of Prior Setting","what":"Example 2: Using Default Priors","title":"Advanced Functionalities","text":"simplest approach: use package defaults adapt outcome type (horseshoe(1) shrunk effects, brms defaults others).","code":"fit_ex3 <- fit_brms_model(   prepared_model = prepared_model,   intercept_prior = \"normal(0, 5)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_prognostic_prior = \"horseshoe(scale_global = 1)\",   shrunk_predictive_prior = \"horseshoe(scale_global = 1)\",   chains = 2, iter = 1000, warmup = 500, cores = 2, refresh = 0, backend = \"cmdstanr\" ) #> Fitting brms model... #> Start sampling #> Running MCMC with 2 parallel chains... #>  #> Chain 2 finished in 2.2 seconds. #> Chain 1 finished in 2.3 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 2.3 seconds. #> Total execution time: 2.4 seconds.  # View the priors that were automatically set cat(\"\\n=== Priors Used ===\\n\") #>  #> === Priors Used === print(fit_ex3[[\"prior\"]]) #>                        prior class    coef group resp dpar              nlpar #>  horseshoe(scale_global = 1)     b                               shpredeffect #>  horseshoe(scale_global = 1)     b trt:X1A                       shpredeffect #>  horseshoe(scale_global = 1)     b trt:X1B                       shpredeffect #>               normal(0, 2.5)     b                         unshrunktermeffect #>               normal(0, 2.5)     b     age                 unshrunktermeffect #>               normal(0, 2.5)     b     trt                 unshrunktermeffect #>                 dirichlet(1) sbhaz                                            #>  lb ub tag       source #>                    user #>            (vectorized) #>            (vectorized) #>                    user #>            (vectorized) #>            (vectorized) #>                 default"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-3-using-the-r2d2-shrinkage-prior","dir":"Articles","previous_headings":"2 Customizing Prior Distributions > 2.2 Practical Examples of Prior Setting","what":"Example 3: Using the R2D2 Shrinkage Prior","title":"Advanced Functionalities","text":"R2D2 prior useful want control global shrinkage via coefficient determination (\\(R^2\\)) rather scale parameter. often interpretable stakeholders.","code":"# Use a custom R2D2 prior for the shrunk predictive effects (interactions)  fit_ex4 <- fit_brms_model(   prepared_model = prepared_model,   intercept_prior = \"normal(0, 5)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_prognostic_prior = \"horseshoe(scale_global = 1)\",   shrunk_predictive_prior = \"R2D2(mean_R2 = 0.5, prec_R2 = 1)\",   chains = 2, iter = 1000, warmup = 500, cores = 2, refresh = 0, backend = \"cmdstanr\" ) #> Fitting brms model... #> Start sampling #> Running MCMC with 2 parallel chains... #>  #> Chain 2 finished in 1.7 seconds. #> Chain 1 finished in 2.1 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 1.9 seconds. #> Total execution time: 2.2 seconds. #> Warning: 19 of 1000 (2.0%) transitions ended with a divergence. #> See https://mc-stan.org/misc/warnings for details.  cat(\"\\n=== Priors Used ===\\n\") #>  #> === Priors Used === print(fit_ex4[[\"prior\"]]) #>                             prior class    coef group resp dpar #>  R2D2(mean_R2 = 0.5, prec_R2 = 1)     b                         #>  R2D2(mean_R2 = 0.5, prec_R2 = 1)     b trt:X1A                 #>  R2D2(mean_R2 = 0.5, prec_R2 = 1)     b trt:X1B                 #>                    normal(0, 2.5)     b                         #>                    normal(0, 2.5)     b     age                 #>                    normal(0, 2.5)     b     trt                 #>                      dirichlet(1) sbhaz                         #>               nlpar lb ub tag       source #>        shpredeffect                   user #>        shpredeffect           (vectorized) #>        shpredeffect           (vectorized) #>  unshrunktermeffect                   user #>  unshrunktermeffect           (vectorized) #>  unshrunktermeffect           (vectorized) #>                                    default"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-4-custom-hierarchical-prior-advanced","dir":"Articles","previous_headings":"2 Customizing Prior Distributions > 2.2 Practical Examples of Prior Setting","what":"Example 4: Custom Hierarchical Prior (Advanced)","title":"Advanced Functionalities","text":"example demonstrates injecting raw Stan code using stanvars. necessary want implement hierarchical structure brms support natively, estimating shared variance parameter across coefficients.","code":"# 1. Define new hyperparameters in Stan stanvars_full_hierarchical <- brms::stanvar(   scode = \"  real mu_pred;\\n  real<lower=0> sigma_pred;\\n\",   block = \"parameters\" ) +   # Add priors for these parameters   brms::stanvar(     scode = \"  // Priors on the hierarchical parameters\\n  target += normal_lpdf(mu_pred | 0, 4); \\n  target += normal_lpdf(sigma_pred | 0, 1) - normal_lccdf(0 | 0, 1); \\n\",     block = \"model\"   )  # 2. Create prior that references the Stan variables prior_full_hierarchical <- brms::set_prior(\"normal(mu_pred, sigma_pred)\")  # 3. Pass both to fit_brms_model fit_ex5 <- fit_brms_model(   prepared_model = prepared_model,   intercept_prior = \"normal(0, 5)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_prognostic_prior = \"horseshoe(scale_global = 1)\",   shrunk_predictive_prior = prior_full_hierarchical,   stanvars = stanvars_full_hierarchical,   chains = 2, iter = 1000, warmup = 500, cores = 2, refresh = 0, backend = \"cmdstanr\" ) #> Fitting brms model... #> Start sampling #> Running MCMC with 2 parallel chains... #>  #> Chain 1 finished in 2.9 seconds. #> Chain 2 finished in 3.1 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 3.0 seconds. #> Total execution time: 3.2 seconds. #> Warning: 59 of 1000 (6.0%) transitions ended with a divergence. #> See https://mc-stan.org/misc/warnings for details.  # View the used priors cat(\"\\n=== Priors Used ===\\n\") #>  #> === Priors Used === print(fit_ex5[[\"prior\"]]) #>                        prior class    coef group resp dpar              nlpar #>  normal(mu_pred, sigma_pred)     b                               shpredeffect #>  normal(mu_pred, sigma_pred)     b trt:X1A                       shpredeffect #>  normal(mu_pred, sigma_pred)     b trt:X1B                       shpredeffect #>               normal(0, 2.5)     b                         unshrunktermeffect #>               normal(0, 2.5)     b     age                 unshrunktermeffect #>               normal(0, 2.5)     b     trt                 unshrunktermeffect #>                 dirichlet(1) sbhaz                                            #>  lb ub tag       source #>                    user #>            (vectorized) #>            (vectorized) #>                    user #>            (vectorized) #>            (vectorized) #>                 default print(fit_ex5[[\"stanvars\"]]) #> [[1]] #> [[1]]$name #> [1] \"\" #>  #> [[1]]$sdata #> NULL #>  #> [[1]]$scode #> [1] \"  real mu_pred;\\n  real<lower=0> sigma_pred;\\n\" #>  #> [[1]]$block #> [1] \"parameters\" #>  #> [[1]]$position #> [1] \"start\" #>  #> [[1]]$pll_args #> character(0) #>  #>  #> [[2]] #> [[2]]$name #> [1] \"\" #>  #> [[2]]$sdata #> NULL #>  #> [[2]]$scode #> [1] \"  // Priors on the hierarchical parameters\\n  target += normal_lpdf(mu_pred | 0, 4); \\n  target += normal_lpdf(sigma_pred | 0, 1) - normal_lccdf(0 | 0, 1); \\n\" #>  #> [[2]]$block #> [1] \"model\" #>  #> [[2]]$position #> [1] \"start\" #>  #> [[2]]$pll_args #> character(0) #>  #>  #> attr(,\"class\") #> [1] \"stanvars\""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-5-coefficient-specific-priors","dir":"Articles","previous_headings":"2 Customizing Prior Distributions > 2.2 Practical Examples of Prior Setting","what":"Example 5: Coefficient-Specific Priors","title":"Advanced Functionalities","text":"can set different priors specific coefficients passing brmsprior object (created c()). Scenario: Set general prior unshrunk terms, use tighter prior specifically treatment-biomarker interactions. Key Technique: Use prepare_formula_model() discover exact coefficient names appear model.","code":"# 1. Run prepare_formula_model prepared_model <- prepare_formula_model(   data = sim_data,   response_formula = Surv(time, status) ~ trt,   shrunk_predictive_formula = ~ 0 + trt:X1,   unshrunk_terms_formula = ~ age + trt*X2,   response_type = \"survival\" ) #> Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz(). #> Note: Marginality principle not followed - interaction term 'X1' is used without its main effect. Consider adding 'X1' to prognostic terms for proper model hierarchy.  # 2. Inspect the Results # A. The generated brms formula object print(prepared_model$formula) #> time | cens(1 - status) + bhaz(Boundary.knots = c(0.02, 99.98), knots = c(27, 51, 73), intercept = FALSE) ~ unshrunktermeffect + shpredeffect  #> unshrunktermeffect ~ 0 + age + trt * X2 + trt #> shpredeffect ~ 0 + trt:X1  # B. The processed terms print(prepared_model$stan_variable_names$X_unshrunktermeffect) #> [1] \"age\"     \"trt\"     \"X2A\"     \"X2B\"     \"X2C\"     \"trt:X2B\" \"trt:X2C\"  cat(\"=== Prior Strategy ===\\n\") #> === Prior Strategy === cat(\"General unshrunk prior: normal(0, 5)\\n\") #> General unshrunk prior: normal(0, 5) cat(\"Specific for trt:X2 interactions: normal(0, 1)\\n\\n\") #> Specific for trt:X2 interactions: normal(0, 1)  # Create combined prior object # IMPORTANT: Use EXACT coefficient names from the prepared data # These names appear after contrast encoding in prepare_formula_model unshrunk_priors_combined <- c(   brms::set_prior(\"normal(0, 5)\", class = \"b\"),  # General   brms::set_prior(\"normal(0, 1)\", class = \"b\", coef = \"trt:X2B\"),   brms::set_prior(\"normal(0, 1)\", class = \"b\", coef = \"trt:X2C\") )  # Fit the model fit_specific <- fit_brms_model(   prepared_model = prepared_model,   intercept_prior = \"normal(0, 5)\",   unshrunk_prior = unshrunk_priors_combined,  # Pass the combined object   shrunk_prognostic_prior = \"horseshoe(scale_global = 1)\",   shrunk_predictive_prior = \"horseshoe(scale_global = 1)\",   chains = 2, iter = 1000, warmup = 500, cores = 2, refresh = 0, backend = \"cmdstanr\" ) #> Fitting brms model... #> Start sampling #> Running MCMC with 2 parallel chains... #>  #> Chain 1 finished in 1.5 seconds. #> Chain 2 finished in 2.7 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 2.1 seconds. #> Total execution time: 2.8 seconds.  # View the used priors cat(\"\\n=== Priors Used ===\\n\") #>  #> === Priors Used === print(fit_specific[[\"prior\"]]) #>                        prior class    coef group resp dpar              nlpar #>  horseshoe(scale_global = 1)     b                               shpredeffect #>  horseshoe(scale_global = 1)     b trt:X1A                       shpredeffect #>  horseshoe(scale_global = 1)     b trt:X1B                       shpredeffect #>                 normal(0, 5)     b                         unshrunktermeffect #>                 normal(0, 5)     b     age                 unshrunktermeffect #>                 normal(0, 5)     b     trt                 unshrunktermeffect #>                 normal(0, 1)     b trt:X2B                 unshrunktermeffect #>                 normal(0, 1)     b trt:X2C                 unshrunktermeffect #>                 normal(0, 5)     b     X2A                 unshrunktermeffect #>                 normal(0, 5)     b     X2B                 unshrunktermeffect #>                 normal(0, 5)     b     X2C                 unshrunktermeffect #>                 dirichlet(1) sbhaz                                            #>  lb ub tag       source #>                    user #>            (vectorized) #>            (vectorized) #>                    user #>            (vectorized) #>            (vectorized) #>                    user #>                    user #>            (vectorized) #>            (vectorized) #>            (vectorized) #>                 default"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-6-hierarchical-priors-with-shared-variance-stanvars","dir":"Articles","previous_headings":"2 Customizing Prior Distributions > 2.2 Practical Examples of Prior Setting","what":"Example 6: Hierarchical Priors with Shared Variance (stanvars)","title":"Advanced Functionalities","text":"Create correlated priors sharing common variance parameter estimated data. Use case: believe treatment effects across subgroups exchangeable, can pool information giving shared variance.","code":"cat(\"\\n=== Hierarchical Prior Structure ===\\n\") #>  #> === Hierarchical Prior Structure === cat(\"Instead of independent priors per coefficient, we pool information through a shared scale:\\n\") #> Instead of independent priors per coefficient, we pool information through a shared scale: cat(\"  tau ~ half-normal(0, 1)  [shared scale parameter]\\n\") #>   tau ~ half-normal(0, 1)  [shared scale parameter] cat(\"  beta_i ~ N(0, tau) for each coefficient i\\n\") #>   beta_i ~ N(0, tau) for each coefficient i cat(\"This creates exchangeability: coefficients are ~similar but with adaptive variation.\\n\\n\") #> This creates exchangeability: coefficients are ~similar but with adaptive variation.  # Step 1: Declare tau as a parameter to be estimated tau_parameter <- brms::stanvar(   scode = \"  real<lower=0> biomarker_tau;  // Shared scale parameter\\n\",   block = \"parameters\" )  # Step 2: Add prior for tau (using normal truncated to positive values with constraint) tau_prior <- brms::stanvar(   scode = \"  biomarker_tau ~ normal(0, 1);  // Hyperprior on the scale\\n\",   block = \"model\" )  # Combine stanvars hierarchical_stanvars <- tau_parameter + tau_prior  # Step 3: Create priors referencing the shared variance parameter # Note: We identified these coefficient names using prepare_formula_model above unshrunk_priors_hier <- c(   brms::set_prior(\"normal(0, 5)\", class = \"b\"),  # General   brms::set_prior(\"normal(0, biomarker_tau)\", class = \"b\", coef = \"trt:X2B\"),   brms::set_prior(\"normal(0, biomarker_tau)\", class = \"b\", coef = \"trt:X2C\") ) # Step 4: Fit the hierarchical model fit_hier <- fit_brms_model(   prepared_model = prepared_model,   intercept_prior = \"normal(0, 5)\",   unshrunk_prior = unshrunk_priors_hier,   shrunk_prognostic_prior = \"horseshoe(scale_global = 1)\",   shrunk_predictive_prior = \"horseshoe(scale_global = 1)\",   stanvars = hierarchical_stanvars,   chains = 2, iter = 1000, warmup = 500, cores = 2, refresh = 0, backend = \"cmdstanr\" )  # View the used priors cat(\"\\n=== Priors Used ===\\n\") print(fit_hier[[\"prior\"]]) print(fit_hier[[\"stanvars\"]])"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"advanced-model-parameterization","dir":"Articles","previous_headings":"","what":"Advanced Model Parameterization","title":"Advanced Functionalities","text":"section demonstrates advanced features controlling model represents subgroups.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-7-custom-contrast-encoding-for-shrunk-terms","dir":"Articles","previous_headings":"3 Advanced Model Parameterization","what":"Example 7: Custom Contrast Encoding for Shrunk Terms","title":"Advanced Functionalities","text":"default, bonsaiforest2 uses one-hot encoding (factor levels, reference category) shrunk interaction terms specified ~ 0 + ... syntax, enabling full hierarchical shrinkage levels. unshrunk terms, treatment contrasts (k-1 dummy variables reference level) used default. However, can manually set custom contrasts data using contrasts(), library preserve choice throughout analysis. Scenario: want use custom contrast coding subgroup variables, Helmert contrasts sum contrasts, instead default treatment contrasts. useful specific hypothesis structures comparing non-orthogonal effects. Key Technique: Set contrasts using contrasts() calling prepare_formula_model(). library preserve choice.","code":"# Create sample data with multiple subgroups set.seed(456) n <- 250 sample_data_contrast <- data.frame(   id = 1:n,   trt = rep(0:1, length.out = n),   y = rnorm(n, 50, 10),   baseline = rnorm(n, 65, 10),   X1 = factor(sample(c(\"A\", \"B\", \"C\"), n, replace = TRUE)) )  # Set Helmert contrasts for the X1 variable contrasts(sample_data_contrast$X1) <- contr.helmert(3) cat(\"Contrast matrix for X1:\\n\") #> Contrast matrix for X1: print(contrasts(sample_data_contrast$X1)) #>   [,1] [,2] #> A   -1   -1 #> B    1   -1 #> C    0    2  # Prepare model  prepared_custom_contrast <- prepare_formula_model(   data = sample_data_contrast,   response_formula = y ~ trt,   unshrunk_terms_formula = ~ baseline,   shrunk_predictive_formula = ~ 0 + trt:X1,    response_type = \"continuous\" ) #> Note: Marginality principle not followed - interaction term 'X1' is used without its main effect. Consider adding 'X1' to prognostic terms for proper model hierarchy.  # Observe costum contrast in the data str(prepared_custom_contrast$data) #> 'data.frame':    250 obs. of  5 variables: #>  $ id      : int  1 2 3 4 5 6 7 8 9 10 ... #>  $ trt     : int  0 1 0 1 0 1 0 1 0 1 ... #>  $ y       : num  36.6 56.2 58 36.1 42.9 ... #>  $ baseline: num  62.5 65.7 67.5 52.7 64.4 ... #>  $ X1      : Factor w/ 3 levels \"A\",\"B\",\"C\": 2 3 2 3 1 2 3 3 2 3 ... #>   ..- attr(*, \"contrasts\")= num [1:3, 1:2] -1 1 0 -1 -1 2 #>   .. ..- attr(*, \"dimnames\")=List of 2 #>   .. .. ..$ : chr [1:3] \"A\" \"B\" \"C\" #>   .. .. ..$ : NULL  # Fit the model fit_custom_contrast <- fit_brms_model(   prepared_model = prepared_custom_contrast,   intercept_prior = \"normal(0, 5)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_prognostic_prior = \"horseshoe(scale_global = 1)\",   shrunk_predictive_prior = \"horseshoe(scale_global = 1)\",   chains = 2, iter = 1000, warmup = 500, cores = 2, refresh = 0, backend = \"cmdstanr\" ) #> Fitting brms model... #> Start sampling #> Running MCMC with 2 parallel chains... #>  #> Chain 1 finished in 1.2 seconds. #> Chain 2 finished in 1.3 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 1.3 seconds. #> Total execution time: 1.4 seconds.  estimate_custom_contrast <- summary_subgroup_effects(fit_custom_contrast) #> Using trt_var from model attributes: trt #> Using response_type from model attributes: continuous #> --- Calculating specific subgroup effects... --- #> Using data from model attributes #> Step 1: Identifying subgroups and creating counterfactuals... #> `subgroup_vars` set to 'auto'. Detecting from model... #> Model data has 250 rows and 5 columns #> Column names: id, trt, y, baseline, X1 #> Treatment variable: 'trt' #> All coefficient names: #> unshrunktermeffect_Intercept #> unshrunktermeffect_baseline #> unshrunktermeffect_trt #> shpredeffect_trt:X1A #> shpredeffect_trt:X1B #> shpredeffect_trt:X1C #> Looking for treatment interactions with pattern: 'trt:' #> Found 3 treatment interaction coefficients #> Treatment interaction coefficients found: #> shpredeffect_trt:X1A #> shpredeffect_trt:X1B #> shpredeffect_trt:X1C #> Detected subgroup variable 'X1' from coefficient 'shpredeffect_trt:X1A' #> Detected subgroup variable 'X1' from coefficient 'shpredeffect_trt:X1B' #> Detected subgroup variable 'X1' from coefficient 'shpredeffect_trt:X1C' #> Checking for random effects parameters... #> Retrieved 14 total parameters from model #> Using regex pattern: '^r_(.+)__[^\\[]+\\[[^,]+,trt\\]' #> Found 0 matching random effect parameters #> No random effect parameters matching the pattern were found #> ...detected subgroup variable(s): X1 #> Step 2: Generating posterior predictions... #> ... detected Fixed Effects (Colon model). Predicting with re_formula = NA. #> ... (predicting expected outcomes)... #> Step 3: Calculating marginal effects... #> ... processing X1 #> Done.  print(estimate_custom_contrast) #> $estimates #> # A tibble: 3 × 4 #>   Subgroup Median CI_Lower CI_Upper #>   <chr>     <dbl>    <dbl>    <dbl> #> 1 X1: A      2.15   -0.778     4.74 #> 2 X1: B      2.35   -0.697     5.41 #> 3 X1: C      1.95   -0.948     4.67 #>  #> $response_type #> [1] \"continuous\" #>  #> $ci_level #> [1] 0.95 #>  #> $trt_var #> [1] \"trt\" #>  #> attr(,\"class\") #> [1] \"subgroup_summary\""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-8-prediction-on-new-data","dir":"Articles","previous_headings":"3 Advanced Model Parameterization","what":"Example 8: Prediction on New Data","title":"Advanced Functionalities","text":"fitting model, can use brms::predict() generate predictions new patients. Scenario: ’ve fitted treatment effect model want predict outcomes new patients different characteristics.","code":"# Use the fitted model from Example 7 # Generate new data for prediction set.seed(789) new_patients <- data.frame(   id = 1:20,   trt = rep(0:1, length.out = 20),   baseline = rnorm(20, 65, 10),   X1 = factor(rep(c(\"A\", \"B\", \"C\"), length.out = 20)) )  # IMPORTANT: Set the same contrasts as in Example 7 # The prediction data must use the same encoding as the training data contrasts(new_patients$X1) <- contr.helmert(3)  # Prepare new data prepared_custom_contrast <- prepare_formula_model(   data = new_patients,   response_formula = y ~ trt,   unshrunk_terms_formula = ~ baseline,   shrunk_predictive_formula = ~ 0 + trt:X1,    response_type = \"continuous\" ) #> Note: Marginality principle not followed - interaction term 'X1' is used without its main effect. Consider adding 'X1' to prognostic terms for proper model hierarchy. #> Warning: Could not extract Stan variable names. Error: The following variables can neither be found in 'data' nor in 'data2': #> 'y'  # Generate predictions using brms::predict # This returns posterior predictive samples predictions <- predict(fit_custom_contrast, newdata = prepared_custom_contrast$data, summary = TRUE)  head(predictions) #>      Estimate Est.Error     Q2.5    Q97.5 #> [1,] 50.21508  10.44761 30.06733 70.44563 #> [2,] 42.31451  10.07955 22.91911 62.45141 #> [3,] 48.14653  10.12869 28.95442 68.88111 #> [4,] 51.22246  10.65935 31.23163 71.00125 #> [5,] 47.47709  10.35556 26.90996 67.09338 #> [6,] 48.67175  10.19170 28.09372 68.26898"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"stratification-for-nuisance-parameters","dir":"Articles","previous_headings":"","what":"Stratification for Nuisance Parameters","title":"Advanced Functionalities","text":"many trials, parameters like observation error variance (\\(\\sigma^2\\) continuous outcomes) baseline hazard function (\\(h_0(t)\\) survival outcomes) known vary site, country, factors. Stratification models known heterogeneity fitting nuisance parameters separately level grouping variable. Use stratification_formula argument define grouping factor(s).","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-9-stratified-continuous-model","dir":"Articles","previous_headings":"4 Stratification for Nuisance Parameters","what":"Example 9: Stratified Continuous Model","title":"Advanced Functionalities","text":"Scenario: model outcomes observation error standard deviation \\(\\sigma\\) differs site. Stratification uses brms distributional formulas estimate separate residual variance parameters site, allowing heterogeneity measurement noise outcome variability across sites.","code":"set.seed(42) n <- 250 sigma_by_site <- c(A = 6, B = 12, C = 18) sample_data_strat_cont <- data.frame(     id = 1:n,     site = factor(sample(c(\"A\", \"B\", \"C\"), n, replace = TRUE)) ) sample_data_strat_cont$trt <- rep(0:1, length.out = n) sample_data_strat_cont$baseline <- rnorm(n, mean = 100, sd = 8) sample_data_strat_cont$X1 <- factor(sample(c(\"A\", \"B\"), n, replace = TRUE))  # Generate outcome with treatment heterogeneity and site-specific noise noise <- rnorm(n, mean = 0, sd = sigma_by_site[sample_data_strat_cont$site]) sample_data_strat_cont$y <- 50 +                              sample_data_strat_cont$trt * (-8 + 2 * (as.numeric(sample_data_strat_cont$X1) - 1)) +                             0.2 * (sample_data_strat_cont$baseline - 100) +                             noise # Model Fitting with Stratified Model  fit_continuous_stratified <- run_brms_analysis(   data = sample_data_strat_cont,   response_formula = y ~ trt,   response_type = \"continuous\",   unshrunk_terms_formula = ~ baseline,   shrunk_predictive_formula = ~ 0 + trt:X1,   stratification_formula = ~ site,   intercept_prior = \"normal(0, 5)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_prognostic_prior = \"horseshoe(scale_global = 1)\",   shrunk_predictive_prior = \"horseshoe(scale_global = 1)\",   chains = 2, iter = 1000, warmup = 500, cores = 2, refresh = 0, backend = \"cmdstanr\" ) #> Step 1: Preparing formula and data... #> Applying stratification: estimating sigma by 'site'. #> Note: Marginality principle not followed - interaction term 'X1' is used without its main effect. Consider adding 'X1' to prognostic terms for proper model hierarchy. #>  #> Step 2: Fitting the brms model... #> Fitting brms model... #> Start sampling #> Running MCMC with 2 parallel chains... #>  #> Chain 2 finished in 2.6 seconds. #> Chain 1 finished in 3.0 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 2.8 seconds. #> Total execution time: 3.1 seconds. #>  #> Analysis complete. strat_continuous_summary <- summary_subgroup_effects(   brms_fit = fit_continuous_stratified   # All parameters automatically extracted! ) #> Using trt_var from model attributes: trt #> Using response_type from model attributes: continuous #> --- Calculating specific subgroup effects... --- #> Using data from model attributes #> Step 1: Identifying subgroups and creating counterfactuals... #> `subgroup_vars` set to 'auto'. Detecting from model... #> Model data has 250 rows and 6 columns #> Column names: id, site, trt, baseline, X1, y #> Treatment variable: 'trt' #> All coefficient names: #> sigma_Intercept #> unshrunktermeffect_Intercept #> unshrunktermeffect_baseline #> unshrunktermeffect_trt #> sigma_siteB #> sigma_siteC #> shpredeffect_trt:X1A #> shpredeffect_trt:X1B #> Looking for treatment interactions with pattern: 'trt:' #> Found 2 treatment interaction coefficients #> Treatment interaction coefficients found: #> shpredeffect_trt:X1A #> shpredeffect_trt:X1B #> Detected subgroup variable 'X1' from coefficient 'shpredeffect_trt:X1A' #> Detected subgroup variable 'X1' from coefficient 'shpredeffect_trt:X1B' #> Checking for random effects parameters... #> Retrieved 15 total parameters from model #> Using regex pattern: '^r_(.+)__[^\\[]+\\[[^,]+,trt\\]' #> Found 0 matching random effect parameters #> No random effect parameters matching the pattern were found #> ...detected subgroup variable(s): X1 #> Step 2: Generating posterior predictions... #> ... detected Fixed Effects (Colon model). Predicting with re_formula = NA. #> ... (predicting expected outcomes)... #> Step 3: Calculating marginal effects... #> ... processing X1 #> Done.  print(strat_continuous_summary$estimates) #> # A tibble: 2 × 4 #>   Subgroup Median CI_Lower CI_Upper #>   <chr>     <dbl>    <dbl>    <dbl> #> 1 X1: A     -6.30    -8.75    -3.83 #> 2 X1: B     -4.87    -7.13    -2.54 plot(strat_continuous_summary, title = \"Stratified Continuous: Subgroup Effects\") #> Preparing data for plotting... #> Generating plot... #> Done."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-10-stratified-survival-model","dir":"Articles","previous_headings":"4 Stratification for Nuisance Parameters","what":"Example 10: Stratified Survival Model","title":"Advanced Functionalities","text":"Scenario: model time--event outcome stratified baseline hazard country using piecewise exponential model. Stratification via stratification_formula = ~ country allows baseline hazard differ country, accommodating regional differences baseline risk standard care.","code":"set.seed(123) n <- 250 lambda_by_country <- c(A = 0.01, B = 0.03) surv_data_strat <- data.frame(     id = 1:n,     country = factor(sample(c(\"A\", \"B\"), n, replace = TRUE)),     trt = rep(0:1, length.out = n),     age = rnorm(n, 65, 10),     X1 = factor(sample(c(\"A\", \"B\"), n, replace = TRUE)) )  # Linear predictor with treatment heterogeneity lp <- (as.numeric(surv_data_strat$trt) - 1) * -0.6 +        (surv_data_strat$age - 65) * 0.03 +       (as.numeric(surv_data_strat$trt) - 1) * (as.numeric(surv_data_strat$X1) - 1) * -0.5  # Generate event times u <- runif(n) lambda_vec <- lambda_by_country[surv_data_strat$country] gamma <- 1.5 # Weibull shape parameter true_event_time <- (-log(u) / (lambda_vec * exp(lp)))^(1/gamma) censoring_time <- 60 # Administrative censoring time surv_data_strat$event_status <- ifelse(true_event_time <= censoring_time, 1, 0) surv_data_strat$event_time <- pmin(true_event_time, censoring_time) # Model Fitting with Stratified Baseline Hazard fit_surv_stratified <- run_brms_analysis(   data = surv_data_strat,   response_formula = Surv(event_time, event_status) ~ trt,   response_type = \"survival\",   unshrunk_terms_formula = ~ age,   shrunk_predictive_formula = ~ 0 + trt:X1,   stratification_formula = ~ country,   intercept_prior = \"normal(0, 5)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_prognostic_prior = \"horseshoe(scale_global = 1)\",   shrunk_predictive_prior = \"horseshoe(scale_global = 1)\",   chains = 2, iter = 1000, warmup = 500, cores = 2, refresh = 0, backend = \"cmdstanr\" ) #> Step 1: Preparing formula and data... #> Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz(). #> Applying stratification: estimating separate baseline hazards by 'country'. #> Note: Marginality principle not followed - interaction term 'X1' is used without its main effect. Consider adding 'X1' to prognostic terms for proper model hierarchy. #>  #> Step 2: Fitting the brms model... #> Fitting brms model... #> Start sampling #> Running MCMC with 2 parallel chains... #>  #> Chain 1 finished in 5.8 seconds. #> Chain 2 finished in 6.6 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 6.2 seconds. #> Total execution time: 6.6 seconds. #> Warning: 12 of 1000 (1.0%) transitions ended with a divergence. #> See https://mc-stan.org/misc/warnings for details. #>  #> Analysis complete. strat_surv_summary <- summary_subgroup_effects(   brms_fit = fit_surv_stratified   # All parameters automatically extracted! ) #> Using trt_var from model attributes: trt #> Using response_type from model attributes: survival #> --- Calculating specific subgroup effects... --- #> Using data from model attributes #> Step 1: Identifying subgroups and creating counterfactuals... #> `subgroup_vars` set to 'auto'. Detecting from model... #> Model data has 250 rows and 7 columns #> Column names: id, country, trt, age, X1, event_status, event_time #> Treatment variable: 'trt' #> All coefficient names: #> unshrunktermeffect_age #> unshrunktermeffect_trt #> shpredeffect_trt:X1A #> shpredeffect_trt:X1B #> Looking for treatment interactions with pattern: 'trt:' #> Found 2 treatment interaction coefficients #> Treatment interaction coefficients found: #> shpredeffect_trt:X1A #> shpredeffect_trt:X1B #> Detected subgroup variable 'X1' from coefficient 'shpredeffect_trt:X1A' #> Detected subgroup variable 'X1' from coefficient 'shpredeffect_trt:X1B' #> Checking for random effects parameters... #> Retrieved 22 total parameters from model #> Using regex pattern: '^r_(.+)__[^\\[]+\\[[^,]+,trt\\]' #> Found 0 matching random effect parameters #> No random effect parameters matching the pattern were found #> ...detected subgroup variable(s): X1 #> Step 2: Generating posterior predictions... #> ... detected Fixed Effects (Colon model). Predicting with re_formula = NA. #> ... (reconstructing baseline hazard and getting linear predictors)... #> Warning: Dropping 'draws_df' class as required metadata was removed. #> Warning: Dropping 'draws_df' class as required metadata was removed. #> Step 3: Calculating marginal effects... #> ... processing X1 #> Done.  print(strat_surv_summary$estimates) #> # A tibble: 2 × 4 #>   Subgroup Median CI_Lower CI_Upper #>   <chr>     <dbl>    <dbl>    <dbl> #> 1 X1: A     0.467    0.359    0.586 #> 2 X1: B     0.498    0.383    0.642 plot(strat_surv_summary, title = \"Stratified Survival: Subgroup Effects (AHR)\") #> Preparing data for plotting... #> Generating plot... #> Done."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"summary","dir":"Articles","previous_headings":"","what":"Summary","title":"Advanced Functionalities","text":"vignette demonstrated advanced functionalities bonsaiforest2: Offset variables count outcomes varying exposure times Custom prior specification flexible prior constraints One-hot encoding full factor representation interactions Coefficient-specific priors fine-grained control Hierarchical priors shared variance using stanvars Stratification nuisance parameters vary groups features provide researchers powerful tools complex trial analyses maintaining principled Bayesian shrinkage framework.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"introduction","dir":"Articles","previous_headings":"","what":"Introduction","title":"Quickstart","text":"bonsaiforest2 package consists 3 core functions typically called sequence: run_brms_analysis() - Prepares model formula fits Bayesian model using brms. summary_subgroup_effects() - Calculates marginal subgroup treatment effects. plot() - Creates forest plot summary object. package enables implementation global models (Wolbers et al. 2025), estimate prognostic predictive effects single unified model using colon notation (e.g., ~ 0 + trt:subgroup), one-way models (Wang et al. 2024), estimate treatment slopes varying subgroup using random effects notation (e.g., ~ (0 + trt || subgroup)). vignette demonstrates use package fit compare different modeling formulas. ’ll learn : Fit one-way models (random effects treatment slopes varying subgroup) Fit global models (subgroup variables one unified model) Generate summaries subgroup treatment effects Visualize compare results different model specifications example makes use Bayesian modeling, requires installation brms package working Stan installation (e.g., via cmdstanr).","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"the-data","dir":"Articles","previous_headings":"","what":"The Data","title":"Quickstart","text":"use simulated example dataset continuous response variable. relevant outcome y. consider model want find treatment effect (trt) y. model adjust baseline prognostic variable (predictor outcome) explore multiple subgroup variables predictive variables (potential treatment effect modifiers): X1: Subgroup 1 (categories: , B, C) X2: Subgroup 2 (categories: , B) X3: Subgroup 3 (categories: , B, C) X4: Subgroup 4 (categories: , B) X5: Subgroup 5 (categories: , B) First, let’s load libraries create data.","code":"# Load the main package library(bonsaiforest2) library(brms) # Create the example data with multiple subgroup variables and treatment effects set.seed(123) n <- 500  data <- data.frame(   id = 1:n,   trt = rep(0:1, length.out = n),  # Numeric treatment 0/1   baseline = rnorm(n, mean = 100, sd = 15),   X1 = factor(sample(c(\"A\", \"B\", \"C\"), n, replace = TRUE)),   X2 = factor(sample(c(\"A\", \"B\"), n, replace = TRUE)),   X3 = factor(sample(c(\"A\", \"B\", \"C\"), n, replace = TRUE)),   X4 = factor(sample(c(\"A\", \"B\"), n, replace = TRUE)),   X5 = factor(sample(c(\"A\", \"B\"), n, replace = TRUE)) )  # Generate outcome with baseline effect and heterogeneous treatment effects data$y <- 50 +    0.2 * data$baseline +    data$trt * (-5 +                                    # Base treatment effect     2 * (as.numeric(data$X1 == \"A\") - 0.33) +        # Heterogeneity by X1     1.5 * (as.numeric(data$X3 == \"B\") - 0.33)        # Heterogeneity by X3   ) +    rnorm(n, 0, 10)  print(head(data)) #>   id trt  baseline X1 X2 X3 X4 X5        y #> 1  1   0  91.59287  A  B  C  B  A 63.61448 #> 2  2   1  96.54734  B  B  C  B  B 70.01582 #> 3  3   0 123.38062  C  A  B  A  B 51.31665 #> 4  4   1 101.05763  B  B  C  A  B 75.00897 #> 5  5   0 101.93932  C  A  C  B  A 54.71636 #> 6  6   1 125.72597  A  B  C  B  B 71.20951"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"one-way-models","dir":"Articles","previous_headings":"","what":"One-way Models","title":"Quickstart","text":"section demonstrates fit separate models, examining one subgroup variable time. one-way models, specify treatment effects random slopes using pipe-pipe notation (e.g., ~ (0 + trt || subgroup)), allows treatment effects vary subgroup automatic hierarchical regularization via random effects.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"one-way-model-x1-only","dir":"Articles","previous_headings":"3 One-way Models","what":"One-way Model: X1 Only","title":"Quickstart","text":"","code":"# Fit model with only X1 as subgroup variable using one-way approach # Random effects notation (0 + trt || X1) estimates varying treatment slopes by X1 oneway_X1 <- run_brms_analysis(   data = data,   response_type = \"continuous\",   response_formula = y ~ trt,   unshrunk_terms_formula = ~ baseline,   shrunk_prognostic_formula = NULL,   shrunk_predictive_formula = ~ (0 + trt || X1),   intercept_prior = \"normal(0, 10)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_predictive_prior = set_prior(\"normal(0, 1)\", class = \"sd\"),   chains = 2, iter = 2000, warmup = 1000, cores = 2,   refresh = 0, backend = \"cmdstanr\" ) #> Running MCMC with 2 parallel chains... #>  #> Chain 1 finished in 3.1 seconds. #> Chain 2 finished in 3.4 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 3.3 seconds. #> Total execution time: 3.5 seconds.  summary_oneway_X1 <- summary_subgroup_effects(brms_fit = oneway_X1) print(summary_oneway_X1) #> $estimates #> # A tibble: 3 × 4 #>   Subgroup Median CI_Lower CI_Upper #>   <chr>     <dbl>    <dbl>    <dbl> #> 1 X1: A     -3.39    -5.31    -1.20 #> 2 X1: B     -3.80    -5.79    -1.72 #> 3 X1: C     -4.91    -7.29    -2.84 #>  #> $response_type #> [1] \"continuous\" #>  #> $ci_level #> [1] 0.95 #>  #> $trt_var #> [1] \"trt\" #>  #> attr(,\"class\") #> [1] \"subgroup_summary\""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"one-way-model-x2-only","dir":"Articles","previous_headings":"3 One-way Models","what":"One-way Model: X2 Only","title":"Quickstart","text":"","code":"oneway_X2 <- run_brms_analysis(   data = data,   response_type = \"continuous\",   response_formula = y ~ trt,   unshrunk_terms_formula = ~ baseline,   shrunk_prognostic_formula = NULL,   shrunk_predictive_formula = ~ (0 + trt || X2),   intercept_prior = \"normal(0, 10)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_predictive_prior = set_prior(\"normal(0, 1)\", class = \"sd\"),   chains = 2, iter = 2000, warmup = 1000, cores = 2,   refresh = 0, backend = \"cmdstanr\" ) #> Running MCMC with 2 parallel chains... #>  #> Chain 2 finished in 3.0 seconds. #> Chain 1 finished in 3.2 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 3.1 seconds. #> Total execution time: 3.2 seconds.  summary_oneway_X2 <- summary_subgroup_effects(brms_fit = oneway_X2)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"one-way-model-x3-only","dir":"Articles","previous_headings":"3 One-way Models","what":"One-way Model: X3 Only","title":"Quickstart","text":"","code":"oneway_X3 <- run_brms_analysis(   data = data,   response_type = \"continuous\",   response_formula = y ~ trt,   unshrunk_terms_formula = ~ baseline,   shrunk_prognostic_formula = NULL,   shrunk_predictive_formula = ~ (0 + trt || X3),   intercept_prior = \"normal(0, 10)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_predictive_prior = set_prior(\"normal(0, 1)\", class = \"sd\"),   chains = 2, iter = 2000, warmup = 1000, cores = 2,   refresh = 0, backend = \"cmdstanr\" ) #> Running MCMC with 2 parallel chains... #>  #> Chain 2 finished in 3.2 seconds. #> Chain 1 finished in 3.5 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 3.4 seconds. #> Total execution time: 3.6 seconds.  summary_oneway_X3 <- summary_subgroup_effects(brms_fit = oneway_X3)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"one-way-model-x4-only","dir":"Articles","previous_headings":"3 One-way Models","what":"One-way Model: X4 Only","title":"Quickstart","text":"","code":"oneway_X4 <- run_brms_analysis(   data = data,   response_type = \"continuous\",   response_formula = y ~ trt,   unshrunk_terms_formula = ~ baseline,   shrunk_prognostic_formula = NULL,   shrunk_predictive_formula = ~ (0 + trt || X4),   intercept_prior = \"normal(0, 10)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_predictive_prior = set_prior(\"normal(0, 1)\", class = \"sd\"),   chains = 2, iter = 2000, warmup = 1000, cores = 2,   refresh = 0, backend = \"cmdstanr\" ) #> Running MCMC with 2 parallel chains... #>  #> Chain 1 finished in 3.3 seconds. #> Chain 2 finished in 3.6 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 3.5 seconds. #> Total execution time: 3.7 seconds.  summary_oneway_X4 <- summary_subgroup_effects(brms_fit = oneway_X4)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"one-way-model-x5-only","dir":"Articles","previous_headings":"3 One-way Models","what":"One-way Model: X5 Only","title":"Quickstart","text":"","code":"oneway_X5 <- run_brms_analysis(   data = data,   response_type = \"continuous\",   response_formula = y ~ trt,   unshrunk_terms_formula = ~ baseline,   shrunk_prognostic_formula = NULL,   shrunk_predictive_formula = ~ (0 + trt || X5),   intercept_prior = \"normal(0, 10)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_predictive_prior = set_prior(\"normal(0, 1)\", class = \"sd\"),   chains = 2, iter = 2000, warmup = 1000, cores = 2,   refresh = 0, backend = \"cmdstanr\" ) #> Running MCMC with 2 parallel chains... #>  #> Chain 2 finished in 3.5 seconds. #> Chain 1 finished in 3.7 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 3.6 seconds. #> Total execution time: 3.8 seconds.  summary_oneway_X5 <- summary_subgroup_effects(brms_fit = oneway_X5)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"one-way-models-visualizing-all-models","dir":"Articles","previous_headings":"3 One-way Models","what":"One-way Models: Visualizing All Models","title":"Quickstart","text":"can combine visualize results multiple models using combine_summaries():","code":"# Combine all one-way models combined_oneway <- combine_summaries(list(   \"X1\" = summary_oneway_X1,   \"X2\" = summary_oneway_X2,   \"X3\" = summary_oneway_X3,   \"X4\" = summary_oneway_X4,   \"X5\" = summary_oneway_X5 ))  plot(combined_oneway, title = \"One-way Models: All Subgroup Variables\") #> Preparing data for plotting... #> Generating plot... #> Done."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"global-model","dir":"Articles","previous_headings":"","what":"Global Model","title":"Quickstart","text":"section demonstrates fit single model includes subgroup variables simultaneously using global approach. treatment--subgroup interactions estimated one unified model colon notation (e.g., ~ 0 + trt:subgroup) strong regularization (Horseshoe prior) applied interaction terms.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"global-model-all-subgroups","dir":"Articles","previous_headings":"4 Global Model","what":"Global Model: All Subgroups","title":"Quickstart","text":"","code":"# Fit a single unified model with ALL subgroup variables simultaneously using global approach # - Unshrunk terms: baseline with reference coding # - Shrunk prognostic effects: subgroup main effects with strong regularization using one-hot encoding # - Shrunk predictive effects: treatment interactions with strong regularization using one-hot encoding global_shrinkage_model <- run_brms_analysis(   data = data,   response_type = \"continuous\",   response_formula = y ~ trt,   unshrunk_terms_formula = ~ baseline,   shrunk_prognostic_formula = ~ 0 + X1 + X2 + X3 + X4 + X5,   shrunk_predictive_formula = ~ 0 + trt:X1 + trt:X2 + trt:X3 + trt:X4 + trt:X5,   intercept_prior = \"normal(0, 10)\",   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_prognostic_prior = \"horseshoe(scale_global = 1)\",   shrunk_predictive_prior = \"horseshoe(scale_global = 0.5)\",   chains = 2, iter = 2000, warmup = 1000, cores = 2,   refresh = 0, backend = \"cmdstanr\" ) #> Running MCMC with 2 parallel chains... #>  #> Chain 2 finished in 8.5 seconds. #> Chain 1 finished in 9.0 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 8.8 seconds. #> Total execution time: 9.1 seconds."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"global-model-summary-of-subgroup-effects","dir":"Articles","previous_headings":"4 Global Model","what":"Global Model: Summary of Subgroup Effects","title":"Quickstart","text":"Use summary_subgroup_effects() generate marginal treatment effects subgroup. function automatically extracts treatment interactions fitted model:","code":"global_summary <- summary_subgroup_effects(brms_fit = global_shrinkage_model) #> Using trt_var from model attributes: trt #> Using response_type from model attributes: continuous #> --- Calculating specific subgroup effects... --- #> Using data from model attributes #> Step 1: Identifying subgroups and creating counterfactuals... #> `subgroup_vars` set to 'auto'. Detecting from model... #> Model data has 500 rows and 9 columns #> Column names: id, trt, baseline, X1, X2, X3, X4, X5, y #> Treatment variable: 'trt' #> All coefficient names: #> unshrunktermeffect_Intercept #> unshrunktermeffect_baseline #> unshrunktermeffect_trt #> shprogeffect_X1A #> shprogeffect_X1B #> shprogeffect_X1C #> shprogeffect_X2A #> shprogeffect_X2B #> shprogeffect_X3A #> shprogeffect_X3B #> shprogeffect_X3C #> shprogeffect_X4A #> shprogeffect_X4B #> shprogeffect_X5A #> shprogeffect_X5B #> shpredeffect_trt:X1A #> shpredeffect_trt:X1B #> shpredeffect_trt:X1C #> shpredeffect_trt:X2A #> shpredeffect_trt:X2B #> shpredeffect_trt:X3A #> shpredeffect_trt:X3B #> shpredeffect_trt:X3C #> shpredeffect_trt:X4A #> shpredeffect_trt:X4B #> shpredeffect_trt:X5A #> shpredeffect_trt:X5B #> Looking for treatment interactions with pattern: 'trt:' #> Found 12 treatment interaction coefficients #> Treatment interaction coefficients found: #> shpredeffect_trt:X1A #> shpredeffect_trt:X1B #> shpredeffect_trt:X1C #> shpredeffect_trt:X2A #> shpredeffect_trt:X2B #> shpredeffect_trt:X3A #> shpredeffect_trt:X3B #> shpredeffect_trt:X3C #> shpredeffect_trt:X4A #> shpredeffect_trt:X4B #> shpredeffect_trt:X5A #> shpredeffect_trt:X5B #> Detected subgroup variable 'X1' from coefficient 'shpredeffect_trt:X1A' #> Detected subgroup variable 'X1' from coefficient 'shpredeffect_trt:X1B' #> Detected subgroup variable 'X1' from coefficient 'shpredeffect_trt:X1C' #> Detected subgroup variable 'X2' from coefficient 'shpredeffect_trt:X2A' #> Detected subgroup variable 'X2' from coefficient 'shpredeffect_trt:X2B' #> Detected subgroup variable 'X3' from coefficient 'shpredeffect_trt:X3A' #> Detected subgroup variable 'X3' from coefficient 'shpredeffect_trt:X3B' #> Detected subgroup variable 'X3' from coefficient 'shpredeffect_trt:X3C' #> Detected subgroup variable 'X4' from coefficient 'shpredeffect_trt:X4A' #> Detected subgroup variable 'X4' from coefficient 'shpredeffect_trt:X4B' #> Detected subgroup variable 'X5' from coefficient 'shpredeffect_trt:X5A' #> Detected subgroup variable 'X5' from coefficient 'shpredeffect_trt:X5B' #> Checking for random effects parameters... #> Retrieved 58 total parameters from model #> Using regex pattern: '^r_(.+)__[^\\[]+\\[[^,]+,trt\\]' #> Found 0 matching random effect parameters #> No random effect parameters matching the pattern were found #> ...detected subgroup variable(s): X1, X2, X3, X4, X5 #> Step 2: Generating posterior predictions... #> ... detected Fixed Effects (Colon model). Predicting with re_formula = NA. #> ... (predicting expected outcomes)... #> Step 3: Calculating marginal effects... #> ... processing X1 #> ... processing X2 #> ... processing X3 #> ... processing X4 #> ... processing X5 #> Done.  # Print the summary of subgroup-specific treatment effects print(global_summary) #> $estimates #> # A tibble: 12 × 4 #>    Subgroup Median CI_Lower CI_Upper #>    <chr>     <dbl>    <dbl>    <dbl> #>  1 X1: A     -3.66    -5.75    -1.47 #>  2 X1: B     -3.84    -5.86    -1.77 #>  3 X1: C     -4.96    -7.50    -2.90 #>  4 X2: A     -4.21    -6.22    -2.32 #>  5 X2: B     -4.09    -6.12    -2.20 #>  6 X3: A     -4.71    -7.22    -2.52 #>  7 X3: B     -3.91    -6.01    -1.67 #>  8 X3: C     -3.92    -5.94    -1.83 #>  9 X4: A     -4.19    -6.09    -2.31 #> 10 X4: B     -4.10    -6.16    -2.26 #> 11 X5: A     -4.18    -6.20    -2.35 #> 12 X5: B     -4.14    -6.04    -2.26 #>  #> $response_type #> [1] \"continuous\" #>  #> $ci_level #> [1] 0.95 #>  #> $trt_var #> [1] \"trt\" #>  #> attr(,\"class\") #> [1] \"subgroup_summary\""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"global-model-visualization","dir":"Articles","previous_headings":"4 Global Model","what":"Global Model: Visualization","title":"Quickstart","text":"Use plot() function create forest plot summary object:","code":"plot(global_summary, title = \"Global Model: All Subgroup Variables\") #> Preparing data for plotting... #> Generating plot... #> Done."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"comparing-multiple-models-in-one-plot","dir":"Articles","previous_headings":"","what":"Comparing Multiple Models in One Plot","title":"Quickstart","text":"plot() function supports comparing multiple models side--side. Pass named list subgroup_summary objects create comparative forest plot.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"example-comparing-one-way-vs-global-models","dir":"Articles","previous_headings":"5 Comparing Multiple Models in One Plot","what":"Example: Comparing One-way vs Global Models","title":"Quickstart","text":"","code":"# Combine summaries for comparison combined <- combine_summaries(list(   \"One-way\" = combined_oneway,   \"Global\" = global_summary ))  # Plot the comparison plot(combined, title = \"Comparing One-way vs Global Models\") #> Preparing data for plotting... #> Generating plot... #> Done."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"scope-of-this-document","dir":"Articles","previous_headings":"","what":"Scope of this document","title":"Statistical Specifications","text":"document describes statistical methods implemented bonsaiforest2 R package Bayesian subgroup analysis continuous, binary, count, time--event outcomes randomized clinical trials (RCTs). package enable implementation global modeling approach (Wolbers et al. 2025), estimates prognostic predictive effects single model, One-variable-time (Wang et al. 2024), estimates predictive effects using different model subgrouping variable. core features described document : Prognostic (main) vs. Predictive (interaction) effects. Shrunk vs. Unshrunk coefficients. Users can specify unshrunk terms (weakly informative priors), add shrunk prognostic effects /shrunk predictive effects (strong regularization priors) needed analysis. Customizable Priors: Users can specify custom priors individual coefficients coefficient groups domain expertise available. custom priors specified, package applies automatic, well-calibrated default priors. Advanced Shrinkage Priors: Supports state---art shrinkage priors, including Regularized Horseshoe (Piironen Vehtari 2017; Wolbers et al. 2025) R2D2 (Zhang et al. 2022). estimate_subgroup_effects() computational G-computation workflow. summary_subgroup_effects() user-friendly effect summaries. document structured follows: Section 2 provides conceptual introduction subgroup analysis challenges Bayesian shrinkage solution. Section 3 details statistical methodology, including notation, global one-variable time models, endpoint-specific likelihoods, prior specifications, standardization procedure. Section 4 maps statistical methods core functions bonsaiforest2 package.","code":""},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"the-challenge-of-subgroup-analysis","dir":"Articles","previous_headings":"2 Introduction to Subgroup Analysis and Estimation","what":"The Challenge of Subgroup Analysis","title":"Statistical Specifications","text":"Exploratory subgroup analyses standard part RCT reporting, typically visualized forest plots assess consistency treatment effects. However, interpretation notoriously difficult due several statistical challenges: Low Power: Subgroups smaller sample sizes, leading low precision (wide confidence intervals) inability detect true, modest differences effect. Multiplicity: Examining many subgroups (e.g., 20 ) inflates risk false-positive findings. Investigators may focus extreme results, often spurious. Overfitting: Standard subgroup-specific estimates (fitting model data within subgroup) unbiased high variance, leading overestimation heterogeneity. led common recommendation overall treatment effect often reliable estimate subgroup estimate derived subgroup’s data alone.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"prognostic-vs--predictive-effects","dir":"Articles","previous_headings":"2 Introduction to Subgroup Analysis and Estimation","what":"Prognostic vs. Predictive Effects","title":"Statistical Specifications","text":"build meaningful model, crucial distinguish baseline variable relates outcome: Prognostic Effect: variable prognostic associated clinical outcome, regardless treatment received. describes natural course disease. model, main effect. Predictive Effect: variable predictive value modifies magnitude direction treatment’s effect. identifies heterogeneity. model, treatment--variable interaction. bonsaiforest2 built model types effects explicitly apply different modeling strategies (e.g., shrinkage) .","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"the-role-of-bayesian-shrinkage","dir":"Articles","previous_headings":"2 Introduction to Subgroup Analysis and Estimation","what":"The Role of Bayesian Shrinkage","title":"Statistical Specifications","text":"Bayesian shrinkage methods directly address challenges subgroup analysis providing principled compromise two extremes “pooling” (subgroup-specific estimates) “full pooling” (overall population estimate). compromise, often called partial pooling, achieved using hierarchical models. Subgroup effects assumed exchangeable (drawn common distribution). assumption allows subgroups “borrow strength” : Subgroups small sample sizes extreme results “shrunk” heavily toward overall mean, reducing variance. Subgroups large sample sizes strong evidence real effect shrunk less, allowing data dominate. results estimates better bias-variance trade-: accept small amount bias (pulling real effects slightly toward mean) exchange large reduction variance, leading lower overall error better control spurious findings.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"conditional-vs--marginal-estimands","dir":"Articles","previous_headings":"2 Introduction to Subgroup Analysis and Estimation","what":"Conditional vs. Marginal Estimands","title":"Statistical Specifications","text":"covariates included non-linear model (like logistic Cox model), resulting coefficients represent conditional effects. example, treatment effect effect patient specific set covariate values (e.g., reference values). problematic forest plots, want know marginal effect: “average treatment effect patients ‘Female’ subgroup, averaging different ages, regions, etc.?”. different subgroups different covariate distributions (e.g., age >= 65 subgroup different health status profile age < 65 group), conditional coefficients directly comparable. bonsaiforest2 solves using Standardization (G-computation) (Hernán Robins 2023). procedure correctly averages specific covariate distribution subgroup estimate valid marginal treatment effect, ensuring subgroups compared interpretable scale. (See Section 3.10 detailed explanation standardization performed package.)","code":""},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"setting-and-notation","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"Setting and Notation","title":"Statistical Specifications","text":"establish following notation global model: \\(= 1, \\dots, N\\): Index individual patients. \\(y_i\\): outcome patient \\(\\). consider variable can binary, count, continuous time--event endpoint. \\(s_i\\): binary treatment indicator (\\(s_i=1\\) treatment, \\(s_i=0\\) control). \\(l = 1, \\dots, L\\): Index overall subgroup level (e.g., “Male”, “Female”, “EU”, “USA”). \\(x_{il}\\): Indicator (0/1) patient \\(\\) belonging subgroup level \\(l\\) (used prognostic effects). \\(z_{il} = s_i \\cdot x_{il}\\): interaction treatment subgroup level \\(l\\) (used predictive effects). \\(u_{iv}\\): Value \\(v\\)-th additional non-subgroup covariate patient \\(\\). additional covariates don’t need binary categorical. \\(\\boldsymbol{\\mu}\\): \\(N \\times 1\\) vector expected outcomes. \\(g(\\cdot)\\): link function. Section 3.7 define used link function type endpoint. \\(\\boldsymbol{\\eta}\\): \\(N \\times 1\\) vector linear predictor.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"design-matrix-considerations","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"Design Matrix Considerations","title":"Statistical Specifications","text":"critical implementation detail construction design matrix, varies based whether coefficients subject shrinkage. package applies different contrast coding schemes shrunk versus unshrunk terms: unshrunk terms (prognostic predictive): Standard dummy coding used, one level per factor treated reference category omitted design matrix. approach: Ensures interpretability coefficients relative baseline Avoids collinearity intercept Results L−J total columns J subgrouping variables L total levels appropriate coefficients given weakly informative priors without strong regularization shrunk terms (prognostic predictive): One-hot encoding used, creating explicit dummy variables levels factor, reference level omitted. example, subgrouping variable levels {, B, C} creates three columns: subgroupA, subgroupB, subgroupC (prognostic effects) trt:subgroupA, trt:subgroupB, trt:subgroupC (predictive effects). approach ensures: subgroup levels treated symmetrically exchangeability assumption shrinkage prior single level serves anchor point toward levels shrunk level interpretable parameter can independently regularized Predictions work correctly G-computation (see Section 3.10) rationale one-hot encoding shrunk terms shrinkage priors assume exchangeability among coefficients—levels drawn prior distribution. reference level break symmetry bias shrinkage process.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"the-principle-of-model-hierarchy","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"The Principle of Model Hierarchy","title":"Statistical Specifications","text":"fundamental concept regression modeling principle model hierarchy (marginality). principle states model includes interaction term (e.g., :B), also include corresponding main effects (e.g., B). context bonsaiforest2, means subgrouping variable included predictive (.e., interaction treatment, like trt:subgroup) also included prognostic (.e., main effect, subgroup). Including main effect ensures interaction term purely captures modification treatment effect, rather mix main prognostic effect interaction, leading stable interpretable model. bonsaiforest2 package checks adherence principle model specification. prepare_formula_model function examines whether main effect specified prognostic every variable included predictive term. , function issues warning recommending user include corresponding main effect ensure proper model hierarchy. However, package enforce automatically, allowing users flexibility override recommendation justified domain knowledge specific modeling goals.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-global","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"The Global Model","title":"Statistical Specifications","text":"package enables implementation global model (Wolbers et al. 2025) effects estimated single, comprehensive regression formula.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"full-model-equation","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.4 The Global Model","what":"Full Model Equation","title":"Statistical Specifications","text":"Matrix form: model linear predictor, \\(\\boldsymbol{\\eta}\\), \\(N\\) patients given : \\[g(\\boldsymbol{\\mu}) = \\boldsymbol{\\eta} = \\underbrace{\\mathbf{X_p}\\boldsymbol{\\beta_{1,p}}}_{\\text{Penalized prognostic effects}} +\\underbrace{\\mathbf{X_n}\\boldsymbol{\\beta_{1,n}}}_{\\text{Non-penalized prognostic effects}} +\\underbrace{\\mathbf{Z_p}\\boldsymbol{\\beta_{2,p}}}_{\\text{Penalized predictive effects}} +\\] \\[ \\underbrace{\\mathbf{Z_n}\\boldsymbol{\\beta_{2,n}}}_{\\text{Non-penalized predictive effects}}+ \\underbrace{\\mathbf{U}\\boldsymbol{\\beta_{3}}}_{\\text{Extra prognostic effects}} \\] Bayesian hierarchical structure applied follows: Penalized Coefficients: \\(\\boldsymbol{\\beta_{1,p}}\\) \\(\\boldsymbol{\\beta_{2,p}}\\) given shrinkage priors. Non-Penalized Coefficients: \\(\\boldsymbol{\\beta_{1,n}}\\) \\(\\boldsymbol{\\beta_{2,n}}\\) given standard, weakly informative priors. Extra prognostic effects Coefficients: \\(\\boldsymbol{\\beta_3}\\) given standard, weakly informative priors. Components definition: \\(\\mathbf{X}= [\\mathbf{X_p} \\;\\;  \\mathbf{X}_n]\\) \\(N \\times M\\) design matrix prognostic effects. typically includes: intercept column. Section 3.6 discuss inclusion prior give intercept detail column main treatment effect. Columns prognostic effects subgroup level. contrast coding depends shrinkage status: Unshrunk terms (\\(\\mathbf{X}_n\\)): Use dummy coding (one reference level per factor dropped) Shrunk terms (\\(\\mathbf{X}_p\\)): Use one-hot encoding (levels included maintain exchangeability) Example: Table 3.1: Example design matrix unshrunk prognostic effects (dummy coding). Note: unshrunk terms, M=1+1+L-J= 1 intercept + 1 treatment + L (total subgroup levels) - J (number subgrouping variables) reference levels dropped. shrunk terms, L levels included (reference level dropped). \\(\\boldsymbol{\\beta_{1,p}}\\) \\(P \\times 1\\) vector coefficients prognostic effects want shrink. give shrinkage prior coefficients. \\(\\boldsymbol{\\beta_{1,n}}\\) \\((M-P) \\times 1\\) vector coefficients prognostic effects don’t want shrink. \\(\\mathbf{Z}= [\\mathbf{Z_p} \\;\\;  \\mathbf{Z}_n]\\) design matrix predictive effects. contrast coding depends shrinkage status: Unshrunk predictive terms (\\(\\mathbf{Z}_n\\)): Use dummy coding (one reference interaction per factor dropped) Shrunk predictive terms (\\(\\mathbf{Z}_p\\)): Use one-hot encoding column trt_subgroupLEVEL equals 1 patient \\(\\) treatment (\\(s_i = 1\\)) belongs specific subgroup level, 0 otherwise. \\(L\\) interaction dummies included ensure subgroups treated symmetrically exchangeability assumption. Table 3.2: Example design matrix shrunk predictive effects (one-hot encoding) \\(\\boldsymbol{\\beta_{2,p}}\\) \\(R \\times 1\\) vector coefficients predictive effects want shrink. give shrinkage prior coefficients. \\(\\boldsymbol{\\beta_{2,n}}\\) \\((L-R) \\times 1\\) vector coefficients predictive effects don’t want shrink. \\(U\\) \\(N \\times V\\) design matrix extra variables want take account fitting model. also unpenalized. \\(\\boldsymbol{\\beta_3}\\) \\(V \\times 1\\) vector extra prognostic effects coefficients Linear form: make concrete, linear predictor single patient \\(\\) can written : \\[ \\eta_i = \\underbrace{\\beta_0 + \\beta_{\\text{treat}}s_i + \\underbrace{\\sum_{l=1}^{P} \\beta^l_{1,p}x^{il}_n}_\\text{penalized}+ \\underbrace{\\sum_{l=P+1}^{M}  \\beta^l_{1,n}x^{il}_n}_\\text{penalized}+\\underbrace{\\sum_{v=1}^{V} \\beta_{3}^vu^{iv}}_{\\text{Extra }}}_{\\text{Prognostic Effects}} + \\underbrace{\\underbrace{\\sum_{l=1}^{L-R} \\beta_{2,p}^l z_p^{il}}_{\\text{penalized }} + \\underbrace{\\sum_{l=L-R+1}^{L} \\beta_{2,n}^l z_n^{il}}_{\\text{penalized}} }_{\\text{Predictive effects}} \\] Note: See even \\(z^{il}=x^{il}\\cdot s^{}\\), prognostic effect predictive effect subgrouping variable may penalized , separate \\(x\\) \\(z\\) formula.","code":"# Example: Unshrunk prognostic effects using dummy coding design_matrix_df <- data.frame(   Patient    = c(1, 2, 3, 4),   Intercept  = c(1, 1, 1, 1),   trt        = c(0, 1, 0, 1),   sexF       = c(0, 1, 1, 0),   regionUS   = c(0, 0, 1, 1),   regionAsia = c(0, 1, 0, 0) )  knitr::kable(   design_matrix_df,   caption = \"Example design matrix for unshrunk prognostic effects (dummy coding).\",   align = c('l', 'c', 'c', 'c', 'c') ) # Example: Shrunk predictive effects using one-hot encoding # Each column represents trt_subgroupLEVEL (1 if treated AND in that level, 0 otherwise) interaction_matrix <- data.frame(   Patient           = 1:6,   `trt_sexM`        = c(1, 0, 1, 1, 0, 0),   `trt_sexF`        = c(0, 1, 0, 0, 1, 1),   `trt_regionEU`    = c(0, 1, 0, 0, 1, 0),   `trt_regionUS`    = c(1, 0, 0, 1, 0, 0),   `trt_regionAsia`  = c(0, 0, 1, 0, 0, 1) )  knitr::kable(   interaction_matrix,   align = 'c',   col.names = c(\"Patient\", \"trt_sexM\", \"trt_sexF\", \"trt_regionEU\", \"trt_regionUS\", \"trt_regionAsia\"),   caption = \"Example design matrix for shrunk predictive effects (one-hot encoding)\" )"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"example","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.4 The Global Model","what":"Example","title":"Statistical Specifications","text":"randomized, double-blind trial comparing new drug, DrugX, placebo patients hypertension. Primary Endpoint (\\(Y_{}\\)): Change baseline systolic blood pressure (SBP) mmHg 6 months. Age Group: <65 vs. ≥65 years. Sex: Male vs. Female. Kidney Function: eGFR <60 (impaired) vs. ≥60 (normal). Covariates: BaselineSBPᵢ, BMIᵢ, Smokerᵢ (binary). Global Model Shrinkage outcome assumed normally distributed: \\(Y_{} \\sim N(\\mu_{}, \\sigma^2)\\). linear predictor \\(\\mu_{}\\) modeled : \\[ \\mu_{} = \\underbrace{\\beta_0}_{\\text{Intercept}} + \\underbrace{\\beta_{\\text{treat}} \\cdot \\text{Treatment}_i}_{\\text{Main Trt Effect}} + \\underbrace{\\sum_{k=1}^{K} \\alpha_k \\cdot \\text{Subgroup}_{ik}}_{\\text{Prognostic Subgroup Effects}} + \\underbrace{\\sum_{k=1}^{K} \\gamma_k \\cdot (\\text{Subgroup}_{ik} \\cdot \\text{Treatment}_i)}_{\\text{Shrunken Predictive Effects}} + \\underbrace{\\sum_{j=1}^{J} \\delta_j \\cdot \\text{Covariate}_{ij}}_{\\text{Extra Prognostic effects}} \\] \\[ =\\underbrace{\\beta_0}_{\\text{Intercept}} + \\underbrace{\\beta_{\\text{treat}} \\cdot \\text{Treatment}_i}_{\\text{Main Trt Effect}} + \\underbrace{\\alpha_1 \\cdot \\text{Age Group}_i+\\alpha_2 \\cdot \\text{Sex}_i+\\alpha_3 \\cdot \\text{eGFR}_i}_{\\text{Prognostic Subgroup Effects}}+ \\] \\[ + \\underbrace{\\gamma_1 \\cdot (\\text{Age Group}_i\\cdot \\text{Treatment}_i)+\\gamma_2 \\cdot (\\text{Sex}_i\\cdot \\text{Treatment}_i)+\\gamma_3 \\cdot (\\text{eGFR}_i\\cdot \\text{Treatment}_i)}_{\\text{Predictive Effects}} + \\underbrace{\\delta_1 \\cdot \\text{BaselineSBP}_i+\\delta_2 \\cdot \\text{BMI}_i+\\delta_3 \\cdot \\text{Smoker}_i}_{\\text{Extra Prognostic effects}} \\]","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-one-var","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"One-Variable-at-a-Time Model","title":"Statistical Specifications","text":"one-variable---time model (Wang et al. 2024) Bayesian hierarchical model (BHM) improves upon standard subgroup analysis borrowing information across subgroup levels produce stable reliable estimates. Instead analyzing subgroup level isolation, analyzes levels within single subgrouping variable (e.g., age groups) together one model. example, variable Sex (levels Male Female), fit one hierarchical model. single model, treatment effects Male (\\(\\beta_{2,\\text{sex,male}}\\)) Female (\\(\\beta_{2,\\text{sex,female}}\\)) treated exchangeable linked common prior distribution. , completely separate hierarchical model fit variable Region.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"full-model-equation-1","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.5 One-Variable-at-a-Time Model","what":"Full Model Equation","title":"Statistical Specifications","text":"given subgrouping variable \\(j\\), can specify flexible linear predictor allows covariate effects constant across levels \\(j\\), others allowed vary. Let’s partition patient-level covariates two sets: \\(\\mathbf{u}_i\\): vector covariates assumed constant prognostic effect across levels subgrouping variable \\(j\\). \\(\\mathbf{v}_i\\): vector covariates strong priori reason believe prognostic effect varies across levels \\(k\\) subgrouping variable \\(j\\). linear predictor patient \\(\\) level \\(k\\) variable \\(j\\) : \\[g(\\mu_{,j,k}) = \\beta_{1,j,k} + \\beta_{2,j,k}z_i + \\boldsymbol{\\beta}_{3,j}\\mathbf{u}_i + \\boldsymbol{\\beta}_{4,j,k}\\mathbf{v}_i\\] \\(\\beta_{2,j,k}\\): predictive effect level \\(k\\) variable \\(j\\). primary parameter interest shrinkage. \\(\\boldsymbol{\\beta}_{3,j}\\mathbf{u}_i\\): effect covariates assumed constant across levels. coefficient vector \\(\\boldsymbol{\\beta}_{3,j}\\) \\(k\\) subscript. \\(\\boldsymbol{\\beta}_{4,j,k}\\mathbf{v}_i\\): effect covariates assumed level-specific. coefficient vector \\(\\boldsymbol{\\beta}_{4,j,k}\\) \\(k\\) subscript, allowing effect different subgroup level. can seen interaction variable \\(x_j\\) \\(v_i\\). Note coefficients \\(\\boldsymbol{\\beta}_{3,j}\\) \\(\\boldsymbol{\\beta}_{4,j,k}\\) can use shrinkage standard priors depending prior beliefs.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"example-1","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.5 One-Variable-at-a-Time Model","what":"Example","title":"Statistical Specifications","text":"Similarly example showed Global model. example Age Group variable, \\(k \\\\{ \\text{<65}, \\text{≥65} \\}\\). outcome patient age subgroup k : \\(Y_{ik} \\sim N(\\mu_{ik}, \\sigma_k^2)\\). linear predictor \\(\\mu_{ik}\\) : \\[ \\mu_{ik} = \\underbrace{\\beta_{1,k}}_{\\text{Subgroup Intercept}} + \\underbrace{\\beta_{2,k} \\cdot \\text{Treatment}_i}_{\\text{Predictive Effect}} + \\underbrace{\\delta_1 \\cdot \\text{BMI}_i + \\delta_2 \\cdot \\text{Smoker}_i}_{\\text{Constant Prognostic Effects}} + \\underbrace{\\delta_{3,k} \\cdot \\text{BaselineSBP}_i}_{\\text{Varying Prognostic Effect}} \\] , \\(\\beta_{1,k}\\) (subgroup-specific intercept) \\(\\beta_{2,k}\\) (subgroup-specific predictive effect) given hierarchical priors borrow information across age groups. example: \\(\\beta_{2,k} \\sim N(\\mu_2, \\tau_2^2)\\). effect Baseline SBP also allowed vary age group (\\(\\delta_{3,k}\\)), BMI Smoking effects assumed constant","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-intercept","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"The Logic of the Intercept","title":"Statistical Specifications","text":"intercept (\\(\\beta_0\\)) subject shrinkage (fixed effect within unshrunktermeffect component), important understand specified package. Default Specification: package uses NULL (brms default) intercept prior, allowing brms automatically calibrate weakly informative prior. User Customization: Users can specify custom intercept priors via intercept_prior parameter fit_brms_model() run_brms_analysis(). example: continuous outcomes: \"normal(0, 10)\" provides weakly informative prior centered 0. binary count outcomes: \"normal(0, 5)\" provides prior log-odds log-rate scale covering plausible effect sizes (e.g., ratios approximately 0.08 12). Special Case: Time--Event Endpoints. Cox proportional hazards models, intercept identifiable omitted linear predictor. Mechanism: intercept effectively absorbed non-parametric baseline hazard function, \\(h_0(t)\\). Implementation: brms backend handles automatically estimating baseline hazard (via bhaz()) rather fixed intercept parameter. Therefore, intercept prior applied survival models. Additional Note: intercept prior automatically omitted user specifies formula without intercept (using ~ 0 + ... syntax).","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-endpoint","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"Endpoint-Specific Models","title":"Statistical Specifications","text":"package supports four primary endpoint types specifying appropriate likelihood link function \\(g(\\boldsymbol{\\mu}) = \\boldsymbol{\\eta}\\).","code":""},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"default-priors","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.8 Prior Specifications","what":"Default Priors","title":"Statistical Specifications","text":"user-specified priors provided, package applies following automatic defaults: response types (continuous, binary, count, survival): Intercept: NULL — Uses brms default prior (weakly informative) Unshrunk terms: NULL — Uses brms default priors (weakly informative) Shrunk prognostic: horseshoe(1) — Strong regularization main effects Shrunk predictive: horseshoe(1) — Strong regularization treatment interactions Special cases: Random effects (one-way model, pipe-pipe || syntax): SD parameters automatically receive normal(0, 1) priors standard deviation scale, regardless shrunk_predictive_prior setting. Survival models: intercept prior applied, Cox proportional hazards models global intercept; absorbed non-parametric baseline hazard. Formulas without intercepts: user specifies formula using ~ 0 + ... syntax (intercept), intercept prior omitted. User customization: Users can override default prior specifying custom priors character strings (e.g., \"normal(0, 2.5)\") brmsprior objects via parameters intercept_prior, unshrunk_prior, shrunk_prognostic_prior, shrunk_predictive_prior fit_brms_model() run_brms_analysis().","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"weakly-informative-priors-unshrunk-terms","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.8 Prior Specifications","what":"Weakly Informative Priors (Unshrunk Terms)","title":"Statistical Specifications","text":"unshrunk coefficients (prognostic predictive terms unshrunktermeffect component, well extra covariates \\(\\boldsymbol{\\beta_{3}}\\)), package uses brms default weakly informative priors aid computational stability without strongly influencing posterior. Default: NULL (uses brms defaults, typically normal(0, ...)). priors weakly regularizing linear predictor scale. User customization: Users can override specifying custom priors (e.g., \"normal(0, 2.5)\") via unshrunk_prior parameter fit_brms_model() run_brms_analysis().","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"regularized-horseshoe-prior-shrunk-terms","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.8 Prior Specifications","what":"Regularized Horseshoe Prior (Shrunk Terms)","title":"Statistical Specifications","text":"default shrinkage prior bonsaiforest2, recommended excellent adaptive shrinkage properties (Piironen Vehtari 2017). Concept: global-local prior. infinitely tall spike zero (aggressively shrink noise) heavy tails (leave true, large signals unshrunk). Hierarchical Specification: \\[\\begin{aligned} \\beta_{2,l} &\\sim N(0, \\tau^2 \\tilde{\\lambda}_l^2) \\\\ \\tilde{\\lambda}_l^2 &= \\frac{c^2 \\lambda_l^2}{c^2 + \\tau^2 \\lambda_l^2} \\\\ \\lambda_l &\\sim C^+(0, 1) \\quad (\\text{Local shrinkage}) \\\\ \\tau &\\sim C^+(0, \\tau_0) \\quad (\\text{Global shrinkage}) \\\\ c^2 &\\sim \\text{Inverse-Gamma}(\\nu/2, \\nu s^2/2) \\end{aligned}\\] Hyperparameter Justification: package supports two ways set crucial global scale \\(\\tau_0\\): Fixed Default (scale_global): horseshoe(scale_global = 1). package default, robust, general-purpose choice. Elicited Prior (par_ratio): Sets \\(\\tau_0\\) based prior belief number effective (non-zero) subgroups, \\(p_{eff}\\), total \\(L\\) (Bornkamp 2025; Piironen Vehtari 2017). specified via \\(\\text{par\\_ratio} = \\frac{p_{eff}}{L - p_{eff}}\\). scales prior based sample size (\\(N\\)) expected sparsity. Regularized Horseshoe Implementation brms brms package implements Regularized Horseshoe prior using function horseshoe(...). regularization term (“slab”) added standard Horseshoe ensure robustness improve computational stability Stan. Horseshoe Function Key Arguments Horseshoe prior set using function call: Relationship Justification: \\(\\mathbf{brms}\\) function offers two primary ways set global shrinkage level, controls overall sparsity model: Fixed Global Scale: Using \\(\\mathbf{scale\\_global}\\) argument, often set \\(\\mathbf{1.0}\\) general-purpose default. value internally multiplied residual standard deviation (\\(\\sigma\\)) autoscale = TRUE. Elicited Global Scale (Recommended): Using \\(\\mathbf{par\\_ratio}\\) argument, allows user specify prior belief sparsity model (.e., expected number true non-zero coefficients, \\(p_{eff}\\)). recommended approach accounts number coefficients \\(L\\) sample size \\(N\\) determine optimal \\(\\tau_0\\). Choosing \\(\\mathbf{scale\\_global}\\) \\(\\mathbf{par\\_ratio}\\): choice \\(\\tau_0\\) (controlled \\(\\mathbf{scale\\_global}\\) \\(\\mathbf{par\\_ratio}\\)) crucial, sets overall magnitude shrinkage. Fixed Default (\\(\\mathbf{scale\\_global=1}\\)): Use : want simple, robust, general-purpose prior without explicit sparsity knowledge. Caveat: May result insufficient shrinkage true number non-zero coefficients small. Elicited Sparsity (\\(\\mathbf{par\\_ratio}\\)): Calculation: \\(\\mathbf{par\\_ratio} = \\frac{p_{eff}}{L - p_{eff}}\\), \\(p_{eff}\\) expected number non-zero coefficients \\(L\\) total number coefficients. Use : strong prior belief number relevant effects. generally preferred adaptive shrinkage scales \\(\\tau_0\\) appropriately. Recommendation: \\(\\mathbf{scale\\_global=1}\\) quick default, specifying \\(\\mathbf{par\\_ratio}\\) based expert knowledge expected sparsity theoretically sound adaptive method setting global shrinkage scale.","code":"horseshoe(df = 1, scale_global = 1, df_global = 1, scale_slab = 2, df_slab = 4, par_ratio = NULL, autoscale = TRUE, main = FALSE)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"r2d2-prior-shrunk-terms","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.8 Prior Specifications","what":"R2D2 Prior (Shrunk Terms)","title":"Statistical Specifications","text":"Concept: prior uniquely derived first placing prior model’s coefficient determination, \\(R^2\\), quantifies proportion variance explained predictors. arguably intuitive specifying priors directly coefficients. Hierarchical Specification (Marginal Version): \\[ \\begin{aligned} \\beta_{2,l} &\\sim DE(\\sigma \\sqrt{\\phi_l \\omega / 2}) \\quad (\\text{Double-Exponential/Laplace kernel}) \\\\ \\boldsymbol{\\phi} &= (\\phi_1, \\dots, \\phi_L) \\sim \\text{Dirichlet}(a_\\pi, \\dots, a_\\pi) \\quad (\\text{Local shrinkage}) \\\\ \\omega &\\sim \\text{Beta-Prime}(, b) \\quad (\\text{Global shrinkage}) \\end{aligned} \\] equivalent assuming proportion variance explained interaction terms follows \\(R^2 = \\frac{\\omega}{1+\\omega} \\sim \\text{Beta}(,b)\\). Justification Hyperparameters: Zhang et al. (2022) provide clear guidance. fully automatic approach set \\(b=0.5\\) achieve Cauchy-like heavy tails. concentration parameter \\(a_\\pi\\) controls sparsity. smaller \\(a_\\pi\\) (e.g., 0.2) implies higher shrinkage, concentrating prior variance fewer coefficients, larger \\(a_\\pi\\) (e.g., 0.5) spreads variance evenly, implying lower shrinkage. Default Recommendation: Set \\(b=0.5\\) offer options user based desired shrinkage strength: High Shrinkage: \\(a_\\pi=0.2\\) Low Shrinkage: \\(a_\\pi=0.5\\) R2D2 Prior Implementation brms brms package implements prior using function R2D2(...), providing high-level parametrization intuitive setting parameters \\(\\), \\(b\\), \\(a_\\pi\\) directly. function translates desired \\(\\mathbf{R^2}\\) properties shrinkage strength underlying prior distribution’s parameters. R2D2 Function Key Arguments R2D2 prior set using function call: Relationship Justification: brms function parameters directly related justified hierarchical parameters: \\(\\mathbf{cons\\_D2}\\) parameter direct counterpart sparsity parameter \\(\\mathbf{a_{\\pi}}\\). default recommendation \\(\\mathbf{cons\\_D2 = 0.5}\\) corresponds precisely \\(\\mathbf{a_{\\pi}=0.5}\\) low shrinkagesetting. \\(\\mathbf{mean\\_R2}\\) \\(\\mathbf{prec\\_R2}\\) arguments define \\(\\text{Beta}(,b)\\) prior \\(R^2\\), : \\[= \\text{mean_R2} \\times \\text{prec_R2}\\] \\[b = (1 - \\text{mean_R2}) \\times \\text{prec_R2}\\] choice \\(\\mathbf{prec\\_R2=2}\\) (default) alongside \\(\\mathbf{mean\\_R2=0.5}\\) results \\(=1\\) \\(b=1\\), Uniform prior \\(R^2 \\sim \\text{Beta}(1, 1)\\), representing maximally weak prior belief global fit. essential \\(\\mathbf{b=0.5}\\) setting Cauchy-like heavy tails (preventing -shrinkage) implicitly handled R2D2 function’s underlying structure require manual specification. Choosing \\(\\mathbf{mean\\_R2}\\) \\(\\mathbf{prec\\_R2}\\) : Choosing parameters involves quantifying prior knowledge model’s overall predictive power observing data. define \\(\\text{Beta}(,b)\\) distribution \\(R^2\\). Choosing \\(\\mathbf{mean\\_R2}\\) (Prior Expected \\(R^2\\)): sets center prior belief. Default (0.5): Use strong prior knowledge. implies neutral expectation fixed effects explain half variance. Informative Low (e.g., 0.1 0.3): Use expect weak noisy relationship. Informative High (e.g., 0.7 0.9): Use expect highly predictive model based strong prior evidence. Choosing \\(\\mathbf{prec\\_R2}\\) (Prior Confidence \\(R^2\\)): determines concentration certainty Beta prior around chosen \\(\\text{mean_R2}\\). Resulting Beta Parameters (\\(\\text{mean_R2}=0.5\\)) Recommendation: Default \\(\\mathbf{mean\\_R2 = 0.5}\\) \\(\\mathbf{prec\\_R2 = 2}\\) provides flexible, weakly informative setting \\(R^2\\), generally recommended unless strong prior knowledge dictates otherwise.","code":"R2D2(mean_R2 = 0.5, prec_R2 = 2, cons_D2 = 0.5, autoscale = TRUE, main = FALSE)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"normal-hierarchical-prior-for-one-variable-at-a-time-model","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.8 Prior Specifications","what":"Normal Hierarchical Prior (for One-Variable-at-a-Time Model)","title":"Statistical Specifications","text":"standard hierarchical model subgroup analysis, assumes treatment effects levels within subgrouping variable drawn common normal distribution. ’s less complex Horseshoe R2D2 priors provides effective shrinkage, especially number subgroup levels small. Hierarchical Specification: given subgrouping variable \\(j\\) levels \\(k=1, \\dots, K_j\\): \\[\\begin{aligned} \\beta_{2,j,k} &\\sim \\mathcal{N}(\\mu_{2,j}, \\tau^2_{2,j}) \\quad (\\text{Level-specific treatment effects}) \\\\     \\mu_{2,j} &\\sim \\mathcal{N}(0, s^2) \\quad (\\text{Common mean effect}) \\\\ \\tau_{2,j} &\\sim \\text{Half-Normal}() \\quad (\\text{-subgroup heterogeneity}) \\end{aligned}     \\] Justification Hyperparameters: key setting scale parameter Half-Normal prior -subgroup standard deviation, \\(\\tau_{2,j}\\), controls degree shrinkage. recommended Bornkamp (2025), can linked planned treatment effect ( \\(\\delta_{plan}\\)) trial protocol, making prior choice interpretable consistent across different endpoints. choice implies prior plausible difference treatment effects two subgroups.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-estimation","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"Estimation (MCMC)","title":"Statistical Specifications","text":"joint posterior distribution parameters complex closed-form solution. use Markov Chain Monte Carlo (MCMC) methods draw samples distribution. Specifically, package uses -U-Turn Sampler (NUTS), efficient variant Hamiltonian Monte Carlo (HMC), implemented Stan via brms package. output set posterior samples (e.g., 4000 draws) representing joint posterior distribution.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-standardization","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"Standardization for Marginal Effects (G-computation)","title":"Statistical Specifications","text":"obtain interpretable marginal effects subgroup, package implements standardization (G-computation) procedure. process repeated MCMC draw generate full posterior distribution marginal effect. single MCMC draw, step--step process : Select Parameters: Take one draw joint posterior distribution model parameters (\\(\\boldsymbol{\\beta}\\)’s, \\(\\sigma\\), \\(\\phi\\), etc.). Create Counterfactuals: every patient \\(\\) original dataset, create two scenarios: Scenario : Patient \\(\\)’s covariates, treatment \\(s_i=0\\) (Control). Scenario B: Patient \\(\\)’s covariates, treatment \\(s_i=1\\) (Treatment). Scenario (control), treatment--subgroup interaction dummies set 0. Scenario B (treatment), interaction dummy trt_subgroupLEVEL set 1 patient belongs subgroup level, 0 otherwise. Predict Outcomes: Use model formula parameters Step 1 predict outcome every patient Scenario (\\(\\hat{\\mu}_{,0}\\)) Scenario B (\\(\\hat{\\mu}_{,1}\\)). brms::posterior_epred() function automatically handles computation using model’s design matrix parameters. Average within Subgroups: subgroup interest \\(l\\) (e.g., “Female”): Calculate average predicted outcome control: \\(\\hat{\\mu}_{l,0} = \\text{mean}(\\hat{\\mu}_{,0})\\) \\(\\) \\(x_{il}=1\\). Calculate average predicted outcome treatment: \\(\\hat{\\mu}_{l,1} = \\text{mean}(\\hat{\\mu}_{,1})\\) \\(\\) \\(x_{il}=1\\). Calculate Effect Measure: Compute marginal effect subgroup \\(l\\) averaged predictions. depends endpoint type: Continuous: Mean Difference = \\(\\hat{\\mu}_{l,1} - \\hat{\\mu}_{l,0}\\). Binary: Odds Ratio = \\(\\frac{\\hat{\\mu}_{l,1} / (1 - \\hat{\\mu}_{l,1})}{\\hat{\\mu}_{l,0} / (1 - \\hat{\\mu}_{l,0})}\\) (\\(\\hat{\\mu}\\) predicted probability). Count: Rate Ratio = \\(\\hat{\\mu}_{l,1} / \\hat{\\mu}_{l,0}\\) (\\(\\hat{\\mu}\\) predicted rate). Time--Event: Average Hazard Ratio (AHR). complex, requires predicting full survival curve \\(S_i(t)\\) patient. marginal survival curves \\(\\hat{S}_{l,0}(t)\\) \\(\\hat{S}_{l,1}(t)\\) calculated, AHR computed , marginal curves may proportional. Repeat: process (Steps 1-5) repeated MCMC draws, yielding full posterior distribution (e.g., 4000 values) marginal effect subgroup. final point estimate (median) 95% credible interval taken distribution.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-functions","dir":"Articles","previous_headings":"","what":"Mapping of Statistical Methods to bonsaiforest2 Functions","title":"Statistical Specifications","text":"section connects statistical methodology (Section 3) package functions. package provides three-level architecture: high-level user interface functions, modular worker functions advanced control, internal helpers.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"high-level-user-interface","dir":"Articles","previous_headings":"4 Mapping of Statistical Methods to bonsaiforest2 Functions","what":"High-Level User Interface","title":"Statistical Specifications","text":"main functions users typically call analysis workflow: run_brms_analysis() Maps : Sections 3.4 (Global Model), 3.5 (One-Variable---Time Model), 3.7 (Endpoints), 3.8 (Priors), 3.9 (Estimation). Internally calls prepare_formula_model() construct three-component brmsformula structure validate inputs. calls fit_brms_model() run MCMC sampling via brms::brm() Stan. Stores essential metadata (treatment variable, response type, original data) attributes fitted model object downstream analysis. Handles formula components: unshrunktermeffect (unshrunk terms), shprogeffect (shrunk prognostic), shpredeffect (shrunk predictive). Returns brmsfit object enriched attributes. summary_subgroup_effects() Maps : Section 3.10 (Standardization / G-computation). Internally calls estimate_subgroup_effects() perform G-computation procedure. Automatically extracts treatment variable, response type, data model attributes (set fit_brms_model()). Auto-detects subgroups formula components searching treatment interactions unshrunktermeffect, shprogeffect, shpredeffect. Returns subgroup_summary S3 object containing estimates, credible intervals, metadata. plot() Maps : Final visualization Section 3.10 results. Action: S3 method subgroup_summary objects. Generates publication-ready forest plots marginal effect estimates median 95% credible intervals.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"advancedmodular-interface","dir":"Articles","previous_headings":"4 Mapping of Statistical Methods to bonsaiforest2 Functions","what":"Advanced/Modular Interface","title":"Statistical Specifications","text":"users requiring fine-grained control modeling process, package exposes intermediate worker functions: prepare_formula_model() data: Dataset containing variables response_formula: Response specification (e.g., outcome ~ trt Surv(time, status) ~ trt) unshrunk_terms_formula: Unshrunk terms specification (may include main effects treatment interactions) shrunk_prognostic_formula: Prognostic main effects regularized (optional) shrunk_predictive_formula: Treatment interactions regularized (optional) response_type: One \"binary\", \"count\", \"continuous\", \"survival\" stratification_formula: Stratification variable (optional) unshrunktermeffect: Unshrunk terms weakly informative priors. Can include prognostic effects (intercept, main treatment effect, pre-specified covariates) predictive effects (treatment interactions). Specified via unshrunk_terms_formula. shprogeffect: Shrunk prognostic effects strong regularization priors. Specified via shrunk_prognostic_formula. shpredeffect: Shrunk predictive effects (treatment interactions) strong regularization priors. Specified via shrunk_predictive_formula. Supports flexible interaction syntax: colon notation (trt:subgroup), star notation (trt*subgroup), random effects notation ((trt || subgroup)), can mixed model. Validates model hierarchy: checks predictive terms corresponding prognostic main effects, issuing warnings violations detected (star notation automatically includes main effects excluded check). Applies automatic contrast coding: one-hot encoding shrunk terms (levels represented exchangeability) dummy encoding unshrunk terms (reference level dropped). Constructs design matrices \\(\\mathbf{X_n}, \\mathbf{X_p}, \\mathbf{Z_n}, \\mathbf{Z_p}, \\mathbf{U}\\) formula specifications. Returns list containing complete brmsformula, transformed data proper contrasts, response type, treatment variable name, Stan parameter names, metadata. fit_brms_model() Takes output prepare_formula_model() manually specified formula components. Assigns priors formula component based user specifications defaults. Calls brms::brm() compile Stan code run MCMC chains. Handles endpoint-specific configurations (Section 3.7): likelihood functions, link functions, stratification. Attaches essential metadata attributes fitted model use estimate_subgroup_effects(). estimate_subgroup_effects() MCMC draw, creates counterfactual datasets (patients treated vs. control). Generates posterior predictions using brms::posterior_epred() brms::posterior_survfit(). Averages predictions within subgroup obtain marginal expected outcomes. Continuous: Mean difference (\\(\\hat{\\mu}_{l,1} - \\hat{\\mu}_{l,0}\\)) Binary: Odds ratio Count: Rate ratio Survival: Average hazard ratio (AHR) Auto-detects subgroups parsing formula components treatment interactions (colon : syntax pipe || syntax random effects). Returns raw posterior draws summary statistics (median, credible intervals).","code":""},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/authors.html","id":null,"dir":"","previous_headings":"","what":"Authors","title":"Authors and Citation","text":"Miriam Pedrera Gomez. Author, maintainer. Isaac Gravestock. Author. Marcel Wolbers. Author.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/authors.html","id":"citation","dir":"","previous_headings":"","what":"Citation","title":"Authors and Citation","text":"Pedrera Gomez M, Gravestock , Wolbers M (2026). bonsaiforest2: Flexible Bayesian Shrinkage Based Forest Plots. R package version 0.1.0, https://openpharma.github.io/bonsaiforest2/.","code":"@Manual{,   title = {bonsaiforest2: Flexible Bayesian Shrinkage Based Forest Plots},   author = {Miriam {Pedrera Gomez} and Isaac Gravestock and Marcel Wolbers},   year = {2026},   note = {R package version 0.1.0},   url = {https://openpharma.github.io/bonsaiforest2/}, }"},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/index.html","id":"overview","dir":"","previous_headings":"","what":"Overview","title":"Flexible Bayesian Shrinkage Based Forest Plots","text":"bonsaiforest2 package used Bayesian shrinkage estimation subgroup treatment effects randomized clinical trials. supports one-way models (random effects) fixed effects modeling approaches estimating treatment--subgroup interactions, built-support continuous, binary, time--event (Cox), count outcomes. package allows usage state---art shrinkage priors including Regularized Horseshoe R2D2, combined standardization (G-computation) provide interpretable marginal treatment effects. leveraging brms Stan, bonsaiforest2 provides practical tool obtaining stable reliable subgroup effect estimates exploratory confirmatory analyses.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/index.html","id":"installation","dir":"","previous_headings":"","what":"Installation","title":"Flexible Bayesian Shrinkage Based Forest Plots","text":"UPDATE USUAL INSTALLATION can install development version bonsaiforest2 GitLab repository:","code":"# install.packages(\"remotes\")  remotes::install_github(\"openpharma/bonsaiforest2\")"},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/index.html","id":"modeling-approaches","dir":"","previous_headings":"Key Concepts","what":"Modeling Approaches","title":"Flexible Bayesian Shrinkage Based Forest Plots","text":"bonsaiforest2 supports two main approaches subgroup analysis:","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/index.html","id":"fixed-effects-models","dir":"","previous_headings":"Key Concepts > Modeling Approaches","what":"Fixed Effects Models","title":"Flexible Bayesian Shrinkage Based Forest Plots","text":"Fit single unified model treatment--subgroup interactions specified fixed effects using colon notation (e.g., ~ 0 + trt:subgroupvar1 + trt:subgroupvar2 + ...) Treat subgroups symmetrically one-hot encoding Recommended: Use approach applications","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/index.html","id":"one-way-models-random-effects","dir":"","previous_headings":"Key Concepts > Modeling Approaches","what":"One-way Models (Random Effects)","title":"Flexible Bayesian Shrinkage Based Forest Plots","text":"Fit random effects treatment slopes varying subgroup Use pipe-pipe notation (e.g., ~ (0 + trt || subgroupvar)) estimate treatment effects varying subgroup subgroup gets treatment effect automatic pooling via random effects","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/index.html","id":"shrinkage-framework","dir":"","previous_headings":"Key Concepts","what":"Shrinkage Framework","title":"Flexible Bayesian Shrinkage Based Forest Plots","text":"model decomposes three components: Unshrunk terms (unshrunktermeffect): Main effects weakly informative priors Shrunk prognostic effects (shprogeffect): Baseline covariate effects strong regularization Shrunk predictive effects (shpredeffect): Treatment--subgroup interactions strong regularization","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/index.html","id":"prior-specification","dir":"","previous_headings":"Key Concepts","what":"Prior Specification","title":"Flexible Bayesian Shrinkage Based Forest Plots","text":"package supports flexible prior specification model components. must specify four priors: - intercept_prior: Prior intercept (example: \"normal(0, 10)\") - unshrunk_prior: Prior unshrunk terms/main effects (example: \"normal(0, 2.5)\") - shrunk_prognostic_prior: Prior shrunk prognostic effects/baseline covariates (example: \"horseshoe(scale_global = 1)\") - shrunk_predictive_prior: Prior shrunk predictive effects/treatment interactions (example: \"horseshoe(scale_global = 0.5)\") one-way models (random effects), random effect SDs automatically use normal(0, 1) priors.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/index.html","id":"response-types","dir":"","previous_headings":"Key Concepts","what":"Response Types","title":"Flexible Bayesian Shrinkage Based Forest Plots","text":"package supports four outcome types: - continuous: Linear regression residual SD - binary: Logistic regression - count: Poisson negative binomial regression - survival: Cox proportional hazards model","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/index.html","id":"quick-start-example","dir":"","previous_headings":"","what":"Quick Start Example","title":"Flexible Bayesian Shrinkage Based Forest Plots","text":"example demonstrates Bayesian shrinkage estimation treatment effects across subgroups using fixed effects model Regularized Horseshoe prior. simulate data real treatment effect heterogeneity across five subgrouping variables.","code":"library(bonsaiforest2)  # 1. Simulate continuous outcome trial data with treatment heterogeneity set.seed(123) n <- 500 dat <- data.frame(   y    = rnorm(n, mean = 50, sd = 15),   trt  = rep(0:1, length.out = n),   x1   = factor(sample(c(\"A\", \"B\"), n, replace = TRUE)),   x2   = factor(sample(c(\"A\", \"B\", \"C\"), n, replace = TRUE)),   x3   = factor(sample(c(\"A\", \"B\"), n, replace = TRUE)),   x4   = factor(sample(c(\"A\", \"B\"), n, replace = TRUE)),   x5   = factor(sample(c(\"A\", \"B\"), n, replace = TRUE)) )  # Add baseline effect and heterogeneous treatment effects by subgroup trt_effect <- dat$trt * (   0.35 +                                           # Base treatment effect   0.35 * (as.numeric(dat$x1 == \"B\") - 0.35)       # Heterogeneity by x1 ) dat$y <- trt_effect + rnorm(n, 0, 1.2)  # 2. Fit fixed effects model with heterogeneous shrinkage fit_fixed <- run_brms_analysis(   data = dat,   response_type = \"continuous\",   response_formula = y ~ trt,   unshrunk_terms_formula = ~ x1 + x2 + x3 + x4 + x5,   shrunk_prognostic_formula = NULL,   shrunk_predictive_formula = ~ 0 + trt:x1 + trt:x2 + trt:x3 + trt:x4 + trt:x5,   intercept_prior = \"normal(50, 15)\",   unshrunk_prior = \"normal(0, 5)\",   shrunk_prognostic_prior = NULL,   shrunk_predictive_prior = \"horseshoe(1)\",   chains = 2, iter = 1000, warmup = 500,   backend = \"cmdstanr\", refresh = 0 ) #> Running MCMC with 2 sequential chains... #>  #> Chain 1 finished in 2.1 seconds. #> Chain 2 finished in 2.0 seconds. #>  #> Both chains finished successfully. #> Mean chain execution time: 2.0 seconds. #> Total execution time: 4.2 seconds.  # 3. Extract and visualize marginal treatment effects by subgroup subgroup_effects <- summary_subgroup_effects(fit_fixed) print(subgroup_effects) #> $estimates #> # A tibble: 11 × 4 #>    Subgroup Median CI_Lower CI_Upper #>    <chr>     <dbl>    <dbl>    <dbl> #>  1 x1: A     0.212  -0.113     0.501 #>  2 x1: B     0.554   0.249     0.908 #>  3 x2: A     0.412   0.161     0.739 #>  4 x2: B     0.325  -0.0227    0.581 #>  5 x2: C     0.398   0.140     0.701 #>  6 x3: A     0.376   0.120     0.616 #>  7 x3: B     0.369   0.127     0.609 #>  8 x4: A     0.382   0.163     0.632 #>  9 x4: B     0.360   0.0824    0.619 #> 10 x5: A     0.401   0.168     0.703 #> 11 x5: B     0.344   0.0918    0.585 #>  #> $response_type #> [1] \"continuous\" #>  #> $ci_level #> [1] 0.95 #>  #> $trt_var #> [1] \"trt\" #>  #> attr(,\"class\") #> [1] \"subgroup_summary\" plot(subgroup_effects)"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/bonsaiforest2-package.html","id":null,"dir":"Reference","previous_headings":"","what":"bonsaiforest2: Flexible Bayesian Shrinkage Based Forest Plots — bonsaiforest2-package","title":"bonsaiforest2: Flexible Bayesian Shrinkage Based Forest Plots — bonsaiforest2-package","text":"extension 'bonsaiforest' package provides increased flexibility prior selection modeling options. supports four types endpoints simplifies fitting interpretation Bayesian models subgroup analysis. Leveraging 'brms', distinguishes prognostic predictive factors using differential shrinkage priors generates publication-ready forest plots.","code":""},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/reference/bonsaiforest2-package.html","id":"author","dir":"Reference","previous_headings":"","what":"Author","title":"bonsaiforest2: Flexible Bayesian Shrinkage Based Forest Plots — bonsaiforest2-package","text":"Maintainer: Miriam Pedrera Gomez miriam.pedrera_gomez@roche.com Authors: Isaac Gravestock isaac.gravestock@roche.com Marcel Wolbers marcel.wolbers@roche.com","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/combine_summaries.html","id":null,"dir":"Reference","previous_headings":"","what":"Combine Multiple Subgroup Summaries for Comparison Plotting — combine_summaries","title":"Combine Multiple Subgroup Summaries for Comparison Plotting — combine_summaries","text":"Combines estimates multiple subgroup summary objects single summary object can plotted compare models.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/combine_summaries.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Combine Multiple Subgroup Summaries for Comparison Plotting — combine_summaries","text":"","code":"combine_summaries(summary_list)"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/combine_summaries.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Combine Multiple Subgroup Summaries for Comparison Plotting — combine_summaries","text":"summary_list Named list subgroup_summary objects.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/combine_summaries.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Combine Multiple Subgroup Summaries for Comparison Plotting — combine_summaries","text":"subgroup_summary. Combined object \"Model\" column estimates.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/combine_summaries.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Combine Multiple Subgroup Summaries for Comparison Plotting — combine_summaries","text":"","code":"if (FALSE) { # \\dontrun{ summary1 <- summary_subgroup_effects(brms_fit = model1) summary2 <- summary_subgroup_effects(brms_fit = model2)  combined <- combine_summaries(list(   \"One-way model\" = summary1,   \"Global\" = summary2 )) plot(combined) } # }"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/estimate_subgroup_effects.html","id":null,"dir":"Reference","previous_headings":"","what":"Estimate Marginal Subgroup Treatment Effects — estimate_subgroup_effects","title":"Estimate Marginal Subgroup Treatment Effects — estimate_subgroup_effects","text":"function uses counterfactual, marginal approach based posterior predictive distribution. averages covariates provide robust estimates subgroup-specific effects.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/estimate_subgroup_effects.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Estimate Marginal Subgroup Treatment Effects — estimate_subgroup_effects","text":"","code":"estimate_subgroup_effects(   brms_fit,   trt_var = NULL,   data = NULL,   subgroup_vars = \"auto\",   response_type = NULL,   ndraws = NULL,   conf = 0.95 )"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/estimate_subgroup_effects.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Estimate Marginal Subgroup Treatment Effects — estimate_subgroup_effects","text":"brms_fit brmsfit object. Fitted model object fit_brms_model() run_brms_analysis(). Must contain necessary attributes extracting treatment variable response type information. trt_var character string NULL. Treatment variable name. NULL, automatically extracted model attributes (set fit_brms_model()). Must binary variable coded 0/1 dataset. data data frame NULL. Dataset used model fitting. NULL, automatically extracted model attributes (set fit_brms_model()). dataset used generating counterfactual predictions. subgroup_vars character vector \"auto\". Subgroup variable names estimate treatment effects. \"auto\" (default), automatically detects treatment interaction terms (colon syntax) random effect grouping factors (pipe syntax) formula components (unshrunktermeffect, shprogeffect, shpredeffect). response_type character string NULL. Outcome type, one \"binary\", \"count\", \"continuous\", \"survival\". NULL, automatically extracted model attributes (set fit_brms_model()). determines appropriate scale effect estimation. ndraws integer NULL. Number posterior draws use estimation. NULL (default), available posterior draws used. Reducing can speed computation cost precision. conf numeric scalar. Credible interval confidence level. Default 0.95 (corresponding 95% credible intervals). Example: use 0.90 90% credible intervals.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/estimate_subgroup_effects.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Estimate Marginal Subgroup Treatment Effects — estimate_subgroup_effects","text":"list two named elements: estimates tibble row represents subgroup (\"Overall\" effect), columns Subgroup, Median, CI_Lower, CI_Upper posterior distribution draws data.frame containing posterior draws subgroup","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/estimate_subgroup_effects.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Estimate Marginal Subgroup Treatment Effects — estimate_subgroup_effects","text":"post-processing function estimates marginal treatment effects specified subgroups fitted brmsfit object.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/fit_brms_model.html","id":null,"dir":"Reference","previous_headings":"","what":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","title":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","text":"function serves wrapper fit Bayesian model using brms package. uses formula data prepared prepare_formula_model simplifies process assigning complex priors different non-linear components model.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/fit_brms_model.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","text":"","code":"fit_brms_model(   prepared_model,   intercept_prior = NULL,   unshrunk_prior = NULL,   shrunk_prognostic_prior = NULL,   shrunk_predictive_prior = NULL,   stanvars = NULL,   ... )"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/fit_brms_model.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","text":"prepared_model list object. Object returned prepare_formula_model() containing elements: formula (brmsformula object), data (modified data.frame appropriate contrast coding), response_type (character string), trt_var (character string). trt_var element stored attribute fitted model use downstream functions like estimate_subgroup_effects(). intercept_prior character string, brmsprior object, NULL. Prior specification model intercept unshrunktermeffect component. used survival models (Cox models intercept). unshrunk_prior character string, brmsprior object, NULL. Prior specification unshrunk terms unshrunktermeffect component (excludes intercept). main effects interactions regularization desired. shrunk_prognostic_prior character string, brmsprior object, NULL. Prior specification regularized prognostic effects shprogeffect component. main effects strong shrinkage/regularization desired. shrunk_predictive_prior character string, brmsprior object, NULL. Prior specification regularized predictive effects (treatment interactions) shpredeffect component. treatment interactions strong shrinkage/regularization desired. stanvars stanvars object NULL. Custom Stan code created via brms::stanvar() implementing hierarchical priors advanced Stan functionality. See brms documentation details creating stanvars objects. ... Additional arguments passed brms::brm(). Common arguments include chains (number MCMC chains), iter (number iterations per chain), cores (number CPU cores use), backend (Stan backend), refresh (progress update frequency).","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/fit_brms_model.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","text":"brmsfit. Fitted Bayesian model object attributes: response_type (character), model_data (data.frame), trt_var (character) downstream analysis functions.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/fit_brms_model.html","id":"prior-specification","dir":"Reference","previous_headings":"","what":"Prior Specification","title":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","text":"Priors specified separately model component using dedicated parameters. provides explicit control prevents errors. function accepts prior definitions character strings (e.g., \"normal(0, 2.5)\") brmsprior objects complex hierarchical parameter-specific priors. Available prior parameters: intercept_prior: Prior intercept unshrunk component unshrunk_prior: Prior unshrunk terms (main effects trust) shrunk_prognostic_prior: Prior shrunk prognostic effects (regularized) shrunk_predictive_prior: Prior shrunk predictive effects (regularized) Default Priors Response Type Model Structure: specify priors, function uses sensible defaults adapt model structure: response types (continuous, binary, count, survival): intercept_prior: NULL (brms default) unshrunk_prior: NULL (brms default) shrunk_prognostic_prior: horseshoe(1) (strong regularization) shrunk_predictive_prior: horseshoe(1) (strong regularization) models random effects (One-way model) (pipe-pipe || syntax): Random effects shrunk predictive terms (e.g., ~ (0 + trt || subgroup)) automatically receive normal(0, 1) priors standard deviation scale coefficient group combination, regardless shrunk_predictive_prior setting. example: prior(normal(0, 1), class = \"sd\", coef = \"trt\", group = \"subgroup\") Example:","code":"fit_brms_model(   prepared_model = prepared,   unshrunk_prior = \"normal(0, 2.5)\",   shrunk_prognostic_prior = \"horseshoe(1)\",   shrunk_predictive_prior = \"horseshoe(1)\" )"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/fit_brms_model.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","text":"","code":"if (require(\"brms\") && require(\"survival\")) {   # 1. Create Sample Data   set.seed(123)   n <- 100   sim_data <- data.frame(     time = round(runif(n, 1, 100)),     status = sample(0:1, n, replace = TRUE),     trt = sample(0:1, n, replace = TRUE),     age = rnorm(n, 50, 10),     region = sample(c(\"A\", \"B\"), n, replace = TRUE),     subgroup = sample(c(\"S1\", \"S2\", \"S3\"), n, replace = TRUE)   )   sim_data$trt <- factor(sim_data$trt, levels = c(0, 1))   sim_data$region <- as.factor(sim_data$region)   sim_data$subgroup <- as.factor(sim_data$subgroup)    # 2. Prepare the formula and data using colon syntax with recommended ~ 0 + for shrunk terms   prepared_model <- prepare_formula_model(     data = sim_data,     response_formula = Surv(time, status) ~ trt,     shrunk_predictive_formula = ~ 0 + trt:subgroup,     unshrunk_terms_formula = ~ age,     shrunk_prognostic_formula = ~ 0 + subgroup,     response_type = \"survival\",     stratification_formula = ~ region   )    # 2b. Alternatively, using one-way model (random effects) with pipe-pipe notation   # prepared_model <- prepare_formula_model(   #   data = sim_data,   #   response_formula = Surv(time, status) ~ trt,   #   unshrunk_terms_formula = ~ age,   #   shrunk_predictive_formula = ~ (0 + trt || subgroup),   #   response_type = \"survival\",   #   stratification_formula = ~ region   # )    # 3. Fit the model   if (FALSE) { # \\dontrun{   fit <- fit_brms_model(     prepared_model = prepared_model,     unshrunk_prior = \"normal(0, 2)\",     shrunk_prognostic_prior = \"horseshoe(scale_global = 1)\",     shrunk_predictive_prior = \"horseshoe(scale_global = 1)\",     backend = \"cmdstanr\",     chains = 2, iter = 1000, warmup = 500, refresh = 0   )    print(fit)   } # } } #> Loading required package: brms #> Loading required package: Rcpp #> Loading 'brms' package (version 2.23.0). Useful instructions #> can be found by typing help('brms'). A more detailed introduction #> to the package is available through vignette('brms_overview'). #>  #> Attaching package: ‘brms’ #> The following object is masked from ‘package:stats’: #>  #>     ar #> Loading required package: survival #>  #> Attaching package: ‘survival’ #> The following object is masked from ‘package:brms’: #>  #>     kidney #> Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz(). #> Applying stratification: estimating separate baseline hazards by 'region'."},{"path":"https://openpharma.github.io/bonsaiforest2/reference/plot.subgroup_summary.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","title":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","text":"Creates forest plot subgroup_summary object list objects.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/plot.subgroup_summary.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","text":"","code":"# S3 method for class 'subgroup_summary' plot(x, x_lab = NULL, title = NULL, ...)"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/plot.subgroup_summary.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","text":"x subgroup_summary list. Object created summary_subgroup_effects(), named list objects comparison plots. x_lab character(1) NULL. Custom label x-axis. title character(1) NULL. Custom title plot. ... Additional arguments (currently unused).","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/plot.subgroup_summary.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","text":"ggplot. Forest plot visualization subgroup treatment effects.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/plot.subgroup_summary.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","text":"function creates forest plots subgroup treatment effects. supports two modes: Single Model Plot: x single subgroup_summary object, creates traditional forest plot estimates confidence intervals displayed text. Multiple Model Comparison: x named list subgroup_summary objects, creates comparative plot different models distinguished colors shapes. useful comparing one-way models vs global models, different prior specifications, sensitivity analyses.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/plot.subgroup_summary.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","text":"","code":"if (FALSE) { # \\dontrun{ # Single model plot summary1 <- summary_subgroup_effects(brms_fit = model1) plot(summary1, title = \"Subgroup Effects\")  # Multiple model comparison summary2 <- summary_subgroup_effects(brms_fit = model2) comparison <- list(   \"Model 1\" = summary1,   \"Model 2\" = summary2 ) plot(comparison, title = \"Model Comparison\") } # }"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":null,"dir":"Reference","previous_headings":"","what":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"function serves pre-processor building complex Bayesian models brms package. automates construction multi-part, non-linear formula classifying covariates three distinct categories: unshrunk terms, shrunk prognostic, shrunk predictive.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"","code":"prepare_formula_model(   data,   response_formula,   unshrunk_terms_formula = NULL,   shrunk_prognostic_formula = NULL,   shrunk_predictive_formula = NULL,   response_type = c(\"binary\", \"count\", \"continuous\", \"survival\"),   stratification_formula = NULL )"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"data data frame. Dataset containing necessary variables model fitting. Must include response variable, treatment variable, covariates specified formula arguments. data modified (contrast coding applied) returned use model fitting. response_formula formula object. response specification defining outcome variable treatment. Examples: outcome ~ trt continuous outcomes, n_events ~ trt + offset(log(days)) count outcomes, Surv(time, status) ~ trt survival models. treatment variable (right-hand side) automatically extracted converted numeric binary variable (0/1). unshrunk_terms_formula formula object NULL. Formula specifying unshrunk terms unshrunktermeffect component. May include main effects treatment interactions without regularization. Supports three syntaxes can combined: colon notation (e.g., ~ age + sex + trt:biomarker), star notation (e.g., ~ age + trt*biomarker), random effects notation (e.g., ~ age + (0+trt || biomarker)). shrunk_prognostic_formula formula object NULL. Formula specifying prognostic main effects regularized shprogeffect component. covariates shrinkage/regularization desired. Recommended: use ~ 0 + ... ~ -1 + ... syntax explicitly remove intercept apply one-hot encoding symmetric regularization across levels without privileging reference group. shrunk_predictive_formula formula object NULL. Formula specifying predictive terms (treatment interactions) regularized shpredeffect component. Supports three syntaxes can combined: colon notation (e.g., ~ 0 + trt:region), star notation (e.g., ~ 0 + trt*region), random effects notation (e.g., ~ (0 + trt || region)). Recommended: use ~ 0 + ... ~ -1 + ... syntax explicitly remove intercept apply one-hot encoding. response_type character string. Type outcome variable, one \"binary\", \"count\", \"continuous\", \"survival\". determines appropriate likelihood function link function model. stratification_formula formula object NULL. Formula specifying stratification variable (e.g., ~ strata_var) modeling baseline hazard (survival models) distributional parameters (models). survival models, estimates separate baseline hazard functions (bhaz) stratum. continuous models, models varying residual standard deviation (sigma). count models, models varying overdispersion (shape).","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"list six named elements: formula brmsformula object containing complete multi-part model specification data data.frame modified contrast coding (must used model fitting) response_type character(1) indicating outcome type (\"binary\", \"count\", \"continuous\", \"survival\") trt_var character(1) name treatment variable extracted response formula stan_variable_names list character vectors showing Stan parameter names model component has_intercept logical(1) indicating whether unshrunk formula includes intercept (TRUE) specified ~ 0 + ... (FALSE)","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"classification allows applying different priors (non-informative shrinkage) different parts model. function also prepares corresponding data using R's contrast coding system proper factor handling interactions.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"key-features","dir":"Reference","previous_headings":"","what":"Key Features","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"Multi-Part Formula Construction: generates brmsformula object three distinct linear components (unshrunktermeffect, shprogeffect, shpredeffect), combined non-linear model. allows assigning different priors component. Automated Interaction Handling: Predictive terms support three syntaxes can used together separately: colon notation (e.g., ~ trt:subgroup), star notation (e.g., ~ trt*subgroup), random effects notation (e.g., ~ (0 + trt || subgroup)). can mix syntaxes model (e.g., ~ trt:var1 + trt*var2 + (0 + trt || var3)). variables involved interactions converted factors appropriate contrasts (reference coding unshrunk, one-hot shrunk), enabling proper model fitting prediction new data without manual dummy variable creation. Hierarchical Integrity Check: predictive term like trt:subgroup specified, function checks whether corresponding prognostic effect subgroup included model. missing, issues warning message alert violation marginality principle, allowing decide whether add main effect. Note: Star notation (*) automatically includes main effects, variables excluded marginality check. Intelligent Defaults: main treatment variable automatically added unshrunk prognostic term specified elsewhere. also provides warnings resolves overlaps term accidentally specified multiple categories.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"survival-model-details-robust-spline-knot-calculation-","dir":"Reference","previous_headings":"","what":"Survival Model Details (Robust Spline Knot Calculation)","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"survival models (response_type = \"survival\"), function explicitly models baseline hazard using B-splines via brms::bhaz(). implements highly robust method calculating spline knots ensure stability: Boundary Definition: first establishes boundary knots taking range unique event times adding small buffer. creates \"safe\" interval placing internal knots. Internal Knot Placement: calculates internal knots using quantiles event times fall strictly within boundary knots. prevents knots placed exact edges data, can cause numerical instability. Fallback Sparse Data: unique event times calculate quantile-based knots, gracefully falls back placing evenly spaced knots within defined boundaries.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"data-transformation-and-contrast-coding","dir":"Reference","previous_headings":"","what":"Data Transformation and Contrast Coding","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"function returns modified data.frame must used subsequent calls fit_brms_model(), original data. transformations : Treatment variable: Converted numeric binary (0/1) avoid multi-level factor interactions. first level (alphabetically numerically) becomes 0, second becomes 1. Factor covariates: Automatic contrast coding based shrinkage type: Shrunk terms: One-hot encoding (factor levels represented). removes reference group treats subgroups symmetrically without privileging specific reference level (ensures exchangeability assumption). Recommended: explicitly remove intercept using ~ 0 + var ~ -1 + var syntax. specified, function still apply one-hot encoding may include redundant intercept complicate interpretation. Unshrunk terms: Dummy encoding (reference level dropped). Recommended: Use standard formula syntax ~ var intercept clarity proper reference coding. Custom contrasts: pre-specified contrasts via contrasts(data$var) <- <matrix> calling function, preserved. Otherwise, defaults applied based shrinkage category.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"stratification","dir":"Reference","previous_headings":"","what":"Stratification","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"stratification_formula_str argument allows estimating certain parameters separately different groups. behavior depends response_type: survival: Estimates separate baseline hazard function (bhaz) level stratification variable. continuous: Models residual standard deviation (sigma) varying across levels stratification variable. count: Models overdispersion parameter (shape) varying across levels stratification variable.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"","code":"if (require(\"brms\") && require(\"survival\")) {   # 1. Create Sample Data   set.seed(123)   n <- 100   sim_data <- data.frame(     time = round(runif(n, 1, 100)),     status = sample(0:1, n, replace = TRUE),     trt = sample(0:1, n, replace = TRUE),     age = rnorm(n, 50, 10),     region = sample(c(\"A\", \"B\"), n, replace = TRUE),     subgroup = sample(c(\"S1\", \"S2\", \"S3\"), n, replace = TRUE)   )   sim_data$trt <- factor(sim_data$trt, levels = c(0, 1))   sim_data$region <- as.factor(sim_data$region)   sim_data$subgroup <- as.factor(sim_data$subgroup)    # 2a. Example with colon interaction syntax (recommended: use ~ 0 + for shrunk terms)   prepared_model <- prepare_formula_model(     data = sim_data,     response_formula = Surv(time, status) ~ trt,     unshrunk_terms_formula = ~ age + subgroup,     shrunk_predictive_formula = ~ 0 + trt:subgroup,     response_type = \"survival\",     stratification_formula = ~ region   )    # 2b. Alternatively, using pipe-pipe (||) syntax   # prepared_model <- prepare_formula_model(   #   data = sim_data,   #   response_formula = Surv(time, status) ~ trt,   #   unshrunk_terms_formula = ~ age,   #   shrunk_predictive_formula = ~ (0 + trt || subgroup),   #   response_type = \"survival\",   #   stratification_formula = ~ region   # )    # 3. View the results   print(prepared_model$formula)   print(head(prepared_model$data)) } #> Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz(). #> Applying stratification: estimating separate baseline hazards by 'region'. #> Note: Marginality principle not followed - interaction term 'subgroup_onehot' is used without its main effect. Consider adding 'subgroup_onehot' to prognostic terms for proper model hierarchy. #> time | cens(1 - status) + bhaz(Boundary.knots = c(0.02, 99.98), knots = c(24, 46, 69), intercept = FALSE, gr = region) ~ unshrunktermeffect + shpredeffect  #> unshrunktermeffect ~ 0 + age + subgroup + trt #> shpredeffect ~ 0 + trt:subgroup_onehot #>   time status trt      age region subgroup subgroup_onehot #> 1   29      0   1 57.87739      B       S2              S2 #> 2   79      1   1 57.69042      B       S1              S1 #> 3   41      1   1 53.32203      B       S3              S3 #> 4   88      0   0 39.91623      B       S3              S3 #> 5   94      1   1 48.80547      A       S3              S3 #> 6    6      1   1 47.19605      A       S2              S2"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/run_brms_analysis.html","id":null,"dir":"Reference","previous_headings":"","what":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","title":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","text":"high-level wrapper function streamlines entire process preparing fitting complex Bayesian hierarchical model brms. serves convenient single entry point complete workflow.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/run_brms_analysis.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","text":"","code":"run_brms_analysis(   data,   response_formula,   response_type = c(\"binary\", \"count\", \"continuous\", \"survival\"),   unshrunk_terms_formula = NULL,   shrunk_prognostic_formula = NULL,   shrunk_predictive_formula = NULL,   stratification_formula = NULL,   intercept_prior = NULL,   unshrunk_prior = NULL,   shrunk_prognostic_prior = NULL,   shrunk_predictive_prior = NULL,   stanvars = NULL,   ... )"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/run_brms_analysis.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","text":"data data frame. Dataset containing necessary variables including response, treatment, covariates. Passed prepare_formula_model() preprocessing. response_formula formula object. Response specification defining outcome treatment. Examples: outcome ~ trt continuous, Surv(time, status) ~ trt survival. Passed prepare_formula_model(). response_type character string. Outcome type, one \"binary\", \"count\", \"continuous\", \"survival\". Determines likelihood function link used. Passed prepare_formula_model(). unshrunk_terms_formula formula object NULL. Unshrunk terms specification unshrunktermeffect component. May include main effects treatment interactions without regularization (e.g., ~ age + sex + trt*region). Passed prepare_formula_model(). shrunk_prognostic_formula formula object NULL. Prognostic effects strong regularization shprogeffect component. Fixed effects (colon syntax): Use ~ 0 + ... syntax one-hot encoding (e.g., ~ 0 + biomarker1 + biomarker2). Random effects (one-way model, pipe-pipe syntax): Use random effects notation (e.g., ~ (0 + 1 || biomarker)) automatic normal(0, 1) priors SD scale. Passed prepare_formula_model(). shrunk_predictive_formula formula object NULL. Treatment interactions strong regularization shpredeffect component. Fixed effects (colon syntax): Use ~ 0 + ... syntax one-hot encoding (e.g., ~ 0 + trt:subgroup). Random effects (one-way model, pipe-pipe syntax): Use random effects notation (e.g., ~ (0 + trt || subgroup)) automatic normal(0, 1) priors SD scale. Passed prepare_formula_model(). stratification_formula formula object NULL. Stratification variable specification (e.g., ~ strata_var). survival models, estimates separate baseline hazards per stratum. models, models varying distributional parameters. Passed prepare_formula_model(). intercept_prior character string, brmsprior object, NULL. Intercept prior unshrunktermeffect component. used survival models (Cox models intercept). Example: \"normal(0, 10)\". Passed fit_brms_model(). unshrunk_prior character string, brmsprior object, NULL. Prior unshrunk terms (non-intercept coefficients unshrunktermeffect component). Example: \"normal(0, 2.5)\". Passed fit_brms_model(). shrunk_prognostic_prior character string, brmsprior object, NULL. Prior regularized prognostic effects shprogeffect component. Fixed effects: Typically strong regularization like \"horseshoe(scale_global = 1)\". Random effects (one-way model): Automatically uses normal(0, 1) priors SD scale. Passed fit_brms_model(). shrunk_predictive_prior character string, brmsprior object, NULL. Prior regularized predictive effects (treatment interactions) shpredeffect component. Fixed effects: Typically strong regularization like \"horseshoe(scale_global = 0.5)\". Random effects (one-way model): Automatically uses normal(0, 1) priors SD scale. Passed fit_brms_model(). stanvars stanvars object NULL. Custom Stan code created via brms::stanvar() implementing hierarchical priors advanced Stan functionality. Passed fit_brms_model(). ... Additional arguments passed brms::brm() via fit_brms_model(). Common arguments include chains, iter, cores, backend, refresh.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/run_brms_analysis.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","text":"brmsfit. Fitted Bayesian model object attached attributes: response_type, model_data (processed data used fitting), trt_var (treatment variable name) use downstream analysis functions.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/run_brms_analysis.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","text":"function main user-facing entry point. first calls prepare_formula_model() build brmsformula process data, passes results fit_brms_model() run analysis.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/run_brms_analysis.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","text":"","code":"if (require(\"brms\") && require(\"survival\")) {   # 1. Create Sample Data   set.seed(123)   n <- 100   sim_data <- data.frame(     time = round(runif(n, 1, 100)),     status = sample(0:1, n, replace = TRUE),     trt = sample(0:1, n, replace = TRUE),     age = rnorm(n, 50, 10),     region = sample(c(\"A\", \"B\"), n, replace = TRUE),     subgroup = sample(c(\"S1\", \"S2\", \"S3\"), n, replace = TRUE)   )   sim_data$trt <- factor(sim_data$trt, levels = c(0, 1))   sim_data$region <- as.factor(sim_data$region)   sim_data$subgroup <- as.factor(sim_data$subgroup)    # 2. Run the full analysis using fixed effects (colon syntax)   if (FALSE) { # \\dontrun{   full_fit_fixed <- run_brms_analysis(     data = sim_data,     response_formula = Surv(time, status) ~ trt,     response_type = \"survival\",     unshrunk_terms_formula = ~ age,     shrunk_prognostic_formula = ~ 0 + region,     shrunk_predictive_formula = ~ 0 + trt:subgroup,     stratification_formula = ~ region,     unshrunk_prior = \"normal(0, 2)\",     shrunk_prognostic_prior = \"horseshoe(scale_global = 1)\",     shrunk_predictive_prior = \"horseshoe(scale_global = 1)\",     backend = \"cmdstanr\",     chains = 2, iter = 1000, warmup = 500, refresh = 0   )    print(full_fit_fixed)    # 3. Alternative: One-way model with random effects (pipe-pipe syntax)   # Random effects automatically get normal(0, 1) priors on SD scale   full_fit_oneway <- run_brms_analysis(     data = sim_data,     response_formula = Surv(time, status) ~ trt,     response_type = \"survival\",     unshrunk_terms_formula = ~ age,     shrunk_prognostic_formula = ~ (0 + 1 || region),     shrunk_predictive_formula = ~ (0 + trt || subgroup),     stratification_formula = ~ region,     backend = \"cmdstanr\",     chains = 2, iter = 1000, warmup = 500, refresh = 0   )    print(full_fit_oneway)   } # } }"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/summary_subgroup_effects.html","id":null,"dir":"Reference","previous_headings":"","what":"Create a Summary of Marginal Subgroup Treatment Effects — summary_subgroup_effects","title":"Create a Summary of Marginal Subgroup Treatment Effects — summary_subgroup_effects","text":"function orchestrates calls estimate_subgroup_effects generate summary table specific subgroups.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/summary_subgroup_effects.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Create a Summary of Marginal Subgroup Treatment Effects — summary_subgroup_effects","text":"","code":"summary_subgroup_effects(   brms_fit,   trt_var = NULL,   response_type = NULL,   subgroup_vars = \"auto\" )"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/summary_subgroup_effects.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Create a Summary of Marginal Subgroup Treatment Effects — summary_subgroup_effects","text":"brms_fit brmsfit object. Fitted model object fit_brms_model() run_brms_analysis(). Must contain necessary attributes extracting treatment variable response type information. trt_var character string NULL. Treatment variable name (coded 0/1). NULL, automatically extracted model attributes (set fit_brms_model()). match treatment variable used model fitting. response_type character string NULL. Outcome type, one \"binary\", \"count\", \"continuous\", \"survival\". NULL, automatically extracted model attributes (set fit_brms_model()). determines appropriate scale summarizing effects. subgroup_vars character vector \"auto\". Subgrouping variable names generate summaries. Defaults \"auto\", automatically detects treatment interactions formula components (unshrunktermeffect, shprogeffect, shpredeffect). NULL.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/summary_subgroup_effects.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Create a Summary of Marginal Subgroup Treatment Effects — summary_subgroup_effects","text":"subgroup_summary. S3 object containing: estimates tibble row represents subgroup, columns Subgroup, Median, CI_Lower, CI_Upper posterior distribution response_type character(1) indicating outcome type ci_level numeric(1) credible interval level (default 0.95) trt_var character(1) treatment variable name","code":""}]
