[{"path":"https://openpharma.github.io/bonsaiforest2/LICENSE.html","id":null,"dir":"","previous_headings":"","what":"MIT License","title":"MIT License","text":"Copyright (c) 2025 bonsaiforest2 authors Permission hereby granted, free charge, person obtaining copy software associated documentation files (“Software”), deal Software without restriction, including without limitation rights use, copy, modify, merge, publish, distribute, sublicense, /sell copies Software, permit persons Software furnished , subject following conditions: copyright notice permission notice shall included copies substantial portions Software. SOFTWARE PROVIDED “”, WITHOUT WARRANTY KIND, EXPRESS IMPLIED, INCLUDING LIMITED WARRANTIES MERCHANTABILITY, FITNESS PARTICULAR PURPOSE NONINFRINGEMENT. EVENT SHALL AUTHORS COPYRIGHT HOLDERS LIABLE CLAIM, DAMAGES LIABILITY, WHETHER ACTION CONTRACT, TORT OTHERWISE, ARISING , CONNECTION SOFTWARE USE DEALINGS SOFTWARE.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"handling-exposure-in-count-outcomes-with-offsets","dir":"Articles","previous_headings":"","what":"Handling Exposure in Count Outcomes with Offsets","title":"Advanced Functionalities","text":"count data (like disease exacerbations event rates), observed count often depends exposure time follow-time. Using offset variable standard statistical method properly account time variation modeling event rate (count per unit time) instead raw count. bonsaiforest2, can include offset directly response_formula using standard brms syntax: outcome + offset(log_time) ~ trt.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-1-count-outcome-with-offset-disease-exacerbations","dir":"Articles","previous_headings":"1 Handling Exposure in Count Outcomes with Offsets","what":"Example 1: Count Outcome with Offset (Disease Exacerbations)","title":"Advanced Functionalities","text":"scenario models exacerbation counts using Negative Binomial distribution explicitly accounts patient’s exposure time. Scenario: Modeling exacerbation counts. Adjust baseline_severity (unshrunk) many exploratory biomarkers (shrunk). interaction terms (overall treatment effect ).","code":"# Data Simulation  set.seed(789) library(bonsaiforest2) n_patients <- 150 biomarker_data <- as.data.frame(matrix(rnorm(n_patients * 10), ncol = 10)) names(biomarker_data) <- paste0(\"biomarker_\", 1:10) count_data <- data.frame(   exacerbation_count = rnbinom(n_patients, size = 1.5, mu = 3),   medication = sample(0:1, n_patients, replace = TRUE),   baseline_severity = rnorm(n_patients, 10, 2),   log_exposure_time = log(runif(n_patients, 0.5, 1.5)) ) count_data <- cbind(count_data, biomarker_data) count_data$medication <- factor(count_data$medication, levels = c(0, 1))  # Create formula string for all biomarkers (Prognostic effects only here) shrunk_prog_str <- paste(\"~\", paste(names(biomarker_data), collapse = \" + \")) # Model Fitting with Offset # For count models, sigma_ref is typically set to 1 (used as reference scale for priors) count_model_fit <- run_brms_analysis(   data = count_data,   # Include offset(log_exposure_time) directly in the response formula   response_formula = exacerbation_count + offset(log_exposure_time) ~ medication,   response_type = \"count\",   unshrunk_terms_formula = ~ 1 + baseline_severity,   shrunk_prognostic_formula = as.formula(shrunk_prog_str),   sigma_ref = 1,    chains = 1, iter = 200, warmup = 100, cores = 1, refresh = 0, backend = \"cmdstanr\" ) #> Step 1: Preparing formula and data... #> Note: Offset on LHS is deprecated. Please use 'response ~ treatment + offset(...)' syntax instead. #> Converting treatment variable 'medication' to numeric binary (0/1). '0' = 0, '1' = 1 #> Note: Treatment 'medication' automatically added to unshrunk terms. #> Warning: Formula 'shprogeffect' contains an intercept. For proper #> regularization/interpretation, consider removing it by adding '~ 0 + ...' or '~ #> -1 + ...' to your input formula. #>  #> Step 2: Fitting the brms model... #> Using trt_var from prepared_model: medication #> Using sigma_ref = 1 #> Using default priors for unspecified effects: #>   - intercept: normal(0, 2) #>   - unshrunk terms: normal(0, 2) #>   - shrunk prognostic: horseshoe(1) #> Fitting brms model... #> Start sampling #> Running MCMC with 1 chain... #>  #> Chain 1 WARNING: There aren't enough warmup iterations to fit the  #> Chain 1          three stages of adaptation as currently configured.  #> Chain 1          Reducing each adaptation stage to 15%/75%/10% of  #> Chain 1          the given number of warmup iterations:  #> Chain 1            init_buffer = 15  #> Chain 1            adapt_window = 75  #> Chain 1            term_buffer = 10  #> Chain 1 finished in 2.6 seconds. #> Loading required namespace: rstan #>  #> Analysis complete."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"customizing-prior-distributions","dir":"Articles","previous_headings":"","what":"Customizing Prior Distributions","title":"Advanced Functionalities","text":"choice prior central Bayesian shrinkage. bonsaiforest2 provides sensible defaults, allows full customization using dedicated prior arguments: intercept_prior, unshrunk_prior, shrunk_prognostic_prior, shrunk_predictive_prior.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"prior-specification-mechanics","dir":"Articles","previous_headings":"2 Customizing Prior Distributions","what":"Prior Specification Mechanics","title":"Advanced Functionalities","text":"Priors specified using separate parameters component, required sigma_ref parameter serves reference scale prior distributions. Key Feature: can use sigma_ref prior expressions (e.g., \"normal(0, 2.5 * sigma_ref)\") actual value automatically substituted. allows specify priors automatically scale data maintaining interpretability.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"practical-examples-of-prior-setting","dir":"Articles","previous_headings":"2 Customizing Prior Distributions","what":"Practical Examples of Prior Setting","title":"Advanced Functionalities","text":"following examples demonstrate customize priors using new API. use synthetic survival dataset show different prior specification strategies, simple defaults advanced hierarchical structures.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"dataset-generation-and-model-preparation","dir":"Articles","previous_headings":"2 Customizing Prior Distributions > 2.2 Practical Examples of Prior Setting","what":"Dataset Generation and Model Preparation","title":"Advanced Functionalities","text":"dataset mimics clinical trial treatment effects vary subgroups.","code":"# Load library library(bonsaiforest2)  # 1. Create Sample Data set.seed(123) n <- 100 sim_data <- data.frame(   time = round(runif(n, 1, 100)),   status = sample(0:1, n, replace = TRUE),   trt = sample(0:1, n, replace = TRUE),   age = rnorm(n, 50, 10),   region = sample(c(\"A\", \"B\"), n, replace = TRUE),   subgroup = sample(c(\"S1\", \"S2\", \"S3\"), n, replace = TRUE) )  # Ensure variables are factors where appropriate sim_data$trt <- factor(sim_data$trt, levels = c(0, 1)) sim_data$region <- as.factor(sim_data$region) sim_data$subgroup <- as.factor(sim_data$subgroup)  # 2. Prepare the model formula prepared_model <- prepare_formula_model(   data = sim_data,   response_formula = Surv(time, status) ~ trt,   shrunk_predictive_formula = ~ 0 + trt:region,   unshrunk_terms_formula = ~ age,   response_type = \"survival\" ) #> Converting treatment variable 'trt' to numeric binary (0/1). '0' = 0, '1' = 1 #> Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz(). #> Note: Treatment 'trt' automatically added to unshrunk terms. #> Note: Applied one-hot encoding to shrunken factor 'region' (will be used with ~ 0 + ...) #> Note: Marginality principle not followed - interaction term 'region' is used without its main effect. Consider adding 'region' to prognostic terms for proper model hierarchy."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-2-using-default-priors-recommended","dir":"Articles","previous_headings":"2 Customizing Prior Distributions > 2.2 Practical Examples of Prior Setting","what":"Example 2: Using Default Priors (Recommended)","title":"Advanced Functionalities","text":"simplest approach: just provide sigma_ref let package use smart defaults adapt outcome type.","code":"# For survival models, sigma_ref is typically 1 # For continuous outcomes, use sd(outcome) sigma_ref <- 1  # Standard for survival models  fit_ex3 <- fit_brms_model(   prepared_model = prepared_model,   sigma_ref = sigma_ref,   # All priors use defaults - no need to specify!   chains = 1, iter = 200, warmup = 100, cores = 1, refresh = 0, backend = \"cmdstanr\" ) #> Using trt_var from prepared_model: trt #> Using sigma_ref = 1 #> Using default priors for unspecified effects: #>   - unshrunk terms: normal(0, 1.5) #>   - shrunk predictive: horseshoe(1) #> Fitting brms model... #> Start sampling #> Running MCMC with 1 chain... #>  #> Chain 1 WARNING: There aren't enough warmup iterations to fit the  #> Chain 1          three stages of adaptation as currently configured.  #> Chain 1          Reducing each adaptation stage to 15%/75%/10% of  #> Chain 1          the given number of warmup iterations:  #> Chain 1            init_buffer = 15  #> Chain 1            adapt_window = 75  #> Chain 1            term_buffer = 10  #> Chain 1 finished in 2.2 seconds. #> Warning: 92 of 100 (92.0%) transitions hit the maximum treedepth limit of 10. #> See https://mc-stan.org/misc/warnings for details.  # View the priors that were automatically set cat(\"\\n=== Priors Used ===\\n\") #>  #> === Priors Used === print(fit_ex3[[\"prior\"]]) #>           prior class        coef group resp dpar              nlpar lb ub tag #>    horseshoe(1)     b                                   shpredeffect           #>    horseshoe(1)     b trt:regionA                       shpredeffect           #>    horseshoe(1)     b trt:regionB                       shpredeffect           #>  normal(0, 1.5)     b                             unshrunktermeffect           #>  normal(0, 1.5)     b         age                 unshrunktermeffect           #>  normal(0, 1.5)     b         trt                 unshrunktermeffect           #>    dirichlet(1) sbhaz                                                          #>        source #>          user #>  (vectorized) #>  (vectorized) #>          user #>  (vectorized) #>  (vectorized) #>       default"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-3-using-the-r2d2-shrinkage-prior","dir":"Articles","previous_headings":"2 Customizing Prior Distributions > 2.2 Practical Examples of Prior Setting","what":"Example 3: Using the R2D2 Shrinkage Prior","title":"Advanced Functionalities","text":"R2D2 prior useful want control global shrinkage via coefficient determination (\\(R^2\\)) rather scale parameter. often interpretable stakeholders.","code":"# Use a custom R2D2 prior for the shrunk predictive effects (interactions)  fit_ex4 <- fit_brms_model(   prepared_model = prepared_model,   sigma_ref = 1,   shrunk_predictive_prior = \"R2D2(mean_R2 = 0.5, prec_R2 = 1)\",   # Can also customize other priors   intercept_prior = \"normal(0, 5 * sigma_ref)\",   unshrunk_prior = \"normal(0, 2.5 * sigma_ref)\",   chains = 1, iter = 200, warmup = 100, cores = 1, refresh = 0, backend = \"cmdstanr\" ) #> Using trt_var from prepared_model: trt #> Using sigma_ref = 1 #> Fitting brms model... #> Start sampling #> Running MCMC with 1 chain... #>  #> Chain 1 WARNING: There aren't enough warmup iterations to fit the  #> Chain 1          three stages of adaptation as currently configured.  #> Chain 1          Reducing each adaptation stage to 15%/75%/10% of  #> Chain 1          the given number of warmup iterations:  #> Chain 1            init_buffer = 15  #> Chain 1            adapt_window = 75  #> Chain 1            term_buffer = 10  #> Chain 1 finished in 2.0 seconds. #> Warning: 89 of 100 (89.0%) transitions hit the maximum treedepth limit of 10. #> See https://mc-stan.org/misc/warnings for details.  cat(\"\\n=== Priors Used ===\\n\") #>  #> === Priors Used === print(fit_ex4[[\"prior\"]]) #>                             prior class        coef group resp dpar #>  R2D2(mean_R2 = 0.5, prec_R2 = 1)     b                             #>  R2D2(mean_R2 = 0.5, prec_R2 = 1)     b trt:regionA                 #>  R2D2(mean_R2 = 0.5, prec_R2 = 1)     b trt:regionB                 #>                normal(0, 2.5 * 1)     b                             #>                normal(0, 2.5 * 1)     b         age                 #>                normal(0, 2.5 * 1)     b         trt                 #>                      dirichlet(1) sbhaz                             #>               nlpar lb ub tag       source #>        shpredeffect                   user #>        shpredeffect           (vectorized) #>        shpredeffect           (vectorized) #>  unshrunktermeffect                   user #>  unshrunktermeffect           (vectorized) #>  unshrunktermeffect           (vectorized) #>                                    default"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-4-custom-hierarchical-prior-advanced","dir":"Articles","previous_headings":"2 Customizing Prior Distributions > 2.2 Practical Examples of Prior Setting","what":"Example 4: Custom Hierarchical Prior (Advanced)","title":"Advanced Functionalities","text":"example demonstrates injecting raw Stan code using stanvars. necessary want implement hierarchical structure brms support natively, estimating shared variance parameter across coefficients.","code":"# 1. Define new hyperparameters in Stan stanvars_full_hierarchical <- brms::stanvar(   scode = \"  real mu_pred;\\n  real<lower=0> sigma_pred;\\n\",   block = \"parameters\" ) +   # Add priors for these parameters   brms::stanvar(     scode = \"  // Priors on the hierarchical parameters\\n  target += normal_lpdf(mu_pred | 0, 4); \\n  target += normal_lpdf(sigma_pred | 0, 1) - normal_lccdf(0 | 0, 1); \\n\",     block = \"model\"   )  # 2. Create prior that references the Stan variables prior_full_hierarchical <- brms::set_prior(\"normal(mu_pred, sigma_pred)\")  # 3. Pass both to fit_brms_model fit_ex5 <- fit_brms_model(   prepared_model = prepared_model,   sigma_ref = 1,   shrunk_predictive_prior = prior_full_hierarchical,   stanvars = stanvars_full_hierarchical,   # Other priors can still use sigma_ref   intercept_prior = \"normal(0, 5 * sigma_ref)\",   unshrunk_prior = \"normal(0, 2.5 * sigma_ref)\",   chains = 1, iter = 200, warmup = 100, cores = 1, refresh = 0, backend = \"cmdstanr\" ) #> Using trt_var from prepared_model: trt #> Using sigma_ref = 1 #> Re-targeting 'brmsprior' object for nlpar: shpredeffect class: b #> Fitting brms model... #> Start sampling #> Running MCMC with 1 chain... #>  #> Chain 1 WARNING: There aren't enough warmup iterations to fit the  #> Chain 1          three stages of adaptation as currently configured.  #> Chain 1          Reducing each adaptation stage to 15%/75%/10% of  #> Chain 1          the given number of warmup iterations:  #> Chain 1            init_buffer = 15  #> Chain 1            adapt_window = 75  #> Chain 1            term_buffer = 10  #> Chain 1 finished in 1.3 seconds. #> Warning: 100 of 100 (100.0%) transitions hit the maximum treedepth limit of 10. #> See https://mc-stan.org/misc/warnings for details.  # View the used priors cat(\"\\n=== Priors Used ===\\n\") #>  #> === Priors Used === print(fit_ex5[[\"prior\"]]) #>                        prior class        coef group resp dpar #>  normal(mu_pred, sigma_pred)     b                             #>  normal(mu_pred, sigma_pred)     b trt:regionA                 #>  normal(mu_pred, sigma_pred)     b trt:regionB                 #>           normal(0, 2.5 * 1)     b                             #>           normal(0, 2.5 * 1)     b         age                 #>           normal(0, 2.5 * 1)     b         trt                 #>                 dirichlet(1) sbhaz                             #>               nlpar lb ub tag       source #>        shpredeffect                   user #>        shpredeffect           (vectorized) #>        shpredeffect           (vectorized) #>  unshrunktermeffect                   user #>  unshrunktermeffect           (vectorized) #>  unshrunktermeffect           (vectorized) #>                                    default print(fit_ex5[[\"stanvars\"]]) #> [[1]] #> [[1]]$name #> [1] \"\" #>  #> [[1]]$sdata #> NULL #>  #> [[1]]$scode #> [1] \"  real mu_pred;\\n  real<lower=0> sigma_pred;\\n\" #>  #> [[1]]$block #> [1] \"parameters\" #>  #> [[1]]$position #> [1] \"start\" #>  #> [[1]]$pll_args #> character(0) #>  #>  #> [[2]] #> [[2]]$name #> [1] \"\" #>  #> [[2]]$sdata #> NULL #>  #> [[2]]$scode #> [1] \"  // Priors on the hierarchical parameters\\n  target += normal_lpdf(mu_pred | 0, 4); \\n  target += normal_lpdf(sigma_pred | 0, 1) - normal_lccdf(0 | 0, 1); \\n\" #>  #> [[2]]$block #> [1] \"model\" #>  #> [[2]]$position #> [1] \"start\" #>  #> [[2]]$pll_args #> character(0) #>  #>  #> attr(,\"class\") #> [1] \"stanvars\""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-5-coefficient-specific-priors","dir":"Articles","previous_headings":"2 Customizing Prior Distributions > 2.2 Practical Examples of Prior Setting","what":"Example 5: Coefficient-Specific Priors","title":"Advanced Functionalities","text":"can set different priors specific coefficients passing brmsprior object (created c()). Scenario: Set general prior unshrunk terms, use tighter prior specifically treatment-biomarker interactions. Key Technique: Use prepare_formula_model() discover exact coefficient names appear model.","code":"# 1. Run prepare_formula_model prepared_model <- prepare_formula_model(   data = sim_data,   response_formula = Surv(time, status) ~ trt,   shrunk_predictive_formula = ~ 0 + trt:region,   unshrunk_terms_formula = ~ age + trt*subgroup,   response_type = \"survival\" ) #> Converting treatment variable 'trt' to numeric binary (0/1). '0' = 0, '1' = 1 #> Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz(). #> Note: Treatment 'trt' automatically added to unshrunk terms. #> Note: Applied dummy encoding (contr.treatment) to unshrunken factor 'subgroup' #> Note: Applied one-hot encoding to shrunken factor 'region' (will be used with ~ 0 + ...) #> Note: Marginality principle not followed - interaction term 'region' is used without its main effect. Consider adding 'region' to prognostic terms for proper model hierarchy.  # 2. Inspect the Results # A. The generated brms formula object print(prepared_model$formula) #> time | cens(1 - status) + bhaz(Boundary.knots = c(0.02, 99.98), knots = c(24, 46, 69), intercept = FALSE) ~ unshrunktermeffect + shpredeffect  #> unshrunktermeffect ~ 0 + age + trt * subgroup + trt #> shpredeffect ~ 0 + trt:region  # B. The processed terms print(prepared_model$stan_variable_names$X_unshrunktermeffect) #> [1] \"age\"            \"trt\"            \"subgroupS1\"     \"subgroupS2\"     #> [5] \"subgroupS3\"     \"trt:subgroupS2\" \"trt:subgroupS3\"  sigma_ref <- 1  cat(\"=== Prior Strategy ===\\n\") #> === Prior Strategy === cat(\"General unshrunk prior: normal(0,\", round(5 * sigma_ref, 2), \")\\n\") #> General unshrunk prior: normal(0, 5 ) cat(\"Specific for trt:subgroup: normal(0,\", round(1 * sigma_ref, 2), \")\\n\\n\") #> Specific for trt:subgroup: normal(0, 1 )  # Create combined prior object # IMPORTANT: Use EXACT coefficient names from the prepared data unshrunk_priors_combined <- c(   brms::set_prior(\"normal(0, 5 * sigma_ref)\", class = \"b\"),  # General   brms::set_prior(\"normal(0, 1 * sigma_ref)\", class = \"b\", coef = \"trt:subgroupS2\"),   brms::set_prior(\"normal(0, 1 * sigma_ref)\", class = \"b\", coef = \"trt:subgroupS3\") )  # Fit the model fit_specific <- fit_brms_model(   prepared_model = prepared_model,   sigma_ref = sigma_ref,   unshrunk_prior = unshrunk_priors_combined,  # Pass the combined object   chains = 1, iter = 200, warmup = 100, cores = 1, refresh = 0, backend = \"cmdstanr\" ) #> Using trt_var from prepared_model: trt #> Using sigma_ref = 1 #> Re-targeting 'brmsprior' object for nlpar: unshrunktermeffect class: b #> Using default priors for unspecified effects: #>   - shrunk predictive: horseshoe(1) #> Fitting brms model... #> Start sampling #> Running MCMC with 1 chain... #>  #> Chain 1 WARNING: There aren't enough warmup iterations to fit the  #> Chain 1          three stages of adaptation as currently configured.  #> Chain 1          Reducing each adaptation stage to 15%/75%/10% of  #> Chain 1          the given number of warmup iterations:  #> Chain 1            init_buffer = 15  #> Chain 1            adapt_window = 75  #> Chain 1            term_buffer = 10  #> Chain 1 finished in 2.5 seconds. #> Warning: 89 of 100 (89.0%) transitions hit the maximum treedepth limit of 10. #> See https://mc-stan.org/misc/warnings for details.  # View the used priors cat(\"\\n=== Priors Used ===\\n\") #>  #> === Priors Used === print(fit_specific[[\"prior\"]]) #>             prior class           coef group resp dpar              nlpar lb ub #>      horseshoe(1)     b                                      shpredeffect       #>      horseshoe(1)     b    trt:regionA                       shpredeffect       #>      horseshoe(1)     b    trt:regionB                       shpredeffect       #>  normal(0, 5 * 1)     b                                unshrunktermeffect       #>  normal(0, 5 * 1)     b            age                 unshrunktermeffect       #>  normal(0, 5 * 1)     b     subgroupS1                 unshrunktermeffect       #>  normal(0, 5 * 1)     b     subgroupS2                 unshrunktermeffect       #>  normal(0, 5 * 1)     b     subgroupS3                 unshrunktermeffect       #>  normal(0, 5 * 1)     b            trt                 unshrunktermeffect       #>  normal(0, 1 * 1)     b trt:subgroupS2                 unshrunktermeffect       #>  normal(0, 1 * 1)     b trt:subgroupS3                 unshrunktermeffect       #>      dirichlet(1) sbhaz                                                         #>  tag       source #>              user #>      (vectorized) #>      (vectorized) #>              user #>      (vectorized) #>      (vectorized) #>      (vectorized) #>      (vectorized) #>      (vectorized) #>              user #>              user #>           default"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-6-hierarchical-priors-with-shared-variance-stanvars","dir":"Articles","previous_headings":"2 Customizing Prior Distributions > 2.2 Practical Examples of Prior Setting","what":"Example 6: Hierarchical Priors with Shared Variance (stanvars)","title":"Advanced Functionalities","text":"Create correlated priors sharing common variance parameter estimated data. Use case: believe treatment effects across subgroups exchangeable, can pool information giving shared variance.","code":"cat(\"\\n=== Hierarchical Prior Structure ===\\n\") #>  #> === Hierarchical Prior Structure === cat(\"Instead of independent priors, we'll use a shared variance:\\n\") #> Instead of independent priors, we'll use a shared variance: cat(\"  tau ~ half-normal(0, 1)  [shared variance parameter]\\n\") #>   tau ~ half-normal(0, 1)  [shared variance parameter] cat(\"  beta_Low ~ N(0, tau)\\n\") #>   beta_Low ~ N(0, tau) cat(\"  beta_Medium ~ N(0, tau)\\n\") #>   beta_Medium ~ N(0, tau) cat(\"This creates exchangeability and adaptive shrinkage.\\n\\n\") #> This creates exchangeability and adaptive shrinkage.  # Step 1: Declare tau as a parameter to be estimated tau_parameter <- brms::stanvar(   scode = \"  real<lower=0> biomarker_tau;  // Shared variance\\n\",   block = \"parameters\" )  # Step 2: Add prior for tau tau_prior <- brms::stanvar(   scode = \"  biomarker_tau ~ normal(0, 1);  // Hyperprior\\n\",   block = \"model\" )  # Combine stanvars hierarchical_stanvars <- tau_parameter + tau_prior  # Step 3: Create priors referencing the estimated tau # Note: We identified these coefficient names using prepare_formula_model above unshrunk_priors_hier <- c(   brms::set_prior(\"normal(0, 5 * sigma_ref)\", class = \"b\"),  # General   brms::set_prior(\"normal(0, biomarker_tau)\", class = \"b\", coef = \"trt:subgroupS2\"),   brms::set_prior(\"normal(0, biomarker_tau)\", class = \"b\", coef = \"trt:subgroupS3\") )  # Step 4: Fit the hierarchical model fit_hier <- fit_brms_model(   prepared_model = prepared_model,   sigma_ref = sigma_ref,   unshrunk_prior = unshrunk_priors_hier,   stanvars = hierarchical_stanvars,   chains = 1, iter = 400, warmup = 200, cores = 1, refresh = 0, backend = \"cmdstanr\" ) #> Using trt_var from prepared_model: trt #> Using sigma_ref = 1 #> Re-targeting 'brmsprior' object for nlpar: unshrunktermeffect class: b #> Using default priors for unspecified effects: #>   - shrunk predictive: horseshoe(1) #> Fitting brms model... #> Start sampling #> Running MCMC with 1 chain... #>  #> Chain 1 finished in 1.3 seconds. #> Warning: 1 of 200 (0.0%) transitions ended with a divergence. #> See https://mc-stan.org/misc/warnings for details.  # View the used priors cat(\"\\n=== Priors Used ===\\n\") #>  #> === Priors Used === print(fit_hier[[\"prior\"]]) #>                     prior class           coef group resp dpar #>              horseshoe(1)     b                                #>              horseshoe(1)     b    trt:regionA                 #>              horseshoe(1)     b    trt:regionB                 #>          normal(0, 5 * 1)     b                                #>          normal(0, 5 * 1)     b            age                 #>          normal(0, 5 * 1)     b     subgroupS1                 #>          normal(0, 5 * 1)     b     subgroupS2                 #>          normal(0, 5 * 1)     b     subgroupS3                 #>          normal(0, 5 * 1)     b            trt                 #>  normal(0, biomarker_tau)     b trt:subgroupS2                 #>  normal(0, biomarker_tau)     b trt:subgroupS3                 #>              dirichlet(1) sbhaz                                #>               nlpar lb ub tag       source #>        shpredeffect                   user #>        shpredeffect           (vectorized) #>        shpredeffect           (vectorized) #>  unshrunktermeffect                   user #>  unshrunktermeffect           (vectorized) #>  unshrunktermeffect           (vectorized) #>  unshrunktermeffect           (vectorized) #>  unshrunktermeffect           (vectorized) #>  unshrunktermeffect           (vectorized) #>  unshrunktermeffect                   user #>  unshrunktermeffect                   user #>                                    default print(fit_hier[[\"stanvars\"]]) #> [[1]] #> [[1]]$name #> [1] \"\" #>  #> [[1]]$sdata #> NULL #>  #> [[1]]$scode #> [1] \"  real<lower=0> biomarker_tau;  // Shared variance\\n\" #>  #> [[1]]$block #> [1] \"parameters\" #>  #> [[1]]$position #> [1] \"start\" #>  #> [[1]]$pll_args #> character(0) #>  #>  #> [[2]] #> [[2]]$name #> [1] \"\" #>  #> [[2]]$sdata #> NULL #>  #> [[2]]$scode #> [1] \"  biomarker_tau ~ normal(0, 1);  // Hyperprior\\n\" #>  #> [[2]]$block #> [1] \"model\" #>  #> [[2]]$position #> [1] \"start\" #>  #> [[2]]$pll_args #> character(0) #>  #>  #> attr(,\"class\") #> [1] \"stanvars\""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"advanced-model-parameterization","dir":"Articles","previous_headings":"","what":"Advanced Model Parameterization","title":"Advanced Functionalities","text":"section demonstrates advanced features controlling model represents subgroups.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-7-custom-contrast-encoding-for-shrunk-terms","dir":"Articles","previous_headings":"3 Advanced Model Parameterization","what":"Example 7: Custom Contrast Encoding for Shrunk Terms","title":"Advanced Functionalities","text":"default, bonsaiforest2 uses one-hot encoding (factor levels) shrunk interaction terms, dummy encoding (drop one level) unshrunk terms. However, can manually set custom contrasts data, library respect choice. Scenario: want use treatment contrasts (k-1 dummy variables reference level) custom contrasts (e.g., Helmert, sum coding) instead one-hot encoding shrunk predictive effects. Key Technique: Set contrasts using contrasts() calling prepare_formula_model(). library preserve choice.","code":"# Create sample data with multiple subgroups set.seed(456) n_patients <- 180 sample_data_contrast <- data.frame(   id = 1:n_patients,   trt = factor(sample(0:1, n_patients, replace = TRUE)),   outcome = rnorm(n_patients, 50, 10),   age = rnorm(n_patients, 65, 10),   biomarker = factor(sample(c(\"Low\", \"Medium\", \"High\"), n_patients, replace = TRUE)) )  # Set Helmert contrasts for the biomarker variable contrasts(sample_data_contrast$biomarker) <- contr.helmert(3) cat(\"Contrast matrix for biomarker:\\\\n\") #> Contrast matrix for biomarker:\\n print(contrasts(sample_data_contrast$biomarker)) #>        [,1] [,2] #> High     -1   -1 #> Low       1   -1 #> Medium    0    2  # Prepare model  prepared_custom_contrast <- prepare_formula_model(   data = sample_data_contrast,   response_formula = outcome ~ trt,   unshrunk_terms_formula = ~ age,   shrunk_predictive_formula = ~ 0 + trt:biomarker,    response_type = \"continuous\" ) #> Converting treatment variable 'trt' to numeric binary (0/1). '0' = 0, '1' = 1 #> Note: Treatment 'trt' automatically added to unshrunk terms. #> Variable 'biomarker' has user-specified contrasts. Keeping them. #> Note: Marginality principle not followed - interaction term 'biomarker' is used without its main effect. Consider adding 'biomarker' to prognostic terms for proper model hierarchy.  # Observe costum contrast in the data str(prepared_custom_contrast$data) #> 'data.frame':    180 obs. of  5 variables: #>  $ id       : int  1 2 3 4 5 6 7 8 9 10 ... #>  $ trt      : num  0 0 0 1 0 1 0 0 1 0 ... #>  $ outcome  : num  45.3 43.3 63.6 64.1 42.7 ... #>  $ age      : num  41.2 66.5 46 81.5 70 ... #>  $ biomarker: Factor w/ 3 levels \"High\",\"Low\",\"Medium\": 1 1 3 1 1 1 1 2 1 3 ... #>   ..- attr(*, \"contrasts\")= num [1:3, 1:2] -1 1 0 -1 -1 2 #>   .. ..- attr(*, \"dimnames\")=List of 2 #>   .. .. ..$ : chr [1:3] \"High\" \"Low\" \"Medium\" #>   .. .. ..$ : NULL  sigma_ref <- 1  # Fit the model fit_custom_contrast <- fit_brms_model(   prepared_model = prepared_custom_contrast,   sigma_ref = sigma_ref,   chains = 1, iter = 200, warmup = 100, cores = 1, refresh = 0, backend = \"cmdstanr\" ) #> Using trt_var from prepared_model: trt #> Note: Using default sigma_ref = 1 for continuous outcome. Consider setting sigma_ref to the outcome standard deviation from the trial protocol (preferred) or sd(outcome) for better prior specification. #> Using sigma_ref = 1 #> Computed outcome mean: 50.06 #> Using default priors for unspecified effects: #>   - intercept: normal(50.0602209848849, 2.5) #>   - unshrunk terms: normal(0, 2.5) #>   - shrunk predictive: horseshoe(1) #> Adding sigma prior: student_t(3, 0, 1) #> Fitting brms model... #> Start sampling #> Running MCMC with 1 chain... #>  #> Chain 1 WARNING: There aren't enough warmup iterations to fit the  #> Chain 1          three stages of adaptation as currently configured.  #> Chain 1          Reducing each adaptation stage to 15%/75%/10% of  #> Chain 1          the given number of warmup iterations:  #> Chain 1            init_buffer = 15  #> Chain 1            adapt_window = 75  #> Chain 1            term_buffer = 10  #> Chain 1 finished in 1.0 seconds.  estimate_custom_contrast <- summary_subgroup_effects(fit_custom_contrast) #> Using trt_var from model attributes: trt #> Using response_type from model attributes: continuous #> --- Calculating specific subgroup effects... --- #> Using data from model attributes #> Step 1: Identifying subgroups and creating counterfactuals... #> `subgroup_vars` set to 'auto'. Detecting from model... #> Model data has 180 rows and 5 columns #> Column names: id, trt, outcome, age, biomarker #> Treatment variable: 'trt' #> All coefficient names: #> unshrunktermeffect_Intercept #> unshrunktermeffect_age #> unshrunktermeffect_trt #> shpredeffect_trt:biomarkerHigh #> shpredeffect_trt:biomarkerLow #> shpredeffect_trt:biomarkerMedium #> Looking for treatment interactions with pattern: 'trt:' #> Found 3 treatment interaction coefficients #> Treatment interaction coefficients found: #> shpredeffect_trt:biomarkerHigh #> shpredeffect_trt:biomarkerLow #> shpredeffect_trt:biomarkerMedium #> Detected subgroup variable 'biomarker' from coefficient 'shpredeffect_trt:biomarkerHigh' #> Detected subgroup variable 'biomarker' from coefficient 'shpredeffect_trt:biomarkerLow' #> Detected subgroup variable 'biomarker' from coefficient 'shpredeffect_trt:biomarkerMedium' #> Checking for random effects parameters... #> Retrieved 14 total parameters from model #> Using regex pattern: '^r_(.+)__[^\\[]+\\[[^,]+,trt\\]' #> Found 0 matching random effect parameters #> No random effect parameters matching the pattern were found #> ...detected subgroup variable(s): biomarker #> Step 2: Generating posterior predictions... #> ... detected Fixed Effects (Colon model). Predicting with re_formula = NA. #> ... (predicting expected outcomes)... #> Step 3: Calculating marginal effects... #> ... processing biomarker #> Done.  print(estimate_custom_contrast) #> $estimates #> # A tibble: 3 × 4 #>   Subgroup          Median CI_Lower CI_Upper #>   <chr>              <dbl>    <dbl>    <dbl> #> 1 biomarker: High   -0.668    -3.30   2.35   #> 2 biomarker: Low    -2.57     -5.77  -0.0927 #> 3 biomarker: Medium -1.33     -4.76   1.64   #>  #> $response_type #> [1] \"continuous\" #>  #> $ci_level #> [1] 0.95 #>  #> $trt_var #> [1] \"trt\" #>  #> attr(,\"class\") #> [1] \"subgroup_summary\""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-8-prediction-on-new-data","dir":"Articles","previous_headings":"3 Advanced Model Parameterization","what":"Example 8: Prediction on New Data","title":"Advanced Functionalities","text":"fitting model, can use brms::predict() generate predictions new patients. Scenario: ’ve fitted treatment effect model want predict outcomes new patients different characteristics.","code":"# Use the fitted model from Example 7 # Generate new data for prediction set.seed(789) new_patients <- data.frame(   id = 1:20,   trt = as.numeric(rep(c(0, 1), each = 10), levels = c(0, 1)),   age = rnorm(20, 65, 10),   biomarker = factor(rep(c(\"Low\", \"Medium\", \"High\"), length.out = 20)) )  # IMPORTANT: Set the same contrasts as in Example 7 # The prediction data must use the same encoding as the training data contrasts(new_patients$biomarker) <- contr.helmert(3)   # Generate predictions using brms::predict # This returns posterior predictive samples predictions <- predict(fit_custom_contrast, newdata = new_patients, summary = TRUE)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"stratification-for-nuisance-parameters","dir":"Articles","previous_headings":"","what":"Stratification for Nuisance Parameters","title":"Advanced Functionalities","text":"many trials, parameters like observation error variance (\\(\\sigma^2\\) continuous outcomes) baseline hazard function (\\(h_0(t)\\) survival outcomes) known vary site, country, factors. Stratification models known heterogeneity fitting nuisance parameters separately level grouping variable. Use stratification_formula argument define grouping factor(s).","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-9-stratified-continuous-model","dir":"Articles","previous_headings":"4 Stratification for Nuisance Parameters","what":"Example 9: Stratified Continuous Model","title":"Advanced Functionalities","text":"Scenario: model SBP change observation variance \\(\\sigma^2\\) differs \\(\\text{clinic\\_site}\\). modeled stratifying \\(\\sigma\\) parameter Normal distribution site variable.","code":"set.seed(42) n_patients <- 180 sigma_by_site <- c(SiteA = 6, SiteB = 12, SiteC = 18) sample_data_strat_cont <- data.frame(     id = 1:n_patients,     clinic_site = factor(sample(c(\"SiteA\", \"SiteB\", \"SiteC\"), n_patients, replace = TRUE)) ) sample_data_strat_cont$trt <- factor(sample(0:1, n_patients, replace = TRUE, prob = c(0.5, 0.5))) sample_data_strat_cont$baseline_sbp <- rnorm(n_patients, mean = 145, sd = 8) sample_data_strat_cont$age_group <- factor(sample(c(\"Under60\", \"Over60\"), n_patients, replace = TRUE)) noise <- rnorm(n_patients, mean = 0, sd = sigma_by_site[sample_data_strat_cont$clinic_site]) sample_data_strat_cont$sbp_change <- -5 - (as.integer(sample_data_strat_cont$trt)-1) * 8 -                                      0.2 * (sample_data_strat_cont$baseline_sbp - 145) +                                      (as.integer(sample_data_strat_cont$trt)-1) * ifelse(sample_data_strat_cont$age_group == \"Over60\", -5, 0) +                                      noise # Model Fitting with Stratified Sigma # Calculate sigma_ref from the outcome SD sigma_ref <- sd(sample_data_strat_cont$sbp_change)  fit_continuous_stratified <- run_brms_analysis(   data = sample_data_strat_cont,   response_formula = sbp_change ~ trt,   response_type = \"continuous\",   unshrunk_terms_formula = ~ baseline_sbp,   shrunk_predictive_formula = ~ 0 + trt:age_group,   stratification_formula = ~ clinic_site,   sigma_ref = sigma_ref,   chains = 1, iter = 200, warmup = 100, cores = 1, refresh = 0, backend = \"cmdstanr\" ) #> Step 1: Preparing formula and data... #> Converting treatment variable 'trt' to numeric binary (0/1). '0' = 0, '1' = 1 #> Applying stratification: estimating sigma by 'clinic_site'. #> Note: Treatment 'trt' automatically added to unshrunk terms. #> Note: Applied one-hot encoding to shrunken factor 'age_group' (will be used with ~ 0 + ...) #> Note: Marginality principle not followed - interaction term 'age_group' is used without its main effect. Consider adding 'age_group' to prognostic terms for proper model hierarchy. #>  #> Step 2: Fitting the brms model... #> Using trt_var from prepared_model: trt #> Using sigma_ref = 13.287 #> Computed outcome mean: -11.302 #> Using default priors for unspecified effects: #>   - intercept: normal(-11.3016300423315, 33.2173779229901) #>   - unshrunk terms: normal(0, 33.2173779229901) #>   - shrunk predictive: horseshoe(1) #> Fitting brms model... #> Start sampling #> Running MCMC with 1 chain... #>  #> Chain 1 WARNING: There aren't enough warmup iterations to fit the  #> Chain 1          three stages of adaptation as currently configured.  #> Chain 1          Reducing each adaptation stage to 15%/75%/10% of  #> Chain 1          the given number of warmup iterations:  #> Chain 1            init_buffer = 15  #> Chain 1            adapt_window = 75  #> Chain 1            term_buffer = 10  #> Chain 1 finished in 2.7 seconds. #> Warning: 56 of 100 (56.0%) transitions hit the maximum treedepth limit of 10. #> See https://mc-stan.org/misc/warnings for details. #>  #> Analysis complete. strat_continuous_summary <- summary_subgroup_effects(   brms_fit = fit_continuous_stratified   # All parameters automatically extracted! ) #> Using trt_var from model attributes: trt #> Using response_type from model attributes: continuous #> --- Calculating specific subgroup effects... --- #> Using data from model attributes #> Step 1: Identifying subgroups and creating counterfactuals... #> `subgroup_vars` set to 'auto'. Detecting from model... #> Model data has 180 rows and 6 columns #> Column names: id, clinic_site, trt, baseline_sbp, age_group, sbp_change #> Treatment variable: 'trt' #> All coefficient names: #> sigma_Intercept #> unshrunktermeffect_Intercept #> unshrunktermeffect_baseline_sbp #> unshrunktermeffect_trt #> sigma_clinic_siteSiteB #> sigma_clinic_siteSiteC #> shpredeffect_trt:age_groupOver60 #> shpredeffect_trt:age_groupUnder60 #> Looking for treatment interactions with pattern: 'trt:' #> Found 2 treatment interaction coefficients #> Treatment interaction coefficients found: #> shpredeffect_trt:age_groupOver60 #> shpredeffect_trt:age_groupUnder60 #> Detected subgroup variable 'age_group' from coefficient 'shpredeffect_trt:age_groupOver60' #> Detected subgroup variable 'age_group' from coefficient 'shpredeffect_trt:age_groupUnder60' #> Checking for random effects parameters... #> Retrieved 15 total parameters from model #> Using regex pattern: '^r_(.+)__[^\\[]+\\[[^,]+,trt\\]' #> Found 0 matching random effect parameters #> No random effect parameters matching the pattern were found #> ...detected subgroup variable(s): age_group #> Step 2: Generating posterior predictions... #> ... detected Fixed Effects (Colon model). Predicting with re_formula = NA. #> ... (predicting expected outcomes)... #> Step 3: Calculating marginal effects... #> ... processing age_group #> Done.  print(strat_continuous_summary$estimates) #> # A tibble: 2 × 4 #>   Subgroup           Median CI_Lower CI_Upper #>   <chr>               <dbl>    <dbl>    <dbl> #> 1 age_group: Over60  -11.5     -14.3    -8.22 #> 2 age_group: Under60  -9.26    -11.9    -5.77 plot(strat_continuous_summary, title = \"Stratified Continuous: Subgroup Effects\") #> Preparing data for plotting... #> Generating plot... #> Done."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"example-10-stratified-survival-model","dir":"Articles","previous_headings":"4 Stratification for Nuisance Parameters","what":"Example 10: Stratified Survival Model","title":"Advanced Functionalities","text":"Scenario: model time--event outcome baseline hazard \\(h_0(t)\\) differs \\(\\text{country}\\). particularly important multi-regional trials regional differences standard care affect baseline risk.","code":"set.seed(123) n_patients <- 200 lambda_by_country <- c(US = 0.01, EU = 0.03) surv_data_strat <- data.frame(     id = 1:n_patients,     country = factor(sample(c(\"US\", \"EU\"), n_patients, replace = TRUE)),     trt = factor(sample(0:1, n_patients, replace = TRUE)),     age = rnorm(n_patients, 65, 10),     biomarker = factor(sample(c(\"Low\", \"High\"), n_patients, replace = TRUE)) ) lp <- (as.integer(surv_data_strat$trt)-1) * -0.6 + (surv_data_strat$age - 65) * 0.03 +       (as.integer(surv_data_strat$trt)-1) * (as.integer(surv_data_strat$biomarker) - 1) * -0.5 u <- runif(n_patients) lambda_vec <- lambda_by_country[surv_data_strat$country] gamma <- 1.5 # Weibull shape parameter true_event_time <- (-log(u) / (lambda_vec * exp(lp)))^(1/gamma) censoring_time <- 60 # Administrative censoring time surv_data_strat$event_status <- ifelse(true_event_time <= censoring_time, 1, 0) surv_data_strat$event_time <- pmin(true_event_time, censoring_time) # Model Fitting with Stratified Baseline Hazard fit_surv_stratified <- run_brms_analysis(   data = surv_data_strat,   response_formula = Surv(event_time, event_status) ~ trt,   response_type = \"survival\",   unshrunk_terms_formula = ~ age,   shrunk_predictive_formula = ~ 0 + trt:biomarker,   stratification_formula = ~ country,   sigma_ref = 1,  # For survival models, typically use 1   chains = 1, iter = 200, warmup = 100, cores = 1, refresh = 0, backend = \"cmdstanr\" ) #> Step 1: Preparing formula and data... #> Converting treatment variable 'trt' to numeric binary (0/1). '0' = 0, '1' = 1 #> Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz(). #> Applying stratification: estimating separate baseline hazards by 'country'. #> Note: Treatment 'trt' automatically added to unshrunk terms. #> Note: Applied one-hot encoding to shrunken factor 'biomarker' (will be used with ~ 0 + ...) #> Note: Marginality principle not followed - interaction term 'biomarker' is used without its main effect. Consider adding 'biomarker' to prognostic terms for proper model hierarchy. #>  #> Step 2: Fitting the brms model... #> Using trt_var from prepared_model: trt #> Using sigma_ref = 1 #> Using default priors for unspecified effects: #>   - unshrunk terms: normal(0, 1.5) #>   - shrunk predictive: horseshoe(1) #> Fitting brms model... #> Start sampling #> Running MCMC with 1 chain... #>  #> Chain 1 WARNING: There aren't enough warmup iterations to fit the  #> Chain 1          three stages of adaptation as currently configured.  #> Chain 1          Reducing each adaptation stage to 15%/75%/10% of  #> Chain 1          the given number of warmup iterations:  #> Chain 1            init_buffer = 15  #> Chain 1            adapt_window = 75  #> Chain 1            term_buffer = 10  #> Chain 1 finished in 7.6 seconds. #> Warning: 100 of 100 (100.0%) transitions hit the maximum treedepth limit of 10. #> See https://mc-stan.org/misc/warnings for details. #>  #> Analysis complete. strat_surv_summary <- summary_subgroup_effects(   brms_fit = fit_surv_stratified   # All parameters automatically extracted! ) #> Using trt_var from model attributes: trt #> Using response_type from model attributes: survival #> --- Calculating specific subgroup effects... --- #> Using data from model attributes #> Step 1: Identifying subgroups and creating counterfactuals... #> `subgroup_vars` set to 'auto'. Detecting from model... #> Model data has 200 rows and 7 columns #> Column names: id, country, trt, age, biomarker, event_status, event_time #> Treatment variable: 'trt' #> All coefficient names: #> unshrunktermeffect_age #> unshrunktermeffect_trt #> shpredeffect_trt:biomarkerHigh #> shpredeffect_trt:biomarkerLow #> Looking for treatment interactions with pattern: 'trt:' #> Found 2 treatment interaction coefficients #> Treatment interaction coefficients found: #> shpredeffect_trt:biomarkerHigh #> shpredeffect_trt:biomarkerLow #> Detected subgroup variable 'biomarker' from coefficient 'shpredeffect_trt:biomarkerHigh' #> Detected subgroup variable 'biomarker' from coefficient 'shpredeffect_trt:biomarkerLow' #> Checking for random effects parameters... #> Retrieved 22 total parameters from model #> Using regex pattern: '^r_(.+)__[^\\[]+\\[[^,]+,trt\\]' #> Found 0 matching random effect parameters #> No random effect parameters matching the pattern were found #> ...detected subgroup variable(s): biomarker #> Step 2: Generating posterior predictions... #> ... detected Fixed Effects (Colon model). Predicting with re_formula = NA. #> ... (reconstructing baseline hazard and getting linear predictors)... #> Warning: Dropping 'draws_df' class as required metadata was removed. #> Warning: Dropping 'draws_df' class as required metadata was removed. #> Step 3: Calculating marginal effects... #> ... processing biomarker #> Done.  print(strat_surv_summary$estimates) #> # A tibble: 2 × 4 #>   Subgroup        Median CI_Lower CI_Upper #>   <chr>            <dbl>    <dbl>    <dbl> #> 1 biomarker: High  0.592    0.476    0.832 #> 2 biomarker: Low   0.376    0.263    0.522 plot(strat_surv_summary, title = \"Stratified Survival: Subgroup Effects (AHR)\") #> Preparing data for plotting... #> Generating plot... #> Done."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Advanced_Functionalities.html","id":"summary","dir":"Articles","previous_headings":"","what":"Summary","title":"Advanced Functionalities","text":"vignette demonstrated advanced functionalities bonsaiforest2: Offset variables count outcomes varying exposure times Custom prior specification new sigma_ref API One-hot encoding full factor representation interactions Coefficient-specific priors fine-grained control Hierarchical priors shared variance using stanvars Stratification nuisance parameters vary groups features provide researchers powerful tools complex trial analyses maintaining principled Bayesian shrinkage framework.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"introduction","dir":"Articles","previous_headings":"","what":"Introduction","title":"Quickstart","text":"bonsaiforest2 package consists 3 core functions typically called sequence: run_brms_analysis() - Prepares model formula fits Bayesian model using brms. summary_subgroup_effects() - Calculates marginal subgroup treatment effects. plot() - Creates forest plot summary object. package enables implementation global modeling approach (Wolbers et al. 2025), estimates prognostic predictive effects single model, One-Variable---Time (OVAT) approach (Wang et al. 2024), estimates predictive effects using different model subgrouping variable. vignette demonstrates use package fit compare different modeling formulas. ’ll learn : Fit OVAT models (one model per subgroup variable) Fit global model (subgroup variables one model) Generate summaries subgroup treatment effects Visualize compare results different model specifications example makes use Bayesian modeling, requires installation brms package working Stan installation (e.g., via cmdstanr).","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"the-data","dir":"Articles","previous_headings":"","what":"The Data","title":"Quickstart","text":"use simulated example dataset representing clinical trial blood pressure. relevant endpoint change Systolic Blood Pressure (SBP) baseline (sbp_change). consider model want find treatment effect (trt) sbp_change. model adjust baseline_sbp prognostic variable (predictor outcome) explore multiple subgroup variables predictive variables (potential treatment effect modifiers): region: Geographic region (USA, EU, APAC) comorbidity: Presence comorbidities (Yes, ) age_group: Age category (< 50, 50-65, > 65) sex: Biological sex (M, F) diabetes: Diabetes status (Yes, ) First, let’s load libraries create data.","code":"# Load the main package library(bonsaiforest2) library(brms) # Create the example data with multiple subgroup variables set.seed(123) n_patients <- 300  continuous_data <- data.frame(   id = 1:n_patients,   sbp_change = rnorm(n_patients, mean = -5, sd = 10),   trt = sample(0:1, n_patients, replace = TRUE),   baseline_sbp = rnorm(n_patients, mean = 140, sd = 15),   region = factor(sample(c(\"USA\", \"EU\", \"APAC\"), n_patients, replace = TRUE)),   comorbidity = factor(sample(c(\"Yes\", \"No\"), n_patients, replace = TRUE, prob = c(0.4, 0.6))),   age_group = factor(sample(c(\"<50\", \"50-65\", \">65\"), n_patients, replace = TRUE, prob = c(0.3, 0.4, 0.3))),   sex = factor(sample(c(\"M\", \"F\"), n_patients, replace = TRUE)),   diabetes = factor(sample(c(\"Yes\", \"No\"), n_patients, replace = TRUE, prob = c(0.3, 0.7))) )  continuous_data$trt <- factor(continuous_data$trt, levels = c(0, 1))  print(head(continuous_data)) #>   id sbp_change trt baseline_sbp region comorbidity age_group sex diabetes #> 1  1 -10.604756   1     161.4560   APAC          No     50-65   M      Yes #> 2  2  -7.301775   1     155.6994     EU          No       <50   F       No #> 3  3  10.587083   1     146.5293     EU          No       <50   F       No #> 4  4  -4.294916   0     150.7277     EU          No       <50   F       No #> 5  5  -3.707123   0     153.7576   APAC         Yes     50-65   M       No #> 6  6  12.150650   0     100.0862     EU          No     50-65   F      Yes"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"ovat-one-variable-at-a-time","dir":"Articles","previous_headings":"","what":"OVAT: One Variable At a Time","title":"Quickstart","text":"section demonstrates fit separate models, examining one subgroup variable time. ’ll fit model 5 subgroup variables.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"ovat-region-only","dir":"Articles","previous_headings":"3 OVAT: One Variable At a Time","what":"OVAT: Region Only","title":"Quickstart","text":"","code":"# Write the sigma specified in the trial protocol priors <- c(   prior(normal(0, 5), class = \"sd\", coef = \"Intercept\", group = \"SEX\"),   prior(normal(0, 5), class = \"sd\", coef = \"TRT01PN\", group = \"SEX\"),   prior(gamma(2, 0.1), class = \"shape\") )  sigma_ref <- 2  # Fit model with only region as subgroup variable ovat_region <- run_brms_analysis(   data = continuous_data,   response_formula = sbp_change ~ trt,   response_type = \"continuous\",   unshrunk_terms_formula = ~ baseline_sbp,   shrunk_predictive_formula = ~ 0+ (1+trt||region),   sigma_ref = sigma_ref,   chains = 1, iter = 2000, warmup = 1000, cores = 1,   refresh = 0, backend = \"cmdstanr\" ) #> Running MCMC with 1 chain... #>  #> Chain 1 finished in 3.0 seconds.  summary_ovat_region <- summary_subgroup_effects(brms_fit = ovat_region)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"ovat-comorbidity-only","dir":"Articles","previous_headings":"3 OVAT: One Variable At a Time","what":"OVAT: Comorbidity Only","title":"Quickstart","text":"","code":"ovat_comorbidity <- run_brms_analysis(   data = continuous_data,   response_formula = sbp_change ~ trt,   response_type = \"continuous\",   unshrunk_terms_formula = ~ baseline_sbp,   shrunk_predictive_formula = ~ 0 + (1+trt||comorbidity),   sigma_ref = sigma_ref,   chains = 1, iter = 2000, warmup = 1000, cores = 1,   refresh = 0, backend = \"cmdstanr\" ) #> Running MCMC with 1 chain... #>  #> Chain 1 finished in 3.3 seconds.  summary_ovat_comorbidity <- summary_subgroup_effects(brms_fit = ovat_comorbidity)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"ovat-age-group-only","dir":"Articles","previous_headings":"3 OVAT: One Variable At a Time","what":"OVAT: Age Group Only","title":"Quickstart","text":"","code":"ovat_age <- run_brms_analysis(   data = continuous_data,   response_formula = sbp_change ~ trt,   response_type = \"continuous\",   unshrunk_terms_formula = ~ baseline_sbp,   shrunk_predictive_formula = ~ 0 + (1+trt||age_group),   sigma_ref = sigma_ref,   chains = 1, iter = 2000, warmup = 1000, cores = 1,   refresh = 0, backend = \"cmdstanr\" ) #> Running MCMC with 1 chain... #>  #> Chain 1 finished in 3.0 seconds.  summary_ovat_age <- summary_subgroup_effects(brms_fit = ovat_age, subgroup_vars = \"age_group\")"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"ovat-sex-only","dir":"Articles","previous_headings":"3 OVAT: One Variable At a Time","what":"OVAT: Sex Only","title":"Quickstart","text":"","code":"ovat_sex <- run_brms_analysis(   data = continuous_data,   response_formula = sbp_change ~ trt,   response_type = \"continuous\",   unshrunk_terms_formula = ~ baseline_sbp,   shrunk_predictive_formula = ~ 0 + (1+trt||sex),   sigma_ref = sigma_ref,   chains = 1, iter = 2000, warmup = 1000, cores = 1,   refresh = 0, backend = \"cmdstanr\" ) #> Running MCMC with 1 chain... #>  #> Chain 1 finished in 3.2 seconds.  summary_ovat_sex <- summary_subgroup_effects(brms_fit = ovat_sex)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"ovat-diabetes-only","dir":"Articles","previous_headings":"3 OVAT: One Variable At a Time","what":"OVAT: Diabetes Only","title":"Quickstart","text":"","code":"ovat_diabetes <- run_brms_analysis(   data = continuous_data,   response_formula = sbp_change ~ trt,   response_type = \"continuous\",   unshrunk_terms_formula = ~ baseline_sbp,   shrunk_predictive_formula = ~ 0 + (1+trt||diabetes),   sigma_ref = sigma_ref,   chains = 1, iter = 2000, warmup = 1000, cores = 1,   refresh = 0, backend = \"cmdstanr\" ) #> Running MCMC with 1 chain... #>  #> Chain 1 finished in 3.6 seconds.  summary_ovat_diabetes <- summary_subgroup_effects(brms_fit = ovat_diabetes)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"ovat-visualizing-all-models","dir":"Articles","previous_headings":"3 OVAT: One Variable At a Time","what":"OVAT: Visualizing All Models","title":"Quickstart","text":"can combine visualize results multiple models using combine_summaries():","code":"# Combine all OVAT models combined_ovat <- combine_summaries(list(   \"Region\" = summary_ovat_region,   \"Comorbidity\" = summary_ovat_comorbidity,   \"Age Group\" = summary_ovat_age,   \"Sex\" = summary_ovat_sex,   \"Diabetes\" = summary_ovat_diabetes ))  plot(combined_ovat, title = \"OVAT: All Subgroup Variables\") #> Preparing data for plotting... #> Generating plot... #> Done."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"global-modeling-approach","dir":"Articles","previous_headings":"","what":"Global Modeling Approach","title":"Quickstart","text":"section demonstrates fit single model includes subgroup variables simultaneously.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"global-model-all-subgroups","dir":"Articles","previous_headings":"4 Global Modeling Approach","what":"Global Model: All Subgroups","title":"Quickstart","text":"","code":"# Fit a single model with ALL subgroup variables global_model <- run_brms_analysis(   data = continuous_data,   response_formula = sbp_change ~ trt,   response_type = \"continuous\",   unshrunk_terms_formula = ~ baseline_sbp + region + comorbidity + age_group + sex + diabetes,   shrunk_predictive_formula = ~ 0 + trt:region+trt:comorbidity + trt:age_group + trt:sex + trt:diabetes,   shrunk_predictive_prior = \"horseshoe(1)\",   sigma_ref = sigma_ref,   chains = 1, iter = 2000, warmup = 1000, cores = 1,   refresh = 0, backend = \"cmdstanr\" ) #> Running MCMC with 1 chain... #>  #> Chain 1 finished in 3.7 seconds."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"global-model-summary-of-subgroup-effects","dir":"Articles","previous_headings":"4 Global Modeling Approach","what":"Global Model: Summary of Subgroup Effects","title":"Quickstart","text":"Use summary_subgroup_effects() generate marginal treatment effects subgroup. function automatically extracts necessary parameters fitted model:","code":"global_summary <- summary_subgroup_effects(   brms_fit = global_model ) #> Using trt_var from model attributes: trt #> Using response_type from model attributes: continuous #> --- Calculating specific subgroup effects... --- #> Using data from model attributes #> Step 1: Identifying subgroups and creating counterfactuals... #> `subgroup_vars` set to 'auto'. Detecting from model... #> Model data has 300 rows and 14 columns #> Column names: id, sbp_change, trt, baseline_sbp, region, comorbidity, age_group, sex, diabetes, region_onehot, comorbidity_onehot, age_group_onehot, sex_onehot, diabetes_onehot #> Treatment variable: 'trt' #> All coefficient names: #> unshrunktermeffect_Intercept #> unshrunktermeffect_baseline_sbp #> unshrunktermeffect_regionEU #> unshrunktermeffect_regionUSA #> unshrunktermeffect_comorbidityYes #> unshrunktermeffect_age_group>65 #> unshrunktermeffect_age_group50M65 #> unshrunktermeffect_sexM #> unshrunktermeffect_diabetesYes #> unshrunktermeffect_trt #> shpredeffect_trt:region_onehotAPAC #> shpredeffect_trt:region_onehotEU #> shpredeffect_trt:region_onehotUSA #> shpredeffect_trt:comorbidity_onehotNo #> shpredeffect_trt:comorbidity_onehotYes #> shpredeffect_trt:age_group_onehot<50 #> shpredeffect_trt:age_group_onehot>65 #> shpredeffect_trt:age_group_onehot50M65 #> shpredeffect_trt:sex_onehotF #> shpredeffect_trt:sex_onehotM #> shpredeffect_trt:diabetes_onehotNo #> shpredeffect_trt:diabetes_onehotYes #> Looking for treatment interactions with pattern: 'trt:' #> Found 12 treatment interaction coefficients #> Treatment interaction coefficients found: #> shpredeffect_trt:region_onehotAPAC #> shpredeffect_trt:region_onehotEU #> shpredeffect_trt:region_onehotUSA #> shpredeffect_trt:comorbidity_onehotNo #> shpredeffect_trt:comorbidity_onehotYes #> shpredeffect_trt:age_group_onehot<50 #> shpredeffect_trt:age_group_onehot>65 #> shpredeffect_trt:age_group_onehot50M65 #> shpredeffect_trt:sex_onehotF #> shpredeffect_trt:sex_onehotM #> shpredeffect_trt:diabetes_onehotNo #> shpredeffect_trt:diabetes_onehotYes #> Detected subgroup variable 'region_onehot' from coefficient 'shpredeffect_trt:region_onehotAPAC' #> Detected subgroup variable 'region_onehot' from coefficient 'shpredeffect_trt:region_onehotEU' #> Detected subgroup variable 'region_onehot' from coefficient 'shpredeffect_trt:region_onehotUSA' #> Detected subgroup variable 'comorbidity_onehot' from coefficient 'shpredeffect_trt:comorbidity_onehotNo' #> Detected subgroup variable 'comorbidity_onehot' from coefficient 'shpredeffect_trt:comorbidity_onehotYes' #> Detected subgroup variable 'age_group_onehot' from coefficient 'shpredeffect_trt:age_group_onehot<50' #> Detected subgroup variable 'age_group_onehot' from coefficient 'shpredeffect_trt:age_group_onehot>65' #> Detected subgroup variable 'age_group_onehot' from coefficient 'shpredeffect_trt:age_group_onehot50M65' #> Detected subgroup variable 'sex_onehot' from coefficient 'shpredeffect_trt:sex_onehotF' #> Detected subgroup variable 'sex_onehot' from coefficient 'shpredeffect_trt:sex_onehotM' #> Detected subgroup variable 'diabetes_onehot' from coefficient 'shpredeffect_trt:diabetes_onehotNo' #> Detected subgroup variable 'diabetes_onehot' from coefficient 'shpredeffect_trt:diabetes_onehotYes' #> Checking for random effects parameters... #> Retrieved 39 total parameters from model #> Using regex pattern: '^r_(.+)__[^\\[]+\\[[^,]+,trt\\]' #> Found 0 matching random effect parameters #> No random effect parameters matching the pattern were found #> ...detected subgroup variable(s): region_onehot, comorbidity_onehot, age_group_onehot, sex_onehot, diabetes_onehot #> Step 2: Generating posterior predictions... #> ... detected Fixed Effects (Colon model). Predicting with re_formula = NA. #> ... (predicting expected outcomes)... #> Step 3: Calculating marginal effects... #> ... processing region_onehot #> ... processing comorbidity_onehot #> ... processing age_group_onehot #> ... processing sex_onehot #> ... processing diabetes_onehot #> Done.  print(global_summary) #> $estimates #> # A tibble: 12 × 4 #>    Subgroup          Median CI_Lower CI_Upper #>    <chr>              <dbl>    <dbl>    <dbl> #>  1 region: APAC     1.53      -1.26      4.88 #>  2 region: EU       0.764     -1.95      3.47 #>  3 region: USA      0.379     -2.60      3.12 #>  4 comorbidity: No  0.607     -1.75      3.11 #>  5 comorbidity: Yes 1.28      -1.37      3.93 #>  6 age_group: <50   1.28      -1.61      4.28 #>  7 age_group: >65   0.852     -2.12      3.93 #>  8 age_group: 50-65 0.661     -1.80      3.20 #>  9 sex: F           0.00542   -2.87      2.66 #> 10 sex: M           1.65      -0.775     4.30 #> 11 diabetes: No     0.312     -2.21      2.72 #> 12 diabetes: Yes    2.01      -0.845     5.15 #>  #> $response_type #> [1] \"continuous\" #>  #> $ci_level #> [1] 0.95 #>  #> $trt_var #> [1] \"trt\" #>  #> attr(,\"class\") #> [1] \"subgroup_summary\""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"global-model-visualization","dir":"Articles","previous_headings":"4 Global Modeling Approach","what":"Global Model: Visualization","title":"Quickstart","text":"Use plot() function create forest plot summary object:","code":"plot(global_summary, title = \"Global Model: All Subgroup Variables\") #> Preparing data for plotting... #> Generating plot... #> Done."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"comparing-multiple-models-in-one-plot","dir":"Articles","previous_headings":"","what":"Comparing Multiple Models in One Plot","title":"Quickstart","text":"plot() function supports comparing multiple models side--side. Pass named list subgroup_summary objects create comparative forest plot.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Quickstart.html","id":"example-comparing-ovat-vs-global-model","dir":"Articles","previous_headings":"5 Comparing Multiple Models in One Plot","what":"Example: Comparing OVAT vs Global Model","title":"Quickstart","text":"","code":"# Combine summaries for comparison combined <- combine_summaries(list(   \"OVAT\" = combined_ovat,   \"Global Model\" = global_summary ))  # Plot the comparison plot(combined, title = \"Comparing OVAT vs Global Model\") #> Preparing data for plotting... #> Generating plot... #> Done."},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"scope-of-this-document","dir":"Articles","previous_headings":"","what":"Scope of this document","title":"Statistical Specifications","text":"document describes statistical methods implemented bonsaiforest2 R package Bayesian subgroup analysis continuous, binary, count, time--event outcomes randomized clinical trials (RCTs). package enable implementation global modeling approach (Wolbers et al. 2025), estimates prognostic predictive effects single model, One-variable-time (Wang et al. 2024), estimates predictive effects using different model subgrouping variable. core features described document : Prognostic (main) vs. Predictive (interaction) effects. Shrunk vs. Unshrunk coefficients. Users can specify unshrunk terms (weakly informative priors), add shrunk prognostic effects /shrunk predictive effects (strong regularization priors) needed analysis. Customizable Priors: Users can specify custom priors individual coefficients coefficient groups domain expertise available. custom priors specified, package applies automatic, well-calibrated default priors. Advanced Shrinkage Priors: Supports state---art shrinkage priors, including Regularized Horseshoe (Piironen Vehtari 2017; Wolbers et al. 2025) R2D2 (Zhang et al. 2022). estimate_subgroup_effects() computational G-computation workflow. summary_subgroup_effects() user-friendly effect summaries. document structured follows: Section 2 provides conceptual introduction subgroup analysis challenges Bayesian shrinkage solution. Section 3 details statistical methodology, including notation, global one-variable time models, endpoint-specific likelihoods, prior specifications, standardization procedure. Section 4 maps statistical methods core functions bonsaiforest2 package.","code":""},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"the-challenge-of-subgroup-analysis","dir":"Articles","previous_headings":"2 Introduction to Subgroup Analysis and Estimation","what":"The Challenge of Subgroup Analysis","title":"Statistical Specifications","text":"Exploratory subgroup analyses standard part RCT reporting, typically visualized forest plots assess consistency treatment effects. However, interpretation notoriously difficult due several statistical challenges: Low Power: Subgroups smaller sample sizes, leading low precision (wide confidence intervals) inability detect true, modest differences effect. Multiplicity: Examining many subgroups (e.g., 20 ) inflates risk false-positive findings. Investigators may focus extreme results, often spurious. Overfitting: Standard subgroup-specific estimates (fitting model data within subgroup) unbiased high variance, leading overestimation heterogeneity. led common recommendation overall treatment effect often reliable estimate subgroup estimate derived subgroup’s data alone.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"prognostic-vs--predictive-effects","dir":"Articles","previous_headings":"2 Introduction to Subgroup Analysis and Estimation","what":"Prognostic vs. Predictive Effects","title":"Statistical Specifications","text":"build meaningful model, crucial distinguish baseline variable relates outcome: Prognostic Effect: variable prognostic associated clinical outcome, regardless treatment received. describes natural course disease. model, main effect. Predictive Effect: variable predictive value modifies magnitude direction treatment’s effect. identifies heterogeneity. model, treatment--variable interaction. bonsaiforest2 built model types effects explicitly apply different modeling strategies (e.g., shrinkage) .","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"the-role-of-bayesian-shrinkage","dir":"Articles","previous_headings":"2 Introduction to Subgroup Analysis and Estimation","what":"The Role of Bayesian Shrinkage","title":"Statistical Specifications","text":"Bayesian shrinkage methods directly address challenges subgroup analysis providing principled compromise two extremes “pooling” (subgroup-specific estimates) “full pooling” (overall population estimate). compromise, often called partial pooling, achieved using hierarchical models. Subgroup effects assumed exchangeable (drawn common distribution). assumption allows subgroups “borrow strength” : Subgroups small sample sizes extreme results “shrunk” heavily toward overall mean, reducing variance. Subgroups large sample sizes strong evidence real effect shrunk less, allowing data dominate. results estimates better bias-variance trade-: accept small amount bias (pulling real effects slightly toward mean) exchange large reduction variance, leading lower overall error better control spurious findings.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"conditional-vs--marginal-estimands","dir":"Articles","previous_headings":"2 Introduction to Subgroup Analysis and Estimation","what":"Conditional vs. Marginal Estimands","title":"Statistical Specifications","text":"covariates included non-linear model (like logistic Cox model), resulting coefficients represent conditional effects. example, treatment effect effect patient specific set covariate values (e.g., reference values). problematic forest plots, want know marginal effect: “average treatment effect patients ‘Female’ subgroup, averaging different ages, regions, etc.?”. different subgroups different covariate distributions (e.g., age >= 65 subgroup different health status profile age < 65 group), conditional coefficients directly comparable. bonsaiforest2 solves using Standardization (G-computation) (Hernán Robins 2023). procedure correctly averages specific covariate distribution subgroup estimate valid marginal treatment effect, ensuring subgroups compared interpretable scale. (See Section 3.10 detailed explanation standardization performed package.)","code":""},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"setting-and-notation","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"Setting and Notation","title":"Statistical Specifications","text":"establish following notation global model: \\(= 1, \\dots, N\\): Index individual patients. \\(y_i\\): outcome patient \\(\\). consider variable can binary, count, continuous time--event endpoint. \\(s_i\\): binary treatment indicator (\\(s_i=1\\) treatment, \\(s_i=0\\) control). \\(l = 1, \\dots, L\\): Index overall subgroup level (e.g., “Male”, “Female”, “EU”, “USA”). \\(x_{il}\\): Indicator (0/1) patient \\(\\) belonging subgroup level \\(l\\) (used prognostic effects). \\(z_{il} = s_i \\cdot x_{il}\\): interaction treatment subgroup level \\(l\\) (used predictive effects). \\(u_{iv}\\): Value \\(v\\)-th additional non-subgroup covariate patient \\(\\). additional covariates don’t need binary categorical. \\(\\boldsymbol{\\mu}\\): \\(N \\times 1\\) vector expected outcomes. \\(g(\\cdot)\\): link function. Section 3.7 define used link function type endpoint. \\(\\boldsymbol{\\eta}\\): \\(N \\times 1\\) vector linear predictor.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"design-matrix-considerations","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"Design Matrix Considerations","title":"Statistical Specifications","text":"critical implementation detail construction design matrix, varies based whether coefficients subject shrinkage. package applies different contrast coding schemes shrunk versus unshrunk terms: unshrunk terms (prognostic predictive): Standard dummy coding used, one level per factor treated reference category omitted design matrix. approach: Ensures interpretability coefficients relative baseline Avoids collinearity intercept Results L−J total columns J subgrouping variables L total levels appropriate coefficients given weakly informative priors without strong regularization shrunk terms (prognostic predictive): One-hot encoding used, creating explicit dummy variables levels factor, reference level omitted. example, subgrouping variable levels {, B, C} creates three columns: subgroupA, subgroupB, subgroupC (prognostic effects) trt:subgroupA, trt:subgroupB, trt:subgroupC (predictive effects). approach ensures: subgroup levels treated symmetrically exchangeability assumption shrinkage prior single level serves anchor point toward levels shrunk level interpretable parameter can independently regularized Predictions work correctly G-computation (see Section 3.10) rationale one-hot encoding shrunk terms shrinkage priors assume exchangeability among coefficients—levels drawn prior distribution. reference level break symmetry bias shrinkage process.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"the-principle-of-model-hierarchy","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"The Principle of Model Hierarchy","title":"Statistical Specifications","text":"fundamental concept regression modeling principle model hierarchy (marginality). principle states model includes interaction term (e.g., :B), also include corresponding main effects (e.g., B). context bonsaiforest2, means subgrouping variable included predictive (.e., interaction treatment, like trt:subgroup) also included prognostic (.e., main effect, subgroup). Including main effect ensures interaction term purely captures modification treatment effect, rather mix main prognostic effect interaction, leading stable interpretable model. bonsaiforest2 package checks adherence principle model specification. prepare_formula_model function examines whether main effect specified prognostic every variable included predictive term. , function issues warning recommending user include corresponding main effect ensure proper model hierarchy. However, package enforce automatically, allowing users flexibility override recommendation justified domain knowledge specific modeling goals.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-global","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"The Global Model","title":"Statistical Specifications","text":"package enables implementation global model (Wolbers et al. 2025) effects estimated single, comprehensive regression formula.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"full-model-equation","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.4 The Global Model","what":"Full Model Equation","title":"Statistical Specifications","text":"Matrix form: model linear predictor, \\(\\boldsymbol{\\eta}\\), \\(N\\) patients given : \\[g(\\boldsymbol{\\mu}) = \\boldsymbol{\\eta} = \\underbrace{\\mathbf{X_p}\\boldsymbol{\\beta_{1,p}}}_{\\text{Penalized prognostic effects}} +\\underbrace{\\mathbf{X_n}\\boldsymbol{\\beta_{1,n}}}_{\\text{Non-penalized prognostic effects}} +\\underbrace{\\mathbf{Z_p}\\boldsymbol{\\beta_{2,p}}}_{\\text{Penalized predictive effects}} +\\] \\[ \\underbrace{\\mathbf{Z_n}\\boldsymbol{\\beta_{2,n}}}_{\\text{Non-penalized predictive effects}}+ \\underbrace{\\mathbf{U}\\boldsymbol{\\beta_{3}}}_{\\text{Extra prognostic effects}} \\] Bayesian hierarchical structure applied follows: Penalized Coefficients: \\(\\boldsymbol{\\beta_{1,p}}\\) \\(\\boldsymbol{\\beta_{2,p}}\\) given shrinkage priors. Non-Penalized Coefficients: \\(\\boldsymbol{\\beta_{1,n}}\\) \\(\\boldsymbol{\\beta_{2,n}}\\) given standard, weakly informative priors. Extra prognostic effects Coefficients: \\(\\boldsymbol{\\beta_3}\\) given standard, weakly informative priors. Components definition: \\(\\mathbf{X}= [\\mathbf{X_p} \\;\\;  \\mathbf{X}_n]\\) \\(N \\times M\\) design matrix prognostic effects. typically includes: intercept column. Section 3.6 discuss inclusion prior give intercept detail column main treatment effect. Columns prognostic effects subgroup level. contrast coding depends shrinkage status: Unshrunk terms (\\(\\mathbf{X}_n\\)): Use dummy coding (one reference level per factor dropped) Shrunk terms (\\(\\mathbf{X}_p\\)): Use one-hot encoding (levels included maintain exchangeability) Example: Table 3.1: Example design matrix unshrunk prognostic effects (dummy coding). Note: unshrunk terms, M=1+1+L-J= 1 intercept + 1 treatment + L (total subgroup levels) - J (number subgrouping variables) reference levels dropped. shrunk terms, L levels included (reference level dropped). \\(\\boldsymbol{\\beta_{1,p}}\\) \\(P \\times 1\\) vector coefficients prognostic effects want shrink. give shrinkage prior coefficients. \\(\\boldsymbol{\\beta_{1,n}}\\) \\((M-P) \\times 1\\) vector coefficients prognostic effects don’t want shrink. \\(\\mathbf{Z}= [\\mathbf{Z_p} \\;\\;  \\mathbf{Z}_n]\\) design matrix predictive effects. contrast coding depends shrinkage status: Unshrunk predictive terms (\\(\\mathbf{Z}_n\\)): Use dummy coding (one reference interaction per factor dropped) Shrunk predictive terms (\\(\\mathbf{Z}_p\\)): Use one-hot encoding column trt_subgroupLEVEL equals 1 patient \\(\\) treatment (\\(s_i = 1\\)) belongs specific subgroup level, 0 otherwise. \\(L\\) interaction dummies included ensure subgroups treated symmetrically exchangeability assumption. Table 3.2: Example design matrix shrunk predictive effects (one-hot encoding) \\(\\boldsymbol{\\beta_{2,p}}\\) \\(R \\times 1\\) vector coefficients predictive effects want shrink. give shrinkage prior coefficients. \\(\\boldsymbol{\\beta_{2,n}}\\) \\((L-R) \\times 1\\) vector coefficients predictive effects don’t want shrink. \\(U\\) \\(N \\times V\\) design matrix extra variables want take account fitting model. also unpenalized. \\(\\boldsymbol{\\beta_3}\\) \\(V \\times 1\\) vector extra prognostic effects coefficients Linear form: make concrete, linear predictor single patient \\(\\) can written : \\[ \\eta_i = \\underbrace{\\beta_0 + \\beta_{\\text{treat}}s_i + \\underbrace{\\sum_{l=1}^{P} \\beta^l_{1,p}x^{il}_n}_\\text{penalized}+ \\underbrace{\\sum_{l=P+1}^{M}  \\beta^l_{1,n}x^{il}_n}_\\text{penalized}+\\underbrace{\\sum_{v=1}^{V} \\beta_{3}^vu^{iv}}_{\\text{Extra }}}_{\\text{Prognostic Effects}} + \\underbrace{\\underbrace{\\sum_{l=1}^{L-R} \\beta_{2,p}^l z_p^{il}}_{\\text{penalized }} + \\underbrace{\\sum_{l=L-R+1}^{L} \\beta_{2,n}^l z_n^{il}}_{\\text{penalized}} }_{\\text{Predictive effects}} \\] Note: See even \\(z^{il}=x^{il}\\cdot s^{}\\), prognostic effect predictive effect subgrouping variable may penalized , separate \\(x\\) \\(z\\) formula.","code":"# Example: Unshrunk prognostic effects using dummy coding design_matrix_df <- data.frame(   Patient    = c(1, 2, 3, 4),   Intercept  = c(1, 1, 1, 1),   trt        = c(0, 1, 0, 1),   sexF       = c(0, 1, 1, 0),   regionUS   = c(0, 0, 1, 1),   regionAsia = c(0, 1, 0, 0) )  knitr::kable(   design_matrix_df,   caption = \"Example design matrix for unshrunk prognostic effects (dummy coding).\",   align = c('l', 'c', 'c', 'c', 'c') ) # Example: Shrunk predictive effects using one-hot encoding # Each column represents trt_subgroupLEVEL (1 if treated AND in that level, 0 otherwise) interaction_matrix <- data.frame(   Patient           = 1:6,   `trt_sexM`        = c(1, 0, 1, 1, 0, 0),   `trt_sexF`        = c(0, 1, 0, 0, 1, 1),   `trt_regionEU`    = c(0, 1, 0, 0, 1, 0),   `trt_regionUS`    = c(1, 0, 0, 1, 0, 0),   `trt_regionAsia`  = c(0, 0, 1, 0, 0, 1) )  knitr::kable(   interaction_matrix,   align = 'c',   col.names = c(\"Patient\", \"trt_sexM\", \"trt_sexF\", \"trt_regionEU\", \"trt_regionUS\", \"trt_regionAsia\"),   caption = \"Example design matrix for shrunk predictive effects (one-hot encoding)\" )"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"example","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.4 The Global Model","what":"Example","title":"Statistical Specifications","text":"randomized, double-blind trial comparing new drug, DrugX, placebo patients hypertension. Primary Endpoint (\\(Y_{}\\)): Change baseline systolic blood pressure (SBP) mmHg 6 months. Age Group: <65 vs. ≥65 years. Sex: Male vs. Female. Kidney Function: eGFR <60 (impaired) vs. ≥60 (normal). Covariates: BaselineSBPᵢ, BMIᵢ, Smokerᵢ (binary). Global Model Shrinkage outcome assumed normally distributed: \\(Y_{} \\sim N(\\mu_{}, \\sigma^2)\\). linear predictor \\(\\mu_{}\\) modeled : \\[ \\mu_{} = \\underbrace{\\beta_0}_{\\text{Intercept}} + \\underbrace{\\beta_{\\text{treat}} \\cdot \\text{Treatment}_i}_{\\text{Main Trt Effect}} + \\underbrace{\\sum_{k=1}^{K} \\alpha_k \\cdot \\text{Subgroup}_{ik}}_{\\text{Prognostic Subgroup Effects}} + \\underbrace{\\sum_{k=1}^{K} \\gamma_k \\cdot (\\text{Subgroup}_{ik} \\cdot \\text{Treatment}_i)}_{\\text{Shrunken Predictive Effects}} + \\underbrace{\\sum_{j=1}^{J} \\delta_j \\cdot \\text{Covariate}_{ij}}_{\\text{Extra Prognostic effects}} \\] \\[ =\\underbrace{\\beta_0}_{\\text{Intercept}} + \\underbrace{\\beta_{\\text{treat}} \\cdot \\text{Treatment}_i}_{\\text{Main Trt Effect}} + \\underbrace{\\alpha_1 \\cdot \\text{Age Group}_i+\\alpha_2 \\cdot \\text{Sex}_i+\\alpha_3 \\cdot \\text{eGFR}_i}_{\\text{Prognostic Subgroup Effects}}+ \\] \\[ + \\underbrace{\\gamma_1 \\cdot (\\text{Age Group}_i\\cdot \\text{Treatment}_i)+\\gamma_2 \\cdot (\\text{Sex}_i\\cdot \\text{Treatment}_i)+\\gamma_3 \\cdot (\\text{eGFR}_i\\cdot \\text{Treatment}_i)}_{\\text{Predictive Effects}} + \\underbrace{\\delta_1 \\cdot \\text{BaselineSBP}_i+\\delta_2 \\cdot \\text{BMI}_i+\\delta_3 \\cdot \\text{Smoker}_i}_{\\text{Extra Prognostic effects}} \\]","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-one-var","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"One-Variable-at-a-Time Model","title":"Statistical Specifications","text":"one-variable---time model (Wang et al. 2024) Bayesian hierarchical model (BHM) improves upon standard subgroup analysis borrowing information across subgroup levels produce stable reliable estimates. Instead analyzing subgroup level isolation, analyzes levels within single subgrouping variable (e.g., age groups) together one model. example, variable Sex (levels Male Female), fit one hierarchical model. single model, treatment effects Male (\\(\\beta_{2,\\text{sex,male}}\\)) Female (\\(\\beta_{2,\\text{sex,female}}\\)) treated exchangeable linked common prior distribution. , completely separate hierarchical model fit variable Region.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"full-model-equation-1","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.5 One-Variable-at-a-Time Model","what":"Full Model Equation","title":"Statistical Specifications","text":"given subgrouping variable \\(j\\), can specify flexible linear predictor allows covariate effects constant across levels \\(j\\), others allowed vary. Let’s partition patient-level covariates two sets: \\(\\mathbf{u}_i\\): vector covariates assumed constant prognostic effect across levels subgrouping variable \\(j\\). \\(\\mathbf{v}_i\\): vector covariates strong priori reason believe prognostic effect varies across levels \\(k\\) subgrouping variable \\(j\\). linear predictor patient \\(\\) level \\(k\\) variable \\(j\\) : \\[g(\\mu_{,j,k}) = \\beta_{1,j,k} + \\beta_{2,j,k}z_i + \\boldsymbol{\\beta}_{3,j}\\mathbf{u}_i + \\boldsymbol{\\beta}_{4,j,k}\\mathbf{v}_i\\] \\(\\beta_{2,j,k}\\): predictive effect level \\(k\\) variable \\(j\\). primary parameter interest shrinkage. \\(\\boldsymbol{\\beta}_{3,j}\\mathbf{u}_i\\): effect covariates assumed constant across levels. coefficient vector \\(\\boldsymbol{\\beta}_{3,j}\\) \\(k\\) subscript. \\(\\boldsymbol{\\beta}_{4,j,k}\\mathbf{v}_i\\): effect covariates assumed level-specific. coefficient vector \\(\\boldsymbol{\\beta}_{4,j,k}\\) \\(k\\) subscript, allowing effect different subgroup level. can seen interaction variable \\(x_j\\) \\(v_i\\). Note coefficients \\(\\boldsymbol{\\beta}_{3,j}\\) \\(\\boldsymbol{\\beta}_{4,j,k}\\) can use shrinkage standard priors depending prior beliefs.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"example-1","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.5 One-Variable-at-a-Time Model","what":"Example","title":"Statistical Specifications","text":"Similarly example showed Global model. example Age Group variable, \\(k \\\\{ \\text{<65}, \\text{≥65} \\}\\). outcome patient age subgroup k : \\(Y_{ik} \\sim N(\\mu_{ik}, \\sigma_k^2)\\). linear predictor \\(\\mu_{ik}\\) : \\[ \\mu_{ik} = \\underbrace{\\beta_{1,k}}_{\\text{Subgroup Intercept}} + \\underbrace{\\beta_{2,k} \\cdot \\text{Treatment}_i}_{\\text{Predictive Effect}} + \\underbrace{\\delta_1 \\cdot \\text{BMI}_i + \\delta_2 \\cdot \\text{Smoker}_i}_{\\text{Constant Prognostic Effects}} + \\underbrace{\\delta_{3,k} \\cdot \\text{BaselineSBP}_i}_{\\text{Varying Prognostic Effect}} \\] , \\(\\beta_{1,k}\\) (subgroup-specific intercept) \\(\\beta_{2,k}\\) (subgroup-specific predictive effect) given hierarchical priors borrow information across age groups. example: \\(\\beta_{2,k} \\sim N(\\mu_2, \\tau_2^2)\\). effect Baseline SBP also allowed vary age group (\\(\\delta_{3,k}\\)), BMI Smoking effects assumed constant","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-intercept","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"The Logic of the Intercept","title":"Statistical Specifications","text":"intercept (\\(\\beta_0\\)) subject shrinkage (fixed effect within unshrunktermeffect component), specifying prior requires care ensure model remains weakly informative without introducing bias numerical instability. Default Specification: package automatically scales intercept prior based reference scale parameter (sigma_ref) provided user: Continuous Endpoints: prior centered observed outcome mean scale proportional sigma_ref: \\[ \\beta_0 \\sim \\mathcal{N}(\\bar{y}, (5 \\times \\sigma_{ref})^2) \\] \\(\\bar{y}\\) sample mean outcome variable sigma_ref protocol standard deviation trial design. Centering outcome mean improves computational efficiency scale \\(5 \\times \\sigma_{ref}\\) provides sufficient flexibility relative trial’s expected variability. Binary Count Endpoints: prior centered 0 scaled sigma_ref (typically set 1): \\[ \\beta_0 \\sim \\mathcal{N}(0, (5 \\times \\sigma_{ref})^2) \\] binary count endpoints, sigma_ref typically set 1, yielding normal(0, 5). standard deviation 5 log-odds log-rate scale covers wide range plausible effect sizes (e.g., ratios approximately 0.08 12) still penalizing extreme, unrealistic values. choice aligned methodology Wolbers et al. (2025). Linking Trial Design: continuous outcomes: Set sigma_ref population standard deviation assumed trial design sample size calculation phase. ensures prior automatically calibrated expected magnitude effects specific trial. binary, count, survival outcomes: Use sigma_ref = 1 (typical default), outcomes modeled transformed scales (logit, log, log-hazard) original outcome standard deviation directly meaningful. Special Case: Time--Event Endpoints. Cox proportional hazards models, intercept identifiable omitted linear predictor. Mechanism: intercept effectively absorbed non-parametric baseline hazard function, \\(h_0(t)\\). Implementation: brms backend handles automatically estimating baseline hazard (via bhaz()) rather fixed intercept parameter. Therefore, prior specification \\(\\beta_0\\) required survival models.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-endpoint","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"Endpoint-Specific Models","title":"Statistical Specifications","text":"package supports four primary endpoint types specifying appropriate likelihood link function \\(g(\\boldsymbol{\\mu}) = \\boldsymbol{\\eta}\\).","code":""},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"default-priors","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.8 Prior Specifications","what":"Default Priors","title":"Statistical Specifications","text":"package requires user specify sigma_ref, reference scale parameter used calibrate default priors. interpretation sigma_ref depends endpoint type: continuous outcomes: sigma_ref represents protocol standard deviation trial (typically obtained sample size calculation). binary, count, survival outcomes: sigma_ref typically set 1, outcomes modeled transformed scales (logit, log, log-hazard) standard deviations directly meaningful. default priors automatically scaled relative sigma_ref ensure appropriately calibrated: continuous outcomes: Intercept: normal(outcome_mean, 5 * sigma_ref) — centered observed outcome mean Unshrunk terms: normal(0, 5 * sigma_ref) Shrunk prognostic: horseshoe(1) Shrunk predictive: horseshoe(1) binary, count, survival outcomes: Intercept: normal(0, 5 * sigma_ref) (typically normal(0, 5) sigma_ref = 1) Unshrunk terms: normal(0, 5 * sigma_ref) (typically normal(0, 5) sigma_ref = 1) Shrunk prognostic: horseshoe(1) Shrunk predictive: horseshoe(1) Note: intercept prior applied response_type = \"survival\", Cox models global intercept. Additionally, intercept prior omitted user specifies formula without intercept (using ~ 0 + ... syntax).","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"weakly-informative-priors-unshrunk-terms","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.8 Prior Specifications","what":"Weakly Informative Priors (Unshrunk Terms)","title":"Statistical Specifications","text":"unshrunk coefficients (prognostic predictive terms unshrunktermeffect component, well extra covariates \\(\\boldsymbol{\\beta_{3}}\\)), use weakly informative priors aid computational stability without strongly influencing posterior. Default: normal(0, 5 * sigma_ref). prior automatically scaled trial’s expected effect size, making weakly regularizing linear predictor scale. Users can override specifying custom priors using sigma_ref placeholder (e.g., \"normal(0, 2.5 * sigma_ref)\"), automatically substituted numeric value model fitting.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"regularized-horseshoe-prior-shrunk-terms","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.8 Prior Specifications","what":"Regularized Horseshoe Prior (Shrunk Terms)","title":"Statistical Specifications","text":"default shrinkage prior bonsaiforest2, recommended excellent adaptive shrinkage properties (Piironen Vehtari 2017). Concept: global-local prior. infinitely tall spike zero (aggressively shrink noise) heavy tails (leave true, large signals unshrunk). Hierarchical Specification: \\[\\begin{aligned} \\beta_{2,l} &\\sim N(0, \\tau^2 \\tilde{\\lambda}_l^2) \\\\ \\tilde{\\lambda}_l^2 &= \\frac{c^2 \\lambda_l^2}{c^2 + \\tau^2 \\lambda_l^2} \\\\ \\lambda_l &\\sim C^+(0, 1) \\quad (\\text{Local shrinkage}) \\\\ \\tau &\\sim C^+(0, \\tau_0) \\quad (\\text{Global shrinkage}) \\\\ c^2 &\\sim \\text{Inverse-Gamma}(\\nu/2, \\nu s^2/2) \\end{aligned}\\] Hyperparameter Justification: package supports two ways set crucial global scale \\(\\tau_0\\): Fixed Default (scale_global): horseshoe(scale_global = 1). package default, robust, general-purpose choice. Elicited Prior (par_ratio): Sets \\(\\tau_0\\) based prior belief number effective (non-zero) subgroups, \\(p_{eff}\\), total \\(L\\) (Bornkamp 2025; Piironen Vehtari 2017). specified via \\(\\text{par\\_ratio} = \\frac{p_{eff}}{L - p_{eff}}\\). scales prior based sample size (\\(N\\)) expected sparsity. Regularized Horseshoe Implementation brms brms package implements Regularized Horseshoe prior using function horseshoe(...). regularization term (“slab”) added standard Horseshoe ensure robustness improve computational stability Stan. Horseshoe Function Key Arguments Horseshoe prior set using function call: Relationship Justification: \\(\\mathbf{brms}\\) function offers two primary ways set global shrinkage level, controls overall sparsity model: Fixed Global Scale: Using \\(\\mathbf{scale\\_global}\\) argument, often set \\(\\mathbf{1.0}\\) general-purpose default. value internally multiplied residual standard deviation (\\(\\sigma\\)) autoscale = TRUE. Elicited Global Scale (Recommended): Using \\(\\mathbf{par\\_ratio}\\) argument, allows user specify prior belief sparsity model (.e., expected number true non-zero coefficients, \\(p_{eff}\\)). recommended approach accounts number coefficients \\(L\\) sample size \\(N\\) determine optimal \\(\\tau_0\\). Choosing \\(\\mathbf{scale\\_global}\\) \\(\\mathbf{par\\_ratio}\\): choice \\(\\tau_0\\) (controlled \\(\\mathbf{scale\\_global}\\) \\(\\mathbf{par\\_ratio}\\)) crucial, sets overall magnitude shrinkage. Fixed Default (\\(\\mathbf{scale\\_global=1}\\)): Use : want simple, robust, general-purpose prior without explicit sparsity knowledge. Caveat: May result insufficient shrinkage true number non-zero coefficients small. Elicited Sparsity (\\(\\mathbf{par\\_ratio}\\)): Calculation: \\(\\mathbf{par\\_ratio} = \\frac{p_{eff}}{L - p_{eff}}\\), \\(p_{eff}\\) expected number non-zero coefficients \\(L\\) total number coefficients. Use : strong prior belief number relevant effects. generally preferred adaptive shrinkage scales \\(\\tau_0\\) appropriately. Recommendation: \\(\\mathbf{scale\\_global=1}\\) quick default, specifying \\(\\mathbf{par\\_ratio}\\) based expert knowledge expected sparsity theoretically sound adaptive method setting global shrinkage scale.","code":"horseshoe(df = 1, scale_global = 1, df_global = 1, scale_slab = 2, df_slab = 4, par_ratio = NULL, autoscale = TRUE, main = FALSE)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"r2d2-prior-shrunk-terms","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.8 Prior Specifications","what":"R2D2 Prior (Shrunk Terms)","title":"Statistical Specifications","text":"Concept: prior uniquely derived first placing prior model’s coefficient determination, \\(R^2\\), quantifies proportion variance explained predictors. arguably intuitive specifying priors directly coefficients. Hierarchical Specification (Marginal Version): \\[ \\begin{aligned} \\beta_{2,l} &\\sim DE(\\sigma \\sqrt{\\phi_l \\omega / 2}) \\quad (\\text{Double-Exponential/Laplace kernel}) \\\\ \\boldsymbol{\\phi} &= (\\phi_1, \\dots, \\phi_L) \\sim \\text{Dirichlet}(a_\\pi, \\dots, a_\\pi) \\quad (\\text{Local shrinkage}) \\\\ \\omega &\\sim \\text{Beta-Prime}(, b) \\quad (\\text{Global shrinkage}) \\end{aligned} \\] equivalent assuming proportion variance explained interaction terms follows \\(R^2 = \\frac{\\omega}{1+\\omega} \\sim \\text{Beta}(,b)\\). Justification Hyperparameters: Zhang et al. (2022) provide clear guidance. fully automatic approach set \\(b=0.5\\) achieve Cauchy-like heavy tails. concentration parameter \\(a_\\pi\\) controls sparsity. smaller \\(a_\\pi\\) (e.g., 0.2) implies higher shrinkage, concentrating prior variance fewer coefficients, larger \\(a_\\pi\\) (e.g., 0.5) spreads variance evenly, implying lower shrinkage. Default Recommendation: Set \\(b=0.5\\) offer options user based desired shrinkage strength: High Shrinkage: \\(a_\\pi=0.2\\) Low Shrinkage: \\(a_\\pi=0.5\\) R2D2 Prior Implementation brms brms package implements prior using function R2D2(...), providing high-level parametrization intuitive setting parameters \\(\\), \\(b\\), \\(a_\\pi\\) directly. function translates desired \\(\\mathbf{R^2}\\) properties shrinkage strength underlying prior distribution’s parameters. R2D2 Function Key Arguments R2D2 prior set using function call: Relationship Justification: brms function parameters directly related justified hierarchical parameters: \\(\\mathbf{cons\\_D2}\\) parameter direct counterpart sparsity parameter \\(\\mathbf{a_{\\pi}}\\). default recommendation \\(\\mathbf{cons\\_D2 = 0.5}\\) corresponds precisely \\(\\mathbf{a_{\\pi}=0.5}\\) low shrinkagesetting. \\(\\mathbf{mean\\_R2}\\) \\(\\mathbf{prec\\_R2}\\) arguments define \\(\\text{Beta}(,b)\\) prior \\(R^2\\), : \\[= \\text{mean_R2} \\times \\text{prec_R2}\\] \\[b = (1 - \\text{mean_R2}) \\times \\text{prec_R2}\\] choice \\(\\mathbf{prec\\_R2=2}\\) (default) alongside \\(\\mathbf{mean\\_R2=0.5}\\) results \\(=1\\) \\(b=1\\), Uniform prior \\(R^2 \\sim \\text{Beta}(1, 1)\\), representing maximally weak prior belief global fit. essential \\(\\mathbf{b=0.5}\\) setting Cauchy-like heavy tails (preventing -shrinkage) implicitly handled R2D2 function’s underlying structure require manual specification. Choosing \\(\\mathbf{mean\\_R2}\\) \\(\\mathbf{prec\\_R2}\\) : Choosing parameters involves quantifying prior knowledge model’s overall predictive power observing data. define \\(\\text{Beta}(,b)\\) distribution \\(R^2\\). Choosing \\(\\mathbf{mean\\_R2}\\) (Prior Expected \\(R^2\\)): sets center prior belief. Default (0.5): Use strong prior knowledge. implies neutral expectation fixed effects explain half variance. Informative Low (e.g., 0.1 0.3): Use expect weak noisy relationship. Informative High (e.g., 0.7 0.9): Use expect highly predictive model based strong prior evidence. Choosing \\(\\mathbf{prec\\_R2}\\) (Prior Confidence \\(R^2\\)): determines concentration certainty Beta prior around chosen \\(\\text{mean_R2}\\). Resulting Beta Parameters (\\(\\text{mean_R2}=0.5\\)) Recommendation: Default \\(\\mathbf{mean\\_R2 = 0.5}\\) \\(\\mathbf{prec\\_R2 = 2}\\) provides flexible, weakly informative setting \\(R^2\\), generally recommended unless strong prior knowledge dictates otherwise.","code":"R2D2(mean_R2 = 0.5, prec_R2 = 2, cons_D2 = 0.5, autoscale = TRUE, main = FALSE)"},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"normal-hierarchical-prior-for-one-variable-at-a-time-model","dir":"Articles","previous_headings":"3 Statistical Methodology > 3.8 Prior Specifications","what":"Normal Hierarchical Prior (for One-Variable-at-a-Time Model)","title":"Statistical Specifications","text":"standard hierarchical model subgroup analysis, assumes treatment effects levels within subgrouping variable drawn common normal distribution. ’s less complex Horseshoe R2D2 priors provides effective shrinkage, especially number subgroup levels small. Hierarchical Specification: given subgrouping variable \\(j\\) levels \\(k=1, \\dots, K_j\\): \\[\\begin{aligned} \\beta_{2,j,k} &\\sim \\mathcal{N}(\\mu_{2,j}, \\tau^2_{2,j}) \\quad (\\text{Level-specific treatment effects}) \\\\     \\mu_{2,j} &\\sim \\mathcal{N}(0, s^2) \\quad (\\text{Common mean effect}) \\\\ \\tau_{2,j} &\\sim \\text{Half-Normal}() \\quad (\\text{-subgroup heterogeneity}) \\end{aligned}     \\] Justification Hyperparameters: key setting scale parameter Half-Normal prior -subgroup standard deviation, \\(\\tau_{2,j}\\), controls degree shrinkage. recommended Bornkamp (2025), can linked planned treatment effect ( \\(\\delta_{plan}\\)) trial protocol, making prior choice interpretable consistent across different endpoints. choice implies prior plausible difference treatment effects two subgroups.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-estimation","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"Estimation (MCMC)","title":"Statistical Specifications","text":"joint posterior distribution parameters complex closed-form solution. use Markov Chain Monte Carlo (MCMC) methods draw samples distribution. Specifically, package uses -U-Turn Sampler (NUTS), efficient variant Hamiltonian Monte Carlo (HMC), implemented Stan via brms package. output set posterior samples (e.g., 4000 draws) representing joint posterior distribution.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-standardization","dir":"Articles","previous_headings":"3 Statistical Methodology","what":"Standardization for Marginal Effects (G-computation)","title":"Statistical Specifications","text":"obtain interpretable marginal effects subgroup, package implements standardization (G-computation) procedure. process repeated MCMC draw generate full posterior distribution marginal effect. single MCMC draw, step--step process : Select Parameters: Take one draw joint posterior distribution model parameters (\\(\\boldsymbol{\\beta}\\)’s, \\(\\sigma\\), \\(\\phi\\), etc.). Create Counterfactuals: every patient \\(\\) original dataset, create two scenarios: Scenario : Patient \\(\\)’s covariates, treatment \\(s_i=0\\) (Control). Scenario B: Patient \\(\\)’s covariates, treatment \\(s_i=1\\) (Treatment). Scenario (control), treatment--subgroup interaction dummies set 0. Scenario B (treatment), interaction dummy trt_subgroupLEVEL set 1 patient belongs subgroup level, 0 otherwise. Predict Outcomes: Use model formula parameters Step 1 predict outcome every patient Scenario (\\(\\hat{\\mu}_{,0}\\)) Scenario B (\\(\\hat{\\mu}_{,1}\\)). brms::posterior_epred() function automatically handles computation using model’s design matrix parameters. Average within Subgroups: subgroup interest \\(l\\) (e.g., “Female”): Calculate average predicted outcome control: \\(\\hat{\\mu}_{l,0} = \\text{mean}(\\hat{\\mu}_{,0})\\) \\(\\) \\(x_{il}=1\\). Calculate average predicted outcome treatment: \\(\\hat{\\mu}_{l,1} = \\text{mean}(\\hat{\\mu}_{,1})\\) \\(\\) \\(x_{il}=1\\). Calculate Effect Measure: Compute marginal effect subgroup \\(l\\) averaged predictions. depends endpoint type: Continuous: Mean Difference = \\(\\hat{\\mu}_{l,1} - \\hat{\\mu}_{l,0}\\). Binary: Odds Ratio = \\(\\frac{\\hat{\\mu}_{l,1} / (1 - \\hat{\\mu}_{l,1})}{\\hat{\\mu}_{l,0} / (1 - \\hat{\\mu}_{l,0})}\\) (\\(\\hat{\\mu}\\) predicted probability). Count: Rate Ratio = \\(\\hat{\\mu}_{l,1} / \\hat{\\mu}_{l,0}\\) (\\(\\hat{\\mu}\\) predicted rate). Time--Event: Average Hazard Ratio (AHR). complex, requires predicting full survival curve \\(S_i(t)\\) patient. marginal survival curves \\(\\hat{S}_{l,0}(t)\\) \\(\\hat{S}_{l,1}(t)\\) calculated, AHR computed , marginal curves may proportional. Repeat: process (Steps 1-5) repeated MCMC draws, yielding full posterior distribution (e.g., 4000 values) marginal effect subgroup. final point estimate (median) 95% credible interval taken distribution.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"sec-functions","dir":"Articles","previous_headings":"","what":"Mapping of Statistical Methods to bonsaiforest2 Functions","title":"Statistical Specifications","text":"section connects statistical methodology (Section 3) package functions. package provides three-level architecture: high-level user interface functions, modular worker functions advanced control, internal helpers.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"high-level-user-interface","dir":"Articles","previous_headings":"4 Mapping of Statistical Methods to bonsaiforest2 Functions","what":"High-Level User Interface","title":"Statistical Specifications","text":"main functions users typically call analysis workflow: run_brms_analysis() Maps : Sections 3.4 (Global Model), 3.5 (One-Variable---Time Model), 3.7 (Endpoints), 3.8 (Priors), 3.9 (Estimation). Internally calls prepare_formula_model() construct three-component brmsformula structure validate inputs. calls fit_brms_model() run MCMC sampling via brms::brm() Stan. Stores essential metadata (treatment variable, response type, original data) attributes fitted model object downstream analysis. Handles formula components: unshrunktermeffect (unshrunk terms), shprogeffect (shrunk prognostic), shpredeffect (shrunk predictive). Returns brmsfit object enriched attributes. summary_subgroup_effects() Maps : Section 3.10 (Standardization / G-computation). Internally calls estimate_subgroup_effects() perform G-computation procedure. Automatically extracts treatment variable, response type, data model attributes (set fit_brms_model()). Auto-detects subgroups formula components searching treatment interactions unshrunktermeffect, shprogeffect, shpredeffect. Returns subgroup_summary S3 object containing estimates, credible intervals, metadata. plot() Maps : Final visualization Section 3.10 results. Action: S3 method subgroup_summary objects. Generates publication-ready forest plots marginal effect estimates median 95% credible intervals.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/articles/Statistical_Specifications.html","id":"advancedmodular-interface","dir":"Articles","previous_headings":"4 Mapping of Statistical Methods to bonsaiforest2 Functions","what":"Advanced/Modular Interface","title":"Statistical Specifications","text":"users requiring fine-grained control modeling process, package exposes intermediate worker functions: prepare_formula_model() data: Dataset containing variables response_formula: Response specification (e.g., outcome ~ trt Surv(time, status) ~ trt) unshrunk_terms_formula: Unshrunk terms specification (may include main effects treatment interactions) shrunk_prognostic_formula: Prognostic main effects regularized (optional) shrunk_predictive_formula: Treatment interactions regularized (optional) response_type: One \"binary\", \"count\", \"continuous\", \"survival\" stratification_formula: Stratification variable (optional) unshrunktermeffect: Unshrunk terms weakly informative priors. Can include prognostic effects (intercept, main treatment effect, pre-specified covariates) predictive effects (treatment interactions). Specified via unshrunk_terms_formula. shprogeffect: Shrunk prognostic effects strong regularization priors. Specified via shrunk_prognostic_formula. shpredeffect: Shrunk predictive effects (treatment interactions) strong regularization priors. Specified via shrunk_predictive_formula. Supports flexible interaction syntax: colon notation (trt:subgroup), star notation (trt*subgroup), random effects notation ((trt || subgroup)), can mixed model. Validates model hierarchy: checks predictive terms corresponding prognostic main effects, issuing warnings violations detected (star notation automatically includes main effects excluded check). Applies automatic contrast coding: one-hot encoding shrunk terms (levels represented exchangeability) dummy encoding unshrunk terms (reference level dropped). Constructs design matrices \\(\\mathbf{X_n}, \\mathbf{X_p}, \\mathbf{Z_n}, \\mathbf{Z_p}, \\mathbf{U}\\) formula specifications. Returns list containing complete brmsformula, transformed data proper contrasts, response type, treatment variable name, Stan parameter names, metadata. fit_brms_model() Takes output prepare_formula_model() manually specified formula components. Assigns priors formula component based user specifications defaults. Calls brms::brm() compile Stan code run MCMC chains. Handles endpoint-specific configurations (Section 3.7): likelihood functions, link functions, stratification. Attaches essential metadata attributes fitted model use estimate_subgroup_effects(). estimate_subgroup_effects() MCMC draw, creates counterfactual datasets (patients treated vs. control). Generates posterior predictions using brms::posterior_epred() brms::posterior_survfit(). Averages predictions within subgroup obtain marginal expected outcomes. Continuous: Mean difference (\\(\\hat{\\mu}_{l,1} - \\hat{\\mu}_{l,0}\\)) Binary: Odds ratio Count: Rate ratio Survival: Average hazard ratio (AHR) Auto-detects subgroups parsing formula components treatment interactions (colon : syntax pipe || syntax random effects). Returns raw posterior draws summary statistics (median, credible intervals).","code":""},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/authors.html","id":null,"dir":"","previous_headings":"","what":"Authors","title":"Authors and Citation","text":"Miriam Pedrera Gomez. Author, maintainer. Isaac Gravestock. Author. Marcel Wolbers. Author.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/authors.html","id":"citation","dir":"","previous_headings":"","what":"Citation","title":"Authors and Citation","text":"Pedrera Gomez M, Gravestock , Wolbers M (2026). bonsaiforest2: Flexible Bayesian Shrinkage Based Forest Plots. R package version 0.1.0, https://openpharma.github.io/bonsaiforest2/.","code":"@Manual{,   title = {bonsaiforest2: Flexible Bayesian Shrinkage Based Forest Plots},   author = {Miriam {Pedrera Gomez} and Isaac Gravestock and Marcel Wolbers},   year = {2026},   note = {R package version 0.1.0},   url = {https://openpharma.github.io/bonsaiforest2/}, }"},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/index.html","id":"overview","dir":"","previous_headings":"","what":"Overview","title":"Flexible Bayesian Shrinkage Based Forest Plots","text":"bonsaiforest2 package used Bayesian shrinkage estimation subgroup treatment effects randomized clinical trials. supports One-Variable---Time (OVAT) Global modeling approaches estimating treatment--subgroup interactions, built-support continuous, binary, time--event (Cox), count outcomes. package implements state---art shrinkage priors including Regularized Horseshoe R2D2, combined standardization (G-computation) provide interpretable marginal treatment effects. leveraging brms Stan, bonsaiforest2 provides practical tool obtaining stable reliable subgroup effect estimates exploratory analyses.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/index.html","id":"installation","dir":"","previous_headings":"","what":"Installation","title":"Flexible Bayesian Shrinkage Based Forest Plots","text":"UPDATE USUAL INSTALLATION can install development version bonsaiforest2 GitLab repository:","code":"# install.packages(\"remotes\")  remotes::install_github(\"openpharma/bonsaiforest2\")"},{"path":"https://openpharma.github.io/bonsaiforest2/index.html","id":"example","dir":"","previous_headings":"","what":"Example","title":"Flexible Bayesian Shrinkage Based Forest Plots","text":"example demonstrates usage bonsaiforest2 subgroup treatment effect estimation across multiple overlapping subgroups (Age, Region, Biomarker) using Global Modeling approach Regularized Horseshoe prior.","code":"library(bonsaiforest2)  # 1. Simulate trial data set.seed(42) n <- 200 trial_data <- data.frame(   outcome  = rnorm(n),   trt      = factor(sample(c(\"Control\", \"Active\"), n, replace = TRUE)),   age_cat  = factor(sample(c(\"<65\", \">=65\"), n, replace = TRUE)),   region   = factor(sample(c(\"US\", \"EU\", \"Asia\"), n, replace = TRUE)),   biomarker = factor(sample(c(\"Pos\", \"Neg\"), n, replace = TRUE)) )  # 2. Fit a Global Model with default priors fit <- run_brms_analysis(   data = trial_data,   response_type = \"continuous\",   response_formula = outcome ~ trt,   unshrunk_terms_formula = ~ age_cat + region + biomarker,    shrunk_predictive_formula = ~ 0 + trt:age_cat + trt:region + trt:biomarker,    sigma_ref = 3,   chains = 2, iter = 1000, warmup = 500 # )  # 3. Derive Marginal Treatment Effects subgroup_effects <- summary_subgroup_effects(   brms_fit = fit ) # Print summary print(subgroup_effects) #> $estimates #> # A tibble: 7 × 4 #>   Subgroup         Median CI_Lower CI_Upper #>   <chr>             <dbl>    <dbl>    <dbl> #> 1 age_cat: <65    0.128    -0.241     0.516 #> 2 age_cat: >=65  -0.184    -0.566     0.219 #> 3 region: Asia   -0.109    -0.544     0.366 #> 4 region: EU     -0.349    -0.828     0.101 #> 5 region: US      0.387    -0.0988    0.918 #> 6 biomarker: Neg -0.0508   -0.426     0.258 #> 7 biomarker: Pos -0.00256  -0.326     0.346 #>  #> $response_type #> [1] \"continuous\" #>  #> $ci_level #> [1] 0.95 #>  #> $trt_var #> [1] \"trt\" #>  #> attr(,\"class\") #> [1] \"subgroup_summary\"  # 4. Visualize Results plot(subgroup_effects) #> Preparing data for plotting... #> Generating plot... #> Done."},{"path":"https://openpharma.github.io/bonsaiforest2/reference/bonsaiforest2-package.html","id":null,"dir":"Reference","previous_headings":"","what":"bonsaiforest2: Flexible Bayesian Shrinkage Based Forest Plots — bonsaiforest2-package","title":"bonsaiforest2: Flexible Bayesian Shrinkage Based Forest Plots — bonsaiforest2-package","text":"extension 'bonsaiforest' package provides increased flexibility prior selection modeling options. supports four types endpoints simplifies fitting interpretation Bayesian models subgroup analysis. Leveraging 'brms', distinguishes prognostic predictive factors using differential shrinkage priors generates publication-ready forest plots.","code":""},{"path":[]},{"path":"https://openpharma.github.io/bonsaiforest2/reference/bonsaiforest2-package.html","id":"author","dir":"Reference","previous_headings":"","what":"Author","title":"bonsaiforest2: Flexible Bayesian Shrinkage Based Forest Plots — bonsaiforest2-package","text":"Maintainer: Miriam Pedrera Gomez miriam.pedrera_gomez@roche.com Authors: Isaac Gravestock isaac.gravestock@roche.com Marcel Wolbers marcel.wolbers@roche.com","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/combine_summaries.html","id":null,"dir":"Reference","previous_headings":"","what":"Combine Multiple Subgroup Summaries for Comparison Plotting — combine_summaries","title":"Combine Multiple Subgroup Summaries for Comparison Plotting — combine_summaries","text":"Combines estimates multiple subgroup summary objects single summary object can plotted compare models.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/combine_summaries.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Combine Multiple Subgroup Summaries for Comparison Plotting — combine_summaries","text":"","code":"combine_summaries(summary_list)"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/combine_summaries.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Combine Multiple Subgroup Summaries for Comparison Plotting — combine_summaries","text":"summary_list Named list subgroup_summary objects.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/combine_summaries.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Combine Multiple Subgroup Summaries for Comparison Plotting — combine_summaries","text":"subgroup_summary. Combined object \"Model\" column estimates.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/combine_summaries.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Combine Multiple Subgroup Summaries for Comparison Plotting — combine_summaries","text":"","code":"if (FALSE) { # \\dontrun{ summary1 <- summary_subgroup_effects(brms_fit = model1) summary2 <- summary_subgroup_effects(brms_fit = model2)  combined <- combine_summaries(list(   \"OVAT\" = summary1,   \"Global\" = summary2 )) plot(combined) } # }"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/estimate_subgroup_effects.html","id":null,"dir":"Reference","previous_headings":"","what":"Estimate Marginal Subgroup Treatment Effects — estimate_subgroup_effects","title":"Estimate Marginal Subgroup Treatment Effects — estimate_subgroup_effects","text":"function uses counterfactual, marginal approach based posterior predictive distribution. averages covariates provide robust estimates subgroup-specific effects.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/estimate_subgroup_effects.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Estimate Marginal Subgroup Treatment Effects — estimate_subgroup_effects","text":"","code":"estimate_subgroup_effects(   brms_fit,   trt_var = NULL,   data = NULL,   subgroup_vars = \"auto\",   response_type = NULL,   ndraws = NULL )"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/estimate_subgroup_effects.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Estimate Marginal Subgroup Treatment Effects — estimate_subgroup_effects","text":"brms_fit brmsfit object. Fitted model object fit_brms_model() run_brms_analysis(). Must contain necessary attributes extracting treatment variable response type information. trt_var character string NULL. Treatment variable name. NULL, automatically extracted model attributes (set fit_brms_model()). Must binary variable coded 0/1 dataset. data data frame NULL. Dataset used model fitting. NULL, automatically extracted model attributes (set fit_brms_model()). dataset used generating counterfactual predictions. subgroup_vars character vector \"auto\". Subgroup variable names estimate treatment effects. \"auto\" (default), automatically detects treatment interaction terms (colon syntax) random effect grouping factors (pipe syntax) formula components (unshrunktermeffect, shprogeffect, shpredeffect). response_type character string NULL. Outcome type, one \"binary\", \"count\", \"continuous\", \"survival\". NULL, automatically extracted model attributes (set fit_brms_model()). determines appropriate scale effect estimation. ndraws integer NULL. Number posterior draws use estimation. NULL (default), available posterior draws used. Reducing can speed computation cost precision.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/estimate_subgroup_effects.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Estimate Marginal Subgroup Treatment Effects — estimate_subgroup_effects","text":"list two named elements: estimates tibble row represents subgroup (\"Overall\" effect), columns Subgroup, Median, CI_Lower, CI_Upper posterior distribution draws data.frame containing posterior draws subgroup","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/estimate_subgroup_effects.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Estimate Marginal Subgroup Treatment Effects — estimate_subgroup_effects","text":"post-processing function estimates marginal treatment effects specified subgroups fitted brmsfit object.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/fit_brms_model.html","id":null,"dir":"Reference","previous_headings":"","what":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","title":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","text":"function serves wrapper fit Bayesian model using brms package. uses formula data prepared prepare_formula_model simplifies process assigning complex priors different non-linear components model.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/fit_brms_model.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","text":"","code":"fit_brms_model(   prepared_model,   sigma_ref = 1,   intercept_prior = NULL,   unshrunk_prior = NULL,   shrunk_prognostic_prior = NULL,   shrunk_predictive_prior = NULL,   stanvars = NULL,   ... )"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/fit_brms_model.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","text":"prepared_model list object. Object returned prepare_formula_model() containing elements: formula (brmsformula object), data (modified data.frame appropriate contrast coding), response_type (character string), trt_var (character string). trt_var element stored attribute fitted model use downstream functions like estimate_subgroup_effects(). sigma_ref numeric scalar. Reference scale prior specification. Default 1. continuous outcomes, recommended values : (1) Assumed standard deviation trial protocol (preferred), (2) sd(outcome_variable) protocol value unavailable. binary, survival count outcomes, default value 1 typically appropriate. Can referenced prior strings using placeholder sigma_ref (e.g., \"normal(0, 2.5 * sigma_ref)\"). intercept_prior character string, brmsprior object, NULL. Prior specification model intercept unshrunktermeffect component. Supports sigma_ref placeholder substitution. used survival models (Cox models intercept). Example: \"normal(0, 10)\". unshrunk_prior character string, brmsprior object, NULL. Prior specification unshrunk terms unshrunktermeffect component (excludes intercept). main effects interactions regularization desired. shrunk_prognostic_prior character string, brmsprior object, NULL. Prior specification regularized prognostic effects shprogeffect component. main effects strong shrinkage/regularization desired. shrunk_predictive_prior character string, brmsprior object, NULL. Prior specification regularized predictive effects (treatment interactions) shpredeffect component. treatment interactions strong shrinkage/regularization desired. stanvars stanvars object NULL. Custom Stan code created via brms::stanvar() implementing hierarchical priors advanced Stan functionality. See brms documentation details creating stanvars objects. ... Additional arguments passed brms::brm(). Common arguments include chains (number MCMC chains), iter (number iterations per chain), cores (number CPU cores use), backend (Stan backend), refresh (progress update frequency).","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/fit_brms_model.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","text":"brmsfit. Fitted Bayesian model object attributes: response_type (character), model_data (data.frame), trt_var (character) downstream analysis functions.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/fit_brms_model.html","id":"prior-specification","dir":"Reference","previous_headings":"","what":"Prior Specification","title":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","text":"Priors specified separately model component using dedicated parameters. provides explicit control prevents errors. function accepts prior definitions character strings (e.g., \"normal(0, 2.5 * sigma_ref)\") brmsprior objects complex hierarchical parameter-specific priors. Available prior parameters: intercept_prior: Prior intercept unshrunk component unshrunk_prior: Prior unshrunk terms (main effects trust) shrunk_prognostic_prior: Prior shrunk prognostic effects (regularized) shrunk_predictive_prior: Prior shrunk predictive effects (regularized) Using sigma_ref priors: can reference sigma_ref prior strings, automatically substituted. example: \"normal(0, 2.5 * sigma_ref)\" becomes \"normal(0, 8)\" sigma_ref = 3.2. Default Priors Response Type Model Structure: specify priors, function uses sensible defaults adapt model structure response type: models fixed effects (GLOBAL) (colon : syntax): Continuous outcomes: intercept_prior: normal(outcome_mean, 2.5 * sigma_ref) (weakly informative, centered outcome mean) unshrunk_prior: normal(0, 2.5 * sigma_ref) (weakly informative) shrunk_prognostic_prior: horseshoe(1) (strong regularization) shrunk_predictive_prior: horseshoe(1) (strong regularization) sigma: student_t(3, 0, sigma_ref) (half-t prior residual SD) Binary outcomes: intercept_prior: normal(0, 1.5) (weakly informative logit scale) unshrunk_prior: normal(0, 1.5) shrunk_prognostic_prior: horseshoe(1) shrunk_predictive_prior: horseshoe(1) Count outcomes: intercept_prior: normal(0, 2) (weakly informative log scale) unshrunk_prior: normal(0, 2) shrunk_prognostic_prior: horseshoe(1) shrunk_predictive_prior: horseshoe(1) shape: Uses brms default prior negative binomial shape parameter Survival outcomes: intercept (Cox models intercepts) unshrunk_prior: normal(0, 1.5) (weakly informative log-hazard scale) shrunk_prognostic_prior: horseshoe(1) shrunk_predictive_prior: horseshoe(1) models random effects (One-variable---time (OVAT)) (pipe-pipe || syntax): Random effects shrunk predictive terms (e.g., ~ (1 + trt || subgroup)) automatically receive normal(0, sigma_ref) priors standard deviation scale coefficient group combination, regardless shrunk_predictive_prior setting. example: prior(normal(0, sigma_ref), class = \"sd\", coef = \"Intercept\", group = \"subgroup\") prior(normal(0, sigma_ref), class = \"sd\", coef = \"trt\", group = \"subgroup\") Example:","code":"fit_brms_model(   prepared_model = prepared,   sigma_ref = 1,   unshrunk_prior = \"normal(0, 2.5 * sigma_ref)\",   shrunk_prognostic_prior = \"horseshoe(scale_global = 0.5)\",   shrunk_predictive_prior = \"horseshoe(scale_global = 0.1)\" )"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/fit_brms_model.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Fit a Bayesian Hierarchical Model using brms — fit_brms_model","text":"","code":"if (require(\"brms\") && require(\"survival\")) {   # 1. Create Sample Data   set.seed(123)   n <- 100   sim_data <- data.frame(     time = round(runif(n, 1, 100)),     status = sample(0:1, n, replace = TRUE),     trt = sample(0:1, n, replace = TRUE),     age = rnorm(n, 50, 10),     region = sample(c(\"A\", \"B\"), n, replace = TRUE),     subgroup = sample(c(\"S1\", \"S2\", \"S3\"), n, replace = TRUE)   )   sim_data$trt <- factor(sim_data$trt, levels = c(0, 1))   sim_data$region <- as.factor(sim_data$region)   sim_data$subgroup <- as.factor(sim_data$subgroup)    # 2. Prepare the formula and data using colon syntax   prepared_model <- prepare_formula_model(     data = sim_data,     response_formula = Surv(time, status) ~ trt,     shrunk_predictive_formula = ~ trt:subgroup,     unshrunk_terms_formula = ~ age,     shrunk_prognostic_formula = ~ region,     response_type = \"survival\",     stratification_formula = ~ region   )    # 3. Fit the model   if (FALSE) { # \\dontrun{   # For survival models, typically use sigma_ref = 1   # For continuous outcomes, use protocol sigma (preferred) or sd(outcome) (fallback)   # Example: sigma_ref <- 12.5  # from protocol   # OR: sigma_ref <- sd(sim_data$outcome)  # if protocol value unavailable    fit <- fit_brms_model(     prepared_model = prepared_model,     sigma_ref = 1,     unshrunk_prior = \"normal(0, 2 * sigma_ref)\",     shrunk_prognostic_prior = \"horseshoe(scale_global = sigma_ref)\",     shrunk_predictive_prior = \"horseshoe(scale_global = sigma_ref)\",     chains = 1, iter = 50, warmup = 10, refresh = 0 # For a quick example   )    print(fit)   } # } } #> Loading required package: brms #> Loading required package: Rcpp #> Loading 'brms' package (version 2.23.0). Useful instructions #> can be found by typing help('brms'). A more detailed introduction #> to the package is available through vignette('brms_overview'). #>  #> Attaching package: ‘brms’ #> The following object is masked from ‘package:stats’: #>  #>     ar #> Loading required package: survival #>  #> Attaching package: ‘survival’ #> The following object is masked from ‘package:brms’: #>  #>     kidney #> Converting treatment variable 'trt' to numeric binary (0/1). '0' = 0, '1' = 1 #> Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz(). #> Applying stratification: estimating separate baseline hazards by 'region'. #> Note: Treatment 'trt' automatically added to unshrunk terms. #> Note: Applied one-hot encoding to shrunken factor 'subgroup' (will be used with ~ 0 + ...) #> Note: Marginality principle not followed - interaction term 'subgroup' is used without its main effect. Consider adding 'subgroup' to prognostic terms for proper model hierarchy. #> Note: Applied one-hot encoding to shrunken factor 'region' (will be used with ~ 0 + ...) #> Warning: Formula 'shprogeffect' contains an intercept. For proper regularization/interpretation, consider removing it by adding '~ 0 + ...' or '~ -1 + ...' to your input formula. #> Warning: Formula 'shpredeffect' contains an intercept. For proper regularization/interpretation, consider removing it by adding '~ 0 + ...' or '~ -1 + ...' to your input formula."},{"path":"https://openpharma.github.io/bonsaiforest2/reference/plot.subgroup_summary.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","title":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","text":"Creates forest plot subgroup_summary object list objects.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/plot.subgroup_summary.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","text":"","code":"# S3 method for class 'subgroup_summary' plot(x, x_lab = NULL, title = NULL, ...)"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/plot.subgroup_summary.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","text":"x subgroup_summary list. Object created summary_subgroup_effects(), named list objects comparison plots. x_lab character(1) NULL. Custom label x-axis. title character(1) NULL. Custom title plot. ... Additional arguments (currently unused).","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/plot.subgroup_summary.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","text":"ggplot. Forest plot visualization subgroup treatment effects.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/plot.subgroup_summary.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","text":"function creates forest plots subgroup treatment effects. supports two modes: Single Model Plot: x single subgroup_summary object, creates traditional forest plot estimates confidence intervals displayed text. Multiple Model Comparison: x named list subgroup_summary objects, creates comparative plot different models distinguished colors shapes. useful comparing OVAT vs global models, different prior specifications, sensitivity analyses.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/plot.subgroup_summary.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot Marginal Subgroup Treatment Effects — plot.subgroup_summary","text":"","code":"if (FALSE) { # \\dontrun{ # Single model plot summary1 <- summary_subgroup_effects(brms_fit = model1) plot(summary1, title = \"Subgroup Effects\")  # Multiple model comparison summary2 <- summary_subgroup_effects(brms_fit = model2) comparison <- list(   \"Model 1\" = summary1,   \"Model 2\" = summary2 ) plot(comparison, title = \"Model Comparison\") } # }"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":null,"dir":"Reference","previous_headings":"","what":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"function serves pre-processor building complex Bayesian models brms package. automates construction multi-part, non-linear formula classifying covariates three distinct categories: unshrunk terms, shrunk prognostic, shrunk predictive.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"","code":"prepare_formula_model(   data,   response_formula,   unshrunk_terms_formula = NULL,   shrunk_prognostic_formula = NULL,   shrunk_predictive_formula = NULL,   response_type = c(\"binary\", \"count\", \"continuous\", \"survival\"),   stratification_formula = NULL )"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"data data frame. Dataset containing necessary variables model fitting. Must include response variable, treatment variable, covariates specified formula arguments. data modified (contrast coding applied) returned use model fitting. response_formula formula object. response specification defining outcome variable treatment. Examples: outcome ~ trt continuous outcomes, n_events ~ trt + offset(log(days)) count outcomes, Surv(time, status) ~ trt survival models. treatment variable (right-hand side) automatically extracted converted numeric binary variable (0/1). unshrunk_terms_formula formula object NULL. Formula specifying unshrunk terms unshrunktermeffect component. May include main effects treatment interactions without regularization. Supports three syntaxes can combined: colon notation (e.g., ~ age + sex + trt:biomarker), star notation (e.g., ~ age + trt*biomarker), random effects notation (e.g., ~ age + (trt || biomarker)). shrunk_prognostic_formula formula object NULL. Formula specifying prognostic main effects regularized shprogeffect component. covariates shrinkage/regularization desired. use ~ 0 + ... syntax apply one-hot encoding symmetric regularization across levels without privileging reference group. shrunk_predictive_formula formula object NULL. Formula specifying predictive terms (treatment interactions) regularized shpredeffect component. Supports three syntaxes can combined: colon notation (e.g., ~ 0 + trt:region), star notation (e.g., ~ 0 + trt*region), random effects notation (e.g., ~ (0 + trt || region)). use ~ 0 + ... syntax one-hot encoding. response_type character string. Type outcome variable, one \"binary\", \"count\", \"continuous\", \"survival\". determines appropriate likelihood function link function model. stratification_formula formula object NULL. Formula specifying stratification variable (e.g., ~ strata_var) modeling baseline hazard (survival models) distributional parameters (models). survival models, estimates separate baseline hazard functions (bhaz) stratum. continuous models, models varying residual standard deviation (sigma). count models, models varying overdispersion (shape).","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"list six named elements: formula brmsformula object containing complete multi-part model specification data data.frame modified contrast coding (must used model fitting) response_type character(1) indicating outcome type (\"binary\", \"count\", \"continuous\", \"survival\") trt_var character(1) name treatment variable extracted response formula stan_variable_names list character vectors showing Stan parameter names model component has_intercept logical(1) indicating whether unshrunk formula includes intercept (TRUE) specified ~ 0 + ... (FALSE)","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"classification allows applying differential shrinkage (regularization) different parts model. function also prepares corresponding data using R's contrast coding system proper factor handling interactions.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"key-features","dir":"Reference","previous_headings":"","what":"Key Features","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"Multi-Part Formula Construction: generates brmsformula object three distinct linear components (unshrunktermeffect, shprogeffect, shpredeffect), combined non-linear model. allows assigning different priors component. Automated Interaction Handling: Predictive terms support three syntaxes can used together separately: colon notation (e.g., ~ trt:subgroup), star notation (e.g., ~ trt*subgroup), random effects notation (e.g., ~ (trt || subgroup)). can mix syntaxes model (e.g., ~ trt:var1 + trt*var2 + (trt || var3)). variables involved interactions converted factors appropriate contrasts (reference coding unshrunk, one-hot shrunk), enabling proper model fitting prediction new data without manual dummy variable creation. Hierarchical Integrity Check: predictive term like trt:subgroup specified, function checks whether corresponding prognostic effect subgroup included model. missing, issues warning message alert violation marginality principle, allowing decide whether add main effect. Note: Star notation (*) automatically includes main effects, variables excluded marginality check. Intelligent Defaults: main treatment variable automatically added unshrunk prognostic term specified elsewhere. also provides warnings resolves overlaps term accidentally specified multiple categories.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"survival-model-details-robust-spline-knot-calculation-","dir":"Reference","previous_headings":"","what":"Survival Model Details (Robust Spline Knot Calculation)","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"survival models (response_type = \"survival\"), function explicitly models baseline hazard using B-splines via brms::bhaz(). implements highly robust method calculating spline knots ensure stability: Boundary Definition: first establishes boundary knots taking range unique event times adding small buffer. creates \"safe\" interval placing internal knots. Internal Knot Placement: calculates internal knots using quantiles event times fall strictly within boundary knots. prevents knots placed exact edges data, can cause numerical instability. Fallback Sparse Data: unique event times calculate quantile-based knots, gracefully falls back placing evenly spaced knots within defined boundaries.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"data-transformation-and-contrast-coding","dir":"Reference","previous_headings":"","what":"Data Transformation and Contrast Coding","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"function returns modified data.frame must used subsequent calls fit_brms_model(), original data. transformations : Treatment variable: Converted numeric binary (0/1) avoid multi-level factor interactions. first level (alphabetically numerically) becomes 0, second becomes 1. Factor covariates: Automatic contrast coding based shrinkage type: Shrunk terms: One-hot encoding (factor levels represented). proper regularization, specify using ~ 0 + var explicitly remove intercept treat subgroups symmetrically without privileging specific reference group (ensures exchangeability assumption). Unshrunk terms: Dummy encoding (reference level dropped). Use standard formula syntax ~ var intercept. Custom contrasts: pre-specified contrasts via contrasts(data$var) <- <matrix> calling function, preserved. Otherwise, defaults applied based shrinkage category.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"stratification","dir":"Reference","previous_headings":"","what":"Stratification","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"stratification_formula_str argument allows estimating certain parameters separately different groups. behavior depends response_type: survival: Estimates separate baseline hazard function (bhaz) level stratification variable. continuous: Models residual standard deviation (sigma) varying across levels stratification variable. count: Models overdispersion parameter (shape) varying across levels stratification variable.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/prepare_formula_model.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model","text":"","code":"if (require(\"brms\") && require(\"survival\")) {   # 1. Create Sample Data   set.seed(123)   n <- 100   sim_data <- data.frame(     time = round(runif(n, 1, 100)),     status = sample(0:1, n, replace = TRUE),     trt = sample(0:1, n, replace = TRUE),     age = rnorm(n, 50, 10),     region = sample(c(\"A\", \"B\"), n, replace = TRUE),     subgroup = sample(c(\"S1\", \"S2\", \"S3\"), n, replace = TRUE)   )   sim_data$trt <- factor(sim_data$trt, levels = c(0, 1))   sim_data$region <- as.factor(sim_data$region)   sim_data$subgroup <- as.factor(sim_data$subgroup)    # 2a. Example with colon interaction syntax   prepared_model <- prepare_formula_model(     data = sim_data,     response_formula = Surv(time, status) ~ trt,     unshrunk_terms_formula = ~ age + subgroup,     shrunk_predictive_formula = ~ trt:subgroup,     response_type = \"survival\",     stratification_formula = ~ region   )    # 2b. Alternatively, using pipe-pipe (||) syntax   # prepared_model <- prepare_formula_model(   #   data = sim_data,   #   response_formula = Surv(time, status) ~ trt,   #   unshrunk_terms_formula = ~ age,   #   shrunk_predictive_formula = ~ (0 + trt || subgroup),   #   response_type = \"survival\",   #   stratification_formula = ~ region   # )    # 3. View the results   print(prepared_model$formula)   print(head(prepared_model$data)) } #> Converting treatment variable 'trt' to numeric binary (0/1). '0' = 0, '1' = 1 #> Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz(). #> Applying stratification: estimating separate baseline hazards by 'region'. #> Note: Treatment 'trt' automatically added to unshrunk terms. #> Note: Variables appear as main effects (unshrunk) and in interactions (shrunk predictive): subgroup. Creating duplicates to allow different contrast encodings. #> Created duplicate variable 'subgroup_onehot' for one-hot encoding (original 'subgroup' will use dummy encoding) #> Note: Applied one-hot encoding to shrunken factor 'subgroup_onehot' (will be used with ~ 0 + ...) #> Note: Marginality principle not followed - interaction term 'subgroup_onehot' is used without its main effect. Consider adding 'subgroup_onehot' to prognostic terms for proper model hierarchy. #> Note: Applied dummy encoding (contr.treatment) to unshrunken factor 'subgroup' #> Warning: Formula 'shpredeffect' contains an intercept. For proper regularization/interpretation, consider removing it by adding '~ 0 + ...' or '~ -1 + ...' to your input formula. #> time | cens(1 - status) + bhaz(Boundary.knots = c(0.02, 99.98), knots = c(24, 46, 69), intercept = FALSE, gr = region) ~ unshrunktermeffect + shpredeffect  #> unshrunktermeffect ~ 0 + age + subgroup + trt #> shpredeffect ~ trt:subgroup_onehot #>   time status trt      age region subgroup subgroup_onehot #> 1   29      0   1 57.87739      B       S2              S2 #> 2   79      1   1 57.69042      B       S1              S1 #> 3   41      1   1 53.32203      B       S3              S3 #> 4   88      0   0 39.91623      B       S3              S3 #> 5   94      1   1 48.80547      A       S3              S3 #> 6    6      1   1 47.19605      A       S2              S2"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/run_brms_analysis.html","id":null,"dir":"Reference","previous_headings":"","what":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","title":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","text":"high-level wrapper function streamlines entire process preparing fitting complex Bayesian hierarchical model brms.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/run_brms_analysis.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","text":"","code":"run_brms_analysis(   data,   response_formula,   response_type = c(\"binary\", \"count\", \"continuous\", \"survival\"),   unshrunk_terms_formula = NULL,   shrunk_prognostic_formula = NULL,   shrunk_predictive_formula = NULL,   stratification_formula = NULL,   sigma_ref = 1,   intercept_prior = NULL,   unshrunk_prior = NULL,   shrunk_prognostic_prior = NULL,   shrunk_predictive_prior = NULL,   stanvars = NULL,   ... )"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/run_brms_analysis.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","text":"data data frame. Dataset containing necessary variables including response, treatment, covariates. Passed prepare_formula_model() preprocessing. response_formula formula object. Response specification defining outcome treatment. Examples: outcome ~ trt continuous, Surv(time, status) ~ trt survival. Passed prepare_formula_model(). response_type character string. Outcome type, one \"binary\", \"count\", \"continuous\", \"survival\". Determines likelihood function link used. Passed prepare_formula_model(). unshrunk_terms_formula formula object NULL. Unshrunk terms specification unshrunktermeffect component. May include main effects treatment interactions without regularization (e.g., ~ age + sex + trt*region). Passed prepare_formula_model(). shrunk_prognostic_formula formula object NULL. Prognostic effects strong regularization shprogeffect component. colon syntax (GLOBAL), use ~ 0 + ... syntax one-hot encoding (e.g., ~ 0 + biomarker1 + biomarker2). pipe-pipe syntax (OVAT), use random effects notation (e.g., ~ (1 || biomarker)). Passed prepare_formula_model(). shrunk_predictive_formula formula object NULL. Treatment interactions strong regularization shpredeffect component. colon syntax (GLOBAL), use ~ 0 + ... syntax one-hot encoding (e.g., ~ 0 + trt:subgroup). pipe-pipe syntax (OVAT), use random effects notation (e.g., ~ (trt || subgroup)). Passed prepare_formula_model(). stratification_formula formula object NULL. Stratification variable specification (e.g., ~ strata_var). survival models, estimates separate baseline hazards per stratum. models, models varying distributional parameters. Passed prepare_formula_model(). sigma_ref numeric scalar. Reference scale prior specification. Default 1. continuous outcomes, recommended values : (1) Assumed standard deviation trial protocol (preferred), (2) sd(outcome_variable) protocol value unavailable. binary, survival count outcomes, default value 1 typically appropriate. Can referenced prior strings using placeholder sigma_ref (e.g., \"normal(0, 2.5 * sigma_ref)\"). Passed fit_brms_model(). intercept_prior character string, brmsprior object, NULL. Intercept prior unshrunktermeffect component. Supports sigma_ref placeholder substitution. used survival models (Cox models intercept). Example: \"normal(0, 10 * sigma_ref)\". Passed fit_brms_model(). unshrunk_prior character string, brmsprior object, NULL. Prior unshrunk terms (non-intercept coefficients unshrunktermeffect component). Supports sigma_ref placeholder substitution. Example: \"normal(0, 2.5 * sigma_ref)\". Passed fit_brms_model(). shrunk_prognostic_prior character string, brmsprior object, NULL. Prior regularized prognostic effects shprogeffect component. fixed effects (colon syntax), typically strong regularization like \"horseshoe(scale_global = sigma_ref)\". random effects (pipe-pipe syntax), automatically uses normal(0, sigma_ref) priors standard deviation scale. Passed fit_brms_model(). shrunk_predictive_prior character string, brmsprior object, NULL. Prior regularized predictive effects (treatment interactions) shpredeffect component. fixed effects (colon syntax), typically strong regularization like \"horseshoe(scale_global = 0.5 * sigma_ref)\". random effects (pipe-pipe syntax), automatically uses normal(0, sigma_ref) priors standard deviation scale. Passed fit_brms_model(). stanvars stanvars object NULL. Custom Stan code created via brms::stanvar() implementing hierarchical priors advanced Stan functionality. Passed fit_brms_model(). ... Additional arguments passed brms::brm() via fit_brms_model(). Common arguments include chains, iter, cores, backend, refresh.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/run_brms_analysis.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","text":"brmsfit. Fitted Bayesian model object stored attributes downstream analysis.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/run_brms_analysis.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","text":"function main user-facing entry point. first calls prepare_formula_model() build brmsformula process data, passes results fit_brms_model() run analysis.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/run_brms_analysis.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Run a Full Bayesian Hierarchical Model Analysis — run_brms_analysis","text":"","code":"if (require(\"brms\") && require(\"survival\")) {   # 1. Create Sample Data   set.seed(123)   n <- 100   sim_data <- data.frame(     time = round(runif(n, 1, 100)),     status = sample(0:1, n, replace = TRUE),     trt = sample(0:1, n, replace = TRUE),     age = rnorm(n, 50, 10),     region = sample(c(\"A\", \"B\"), n, replace = TRUE),     subgroup = sample(c(\"S1\", \"S2\", \"S3\"), n, replace = TRUE)   )   sim_data$trt <- factor(sim_data$trt, levels = c(0, 1))   sim_data$region <- as.factor(sim_data$region)   sim_data$subgroup <- as.factor(sim_data$subgroup)    # 2. Run the full analysis using GLOBAL fixed effects (colon syntax)   if (FALSE) { # \\dontrun{   # For survival models, typically use sigma_ref = 1 (default)   # For continuous outcomes, use protocol sigma (preferred) or sd(outcome) (fallback)   # Example: sigma_ref <- 12.5  # from protocol   # OR: sigma_ref <- sd(sim_data$outcome)  # if protocol value unavailable    full_fit_global <- run_brms_analysis(     data = sim_data,     response_formula = Surv(time, status) ~ trt,     response_type = \"survival\",     unshrunk_terms_formula = ~ age,     shrunk_prognostic_formula = ~ 0 + region,     shrunk_predictive_formula = ~ 0 + trt:subgroup,     stratification_formula = ~ region,     sigma_ref = 1,  # Default for survival     unshrunk_prior = \"normal(0, 2 * sigma_ref)\",     shrunk_prognostic_prior = \"horseshoe(scale_global = sigma_ref)\",     shrunk_predictive_prior = \"horseshoe(scale_global = sigma_ref)\",     chains = 1, iter = 50, warmup = 10, refresh = 0 # For quick example   )    print(full_fit_global)    # 3. Alternative: OVAT random effects (pipe-pipe syntax)   # Random effects automatically get normal(0, sigma_ref) priors on SD scale   full_fit_ovat <- run_brms_analysis(     data = sim_data,     response_formula = Surv(time, status) ~ trt,     response_type = \"survival\",     unshrunk_terms_formula = ~ age,     shrunk_prognostic_formula = ~ (1 || region),     shrunk_predictive_formula = ~ (trt || subgroup),     stratification_formula = ~ region,     sigma_ref = 1,     chains = 1, iter = 50, warmup = 10, refresh = 0   )    print(full_fit_ovat)   } # } }"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/summary_subgroup_effects.html","id":null,"dir":"Reference","previous_headings":"","what":"Create a Summary of Marginal Subgroup Treatment Effects — summary_subgroup_effects","title":"Create a Summary of Marginal Subgroup Treatment Effects — summary_subgroup_effects","text":"function orchestrates calls estimate_subgroup_effects generate summary table specific subgroups.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/summary_subgroup_effects.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Create a Summary of Marginal Subgroup Treatment Effects — summary_subgroup_effects","text":"","code":"summary_subgroup_effects(   brms_fit,   trt_var = NULL,   response_type = NULL,   subgroup_vars = \"auto\" )"},{"path":"https://openpharma.github.io/bonsaiforest2/reference/summary_subgroup_effects.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Create a Summary of Marginal Subgroup Treatment Effects — summary_subgroup_effects","text":"brms_fit brmsfit object. Fitted model object fit_brms_model() run_brms_analysis(). Must contain necessary attributes extracting treatment variable response type information. trt_var character string NULL. Treatment variable name (coded 0/1). NULL, automatically extracted model attributes (set fit_brms_model()). match treatment variable used model fitting. response_type character string NULL. Outcome type, one \"binary\", \"count\", \"continuous\", \"survival\". NULL, automatically extracted model attributes (set fit_brms_model()). determines appropriate scale summarizing effects. subgroup_vars character vector \"auto\". Subgrouping variable names generate summaries. Defaults \"auto\", automatically detects treatment interactions formula components (unshrunktermeffect, shprogeffect, shpredeffect). NULL.","code":""},{"path":"https://openpharma.github.io/bonsaiforest2/reference/summary_subgroup_effects.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Create a Summary of Marginal Subgroup Treatment Effects — summary_subgroup_effects","text":"subgroup_summary. S3 object containing: estimates tibble subgroup-specific treatment effect estimates response_type character(1) indicating outcome type ci_level numeric(1) credible interval level (default 0.95) trt_var character(1) treatment variable name","code":""}]
