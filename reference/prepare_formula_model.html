<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model • bonsaiforest2</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Prepare a Multi-Part brms Formula and Corresponding Data — prepare_formula_model"><meta name="description" content="This function serves as a powerful pre-processor for building complex Bayesian
models with the `brms` package. It automates the construction of a multi-part,
non-linear formula by classifying covariates into four distinct categories:
unshrunk prognostic, shrunk prognostic, unshrunk predictive, and shrunk predictive."><meta property="og:description" content="This function serves as a powerful pre-processor for building complex Bayesian
models with the `brms` package. It automates the construction of a multi-part,
non-linear formula by classifying covariates into four distinct categories:
unshrunk prognostic, shrunk prognostic, unshrunk predictive, and shrunk predictive."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bonsaiforest2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/Statistical_Specifications.html">Statistical Specifications</a></li>
    <li><a class="dropdown-item" href="../articles/technical-details.html">Technical Details of bonsai forest Models</a></li>
    <li><a class="dropdown-item" href="../articles/using-bonsaiforest.html">Using bonsai forest for Bayesian Subgroup Analysis</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Prepare a Multi-Part brms Formula and Corresponding Data</h1>

      <div class="d-none name"><code>prepare_formula_model.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function serves as a powerful pre-processor for building complex Bayesian
models with the `brms` package. It automates the construction of a multi-part,
non-linear formula by classifying covariates into four distinct categories:
unshrunk prognostic, shrunk prognostic, unshrunk predictive, and shrunk predictive.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">prepare_formula_model</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">response_formula_str</span>,</span>
<span>  shrunk_predictive_formula_str <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  unshrunk_prognostic_formula_str <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  unshrunk_predictive_formula_str <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  shrunk_prognostic_formula_str <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  response_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"binary"</span>, <span class="st">"count"</span>, <span class="st">"continuous"</span>, <span class="st">"survival"</span><span class="op">)</span>,</span>
<span>  stratification_formula_str <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>A data.frame containing all the necessary variables.</p></dd>


<dt id="arg-response-formula-str">response_formula_str<a class="anchor" aria-label="anchor" href="#arg-response-formula-str"></a></dt>
<dd><p>A character string for the response part, e.g.,
"outcome ~ trt", for count models "n_events + offset(log(days)) ~ trt" or for
survival models "Surv(time,status) ~ trt".</p></dd>


<dt id="arg-shrunk-predictive-formula-str">shrunk_predictive_formula_str<a class="anchor" aria-label="anchor" href="#arg-shrunk-predictive-formula-str"></a></dt>
<dd><p>Predictive terms to be shrunk ('shpredeffect').
These are typically interactions with the treatment variable.</p></dd>


<dt id="arg-unshrunk-prognostic-formula-str">unshrunk_prognostic_formula_str<a class="anchor" aria-label="anchor" href="#arg-unshrunk-prognostic-formula-str"></a></dt>
<dd><p>Prognostic terms not to be shrunk
('unprogeffect'). These are main effects assumed to be important.</p></dd>


<dt id="arg-unshrunk-predictive-formula-str">unshrunk_predictive_formula_str<a class="anchor" aria-label="anchor" href="#arg-unshrunk-predictive-formula-str"></a></dt>
<dd><p>Predictive terms not to be shrunk
('unpredeffect').</p></dd>


<dt id="arg-shrunk-prognostic-formula-str">shrunk_prognostic_formula_str<a class="anchor" aria-label="anchor" href="#arg-shrunk-prognostic-formula-str"></a></dt>
<dd><p>Prognostic terms to be shrunk
('shprogeffect'). These are main effects where regularization is desired.</p></dd>


<dt id="arg-response-type">response_type<a class="anchor" aria-label="anchor" href="#arg-response-type"></a></dt>
<dd><p>The type of outcome variable. One of "binary", "count",
"continuous", or "survival".</p></dd>


<dt id="arg-stratification-formula-str">stratification_formula_str<a class="anchor" aria-label="anchor" href="#arg-stratification-formula-str"></a></dt>
<dd><p>A formula string specifying the stratification
variable, e.g., "~ strata_var".</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list with three elements: `formula` (a `brmsformula` object),
  `data` (the modified data.frame), and `response_type` (the
  character string of the response type).</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This classification allows for applying differential shrinkage (regularization)
to different parts of the model. The function also prepares the corresponding
data, including the automatic creation of dummy variables for predictive effects (interactions).</p>
    </div>
    <div class="section level2">
    <h2 id="key-features">Key Features<a class="anchor" aria-label="anchor" href="#key-features"></a></h2>


<ul><li><p><strong>Multi-Part Formula Construction:</strong> It generates a `brmsformula`
    object with up to four distinct linear components (`unprogeffect`,
    `shprogeffect`, `unpredeffect`, `shpredeffect`), which are combined
    in a non-linear model. This allows for assigning different priors to each
    component.</p></li>
<li><p><strong>Automated Interaction Handling:</strong> Predictive terms (e.g.,
    `~ trt:subgroup`) are automatically expanded. For each level of the
    `subgroup` variable, a new dummy column is created in the dataset,
    representing the interaction, simplifying the modeling of treatment effect
    heterogeneity.</p></li>
<li><p><strong>Hierarchical Integrity:</strong> When a predictive term like
    `trt:subgroup` is specified, the function automatically ensures that the
    corresponding prognostic (main) effect `subgroup` is included in the model,
    adhering to the principle of model hierarchy.</p></li>
<li><p><strong>Intelligent Defaults:</strong> The main treatment variable is automatically
    added as an unshrunk prognostic term if not specified elsewhere. It also
    provides warnings and resolves overlaps if a term is accidentally specified
    in multiple categories.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="survival-model-details-robust-spline-knot-calculation-">Survival Model Details (Robust Spline Knot Calculation)<a class="anchor" aria-label="anchor" href="#survival-model-details-robust-spline-knot-calculation-"></a></h2>


<p>For survival models (`response_type = "survival"`), the function explicitly models
the baseline hazard using B-splines via `brms::bhaz()`. It implements a highly
robust method for calculating spline knots to ensure stability:</p><ol><li><p><strong>Boundary Definition:</strong> It first establishes boundary knots by taking
    the range of unique event times and adding a small buffer. This creates a
    "safe" interval for placing internal knots.</p></li>
<li><p><strong>Internal Knot Placement:</strong> It calculates internal knots using
    quantiles of the event times that fall strictly within the boundary knots.
    This prevents knots from being placed at the exact edges of the data, which
    can cause numerical instability.</p></li>
<li><p><strong>Fallback for Sparse Data:</strong> If there are too few unique event
    times to calculate quantile-based knots, it gracefully falls back to placing
    evenly spaced knots within the defined boundaries.</p></li>
</ol></div>
    <div class="section level2">
    <h2 id="data-transformation">Data Transformation<a class="anchor" aria-label="anchor" href="#data-transformation"></a></h2>


<p>It is critical to note that this function returns a modified `data.frame`.
The treatment variable is converted to an integer (0/1), and new columns for
interaction terms are created. The returned `data` object should be used in the
subsequent call to `brms::brm()`, not the original data.</p>
    </div>
    <div class="section level2">
    <h2 id="stratification">Stratification<a class="anchor" aria-label="anchor" href="#stratification"></a></h2>


<p>The `stratification_formula_str` argument allows for estimating certain parameters
separately for different groups. Its behavior depends on the `response_type`:</p><ul><li><p><code>survival</code>: Estimates a separate baseline hazard function (`bhaz`) for
    each level of the stratification variable.</p></li>
<li><p><code>continuous</code>: Models the residual standard deviation (`sigma`) as varying
    across levels of the stratification variable.</p></li>
<li><p><code>count</code>: Models the overdispersion parameter (`shape`) as varying
    across levels of the stratification variable.</p></li>
</ul></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/paul-buerkner/brms" class="external-link">"brms"</a></span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/therneau/survival" class="external-link">"survival"</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="co"># 1. Create Sample Data</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span></span></span>
<span class="r-in"><span>  <span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    subgroup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S1"</span>, <span class="st">"S2"</span>, <span class="st">"S3"</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">sim_data</span><span class="op">$</span><span class="va">trt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">$</span><span class="va">trt</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">sim_data</span><span class="op">$</span><span class="va">region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">$</span><span class="va">region</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">sim_data</span><span class="op">$</span><span class="va">subgroup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">$</span><span class="va">subgroup</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># 2. Run the function</span></span></span>
<span class="r-in"><span>  <span class="va">prepared_model</span> <span class="op">&lt;-</span> <span class="fu">prepare_formula_model</span><span class="op">(</span></span></span>
<span class="r-in"><span>    data <span class="op">=</span> <span class="va">sim_data</span>,</span></span>
<span class="r-in"><span>    response_formula_str <span class="op">=</span> <span class="st">"Surv(time, status) ~ trt"</span>,</span></span>
<span class="r-in"><span>    shrunk_predictive_formula_str <span class="op">=</span> <span class="st">"~ trt:subgroup"</span>,</span></span>
<span class="r-in"><span>    unshrunk_prognostic_formula_str <span class="op">=</span> <span class="st">"~ age"</span>,</span></span>
<span class="r-in"><span>    shrunk_prognostic_formula_str <span class="op">=</span> <span class="st">"~ region"</span>,</span></span>
<span class="r-in"><span>    response_type <span class="op">=</span> <span class="st">"survival"</span>,</span></span>
<span class="r-in"><span>    stratification_formula_str <span class="op">=</span> <span class="st">"~ region"</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># 3. View the results</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">prepared_model</span><span class="op">$</span><span class="va">formula</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">prepared_model</span><span class="op">$</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Response type is 'survival'. Modeling the baseline hazard explicitly using bhaz().</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Applying stratification: estimating separate baseline hazards by 'region'.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Treatment 'trt' added to unshrunk prognostic terms by default.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Auto-adding missing prognostic effect for interaction: subgroup</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> time | cens(1 - status) + bhaz(Boundary.knots = c(0.02, 99.98), knots = c(24, 46, 69), intercept = FALSE, gr = region) ~ unprogeffect + shprogeffect + shpredeffect </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> unprogeffect ~ age + trt + subgroup + 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> shprogeffect ~ region + 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> shpredeffect ~ subgroup_S1_x_trt + subgroup_S2_x_trt + subgroup_S3_x_trt + 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   time status trt      age region subgroup subgroup_S1_x_trt subgroup_S2_x_trt</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1   29      0   1 57.87739      B       S2                 0                 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2   79      1   1 57.69042      B       S1                 1                 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3   41      1   1 53.32203      B       S3                 0                 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4   88      0   0 39.91623      B       S3                 0                 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5   94      1   1 48.80547      A       S3                 0                 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6    6      1   1 47.19605      A       S2                 0                 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   subgroup_S3_x_trt</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1                 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2                 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3                 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4                 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5                 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6                 0</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Miriam Pedrera Gomez, Isaac Gravestock.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

