% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fit_brms_model.R
\name{fit_brms_model}
\alias{fit_brms_model}
\title{Fit a Bayesian Hierarchical Model using brms}
\usage{
fit_brms_model(
  prepared_model,
  sigma_ref = 1,
  intercept_prior = NULL,
  unshrunk_prior = NULL,
  shrunk_prognostic_prior = NULL,
  shrunk_predictive_prior = NULL,
  stanvars = NULL,
  ...
)
}
\arguments{
\item{prepared_model}{A list object. Object returned from \code{prepare_formula_model()} containing
the elements: \code{formula} (a \code{brmsformula} object), \code{data} (a modified \code{data.frame} with
appropriate contrast coding), \code{response_type} (a character string), and \code{trt_var} (a
character string). The \code{trt_var} element is stored as an attribute on the fitted model
for use by downstream functions like \code{estimate_subgroup_effects()}.}

\item{sigma_ref}{A numeric scalar. Reference scale for prior specification. Default is 1.
For continuous outcomes, recommended values are: (1) Assumed standard deviation from trial
protocol (preferred), or (2) \code{sd(outcome_variable)} if protocol value unavailable.
For binary, survival and count outcomes, the default value of 1 is typically appropriate.
Can be referenced in prior strings using the placeholder \code{sigma_ref}
(e.g., \code{"normal(0, 2.5 * sigma_ref)"}).}

\item{intercept_prior}{A character string, \code{brmsprior} object, or \code{NULL}. Prior specification
for the model intercept in the \code{unshrunktermeffect} component. Supports \code{sigma_ref}
placeholder substitution. Not used for survival models (Cox models have no intercept).
Example: \code{"normal(0, 10)"}.}

\item{unshrunk_prior}{A character string, \code{brmsprior} object, or \code{NULL}. Prior specification
for unshrunk terms in the \code{unshrunktermeffect} component (excludes intercept). These are
main effects and interactions for which no regularization is desired.}

\item{shrunk_prognostic_prior}{A character string, \code{brmsprior} object, or \code{NULL}. Prior
specification for regularized prognostic effects in the \code{shprogeffect} component. These
are main effects for which strong shrinkage/regularization is desired.}

\item{shrunk_predictive_prior}{A character string, \code{brmsprior} object, or \code{NULL}. Prior
specification for regularized predictive effects (treatment interactions) in the
\code{shpredeffect} component. These are treatment interactions for which strong
shrinkage/regularization is desired.}

\item{stanvars}{A \code{stanvars} object or \code{NULL}. Custom Stan code created via \code{brms::stanvar()}
for implementing hierarchical priors or other advanced Stan functionality. See the brms
documentation for details on creating \code{stanvars} objects.}

\item{...}{Additional arguments passed to \code{brms::brm()}. Common arguments include \code{chains}
(number of MCMC chains), \code{iter} (number of iterations per chain), \code{cores} (number of
CPU cores to use), \code{backend} (Stan backend), and \code{refresh} (progress update frequency).}
}
\value{
\code{brmsfit}. Fitted Bayesian model object with attributes:
\code{response_type} (\code{character}), \code{model_data} (\code{data.frame}), and
\code{trt_var} (\code{character}) for downstream analysis functions.
}
\description{
This function serves as a wrapper to fit a Bayesian model using the \code{brms}
package. It uses a formula and data prepared by \code{prepare_formula_model} and
simplifies the process of assigning complex priors to the different non-linear
components of the model.
}
\section{Prior Specification}{

Priors are specified separately for each model component using dedicated parameters.
This provides explicit control and prevents errors. The function accepts prior
definitions as character strings (e.g., \code{"normal(0, 2.5 * sigma_ref)"}) or as
\code{brmsprior} objects for complex hierarchical or parameter-specific priors.

\strong{Available prior parameters:}
\itemize{
\item \code{intercept_prior}: Prior for the intercept in the unshrunk component
\item \code{unshrunk_prior}: Prior for all unshrunk terms (main effects you trust)
\item \code{shrunk_prognostic_prior}: Prior for shrunk prognostic effects (regularized)
\item \code{shrunk_predictive_prior}: Prior for shrunk predictive effects (regularized)
}

\strong{Using sigma_ref in priors:}
You can reference \code{sigma_ref} in prior strings, and it will be automatically
substituted. For example: \code{"normal(0, 2.5 * sigma_ref)"} becomes
\code{"normal(0, 8)"} when sigma_ref = 3.2.

\strong{Default Priors by Response Type and Model Structure:}

If you don't specify priors, the function uses sensible defaults that adapt to
the model structure and response type:

\strong{For models with fixed effects (GLOBAL) (colon \code{:} syntax):}

\emph{Continuous outcomes:}
\itemize{
\item \code{intercept_prior}: \code{normal(outcome_mean, 2.5 * sigma_ref)} (weakly informative, centered at outcome mean)
\item \code{unshrunk_prior}: \code{normal(0, 2.5 * sigma_ref)} (weakly informative)
\item \code{shrunk_prognostic_prior}: \code{horseshoe(1)} (strong regularization)
\item \code{shrunk_predictive_prior}: \code{horseshoe(1)} (strong regularization)
\item \code{sigma}: \code{student_t(3, 0, sigma_ref)} (half-t prior for residual SD)
}

\emph{Binary outcomes:}
\itemize{
\item \code{intercept_prior}: \code{normal(0, 1.5)} (weakly informative on logit scale)
\item \code{unshrunk_prior}: \code{normal(0, 1.5)}
\item \code{shrunk_prognostic_prior}: \code{horseshoe(1)}
\item \code{shrunk_predictive_prior}: \code{horseshoe(1)}
}

\emph{Count outcomes:}
\itemize{
\item \code{intercept_prior}: \code{normal(0, 2)} (weakly informative on log scale)
\item \code{unshrunk_prior}: \code{normal(0, 2)}
\item \code{shrunk_prognostic_prior}: \code{horseshoe(1)}
\item \code{shrunk_predictive_prior}: \code{horseshoe(1)}
\item \code{shape}: Uses brms default prior for negative binomial shape parameter
}

\emph{Survival outcomes:}
\itemize{
\item No intercept (Cox models don't have intercepts)
\item \code{unshrunk_prior}: \code{normal(0, 1.5)} (weakly informative on log-hazard scale)
\item \code{shrunk_prognostic_prior}: \code{horseshoe(1)}
\item \code{shrunk_predictive_prior}: \code{horseshoe(1)}
}

\strong{For models with random effects (One-variable-at-a-time (OVAT)) (pipe-pipe \code{||} syntax):}

Random effects in shrunk predictive terms (e.g., \code{~ (1 + trt || subgroup)})
automatically receive \code{normal(0, sigma_ref)} priors on the standard deviation
scale for each coefficient and group combination, regardless of the
shrunk_predictive_prior setting. For example:
\itemize{
\item \code{prior(normal(0, sigma_ref), class = "sd", coef = "Intercept", group = "subgroup")}
\item \code{prior(normal(0, sigma_ref), class = "sd", coef = "trt", group = "subgroup")}
}

\strong{Example:}

\if{html}{\out{<div class="sourceCode">}}\preformatted{fit_brms_model(
  prepared_model = prepared,
  sigma_ref = 1,
  unshrunk_prior = "normal(0, 2.5 * sigma_ref)",
  shrunk_prognostic_prior = "horseshoe(scale_global = 0.5)",
  shrunk_predictive_prior = "horseshoe(scale_global = 0.1)"
)
}\if{html}{\out{</div>}}
}

\examples{
if (require("brms") && require("survival")) {
  # 1. Create Sample Data
  set.seed(123)
  n <- 100
  sim_data <- data.frame(
    time = round(runif(n, 1, 100)),
    status = sample(0:1, n, replace = TRUE),
    trt = sample(0:1, n, replace = TRUE),
    age = rnorm(n, 50, 10),
    region = sample(c("A", "B"), n, replace = TRUE),
    subgroup = sample(c("S1", "S2", "S3"), n, replace = TRUE)
  )
  sim_data$trt <- factor(sim_data$trt, levels = c(0, 1))
  sim_data$region <- as.factor(sim_data$region)
  sim_data$subgroup <- as.factor(sim_data$subgroup)

  # 2. Prepare the formula and data using colon syntax
  prepared_model <- prepare_formula_model(
    data = sim_data,
    response_formula = Surv(time, status) ~ trt,
    shrunk_predictive_formula = ~ trt:subgroup,
    unshrunk_terms_formula = ~ age,
    shrunk_prognostic_formula = ~ region,
    response_type = "survival",
    stratification_formula = ~ region
  )

  # 3. Fit the model
  \dontrun{
  # For survival models, typically use sigma_ref = 1
  # For continuous outcomes, use protocol sigma (preferred) or sd(outcome) (fallback)
  # Example: sigma_ref <- 12.5  # from protocol
  # OR: sigma_ref <- sd(sim_data$outcome)  # if protocol value unavailable

  fit <- fit_brms_model(
    prepared_model = prepared_model,
    sigma_ref = 1,
    unshrunk_prior = "normal(0, 2 * sigma_ref)",
    shrunk_prognostic_prior = "horseshoe(scale_global = sigma_ref)",
    shrunk_predictive_prior = "horseshoe(scale_global = sigma_ref)",
    chains = 1, iter = 50, warmup = 10, refresh = 0 # For a quick example
  )

  print(fit)
  }
}
}
