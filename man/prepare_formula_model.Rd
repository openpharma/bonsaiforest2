% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/prepare_formula_model.R
\name{prepare_formula_model}
\alias{prepare_formula_model}
\title{Prepare a Multi-Part brms Formula and Corresponding Data}
\usage{
prepare_formula_model(
  data,
  response_formula,
  unshrunk_terms_formula = NULL,
  shrunk_prognostic_formula = NULL,
  shrunk_predictive_formula = NULL,
  response_type = c("binary", "count", "continuous", "survival"),
  stratification_formula = NULL
)
}
\arguments{
\item{data}{`data.frame`. A dataset containing all necessary variables for model fitting.}

\item{response_formula}{`formula`. The response specification (e.g., `outcome ~ trt` for continuous,
`n_events + offset(log(days)) ~ trt` for count, or `Surv(time, status) ~ trt` for survival models).}

\item{unshrunk_terms_formula}{`formula` or `NULL`. Formula specifying unshrunk terms (`unshrunktermeffect`).
May include main effects and treatment interactions. Supports colon notation (e.g., `~ age + sex + trt:biomarker`),
star notation (e.g., `~ age + trt*biomarker`), or random effects notation (e.g., `~ age + (trt || biomarker)`).
Different syntaxes may be combined.}

\item{shrunk_prognostic_formula}{`formula` or `NULL`. Formula specifying prognostic main effects to be regularized
(`shprogeffect`). These are covariates where shrinkage/regularization is desired.}

\item{shrunk_predictive_formula}{`formula` or `NULL`. Formula specifying predictive terms to be regularized
(`shpredeffect`). Typically treatment interactions. Supports colon notation (e.g., `~ 0 + trt:region`),
star notation (e.g., `~ 0 + trt*region`), or random effects notation (e.g., `~ (0 + trt || region)`).
Different syntaxes may be combined.}

\item{response_type}{`character(1)`. Type of outcome variable: one of `"binary"`, `"count"`,
`"continuous"`, or `"survival"`.}

\item{stratification_formula}{`formula` or `NULL`. Formula specifying stratification variable
(e.g., `~ strata_var`) for modeling baseline hazard (survival) or distributional parameters.}
}
\value{
`list` with six named elements:
  \describe{
    \item{`formula`}{`brmsformula` object containing the complete multi-part model specification}
    \item{`data`}{`data.frame` with modified contrast coding (must be used for model fitting)}
    \item{`response_type`}{`character(1)` indicating the outcome type (`"binary"`, `"count"`, `"continuous"`, or `"survival"`)}
    \item{`trt_var`}{`character(1)` name of treatment variable extracted from response formula}
    \item{`stan_variable_names`}{`list` of character vectors showing Stan parameter names for each model component}
    \item{`has_intercept`}{`logical(1)` indicating whether the unshrunk formula includes an intercept (`TRUE`) or was specified with `~ 0 + ...` (`FALSE`)}
  }
}
\description{
This function serves as a pre-processor for building complex Bayesian
models with the `brms` package. It automates the construction of a multi-part,
non-linear formula by classifying covariates into three distinct categories:
unshrunk terms, shrunk prognostic, and shrunk predictive.
}
\details{
This classification allows for applying differential shrinkage (regularization)
to different parts of the model. The function also prepares the corresponding
data using R's contrast coding system for proper factor handling and interactions.
}
\section{Key Features}{

\itemize{
  \item \strong{Multi-Part Formula Construction:} It generates a `brmsformula`
    object with up to four distinct linear components (`unshrunktermeffect`,
    `shprogeffect`, `shpredeffect`), which are combined in a non-linear model.
    This allows for assigning different priors to each component.
  \item \strong{Automated Interaction Handling:} Predictive terms support three syntaxes
    that can be used together or separately: colon notation (e.g., `~ trt:subgroup`),
    star notation (e.g., `~ trt*subgroup`), or random effects notation (e.g.,
    `~ (trt || subgroup)`). You can mix these syntaxes in the same model (e.g.,
    `~ trt:var1 + trt*var2 + (trt || var3)`). All variables involved in interactions
    are converted to factors with appropriate contrasts (reference coding for unshrunk,
    one-hot for shrunk), enabling proper model fitting and prediction on new data
    without manual dummy variable creation.
  \item \strong{Hierarchical Integrity Check:} When a predictive term like
    `trt:subgroup` is specified, the function checks whether the corresponding
    prognostic effect `subgroup` is included in the model. If missing, it issues
    a warning message to alert you about the violation of the marginality
    principle, allowing you to decide whether to add the main effect. Note: Star
    notation (`*`) automatically includes main effects, so these variables are
    excluded from the marginality check.
  \item \strong{Intelligent Defaults:} The main treatment variable is automatically
    added as an unshrunk prognostic term if not specified elsewhere. It also
    provides warnings and resolves overlaps if a term is accidentally specified
    in multiple categories.
}
}

\section{Survival Model Details (Robust Spline Knot Calculation)}{

For survival models (`response_type = "survival"`), the function explicitly models
the baseline hazard using B-splines via `brms::bhaz()`. It implements a highly
robust method for calculating spline knots to ensure stability:
\enumerate{
  \item \strong{Boundary Definition:} It first establishes boundary knots by taking
    the range of unique event times and adding a small buffer. This creates a
    "safe" interval for placing internal knots.
  \item \strong{Internal Knot Placement:} It calculates internal knots using
    quantiles of the event times that fall strictly within the boundary knots.
    This prevents knots from being placed at the exact edges of the data, which
    can cause numerical instability.
  \item \strong{Fallback for Sparse Data:} If there are too few unique event
    times to calculate quantile-based knots, it gracefully falls back to placing
    evenly spaced knots within the defined boundaries.
}
}

\section{Data Transformation and Contrast Coding}{

\strong{CRITICAL:} This function returns a modified `data.frame` that must be used
in subsequent calls to `brms::brm()`, not the original data. The transformations are:
\itemize{
  \item \strong{Treatment variable:} Converted to numeric binary (0/1) to avoid
    multi-level factor interactions. The first level (alphabetically or numerically)
    becomes 0, the second becomes 1.
  \item \strong{Factor covariates:} Automatic contrast coding based on shrinkage type:
    \itemize{
      \item \strong{Shrunk terms:} One-hot encoding (all factor levels represented).
        For proper regularization, specify these using `~ 0 + var` to explicitly remove
        the intercept. To treat all subgroups symmetrically without privileging a specific
        reference group, to ensure the exchangeability assumption.
      \item \strong{Unshrunk terms:} Dummy encoding (reference level dropped).
      Use standard formula syntax `~ var` with intercept.
    }
  \item \strong{Custom contrasts:} If you have pre-specified contrasts via
    `contrasts(data$var) <- <matrix>` before calling this function, they will
    be preserved. Otherwise, defaults are applied based on shrinkage category.
}
}

\section{Stratification}{

The `stratification_formula_str` argument allows for estimating certain parameters
separately for different groups. Its behavior depends on the `response_type`:
\itemize{
  \item \code{survival}: Estimates a separate baseline hazard function (`bhaz`) for
    each level of the stratification variable.
  \item \code{continuous}: Models the residual standard deviation (`sigma`) as varying
    across levels of the stratification variable.
  \item \code{count}: Models the overdispersion parameter (`shape`) as varying
    across levels of the stratification variable.
}
}

\examples{
if (require("brms") && require("survival")) {
  # 1. Create Sample Data
  set.seed(123)
  n <- 100
  sim_data <- data.frame(
    time = round(runif(n, 1, 100)),
    status = sample(0:1, n, replace = TRUE),
    trt = sample(0:1, n, replace = TRUE),
    age = rnorm(n, 50, 10),
    region = sample(c("A", "B"), n, replace = TRUE),
    subgroup = sample(c("S1", "S2", "S3"), n, replace = TRUE)
  )
  sim_data$trt <- factor(sim_data$trt, levels = c(0, 1))
  sim_data$region <- as.factor(sim_data$region)
  sim_data$subgroup <- as.factor(sim_data$subgroup)

  # 2a. Example with colon interaction syntax
  prepared_model <- prepare_formula_model(
    data = sim_data,
    response_formula = Surv(time, status) ~ trt,
    unshrunk_terms_formula = ~ age + subgroup,
    shrunk_predictive_formula = ~ trt:subgroup,
    response_type = "survival",
    stratification_formula = ~ region
  )

  # 2b. Alternatively, using pipe-pipe (||) syntax
  # prepared_model <- prepare_formula_model(
  #   data = sim_data,
  #   response_formula = Surv(time, status) ~ trt,
  #   unshrunk_terms_formula = ~ age,
  #   shrunk_predictive_formula = ~ (0 + trt || subgroup),
  #   response_type = "survival",
  #   stratification_formula = ~ region
  # )

  # 3. View the results
  print(prepared_model$formula)
  print(head(prepared_model$data))
}

}
