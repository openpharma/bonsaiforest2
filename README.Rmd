---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# bonsaiforest2 <a href="https://github.com/openpharma/bonsaiforest2"><img src="man/figures/logo.png" alt="bonsaiforest2 website" align="right" height="138"/></a>

## Overview

The `bonsaiforest2` package is used for Bayesian shrinkage estimation of subgroup treatment effects in randomized clinical trials. It supports both one-way models (random effects) and fixed effects modeling approaches for estimating treatment-by-subgroup interactions, with built-in support for continuous, binary, time-to-event (Cox), and count outcomes. The package allows the usage of state-of-the-art shrinkage priors including Regularized Horseshoe and R2D2, combined with standardization (G-computation) to provide interpretable marginal treatment effects. By leveraging `brms` and `Stan`, `bonsaiforest2` provides a practical tool for obtaining more stable and reliable subgroup effect estimates in exploratory and confirmatory analyses.

## Installation

**UPDATE TO USUAL INSTALLATION** You can install the development version of `bonsaiforest2` from its GitLab repository:

```{r, eval=FALSE}
# install.packages("remotes") 
remotes::install_github("openpharma/bonsaiforest2")
```

## Key Concepts

### Modeling Approaches

`bonsaiforest2` supports two main approaches for subgroup analysis:

#### Fixed Effects Models
- Fit a single unified model with treatment-by-subgroup interactions specified as fixed effects using colon notation (e.g., `~ 0 + trt:subgroupvar1 + trt:subgroupvar2 + ...`)
- Treat all subgroups symmetrically through one-hot encoding
- Recommended: Use this approach for most applications

#### One-way Models (Random Effects)
- Fit random effects for treatment slopes varying by subgroup
- Use pipe-pipe notation (e.g., `~ (0 + trt || subgroupvar)`) to estimate treatment effects varying by subgroup
- Each subgroup gets its own treatment effect with automatic pooling via random effects

### Shrinkage Framework

The model decomposes into three components:

1. **Unshrunk terms** (`unshrunktermeffect`): Main effects with weakly informative priors
2. **Shrunk prognostic effects** (`shprogeffect`): Baseline covariate effects with strong regularization
3. **Shrunk predictive effects** (`shpredeffect`): Treatment-by-subgroup interactions with strong regularization

### Prior Specification

The package supports flexible prior specification for all model components. You must specify four priors:
- `intercept_prior`: Prior for the intercept (example: `"normal(0, 10)"`)
- `unshrunk_prior`: Prior for unshrunk terms/main effects (example: `"normal(0, 2.5)"`)
- `shrunk_prognostic_prior`: Prior for shrunk prognostic effects/baseline covariates (example: `"horseshoe(scale_global = 1)"`)
- `shrunk_predictive_prior`: Prior for shrunk predictive effects/treatment interactions (example: `"horseshoe(scale_global = 0.5)"`)

For one-way models (random effects), random effect SDs automatically use `normal(0, 1)` priors.

### Response Types

The package supports four outcome types:
- **continuous**: Linear regression with residual SD
- **binary**: Logistic regression  
- **count**: Poisson or negative binomial regression
- **survival**: Cox proportional hazards model

## Quick Start Example

This example demonstrates Bayesian shrinkage estimation of treatment effects across subgroups using a **fixed effects model** with a Regularized Horseshoe prior. We simulate data with real treatment effect heterogeneity across five subgrouping variables.

```{r example-continuous, message=FALSE, warning=FALSE}
library(bonsaiforest2)

# 1. Simulate continuous outcome trial data with treatment heterogeneity
set.seed(123)
n <- 500
dat <- data.frame(
  y    = rnorm(n, mean = 50, sd = 15),
  trt  = rep(0:1, length.out = n),
  x1   = factor(sample(c("A", "B"), n, replace = TRUE)),
  x2   = factor(sample(c("A", "B", "C"), n, replace = TRUE)),
  x3   = factor(sample(c("A", "B"), n, replace = TRUE)),
  x4   = factor(sample(c("A", "B"), n, replace = TRUE)),
  x5   = factor(sample(c("A", "B"), n, replace = TRUE))
)

# Add baseline effect and heterogeneous treatment effects by subgroup
trt_effect <- dat$trt * (
  0.35 +                                           # Base treatment effect
  0.35 * (as.numeric(dat$x1 == "B") - 0.35)       # Heterogeneity by x1
)
dat$y <- trt_effect + rnorm(n, 0, 1.2)

# 2. Fit fixed effects model with heterogeneous shrinkage
fit_fixed <- run_brms_analysis(
  data = dat,
  response_type = "continuous",
  response_formula = y ~ trt,
  unshrunk_terms_formula = ~ x1 + x2 + x3 + x4 + x5,
  shrunk_prognostic_formula = NULL,
  shrunk_predictive_formula = ~ 0 + trt:x1 + trt:x2 + trt:x3 + trt:x4 + trt:x5,
  intercept_prior = "normal(50, 15)",
  unshrunk_prior = "normal(0, 5)",
  shrunk_prognostic_prior = NULL,
  shrunk_predictive_prior = "horseshoe(1)",
  chains = 2, iter = 1000, warmup = 500,
  backend = "cmdstanr", refresh = 0
)

# 3. Extract and visualize marginal treatment effects by subgroup
subgroup_effects <- summary_subgroup_effects(fit_fixed)
print(subgroup_effects)
plot(subgroup_effects)
```

