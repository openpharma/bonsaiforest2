---
title: "Count Data: Subgroup vs Population Method Comparison"
author: "Analysis"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = TRUE)
```

# Overview

This document applies both the **population method** and the **subgroup method** to the first dataset from scenario 5 of the count endpoint simulation, to verify that the calculations are correct.

## Load Libraries and Functions

```{r load}
library(checkmate)
library(dplyr)
library(broom)
library(MASS) # For glm.nb
library(knitr)

# Source all helper functions
source("../functions.R")

# Set endpoint parameters (matching Subgroup.R)
endpoint_params <- list(
  folder = "Count",
  resp = "y",
  status = NULL,
  resptype = "count"
)
```

## Load Scenario 5 Data

```{r load-data}
# Load scenario 5
scenario5 <- readRDS("Scenarios/scenario5.rds")

# Get the first dataset
df <- scenario5[[1]]

# Ensure arm is a factor
df$arm <- factor(df$arm)

# Show data structure
cat("Dataset dimensions:", nrow(df), "rows,", ncol(df), "columns\n")
cat("Arm levels:", levels(df$arm), "\n")
cat("Table of arm:\n")
print(table(df$arm))

# Show first few rows
kable(head(df), caption = "First 6 rows of scenario 5, dataset 1")
```

## Load Truth Data for Scenario 5

```{r load-truth}
# Load the count truth data
truth_file <- file.path("Scenarios", "truth.RData")

if (file.exists(truth_file)) {
  load(truth_file)
  
  cat("Truth data loaded successfully!\n")
  cat("\nTruth data structure:\n")
  print(names(simul_truth))
  
  # Extract scenario 2 truth
  truth_overall <- simul_truth$truth_overall
  truth_subgroup <- simul_truth$truth_subgroup
  
  # Filter for scenario 5
  truth_overall_s5 <- truth_overall[truth_overall$scenario == "5", ]
  truth_subgroup_s5 <- truth_subgroup[truth_subgroup$scenario == "5", ]
  
  cat("\nScenario 5 overall truth:\n")
  print(truth_overall_s5)
  
  cat("\nScenario 5 subgroup truth (first 10 rows):\n")
  print(head(truth_subgroup_s5, 10))
  
  cat("\nâš ï¸  IMPORTANT NOTE ON TRUTH VALUES:\n")
  cat("For scenario 5 (strong heterogeneity), the 'truth' values represent\n")
  cat("the TREATMENT x SUBGROUP INTERACTION COEFFICIENTS used in data generation.\n")
  cat("However, when we fit y ~ arm within a subgroup, we estimate the MARGINAL\n")
  cat("treatment effect within that subgroup, which averages over all other\n")
  cat("covariates and their interactions.\n\n")
  cat("Therefore, the observed estimates will NOT match these truth values directly.\n")
  cat("The observed values include contributions from ALL interaction terms for\n")
  cat("patients in that subgroup, weighted by covariate distributions.\n\n")
  
  truth_available <- TRUE
} else {
  cat("WARNING: Truth data file not found at:", truth_file, "\n")
  cat("Run Truth.Rmd first to generate the truth data.\n")
  truth_available <- FALSE
}
```

## Method 1: Population Method

The population method fits a single model to the entire dataset and replicates the estimate across all subgroups.

```{r population-method}
# Apply the population method
simul_no <- 1

population_result <- population_method_endpoint(df, simul_no)

cat("\nPopulation method results:\n")
kable(population_result, caption = "Population Method Results")

# Extract the unique estimate
unique_estimate <- unique(population_result$estimate)
cat("\nUnique population estimate (log-RR):", unique_estimate, "\n")
cat("Exponentiated (RR):", exp(unique_estimate), "\n")
```

### Verify Population Model Manually

```{r verify-population}
# Fit the model manually to verify
model_pop <- glm.nb(y ~ arm, data = df)

cat("\nManual population model summary:\n")
print(summary(model_pop))

cat("\nManual estimate (log-RR):", coef(model_pop)[2], "\n")
cat("Match with population_method_endpoint?", 
    abs(coef(model_pop)[2] - unique_estimate) < 1e-6, "\n")
```

## Method 2: Subgroup Method

The subgroup method fits separate models within each subgroup.

```{r subgroup-method}
# Apply the subgroup method
subgroup_result <- subgroup_method_endpoint(df, simul_no)

cat("\nSubgroup method results:\n")
kable(subgroup_result, caption = "Subgroup Method Results")
```

### Verify Subgroup Models Manually for x_4

Let's manually fit models for the x_4 subgroups to verify the calculations.

```{r verify-subgroup-x4}
cat("\nManual verification for x_4 subgroups:\n\n")

for (level in levels(df$x_4)) {
  subdf <- df[df$x_4 == level, ]
  
  cat("Subgroup x_4 =", level, "\n")
  cat("  N =", nrow(subdf), "\n")
  cat("  Arm distribution:", table(subdf$arm), "\n")
  
  # Fit model
  model <- glm.nb(y ~ arm, data = subdf)
  
  # Extract coefficient
  coef_est <- coef(model)[2]
  se_est <- summary(model)$coefficients[2, "Std. Error"]
  
  cat("  Estimate (log-RR):", round(coef_est, 4), "\n")
  cat("  Std. Error:", round(se_est, 4), "\n")
  cat("  RR:", round(exp(coef_est), 4), "\n")
  
  # Compare to subgroup_result
  subg_name <- paste0("S_4.", level)
  matched_row <- subgroup_result[subgroup_result$subgroup == subg_name, ]
  
  if (nrow(matched_row) > 0) {
    cat("  Match with subgroup_method?", 
        abs(matched_row$estimate - coef_est) < 1e-6, "\n")
  } else {
    cat("  WARNING: Subgroup", subg_name, "not found in results!\n")
  }
  
  cat("\n")
}
```

### Verify Subgroup Models Manually for x_5

```{r verify-subgroup-x5}
cat("\nManual verification for x_5 subgroups:\n\n")

for (level in levels(df$x_5)) {
  subdf <- df[df$x_5 == level, ]
  
  cat("Subgroup x_5 =", level, "\n")
  cat("  N =", nrow(subdf), "\n")
  cat("  Arm distribution:", table(subdf$arm), "\n")
  
  # Fit model
  model <- glm.nb(y ~ arm, data = subdf)
  
  # Extract coefficient
  coef_est <- coef(model)[2]
  se_est <- summary(model)$coefficients[2, "Std. Error"]
  
  cat("  Estimate (log-RR):", round(coef_est, 4), "\n")
  cat("  Std. Error:", round(se_est, 4), "\n")
  cat("  RR:", round(exp(coef_est), 4), "\n")
  
  # Compare to subgroup_result
  subg_name <- paste0("S_5.", level)
  matched_row <- subgroup_result[subgroup_result$subgroup == subg_name, ]
  
  if (nrow(matched_row) > 0) {
    cat("  Match with subgroup_method?", 
        abs(matched_row$estimate - coef_est) < 1e-6, "\n")
  } else {
    cat("  WARNING: Subgroup", subg_name, "not found in results!\n")
  }
  
  cat("\n")
}
```

## Comparison: Population vs Subgroup

```{r comparison}
# Merge the two results for comparison
comparison <- merge(
  population_result[, c("subgroup", "estimate", "std.error")],
  subgroup_result[, c("subgroup", "estimate", "std.error")],
  by = "subgroup",
  suffixes = c("_pop", "_subg")
)

# Add difference column
comparison$diff <- comparison$estimate_subg - comparison$estimate_pop

# Show comparison
kable(comparison, 
      digits = 4,
      caption = "Comparison: Population vs Subgroup Estimates")

# Summary statistics
cat("\nDifference statistics (Subgroup - Population):\n")
cat("Mean difference:", round(mean(comparison$diff), 4), "\n")
cat("Median difference:", round(median(comparison$diff), 4), "\n")
cat("Range:", round(min(comparison$diff), 4), "to", round(max(comparison$diff), 4), "\n")
cat("SD of differences:", round(sd(comparison$diff), 4), "\n")
```

## Visualization

```{r plot, fig.width=10, fig.height=6}
library(ggplot2)

# Prepare data for plotting
plot_data <- rbind(
  data.frame(
    subgroup = population_result$subgroup,
    estimate = population_result$estimate,
    lower =population_result$lower_ci,
    upper = population_result$upper_ci,
    method = "Population"
  ),
  data.frame(
    subgroup = subgroup_result$subgroup,
    estimate = subgroup_result$estimate,
    lower = subgroup_result$lower_ci,
    upper = subgroup_result$upper_ci,
    method = "Subgroup"
  )
)

# Add truth data if available
if (truth_available) {
  truth_subgroup_s5$subgroup_clean <- gsub("^x_", "S_", truth_subgroup_s5$subgroup)
  
  truth_plot_data <- data.frame(
    subgroup = truth_subgroup_s5$subgroup_clean,
    estimate = truth_subgroup_s5$value,
    lower = NA,  # No CI for truth
    upper = NA,
    method = "Truth"
  )
  
  plot_data <- rbind(plot_data, truth_plot_data)
}

# Create forest plot
ggplot(plot_data, aes(x = estimate, y = subgroup, color = method)) +
  geom_point(position = position_dodge(width = 0.5), size = 2) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), 
                 position = position_dodge(width = 0.5),
                 height = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  labs(
    title = "Count Endpoint: Population vs Subgroup Estimates (Scenario 5)",
    subtitle = "Log-Rate Ratio with 95% CI (Truth shown as points)",
    x = "Log-Rate Ratio",
    y = "Subgroup",
    color = "Method"
  ) +
  theme_bw() +
  theme(legend.position = "bottom")
```

## Expected vs Observed

For scenario 5, the treatment effects are randomly generated across subgroups (strong heterogeneity).

```{r expected}
# For scenario 5, we compare the observed subgroup estimates to the population average

cat("Observed POPULATION effect (average across all patients):\n")
pop_estimate <- unique(population_result$estimate)
cat(sprintf("  Log-RR: %.4f\n", pop_estimate))
cat(sprintf("  RR: %.4f\n\n", exp(pop_estimate)))

cat("Observed SUBGROUP effects (separate models per subgroup):\n")
for (i in 1:nrow(subgroup_result)) {
  diff_from_pop <- subgroup_result$estimate[i] - pop_estimate
  cat(sprintf("  %s: %.4f (RR = %.4f) [diff from pop: %+.4f]\n",
              subgroup_result$subgroup[i],
              subgroup_result$estimate[i],
              exp(subgroup_result$estimate[i]),
              diff_from_pop))
}

cat("\n\nHeterogeneity summary:\n")
cat(sprintf("  Range of subgroup effects: %.4f to %.4f\n",
            min(subgroup_result$estimate),
            max(subgroup_result$estimate)))
cat(sprintf("  SD of subgroup effects: %.4f\n",
            sd(subgroup_result$estimate)))
```

## Comparison with True Effects

âš ï¸ **Important caveat for Scenario 5:**

The "truth" values represent the **treatment Ã— subgroup interaction coefficients** from the data generation model. However, when we fit `y ~ arm` within a subgroup, we estimate the **marginal treatment effect** within that subgroup.

For scenario 5 with strong heterogeneity, there are random interaction effects for ALL subgroups (x_1 through x_10). When estimating the treatment effect within x_4=a, the observed log-RR includes:
- The base treatment effect (arm1 = 0 for scenario 5)
- The x_4=a interaction
- ALL other interactions (x_1, x_2, x_3, x_5, x_6, ..., x_10), weighted by their frequency within the x_4=a subgroup

Therefore, **we expect large discrepancies** between the interaction coefficients and observed marginal effects for this scenario.

```{r compare-truth}
if (truth_available) {
  
  # Prepare the truth data for comparison
  # Convert subgroup names to match our format (x_1.a -> S_1.a)
  truth_subgroup_s5$subgroup_clean <- gsub("^x_", "S_", truth_subgroup_s5$subgroup)
  
  # Merge with observed subgroup results
  comparison_truth <- merge(
    subgroup_result[, c("subgroup", "estimate")],
    truth_subgroup_s5[, c("subgroup_clean", "value")],
    by.x = "subgroup",
    by.y = "subgroup_clean",
    all.x = TRUE
  )
  
  names(comparison_truth) <- c("subgroup", "observed_marginal", "interaction_coef")
  
  # Calculate difference
  comparison_truth$difference <- comparison_truth$observed_marginal - comparison_truth$interaction_coef
  
  cat("\nComparison: Observed Marginal Effects vs Interaction Coefficients:\n")
  cat("(Note: These SHOULD differ for scenario 5 due to marginalization)\n\n")
  kable(comparison_truth, 
        digits = 4,
        caption = "Observed Marginal Log-RR vs Interaction Coefficient (Scenario 5)")
  
  # Summary statistics
  cat("\n\nDifference summary (Observed - Interaction Coefficient):\n")
  cat(sprintf("  Mean difference: %.4f\n", mean(comparison_truth$difference, na.rm = TRUE)))
  cat(sprintf("  Median difference: %.4f\n", median(comparison_truth$difference, na.rm = TRUE)))
  cat(sprintf("  Range: %.4f to %.4f\n", 
              min(comparison_truth$difference, na.rm = TRUE),
              max(comparison_truth$difference, na.rm = TRUE)))
  
  cat("\nInterpretation:\n")
  cat("The large negative differences indicate that the marginal treatment effects\n")
  cat("estimated within each subgroup are much more negative (stronger protective effect)\n")
  cat("than the individual interaction coefficients. This is because patients in each\n")
  cat("subgroup have different combinations of OTHER covariates, each with their own random\n")
  cat("interaction effects, creating substantial heterogeneity WITHIN each x_4 subgroup.\n")
  
} else{
  cat("Truth data not available for comparison.\n")
}
```

## Visualization: Observed vs True

**Note:** For scenario 5, the "truth" points represent interaction coefficients, NOT marginal effects. They are shown for reference but are not directly comparable to the observed marginal estimates.

```{r plot-truth, fig.width=10, fig.height=8}
if (truth_available) {
  
  library(ggplot2)
  
  # Create scatter plot
  p1 <- ggplot(comparison_truth, aes(x = interaction_coef, y = observed_marginal)) +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
    geom_point(size = 3, alpha = 0.7) +
    geom_text(aes(label = subgroup), hjust = -0.1, vjust = -0.1, size = 2.5) +
    labs(
      title = "Observed Marginal Effects vs Interaction Coefficients (Scenario 5)",
      subtitle = "Red line = perfect agreement (NOT expected for this scenario)",
      x = "Interaction Coefficient (from data generation)",
      y = "Observed Marginal Log-RR (from fitted models)"
    ) +
    theme_bw()
  
  print(p1)
  
  # Create difference plot
  comparison_truth$subgroup <- factor(comparison_truth$subgroup, 
                                       levels = comparison_truth$subgroup[order(comparison_truth$difference)])
  
  p2 <- ggplot(comparison_truth, aes(x = subgroup, y = difference)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    geom_point(size = 3) +
    geom_segment(aes(xend = subgroup, y = 0, yend = difference)) +
    labs(
      title = "Difference: Marginal Effect - Interaction Coefficient (Scenario 5)",
      subtitle = "Negative values = Marginal effect is more protective than interaction alone",
      x = "Subgroup",
      y = "Difference (Log-RR scale)"
    ) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  print(p2)
  
  cat("\nðŸ“Š Interpretation:\n")
  cat("The systematic negative differences show that the marginal treatment effects\n")
  cat("estimated within each subgroup are consistently more protective (more negative)\n")
  cat("than the individual interaction coefficients used in data generation.\n\n")
  cat("This occurs because scenario 5 has random interactions for ALL 10 covariates,\n")
  cat("and the marginal effect within any one subgroup reflects the distribution of\n")
  cat("all other covariates and their interactions within that subgroup.\n")
  
} else {
  cat("Truth data not available for visualization.\n")
}
```

## Conclusion

This document demonstrates:

1. **Population method**: Fits one model to all data, replicates estimate across subgroups
2. **Subgroup method**: Fits separate models within each subgroup
3. **Comparison**: Shows how much the subgroup estimates vary from the population estimate

The variation between subgroup and population estimates represents the heterogeneity in treatment effects across subgroups, plus sampling variability.
