---
title: "Simulation Results Analysis - All Endpoints"
subtitle: "Master's Thesis Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      fig.width = 14, fig.height = 8)

# --- LOAD LIBRARIES ---
library(dplyr)
library(tidyr)
library(stringr)
library(purrr)
library(ggplot2)
library(knitr)
library(kableExtra)
library(checkmate)
library(gridExtra)
library(grid)
library(survival)
library(forcats)
```

# Overview

This document presents comprehensive simulation results for all four endpoint types:

- **Time-to-Event (TTE)**: Survival analysis with hazard ratios
- **Binary**: Logistic regression with odds ratios  
- **Count**: Negative binomial with rate ratios
- **Continuous**: Linear regression with mean differences

The analysis includes:

1. Standardized RMSE plots across all scenarios for each endpoint
2. Performance tables (RMSE, Bias, Coverage) for all endpoints
3. Additional TTE-specific visualizations

---

```{r helper_functions}
# ===== HELPER FUNCTIONS =====

# Set base path for all endpoints
base_path <- "/home/pedreram/bonsaiforest2/simulations"
message(paste("Base path set to:", base_path))

# Create output directories
plots_path <- file.path(base_path, "plots")
results_path <- file.path(base_path, "Results")
dir.create(plots_path, showWarnings = FALSE, recursive = TRUE)
dir.create(results_path, showWarnings = FALSE, recursive = TRUE)
message(paste("Plots will be saved to:", plots_path))
message(paste("Results will be saved to:", results_path))

# Function to load and process a single endpoint
load_endpoint_results <- function(endpoint_id) {
  
  message(paste("\n========== Processing Endpoint:", toupper(endpoint_id), "=========="))
  
  # Define endpoint-specific parameters
  ep_params <- switch(endpoint_id,
    "tte" = list(
      folder = file.path(base_path, "TTE"),
      truth_list_name = "simul_parameter",
      truth_overall_name = "true_overall_results",
      truth_subgroup_name = "true_subgroup_ahr",
      truth_metric_exp = "AHR",
      est_metric = "AHR",
      est_col = "estimate_ahr",
      ci_low = "lower_ci_ahr",
      ci_up = "upper_ci_ahr",
      log_truth_col = "true_log_ahr",
      display_name = "Time-to-Event (TTE)"
    ),
    "binary" = list(
      folder = file.path(base_path, "Binary"),
      truth_list_name = "simul_truth",
      truth_overall_name = "truth_overall",
      truth_subgroup_name = "truth_subgroup",
      truth_metric_exp = "exp_value",
      est_metric = "OR",
      est_col = "estimate",
      ci_low = "lower_ci_ahr",
      ci_up = "upper_ci_ahr",
      log_truth_col = "value",
      display_name = "Binary"
    ),
    "count" = list(
      folder = file.path(base_path, "Count"),
      truth_list_name = "simul_truth",
      truth_overall_name = "truth_overall",
      truth_subgroup_name = "truth_subgroup",
      truth_metric_exp = "exp_value",
      est_metric = "RR",
      est_col = "estimate",
      ci_low = "lower_ci",
      ci_up = "upper_ci",
      log_truth_col = "value",
      display_name = "Count"
    ),
    "continuous" = list(
      folder = file.path(base_path, "Continuous"),
      truth_list_name = "simul_truth",
      truth_overall_name = "truth_overall",
      truth_subgroup_name = "truth_subgroup",
      truth_metric_exp = "value",
      est_metric = "MeanDiff",
      est_col = "estimate",
      ci_low = "lower_ci",
      ci_up = "upper_ci",
      log_truth_col = "value",
      display_name = "Continuous"
    )
  )
  
  # --- LOAD ALL RESULTS FILES ---
  results_path <- file.path(ep_params$folder, "Results")
  
  if (!dir.exists(results_path)) {
    stop(paste("Results folder does not exist:", results_path))
  }
  
  message(paste("Looking for .rds files in:", results_path))
  all_files <- list.files(results_path, pattern = "\\.rds$", full.names = TRUE)
  message(paste("Found", length(all_files), "RDS files"))
  
  # Helper function to load and validate
  load_and_validate_rds <- function(file_path) {
    message(paste("  Loading:", basename(file_path)))
    
    # Check file exists
    if (!file.exists(file_path)) {
      warning(paste("File does not exist:", file_path))
      return(NULL)
    }
    
    # Try to read the file
    df <- tryCatch({
      readRDS(file_path)
    }, error = function(e) {
      warning(paste("Error reading file:", file_path, "\n  Error:", e$message))
      return(NULL)
    })
    
    if (is.null(df)) {
      return(NULL)
    }
    
    # Validate 6000 simulations (6 scenarios * 1000 reps)
    if ("scenario_id" %in% names(df)) {
      n_sims <- df %>% distinct(scenario_id, replication_id) %>% nrow()
    } else if ("scenario_no" %in% names(df)) {
      n_sims <- df %>% distinct(scenario_no, simul_no) %>% nrow()
    } else {
      warning(paste("Could not validate file:", basename(file_path)))
      return(NULL)
    }
    
    if (n_sims != 6000) {
      warning(sprintf("File %s incomplete! Expected 6000, found %d.", 
                      basename(file_path), n_sims))
    } else {
      message(paste("  ...OK: 6000 simulations found."))
    }
    
    # Add metadata
    df %>% mutate(
      file_name = basename(file_path),
      estimator_name = str_remove(file_name, paste0("^", endpoint_id, "_")) %>%
                       str_remove("\\.rds$")
    )
  }
  
  # Load all files
  all_results_list <- lapply(all_files, load_and_validate_rds)
  
  # Filter out NULL results
  all_results_list <- Filter(Negate(is.null), all_results_list)
  
  if (length(all_results_list) == 0) {
    stop(paste("No valid results files found for endpoint:", endpoint_id))
  }
  
  # --- LOAD TRUTH DATA ---
  truth_file <- file.path(ep_params$folder, "Scenarios", "truth.RData")
  if (!file.exists(truth_file)) {
    truth_file <- file.path(ep_params$folder, "Scenarios", "truth_2.RData")
  }
  
  if (!file.exists(truth_file)) {
    stop(paste("Truth file not found for endpoint:", endpoint_id))
  }
  
  load(truth_file)
  message(paste("Loaded truth from:", truth_file))
  
  # --- STANDARDIZE TRUTH DATA ---
  real_params_tidy <- NULL
  
  if (exists("simul_parameter") && endpoint_id == "tte") {
    # TTE Truth
    real_params_tidy <- simul_parameter[[ep_params$truth_subgroup_name]] %>%
      mutate(scenario_no = as.character(row_number())) %>%
      pivot_longer(
        cols = -scenario_no,
        names_to = "subgroup_real",
        values_to = "truth_exp"
      ) %>%
      mutate(
        join_key = gsub("x_|\\.", "", subgroup_real),
        truth_log = log(truth_exp)
      ) %>%
      dplyr::select(scenario_no, join_key, truth_log, truth_exp)
      
    true_population_results <- simul_parameter[[ep_params$truth_overall_name]] %>%
      mutate(
        scenario_no = as.character(1:6),
        truth_population_exp = !!sym(ep_params$truth_metric_exp),
        truth_population_log = log(truth_population_exp)
      ) %>%
      dplyr::select(scenario_no, truth_population_exp, truth_population_log)
      
  } else if (exists("simul_truth")) {
    # Other endpoints
    real_params_tidy <- simul_truth[[ep_params$truth_subgroup_name]] %>%
      mutate(
        join_key = gsub("x_", "", subgroup),
        scenario_no = as.character(scenario)
      ) %>%
      # Normalize join_key (remove dots/underscores/spaces and lowercase) to match results
      mutate(join_key = stringr::str_replace_all(join_key, "[\\._\\s]", "") %>% tolower()) %>%
      rename(truth_value = !!sym(ep_params$log_truth_col)) %>%
      mutate(
        truth_log = if (endpoint_id == "continuous") truth_value else truth_value,
        truth_exp = if (endpoint_id == "continuous") truth_value else exp(truth_value)
      ) %>%
      dplyr::select(scenario_no, join_key, truth_log, truth_exp, truth_value)

    true_population_results <- simul_truth[[ep_params$truth_overall_name]] %>%
      mutate(
        scenario_no = as.character(scenario),
        truth_pop_value = !!sym(ep_params$log_truth_col)
      ) %>%
      mutate(
        truth_population_log = if (endpoint_id == "continuous") truth_pop_value else truth_pop_value,
        truth_population_exp = if (endpoint_id == "continuous") truth_pop_value else exp(truth_pop_value)
      ) %>%
      dplyr::select(scenario_no, truth_population_exp, truth_population_log)
  } else {
    stop("Could not find truth data in .RData file.")
  }
  
  # --- STANDARDIZE ALL RESULTS ---
  standardized_results_list <- lapply(all_results_list, function(df) {
    
    estimator_type <- df$estimator_name[1]
    
    if (estimator_type %in% c("population", "subgroup")) {
      # Naive estimators
      df %>%
        mutate(
          join_key = gsub("S_|Overall", "", subgroup),
          scenario_id = as.integer(scenario_no),
          replication_id = as.integer(simul_no),
          estimate_log = estimate,
          ci_lower = lower_ci,
          ci_up = upper_ci,
          estimator_name = estimator
        ) %>%
        dplyr::select(scenario_id, replication_id, estimator_name, join_key, 
               estimate_log, ci_lower, ci_up)
        
    } else {
      # bonsaiforest2 estimators (Global/OVAT)
      df %>%
        filter(Subgroup != "Overall") %>%
        mutate(
          join_key = gsub(": ", ".", gsub("x_", "", Subgroup)),
          estimator_name = paste(model_type, prior_name, sep = "_")
        ) %>%
        rename(
          estimate_log = Median,
          ci_lower = CI_Lower,
          ci_up = CI_Upper
        ) %>%
        {
          if (endpoint_id %in% c("tte", "count")) {
            mutate(.,
              estimate_log = log(estimate_log),
              ci_lower = log(ci_lower),
              ci_up = log(ci_up)
            )
          } else {
            .
          }
        } %>%
        dplyr::select(scenario_id, replication_id, estimator_name, join_key, 
               estimate_log, ci_lower, ci_up)
    }
  })
  
  # --- COMBINE AND MERGE WITH TRUTH ---
  all_estimators_df <- bind_rows(standardized_results_list)
  all_estimators_df$scenario_no <- as.character(all_estimators_df$scenario_id)
  # Normalize join_key to avoid naming mismatches (e.g., "1.a" vs "1a")
  all_estimators_df$join_key <- all_estimators_df$join_key %>%
    stringr::str_replace_all("[\\._\\s]", "") %>%
    tolower()
  
  merged_df <- left_join(all_estimators_df, real_params_tidy, by = c("scenario_no", "join_key"))
  merged_df_with_pop <- left_join(merged_df, true_population_results, by = "scenario_no")
  
  message(paste("Endpoint", endpoint_id, "processing complete."))
  
  return(list(
    params = ep_params,
    merged_data = merged_df_with_pop,
    endpoint_id = endpoint_id
  ))
}

# Function to beautify estimator names
beautify_estimator_name <- function(estimator_name) {
  # Handle different estimator types
  case_when(
    # Frequentist estimators
    estimator_name == "population" ~ "Population (full shrinkage)",
    estimator_name == "subgroup" ~ "Subgroup (no shrinkage)",
    
    # Global models - Horseshoe
    estimator_name == "Global_horseshoe_low" ~ "GM - Horseshoe (Low)",
    estimator_name == "Global_horseshoe_mid" ~ "GM - Horseshoe (Mid)",
    estimator_name == "Global_horseshoe_strong" ~ "GM - Horseshoe (Strong)",
    
    # Global models - R2D2
    estimator_name == "Global_r2d2_low" ~ "GM - R2D2 (Low)",
    estimator_name == "Global_r2d2_mid" ~ "GM - R2D2 (Mid)",
    estimator_name == "Global_r2d2_strong" ~ "GM - R2D2 (Strong)",
    estimator_name == "Global_r2d2_mid_unshrunk_x4" ~ "GM - R2D2 (Mid, unshrunk×4)",
    
    # Global models - Normal Hierarchical
    estimator_name == "Global_full_hierarchical" ~ "GM - Normal Hierarchical",
    
    # OVAT models (all use same hierarchical prior, split by scenario for speed)
    grepl("^OVAT_", estimator_name) ~ "OVAT - Hierarchical",
    
    # Default: return as is
    TRUE ~ estimator_name
  )
}

# Function to assign model type for shapes
get_model_type <- function(estimator_name) {
  case_when(
    estimator_name %in% c("population", "subgroup") ~ "Frequentist",
    grepl("^Global_", estimator_name) ~ "Global",
    grepl("^OVAT_", estimator_name) ~ "OVAT",
    TRUE ~ "Other"
  )
}

# Function to calculate performance metrics
calculate_performance <- function(merged_df) {
  merged_df %>%
    group_by(scenario_no, estimator_name) %>%
    summarise(
      rmse = sqrt(mean((estimate_log - truth_log)^2, na.rm = TRUE)),
      mae = mean(abs(estimate_log - truth_log), na.rm = TRUE),
      bias = mean(estimate_log - truth_log, na.rm = TRUE),
      median_ae = median(abs(estimate_log - truth_log), na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(
      estimator_display = beautify_estimator_name(estimator_name),
      model_type = get_model_type(estimator_name)
    )
}

# Function to create standardized RMSE plot
create_rmse_plot <- function(performance_df, ep_params, reference_estimator = "subgroup", 
                              use_shapes = TRUE, title_size = 14) {
  
  # Filter out problematic estimators
  performance_df <- performance_df %>% 
    filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name))
  
  # Baseline RMSE
  baseline_rmse <- performance_df %>%
    filter(estimator_name == reference_estimator) %>%
    dplyr::select(scenario_no, rmse_baseline = rmse)
  
  # Scenario labels
  scenario_labels <- c(
    `1` = "Positive\n(homogeneous)",
    `2` = "Positive\n(except 1 subgroup)",
    `3` = "Negative\n(except 1 subgroup)",
    `4` = "Mild\nheterogeneity",
    `5` = "Strong\nheterogeneity",
    `6` = "Misspecified"
  )
  
  # Calculate standardized RMSE
  plot_data <- performance_df %>%
    left_join(baseline_rmse, by = "scenario_no") %>%
    mutate(
      standardized_rmse = rmse / rmse_baseline,
      scenario_name = factor(scenario_no, levels = names(scenario_labels), 
                            labels = scenario_labels)
    )
  
  # Define color palette (expanded for more models)
  color_values <- c(
    "Population (full shrinkage)" = "#5E3C99",    # Dark purple
    "Subgroup (no shrinkage)" = "#FF7F00",      # Orange
    "GM - Horseshoe (Low)" = "#A6CEE3",         # Light blue
    "GM - Horseshoe (Mid)" = "#377EB8",         # Medium blue
    "GM - Horseshoe (Strong)" = "#08519C",      # Dark blue
    "GM - R2D2 (Low)" = "#A1D99B",              # Light green
    "GM - R2D2 (Mid)" = "#31A354",              # Medium green
    "GM - R2D2 (Strong)" = "#006D2C",           # Dark green
    "GM - Normal Hierarchical" = "#E78AC3",     # Pink
    "OVAT - Hierarchical" = "#E41A1C"           # Red
  )
  
  # Create base plot
  p <- ggplot(plot_data, aes(x = scenario_name, y = standardized_rmse, 
                              group = estimator_display, color = estimator_display)) +
    geom_line(size = 1.2) +
    geom_point(size = 3.5) +
    scale_color_manual(values = color_values, name = "Estimator") +
    labs(
      title = paste("Standardized RMSE -", ep_params$display_name, "Endpoint"),
      subtitle = paste("RMSE relative to 'Subgroup (no shrinkage)' for", ep_params$est_metric),
      y = "Standardized Overall RMSE",
      x = "Simulation Scenario"
    ) +
    theme_bw() +
    theme(
      plot.title = element_text(face = "bold", size = title_size),
      plot.subtitle = element_text(size = title_size - 3),
      axis.title = element_text(size = title_size - 3),
      axis.text.x = element_text(size = title_size - 5),
      legend.title = element_text(face = "bold", size = title_size - 4),
      legend.text = element_text(size = title_size - 5),
      legend.position = "bottom",
      panel.grid.minor = element_blank()
    ) +
    guides(
      color = guide_legend(ncol = 2, override.aes = list(size = 2))
    )
  
  return(p)
}

# Function to create combined faceted RMSE plot for all endpoints
create_rmse_facet_plot <- function(performance_list, endpoint_results, reference_estimator = "subgroup") {
  
  # Combine all endpoint data
  combined_data <- bind_rows(
    lapply(names(performance_list), function(ep) {
      performance_df <- performance_list[[ep]] %>% 
        filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name))
      
      # Baseline RMSE
      baseline_rmse <- performance_df %>%
        filter(estimator_name == reference_estimator) %>%
        dplyr::select(scenario_no, rmse_baseline = rmse)
      
      # Calculate standardized RMSE and add endpoint label
      performance_df %>%
        left_join(baseline_rmse, by = "scenario_no") %>%
        mutate(
          standardized_rmse = rmse / rmse_baseline,
          endpoint = endpoint_results[[ep]]$params$display_name
        )
    })
  )
  
  # Scenario labels
  scenario_labels <- c(
    `1` = "Positive\n(homogeneous)",
    `2` = "Positive\n(except 1 subgroup)",
    `3` = "Negative\n(except 1 subgroup)",
    `4` = "Mild\nheterogeneity",
    `5` = "Strong\nheterogeneity",
    `6` = "Misspecified"
  )
  
  # Prepare plot data
  plot_data <- combined_data %>%
    mutate(
      scenario_name = factor(scenario_no, levels = names(scenario_labels), 
                            labels = scenario_labels),
      endpoint = factor(endpoint, levels = c("Time-to-Event (TTE)", "Binary", "Count", "Continuous"))
    )
  
  # Define color palette
  color_values <- c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )
  
  # Create faceted plot
  p <- ggplot(plot_data, aes(x = scenario_name, y = standardized_rmse, 
                              group = estimator_display, color = estimator_display)) +
    geom_line(size = 1.0) +
    geom_point(size = 2.5) +
    facet_wrap(~ endpoint, ncol = 2, scales = "free_y") +
    scale_color_manual(values = color_values, name = "Estimator") +
    labs(
      title = "Standardized RMSE Across All Endpoints",
      subtitle = "RMSE relative to 'Subgroup (no shrinkage)'",
      y = "Standardized Overall RMSE",
      x = "Simulation Scenario"
    ) +
    theme_bw() +
    theme(
      plot.title = element_text(face = "bold", size = 16),
      plot.subtitle = element_text(size = 13),
      axis.title = element_text(size = 12),
      axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
      strip.text = element_text(size = 12, face = "bold"),
      legend.title = element_text(face = "bold", size = 11),
      legend.text = element_text(size = 10),
      legend.position = "bottom",
      panel.grid.minor = element_blank()
    ) +
    guides(
      color = guide_legend(ncol = 3, override.aes = list(size = 3))
    )
  
  return(p)
}

# Function to create combined faceted RMSE plot (non-standardized) for all endpoints
create_rmse_facet_plot_raw <- function(performance_list, endpoint_results) {
  
  # Combine all endpoint data (without standardization)
  combined_data <- bind_rows(
    lapply(names(performance_list), function(ep) {
      performance_df <- performance_list[[ep]] %>% 
        filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name))
      
      # Add endpoint label
      performance_df %>%
        mutate(
          endpoint = endpoint_results[[ep]]$params$display_name
        )
    })
  )
  
  # Scenario labels
  scenario_labels <- c(
    `1` = "Positive\n(homogeneous)",
    `2` = "Positive\n(except 1 subgroup)",
    `3` = "Negative\n(except 1 subgroup)",
    `4` = "Mild\nheterogeneity",
    `5` = "Strong\nheterogeneity",
    `6` = "Misspecified"
  )
  
  # Prepare plot data
  plot_data <- combined_data %>%
    mutate(
      scenario_name = factor(scenario_no, levels = names(scenario_labels), 
                            labels = scenario_labels),
      endpoint = factor(endpoint, levels = c("Time-to-Event (TTE)", "Binary", "Count", "Continuous"))
    )
  
  # Define color palette
  color_values <- c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "GM - Normal Hierarchical" = "#E78AC3",
    "OVAT - Hierarchical" = "#E41A1C"
  )
  
  # Create faceted plot
  p <- ggplot(plot_data, aes(x = scenario_name, y = rmse, 
                              group = estimator_display, color = estimator_display)) +
    geom_line(size = 1.0) +
    geom_point(size = 2.5) +
    facet_wrap(~ endpoint, ncol = 1, scales = "free_y") +
    scale_color_manual(values = color_values, name = "Estimator") +
    labs(
      title = "RMSE Across All Endpoints",
      subtitle = "Root Mean Squared Error (non-standardized)",
      y = "Overall RMSE",
      x = "Simulation Scenario"
    ) +
    theme_bw() +
    theme(
      plot.title = element_text(face = "bold", size = 16),
      plot.subtitle = element_text(size = 13),
      axis.title = element_text(size = 12),
      axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
      strip.text = element_text(size = 12, face = "bold"),
      legend.title = element_text(face = "bold", size = 11),
      legend.text = element_text(size = 10),
      legend.position = "bottom",
      panel.grid.minor = element_blank()
    ) +
    guides(
      color = guide_legend(ncol = 3, override.aes = list(size = 3))
    )
  
  return(p)
}

# Function to create combined faceted Bias plot for all endpoints
create_bias_facet_plot <- function(performance_list, endpoint_results) {
  
  # Combine all endpoint data
  combined_data <- bind_rows(
    lapply(names(performance_list), function(ep) {
      performance_df <- performance_list[[ep]] %>% 
        filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name))
      
      # Add endpoint label and calculate absolute bias
      performance_df %>%
        mutate(
          abs_bias = abs(bias),
          endpoint = endpoint_results[[ep]]$params$display_name
        )
    })
  )
  
  # Scenario labels
  scenario_labels <- c(
    `1` = "Positive\n(homogeneous)",
    `2` = "Positive\n(except 1 subgroup)",
    `3` = "Negative\n(except 1 subgroup)",
    `4` = "Mild\nheterogeneity",
    `5` = "Strong\nheterogeneity",
    `6` = "Misspecified"
  )
  
  # Prepare plot data
  plot_data <- combined_data %>%
    mutate(
      scenario_name = factor(scenario_no, levels = names(scenario_labels), 
                            labels = scenario_labels),
      endpoint = factor(endpoint, levels = c("Time-to-Event (TTE)", "Binary", "Count", "Continuous"))
    )
  
  # Define color palette
  color_values <- c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "GM - Normal Hierarchical" = "#E78AC3",
    "OVAT - Hierarchical" = "#E41A1C"
  )
  
  # Create faceted plot
  p <- ggplot(plot_data, aes(x = scenario_name, y = abs_bias, 
                              group = estimator_display, color = estimator_display)) +
    geom_line(size = 1.0) +
    geom_point(size = 2.5) +
    facet_wrap(~ endpoint, ncol = 1, scales = "free_y") +
    scale_color_manual(values = color_values, name = "Estimator") +
    labs(
      title = "Absolute Bias Across All Endpoints",
      subtitle = "Average absolute bias in treatment effect estimation",
      y = "Absolute Bias",
      x = "Simulation Scenario"
    ) +
    theme_bw() +
    theme(
      plot.title = element_text(face = "bold", size = 16),
      plot.subtitle = element_text(size = 13),
      axis.title = element_text(size = 12),
      axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
      strip.text = element_text(size = 12, face = "bold"),
      legend.title = element_text(face = "bold", size = 11),
      legend.text = element_text(size = 10),
      legend.position = "bottom",
      panel.grid.minor = element_blank()
    ) +
    guides(
      color = guide_legend(ncol = 3, override.aes = list(size = 3))
    )
  
  return(p)
}

# Function to create comparison plot: Subgroup vs R2D2 variants
create_r2d2_comparison_plot <- function(performance_list, endpoint_results, reference_estimator = "subgroup") {
  
  # Combine performance data from all endpoints
  combined_data <- bind_rows(
    lapply(names(performance_list), function(ep) {
      performance_df <- performance_list[[ep]] %>%
        filter(
          estimator_name %in% c("subgroup", "Global_r2d2_mid", "Global_r2d2_mid_unshrunk_x4")
        )
      
      # Calculate baseline RMSE for standardization
      baseline_rmse <- performance_df %>%
        filter(estimator_name == reference_estimator) %>%
        dplyr::select(scenario_no, rmse_baseline = rmse)
      
      # Standardize RMSE
      performance_df %>%
        left_join(baseline_rmse, by = "scenario_no") %>%
        mutate(
          standardized_rmse = rmse / rmse_baseline,
          endpoint = endpoint_results[[ep]]$params$display_name
        ) 
    })
  )
  
  # Scenario labels
  scenario_labels <- c(
    `1` = "Positive\n(homogeneous)",
    `2` = "Positive\n(except 1 subgroup)",
    `3` = "Negative\n(except 1 subgroup)",
    `4` = "Mild\nheterogeneity",
    `5` = "Strong\nheterogeneity",
    `6` = "Misspecified"
  )
  
  # Prepare plot data
  plot_data <- combined_data %>%
    mutate(
      scenario_name = factor(scenario_no, levels = names(scenario_labels), 
                            labels = scenario_labels),
      endpoint = factor(endpoint, levels = c("Time-to-Event (TTE)", "Binary", "Count", "Continuous"))
    ) 
  
  # Define color palette for these three estimators
  color_values <- c(
    "Subgroup (no shrinkage)" = "#FF7F00",        # Orange
    "GM - R2D2 (Mid)" = "#31A354",                # Medium green
    "GM - R2D2 (Mid, unshrunk×4)" = "#006D2C"     # Dark green
  )
  
  # Create faceted plot
  p <- ggplot(plot_data, aes(x = scenario_name, y = standardized_rmse, 
                              group = estimator_display, color = estimator_display)) +
    geom_line(size = 1.2) +
    geom_point(size = 3) +
    facet_wrap(~ endpoint, ncol = 1, scales = "free_y") +
    scale_color_manual(values = color_values, name = "Estimator") +
    labs(
      title = "Standardized RMSE Comparison: R2D2 Variants vs Subgroup Estimator",
      subtitle = "Effect of unshrinking x4 interactions in R2D2 Mid prior",
      y = "Standardized RMSE",
      x = "Simulation Scenario"
    ) +
    theme_bw() +
    theme(
      plot.title = element_text(face = "bold", size = 16),
      plot.subtitle = element_text(size = 13),
      axis.title = element_text(size = 12),
      axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
      strip.text = element_text(size = 12, face = "bold"),
      legend.title = element_text(face = "bold", size = 11),
      legend.text = element_text(size = 10),
      legend.position = "bottom",
      panel.grid.minor = element_blank()
    ) +
    guides(
      color = guide_legend(ncol = 1, override.aes = list(size = 3))
    )
  
  return(p)
}

# Function to calculate subgroup performance
calculate_subgroup_performance <- function(merged_df_with_pop, endpoint_id) {
  
  subgroupPerformance <- merged_df_with_pop %>%
    group_by(scenario_no, join_key, estimator_name) %>%
    summarize(
      truth_log = first(truth_log),
      truth_exp = first(truth_exp),
      truth_population_log = first(truth_population_log),
      bias = mean(estimate_log - truth_log, na.rm = TRUE),
      RMSE = sqrt(mean((estimate_log - truth_log)^2, na.rm = TRUE)),
      coverage = mean((truth_log >= ci_lower) & (truth_log <= ci_up), na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(
      threshold = if (endpoint_id == "continuous") 0.1 else log(1.1),
      heterogeneous = (abs(truth_log - truth_population_log) > threshold),
      estimator_display = beautify_estimator_name(estimator_name),
      model_type = get_model_type(estimator_name)
    ) %>%
    dplyr::select(-threshold)
  
  # Replace NaN with NA
  subgroupPerformance %>%
    mutate(coverage = if_else(is.nan(coverage), NA_real_, coverage))
}

# Helper display functions
display <- function(x, digits = 2) {
  formatC(x, format = "f", digits = digits)
}

getPercentage <- function(x, digits = 0) {
  val <- 100 * x
  ifelse(is.na(val), "NA",
    paste(formatC(val, digits = digits, format = "f"), "%", sep = "")
  )
}

# Function to analyze heterogeneous subgroup identification (Scenario 2)
analyze_heterogeneous_identification <- function(merged_df, endpoint_id) {
  
  # Filter for scenario 2
  scenario2_data <- merged_df %>%
    filter(scenario_no == "2")
  
  # For each replication and estimator, identify which subgroup has the most extreme estimate
  identification_results <- scenario2_data %>%
    group_by(replication_id, estimator_name) %>%
    mutate(
      # Find the most extreme estimate (farthest from 0 in absolute terms)
      abs_estimate = abs(estimate_log),
      is_most_extreme = abs_estimate == max(abs_estimate, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    # Check if x4a subgroups (4aa, 4ab) was correctly identified
    filter(grepl("^4a", join_key)) %>%  # x4a subgroups only (4aa, 4ab)
    group_by(replication_id, estimator_name) %>%
    summarize(
      correctly_identified = any(is_most_extreme),
      .groups = 'drop'
    )
  
  # Calculate identification rate, bias, and coverage ONLY for x4a subgroups
  summary_stats <- scenario2_data %>%
    filter(grepl("^4a", join_key)) %>%  # x4a subgroups only (4aa, 4ab)
    left_join(identification_results, by = c("replication_id", "estimator_name")) %>%
    group_by(estimator_name) %>%
    summarize(
      identification_rate = mean(correctly_identified, na.rm = TRUE),
      x4a_bias = mean(estimate_log - truth_log, na.rm = TRUE),
      x4a_abs_bias = mean(abs(estimate_log - truth_log), na.rm = TRUE),
      x4a_coverage = mean((truth_log >= ci_lower) & (truth_log <= ci_up), na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(
      estimator_display = beautify_estimator_name(estimator_name)
    ) %>%
    filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name)) %>%
    arrange(desc(identification_rate))
  
  return(summary_stats)
}

# Function to create forest plot for Scenario 2 showing coverage issues
create_scenario2_forest_plot <- function(merged_data, endpoint_name = "TTE") {
  
  # First check what data we have
  scenario2_all <- merged_data %>%
    filter(as.character(scenario_no) == "2" | scenario_no == 2)
  
  # Get available estimators and filter to the ones we want
  # For OVAT, include any OVAT variant
  scenario2_data <- scenario2_all %>%
    filter(
      estimator_name %in% c("population", "subgroup", "Global_r2d2_mid") |
      grepl("^OVAT_", estimator_name)
    ) %>%
    # For OVAT, consolidate to single name for plotting
    mutate(
      estimator_name = if_else(grepl("^OVAT_", estimator_name), "OVAT_1", estimator_name)
    ) %>%
    filter(grepl("^4a", join_key))  # Focus on x4=a subgroups (4aa, 4ab)
  
  # Calculate average estimates and CIs across replications
  plot_data <- scenario2_data %>%
    group_by(estimator_name, join_key, truth_log, truth_exp) %>%
    summarize(
      mean_estimate_log = mean(estimate_log, na.rm = TRUE),
      mean_estimate_exp = mean(exp(estimate_log), na.rm = TRUE),
      mean_ci_lower = mean(ci_lower, na.rm = TRUE),
      mean_ci_upper = mean(ci_up, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(
      estimator_display = beautify_estimator_name(estimator_name),
      subgroup_label = paste0("Subgroup ", join_key)
    )
  
  # Define color palette matching other plots
  color_values <- c(
    "Population (full shrinkage)" = "#5E3C99",    # Dark purple
    "Subgroup (no shrinkage)" = "#FF7F00",        # Orange
    "GM - R2D2 (Mid)" = "#31A354",                # Medium green
    "OVAT - Hierarchical" = "#E41A1C"             # Red
  )
  
  # Order estimators for plotting
  estimator_order <- c("Population (full shrinkage)", 
                       "Subgroup (no shrinkage)",
                       "GM - R2D2 (Mid)", 
                       "OVAT - Hierarchical")
  
  plot_data <- plot_data %>%
    mutate(estimator_display = factor(estimator_display, levels = estimator_order))
  
  # Create the forest plot (on exp scale for interpretability)
  p <- ggplot(plot_data, aes(x = mean_estimate_exp, y = estimator_display, 
                              color = estimator_display)) +
    geom_vline(xintercept = 1, linetype = "dashed", color = "gray50", size = 0.5) +
    geom_errorbarh(aes(xmin = exp(mean_ci_lower), xmax = exp(mean_ci_upper)), 
                   height = 0.2, size = 0.8) +
    geom_point(size = 3.5) +
    # Add truth marker with X
    geom_point(aes(x = truth_exp, y = estimator_display), 
               shape = 4, size = 4, color = "black", stroke = 2) +
    scale_color_manual(values = color_values, guide = "none") +
    facet_wrap(~ subgroup_label, ncol = 1) +
    labs(
      title = paste0("Coverage Issue in Scenario 2 - ", endpoint_name, " Endpoint"),
      subtitle = "Average estimates with 95% CI across 1000 replications. Black X = True effect",
      x = if(endpoint_name == "Continuous") "Mean Difference" else "Effect Ratio",
      y = NULL
    ) +
    theme_bw() +
    theme(
      plot.title = element_text(face = "bold", size = 14),
      plot.subtitle = element_text(size = 11),
      axis.title.x = element_text(size = 12),
      axis.text.y = element_text(size = 11, face = "bold"),
      axis.text.x = element_text(size = 10),
      strip.text = element_text(size = 11, face = "bold"),
      strip.background = element_rect(fill = "gray90"),
      panel.grid.minor = element_blank(),
      legend.position = "none"
    )
  
  # Add coordinate limits based on endpoint type
  if (endpoint_name != "Continuous") {
    p <- p + coord_cartesian(xlim = c(0.5, 1.5))
  }
  
  return(p)
}

# Function to create R2D2 comparison forest plot for a specific scenario
create_r2d2_forest_plot <- function(merged_data, scenario_num, endpoint_name = "TTE") {
  
  # Filter to specified scenario and R2D2 estimators + subgroup
  selected_estimators <- c("subgroup", "Global_r2d2_mid", "Global_r2d2_mid_unshrunk_x4")
  
  scenario_data <- merged_data %>%
    filter(
      as.character(scenario_no) == as.character(scenario_num) | scenario_no == scenario_num,
      estimator_name %in% selected_estimators
    )
  
  # Calculate average estimates and CIs across replications
  plot_data <- scenario_data %>%
    group_by(estimator_name, join_key, truth_log, truth_exp) %>%
    summarize(
      mean_estimate_log = mean(estimate_log, na.rm = TRUE),
      mean_estimate_exp = mean(exp(estimate_log), na.rm = TRUE),
      mean_ci_lower = mean(ci_lower, na.rm = TRUE),
      mean_ci_upper = mean(ci_up, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(
      estimator_display = beautify_estimator_name(estimator_name),
      subgroup_label = join_key
    )
  
  # Define color palette for R2D2 comparison
  color_values <- c(
    "Subgroup (no shrinkage)" = "#FF7F00",        # Orange
    "GM - R2D2 (Mid)" = "#31A354",                # Medium green
    "GM - R2D2 (Mid, unshrunk×4)" = "#006D2C"     # Dark green
  )
  
  # Order estimators for plotting
  estimator_order <- c("Subgroup (no shrinkage)",
                       "GM - R2D2 (Mid)", 
                       "GM - R2D2 (Mid, unshrunk×4)")
  
  plot_data <- plot_data %>%
    mutate(estimator_display = factor(estimator_display, levels = estimator_order))
  
  # Create the forest plot (on log scale to match the reference image)
  p <- ggplot(plot_data, aes(x = mean_estimate_log, y = subgroup_label, 
                              color = estimator_display)) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", size = 0.5) +
    geom_errorbarh(aes(xmin = mean_ci_lower, xmax = mean_ci_upper), 
                   height = 0.3, size = 0.8, position = position_dodge(width = 0.6)) +
    geom_point(size = 2.5, position = position_dodge(width = 0.6)) +
    # Add truth marker with X
    geom_point(aes(x = truth_log, y = subgroup_label), 
               shape = 4, size = 3, color = "black", stroke = 1.5) +
    scale_color_manual(values = color_values, name = "Estimator") +
    labs(
      title = paste0("Average Estimated Effect vs. Truth (Scenario ", scenario_num, ": Heterogeneity)"),
      subtitle = "Comparing shrinkage behavior across all subgroups. 'X' marks the truth.",
      x = "Log Treatment Effect",
      y = "Subgroup"
    ) +
    theme_bw() +
    theme(
      plot.title = element_text(face = "bold", size = 13),
      plot.subtitle = element_text(size = 10),
      axis.title = element_text(size = 11),
      axis.text.y = element_text(size = 9),
      axis.text.x = element_text(size = 9),
      legend.title = element_text(face = "bold", size = 10),
      legend.text = element_text(size = 9),
      legend.position = "bottom",
      panel.grid.minor = element_blank()
    ) +
    guides(
      color = guide_legend(nrow = 1)
    )
  
  return(p)
}

# Function to create performance table
create_performance_table <- function(subgroupPerformance, ep_params) {
  
  # Keep original copy so we can generate focused checks including unshrunk×4
  orig_subgroupPerformance <- subgroupPerformance

  # Filter out problematic estimators for the main summaries
  subgroupPerformance <- subgroupPerformance %>%
    filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name))
  
  # Summaries by estimator (use display names)
  sum_RMSEbias <- subgroupPerformance %>%
    group_by(estimator_display) %>%
    summarize(
      RMSE = paste(display(mean(RMSE, na.rm = TRUE), 2), " (", 
                   display(min(RMSE, na.rm = TRUE), 2), "-", 
                   display(max(RMSE, na.rm = TRUE), 2), ")", sep = ""),
      abs_bias = paste(display(mean(abs(bias), na.rm = TRUE), 2), " (", 
                       display(min(abs(bias), na.rm = TRUE), 2), "-", 
                       display(max(abs(bias), na.rm = TRUE), 2), ")", sep = "")
    ) %>%
    arrange(estimator_display)
  
  sum_coverage <- subgroupPerformance %>%
    group_by(estimator_display) %>%
    summarize(
      coverage = ifelse(
        all(is.na(coverage)), "NA",
        paste(getPercentage(mean(coverage, na.rm = TRUE)), " (", 
              getPercentage(min(coverage, na.rm = TRUE)), "-", 
              getPercentage(max(coverage, na.rm = TRUE)), ")", sep = "")
      )
    ) %>%
    arrange(estimator_display)
  
  # Summaries by heterogeneity
  sum_RMSEbias_het <- subgroupPerformance %>%
    group_by(heterogeneous, estimator_display) %>%
    summarize(
      RMSE = paste(display(mean(RMSE, na.rm = TRUE), 2), " (", 
                   display(min(RMSE, na.rm = TRUE), 2), "-", 
                   display(max(RMSE, na.rm = TRUE), 2), ")", sep = ""),
      abs_bias = paste(display(mean(abs(bias), na.rm = TRUE), 2), " (", 
                       display(min(abs(bias), na.rm = TRUE), 2), "-", 
                       display(max(abs(bias), na.rm = TRUE), 2), ")", sep = ""),
      .groups = 'drop'
    ) %>%
    arrange(estimator_display)
  
  sum_coverage_het <- subgroupPerformance %>%
    group_by(heterogeneous, estimator_display) %>%
    summarize(
      coverage = ifelse(
        all(is.na(coverage)), "NA",
        paste(getPercentage(mean(coverage, na.rm = TRUE)), " (", 
              getPercentage(min(coverage, na.rm = TRUE)), "-", 
              getPercentage(max(coverage, na.rm = TRUE)), ")", sep = "")
      ),
      .groups = 'drop'
    ) %>%
    arrange(estimator_display)
  
  # Get estimators
  estimator_names <- sort(unique(subgroupPerformance$estimator_display))
  estimator_rows <- paste("  ", estimator_names, sep = "")
  n_estimators <- length(estimator_names)
  
  estimators_with_coverage <- sum_coverage$estimator_display[sum_coverage$coverage != "NA"]
  estimator_rows_coverage <- paste("  ", estimators_with_coverage, sep = "")
  n_estimators_coverage <- length(estimators_with_coverage)
  
  # Assemble table (pad vectors to equal length to avoid mismatched lengths)
  criteria_vec <- c(
    "RMSE", estimator_rows,
    "Absolute bias", estimator_rows,
    "Coverage of 95% CI", estimator_rows_coverage
  )

  overall_vec <- c(
    " ", sum_RMSEbias$RMSE,
    " ", sum_RMSEbias$abs_bias,
    " ", sum_coverage$coverage[sum_coverage$coverage != "NA"]
  )

  homo_vec <- c(
    " ", with(sum_RMSEbias_het, RMSE[!heterogeneous]),
    " ", with(sum_RMSEbias_het, abs_bias[!heterogeneous]),
    " ", with(sum_coverage_het, coverage[!heterogeneous & coverage != "NA"])
  )

  het_vec <- c(
    " ", with(sum_RMSEbias_het, RMSE[heterogeneous]),
    " ", with(sum_RMSEbias_het, abs_bias[heterogeneous]),
    " ", with(sum_coverage_het, coverage[heterogeneous & coverage != "NA"])
  )

  pad_to <- length(criteria_vec)
  pad <- function(x, n) {
    x <- as.character(x)
    if (length(x) < n) length(x) <- n
    x[is.na(x)] <- ""
    x
  }

  r <- data.frame(
    Criterion = criteria_vec,
    overall = pad(overall_vec, pad_to),
    homo = pad(homo_vec, pad_to),
    het = pad(het_vec, pad_to),
    stringsAsFactors = FALSE
  )

  # --- Focused check: show RMSE, bias, coverage for subgroups 4a/4b/4c in scenarios 2 & 3 ---
  focus_keys <- c("4a", "4b", "4c")
  focus_scen <- c("2", "3")
  focus_estimators <- c("subgroup", "Global_r2d2_mid", "Global_r2d2_mid_unshrunk_x4")

  focus_table <- orig_subgroupPerformance %>%
    filter(scenario_no %in% focus_scen,
           join_key %in% focus_keys,
           estimator_name %in% focus_estimators) %>%
    arrange(scenario_no, join_key, estimator_name) %>%
    transmute(
      Scenario = scenario_no,
      Subgroup = join_key,
      Estimator = beautify_estimator_name(estimator_name),
      RMSE = round(RMSE, 3),
      Bias = round(bias, 3),
      Coverage = ifelse(is.na(coverage), NA, round(coverage, 3))
    )

  if (nrow(focus_table) > 0) {
    cat('\n### Focus: Subgroups 4a/4b/4c — Scenarios 2 & 3 (check unshrunk x4)\n\n')
    print(kable(focus_table, caption = paste('Focused metrics -', ep_params$display_name), digits = 3))
    cat('\n\n')
  }
  
  # Calculate footnotes
  n_scenarios <- n_distinct(subgroupPerformance$scenario_no)
  n_subgroups_per_scenario <- n_distinct(subgroupPerformance$join_key)
  total_subgroups <- n_scenarios * n_subgroups_per_scenario
  
  count_het <- subgroupPerformance %>%
    filter(estimator_name == estimator_names[1]) %>%
    group_by(scenario_no) %>%
    summarise(total_het = sum(heterogeneous))
  total_het <- sum(count_het$total_het)
  total_homo <- total_subgroups - total_het
  
  # Create table
  kbl(r,
    caption = paste("Performance Metrics for", ep_params$display_name, "Endpoint"),
    booktabs = TRUE,
    linesep = c(
      "", rep("", n_estimators),
      "\\addlinespace", rep("", n_estimators),
      "\\addlinespace", rep("", n_estimators_coverage)
    ),
    col.names = c("Criterion", "All subgroups", "Homogeneous", "Heterogeneous")
  ) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                  full_width = FALSE) %>%
    footnote(
      general = c(
        paste("Summary across", total_subgroups, "subgroups (", n_subgroups_per_scenario, 
              "subgroups ×", n_scenarios, "scenarios) including", total_homo, 
              "homogeneous and", total_het, "heterogeneous subgroups."),
        "Monte Carlo SE of estimated coverage ≈ 0.7% (1000 simulations, 95% true coverage)."
      ),
      general_title = ""
    )
}
```

---

# Analysis by Endpoint

```{r load_all_endpoints_2, results='hide'}
# Load all four endpoints
# Change this to load only specific endpoints if needed:
# endpoints <- c("continuous")  # Load only continuous
# endpoints <- c("tte", "binary", "count", "continuous")  # Load all
endpoints <- c("tte", "binary", "count", "continuous")
endpoint_results <- lapply(endpoints, load_endpoint_results)
names(endpoint_results) <- endpoints

# Calculate performance for all
performance_list <- lapply(endpoints, function(ep_id) {
  if (!is.null(endpoint_results[[ep_id]]) && !is.null(endpoint_results[[ep_id]]$merged_data)) {
    calculate_performance(endpoint_results[[ep_id]]$merged_data)
  } else {
    NULL
  }
})
names(performance_list) <- endpoints

subgroup_performance_list <- lapply(endpoints, function(ep_id) {
  if (!is.null(endpoint_results[[ep_id]]) && !is.null(endpoint_results[[ep_id]]$merged_data)) {
    calculate_subgroup_performance(endpoint_results[[ep_id]]$merged_data, ep_id)
  } else {
    NULL
  }
})
names(subgroup_performance_list) <- endpoints
```

```{r save_truth_data}
# ===== SAVE TRUTH COEFFICIENTS TO CSV =====

# Extract truth coefficients for all endpoints
truth_coefficients_list <- lapply(endpoints, function(ep) {
  merged_data <- endpoint_results[[ep]]$merged_data
  ep_params <- endpoint_results[[ep]]$params
  
  # Get unique truth values per scenario and subgroup
  truth_data <- merged_data %>%
    distinct(scenario_no, join_key, truth_log, truth_exp) %>%
    filter(!is.na(truth_log)) %>%
    mutate(
      endpoint = ep_params$display_name,
      metric = ep_params$est_metric
    ) %>%
    arrange(scenario_no, join_key)
  
  return(truth_data)
})

# Combine all endpoints
all_truth_coefficients <- bind_rows(truth_coefficients_list)

# Save to CSV in Results folder
output_file <- file.path(results_path, "truth_subgroup_coefficients.csv")
write.csv(all_truth_coefficients, 
          file = output_file, 
          row.names = FALSE)

message(paste("Truth subgroup coefficients saved to", output_file))

# ===== SAVE OVERALL TREATMENT EFFECTS TO CSV =====

# Extract overall treatment effects for all endpoints
overall_treatment_effects_list <- lapply(endpoints, function(ep) {
  merged_data <- endpoint_results[[ep]]$merged_data
  ep_params <- endpoint_results[[ep]]$params
  
  # Get unique population-level truth values per scenario
  overall_data <- merged_data %>%
    distinct(scenario_no, truth_population_log, truth_population_exp) %>%
    filter(!is.na(truth_population_log)) %>%
    mutate(
      endpoint = ep_params$display_name,
      metric = ep_params$est_metric,
      scenario = as.integer(scenario_no)
    ) %>%
    arrange(scenario) %>%
    dplyr::select(endpoint, metric, scenario, truth_population_log, truth_population_exp)
  
  return(overall_data)
})

# Combine all endpoints
all_overall_effects <- bind_rows(overall_treatment_effects_list)

# Save to CSV in Results folder
output_file <- file.path(results_path, "truth_overall_treatment_effects.csv")
write.csv(all_overall_effects, 
          file = output_file, 
          row.names = FALSE)

message(paste("Overall treatment effects saved to", output_file))

# Print summary
cat("\n=== Truth Data Export Summary ===\n")
cat("Subgroup coefficients: ", nrow(all_truth_coefficients), " rows\n")
cat("Overall treatment effects: ", nrow(all_overall_effects), " rows\n")
cat("Files saved in: simulations/Results/\n")
```

---

## Standardized RMSE Plots (All Endpoints Combined)

These plots show the Root Mean Squared Error (RMSE) standardized relative to the baseline "Subgroup (no shrinkage)" estimator across all six simulation scenarios.

```{r rmse_plots_all, fig.height=11.69, fig.width=8.27}
# Create faceted plot with shared legend
p <- create_rmse_facet_plot(performance_list, endpoint_results)
print(p)

# Save as PNG
ggsave(file.path(plots_path, "standardized_rmse_all_endpoints.png"), plot = p, 
       width = 10.3, height = 7.5, units = "in", dpi = 300)
```

**Interpretation:** Values below 1.0 indicate better performance than the baseline subgroup estimator. Lower values indicate better estimation accuracy.

---

## RMSE Plots (All Endpoints Combined, Non-Standardized)

These plots show the Root Mean Squared Error (RMSE) in absolute terms across all six simulation scenarios.

```{r rmse_plots_all_raw, fig.height=11.69, fig.width=8.27}
# Create faceted plot with raw RMSE values
p_raw <- create_rmse_facet_plot_raw(performance_list, endpoint_results)
print(p_raw)

# Save as PNG
ggsave(file.path(plots_path, "rmse_all_endpoints_raw.png"), plot = p_raw, 
       width = 8.27, height = 11.69, units = "in", dpi = 300)
```

**Interpretation:** Lower values indicate better estimation accuracy. Note that RMSE values are on different scales across endpoints due to different effect sizes and metrics (log hazard ratios for TTE, log odds ratios for Binary, log rate ratios for Count, and mean differences for Continuous).

---

## Absolute Bias Plots (All Endpoints Combined)

These plots show the average absolute bias in treatment effect estimation across all six simulation scenarios.

```{r bias_plots_all, fig.height=11.69, fig.width=8.27}
# Create faceted plot with absolute bias values
p_bias <- create_bias_facet_plot(performance_list, endpoint_results)
print(p_bias)

# Save as PNG
ggsave(file.path(plots_path, "absolute_bias_all_endpoints.png"), plot = p_bias, 
       width = 8.27, height = 11.69, units = "in", dpi = 300)
```

**Interpretation:** Lower values indicate more accurate estimates. Absolute bias measures the magnitude of estimation error regardless of direction (over- or underestimation).

---

## R2D2 Comparison: Unshrunk x4 Effect

This section compares the GM - R2D2 (Mid) estimator with its variant where x4 interactions are left unshrunk. The plot shows RMSE across scenarios to evaluate the impact of selective unshrinking.

```{r r2d2_comparison, fig.height=11.69, fig.width=8.27}
# Create comparison plot
performance_list<-performance_list[1]
p_r2d2 <- create_r2d2_comparison_plot(performance_list, endpoint_results)
print(p_r2d2)

# Save as PNG
ggsave(file.path(plots_path, "r2d2_comparison_unshrunk_x4.png"), plot = p_r2d2, 
       width = 7, height = 10, units = "in", dpi = 300)
```

```{r r2d2_focus_table, results='asis'}
# Focused table: RMSE, Bias, Coverage for subgroups 4a/4b/4c in scenarios 2 & 3
selected_estimators <- c("subgroup", "Global_r2d2_mid", "Global_r2d2_mid_unshrunk_x4")
focus_scen <- c("2", "3")
focus_keys <- c("4a", "4b", "4c")

focus_list <- lapply(names(endpoint_results), function(ep) {
  sp <- calculate_subgroup_performance(endpoint_results[[ep]]$merged_data, ep)
  df <- sp %>%
    filter(scenario_no %in% focus_scen,
           join_key %in% focus_keys,
           estimator_name %in% selected_estimators) %>%
    mutate(
      Endpoint = endpoint_results[[ep]]$params$display_name,
      Estimator = beautify_estimator_name(estimator_name),
      RMSE = round(RMSE, 3),
      Bias = round(bias, 3),
      Coverage = ifelse(is.na(coverage), NA, round(coverage, 3))
    ) %>%
    dplyr::select(Endpoint, scenario_no, join_key, Estimator, RMSE, Bias, Coverage) %>%
    rename(Scenario = scenario_no, Subgroup = join_key)

  df
})

focus_df <- bind_rows(focus_list)

if (nrow(focus_df) == 0) {
  cat("No matching rows found for focused R2D2 comparison.\n")
} else {
  focus_df <- focus_df %>% arrange(Endpoint, Scenario, Subgroup, Estimator)
  print(kable(focus_df, caption = "R2D2 focus: RMSE/Bias/Coverage for subgroups 4a-4c (Scenarios 2 & 3)") %>%
          kable_styling(full_width = FALSE, bootstrap_options = c("striped","condensed")))
}
```

**Interpretation:** 
- **Subgroup (orange)**: Baseline with no shrinkage, highest RMSE due to noise
- **GM - R2D2 Mid (medium green)**: Standard R2D2 with shrinkage on all interactions
- **GM - R2D2 Mid, unshrunk×4 (dark green)**: Selective unshrinking of x4 interactions to preserve heterogeneity signal

Compare performance in Scenario 2 (heterogeneous in x4) vs other scenarios to evaluate the benefit of selective unshrinking.

### Forest Plot: Scenario 3 - R2D2 Comparison

Scenario 3 has heterogeneity in x4 subgroups (negative treatment effect except for one subgroup). This forest plot compares the three estimators in capturing this heterogeneous pattern.

```{r r2d2_forest_scen3, fig.width=8, fig.height=6}
# Only create TTE forest plot if TTE endpoint was loaded
if ("tte" %in% names(endpoint_results)) {
  forest_r2d2_scen3 <- create_r2d2_forest_plot(endpoint_results$tte$merged_data, scenario_num = 3, "TTE")
  print(forest_r2d2_scen3)
  
  # Save plot
  ggsave(file.path(plots_path, "forest_scenario3_r2d2_comparison.png"), plot = forest_r2d2_scen3, 
         width = 8, height = 6, dpi = 300, bg = "white")
} else {
  cat("TTE endpoint not loaded. Skipping R2D2 forest plot.\n")
}
```

**Interpretation:**
- **Subgroup (orange)**: No shrinkage, captures heterogeneity but with wide intervals
- **GM - R2D2 Mid (medium green)**: Applies shrinkage to all interactions, may partially shrink the signal
- **GM - R2D2 Mid, unshrunk×4 (dark green)**: Preserves x4 heterogeneity by not shrinking x4 interactions

The plot shows whether unshrinking x4 interactions helps preserve the heterogeneous treatment effect while maintaining reasonable interval widths.

---

## Standardized RMSE Plots by Endpoint

Individual plots for each endpoint with enhanced visibility.

### Time-to-Event (TTE) Endpoint

```{r rmse_tte, fig.height=6, fig.width=14}
if ("tte" %in% names(endpoint_results)) {
  create_rmse_plot(performance_list$tte, endpoint_results$tte$params, 
                   use_shapes = TRUE, title_size = 16)
} else {
  cat("TTE endpoint not loaded.\n")
}
```

---

### Binary Endpoint

```{r rmse_binary, fig.height=6, fig.width=14}
if ("binary" %in% names(endpoint_results)) {
  create_rmse_plot(performance_list$binary, endpoint_results$binary$params, 
                   use_shapes = TRUE, title_size = 16)
} else {
  cat("Binary endpoint not loaded.\n")
}
```

---

### Count Endpoint

```{r rmse_count, fig.height=6, fig.width=14}
if ("count" %in% names(endpoint_results)) {
  create_rmse_plot(performance_list$count, endpoint_results$count$params, 
                   use_shapes = TRUE, title_size = 16)
} else {
  cat("Count endpoint not loaded.\n")
}
```

---

### Continuous Endpoint

```{r rmse_continuous, fig.height=6, fig.width=14}
if ("continuous" %in% names(endpoint_results)) {
  create_rmse_plot(performance_list$continuous, endpoint_results$continuous$params, 
                   use_shapes = TRUE, title_size = 16)
} else {
  cat("Continuous endpoint not loaded.\n")
}
```
---

# Analysis by Endpoint

```{r load_all_endpoints, results='hide'}
# Load all four endpoints
endpoints <- c("tte", "binary", "count", "continuous")
endpoint_results <- lapply(endpoints, load_endpoint_results)
names(endpoint_results) <- endpoints

# Calculate performance for all
performance_list <- lapply(endpoint_results, function(ep) {
  calculate_performance(ep$merged_data)
})

subgroup_performance_list <- lapply(endpoints, function(ep_id) {
  calculate_subgroup_performance(endpoint_results[[ep_id]]$merged_data, ep_id)
})
names(subgroup_performance_list) <- endpoints
```

---

## Standardized RMSE Plots (All Endpoints)

These plots show the Root Mean Squared Error (RMSE) standardized relative to the baseline "subgroup (no shrinkage)" estimator across all six simulation scenarios.

```{r rmse_plots_all_grid, fig.height=10, fig.width=14}
# Create all RMSE plots
rmse_plots <- lapply(endpoints, function(ep) {
  create_rmse_plot(performance_list[[ep]], endpoint_results[[ep]]$params)
})

# Arrange in 2x2 grid
grid.arrange(grobs = rmse_plots, ncol = 2, nrow = 2,
             top = textGrob("Standardized RMSE Across All Endpoints", 
                           gp = gpar(fontsize = 16, fontface = "bold")))
```

**Interpretation:** Values below 1.0 indicate better performance than the baseline subgroup estimator. Lower values indicate better estimation accuracy.

---

## Coverage Issues in Scenario 2 - Forest Plots

This section illustrates the undercoverage problem in heterogeneous subgroups (Scenario 2). The plots show average treatment effect estimates with 95% credible intervals for subgroups 4aa and 4ab (where x4=a), which deviate from the overall positive treatment effect. The black 'X' marks the true effect.

### Time-to-Event (TTE) Endpoint

```{r forest_scen2_tte, fig.width=8, fig.height=6}
if ("tte" %in% names(endpoint_results)) {
  forest_tte <- create_scenario2_forest_plot(endpoint_results$tte$merged_data, "TTE")
  print(forest_tte)
  
  # Save plot
  ggsave(file.path(plots_path, "forest_scenario2_tte.png"), plot = forest_tte, 
         width = 8, height = 6, dpi = 300, bg = "white")
} else {
  cat("TTE endpoint not loaded.\n")
}
```

### Binary Endpoint

```{r forest_scen2_binary, fig.width=8, fig.height=6}
if ("binary" %in% names(endpoint_results)) {
  forest_binary <- create_scenario2_forest_plot(endpoint_results$binary$merged_data, "Binary")
  print(forest_binary)
  
  # Save plot
  ggsave(file.path(plots_path, "forest_scenario2_binary.png"), plot = forest_binary, 
         width = 8, height = 6, dpi = 300, bg = "white")
} else {
  cat("Binary endpoint not loaded.\n")
}
```

### Count Endpoint

```{r forest_scen2_count, fig.width=8, fig.height=6}
if ("count" %in% names(endpoint_results)) {
  forest_count <- create_scenario2_forest_plot(endpoint_results$count$merged_data, "Count")
  print(forest_count)
  
  # Save plot
  ggsave(file.path(plots_path, "forest_scenario2_count.png"), plot = forest_count, 
         width = 8, height = 6, dpi = 300, bg = "white")
} else {
  cat("Count endpoint not loaded.\n")
}
```

### Continuous Endpoint

```{r forest_scen2_continuous, fig.width=8, fig.height=6}
if ("continuous" %in% names(endpoint_results)) {
  forest_continuous <- create_scenario2_forest_plot(endpoint_results$continuous$merged_data, "Continuous")
  print(forest_continuous)
  
  # Save plot
  ggsave(file.path(plots_path, "forest_scenario2_continuous.png"), plot = forest_continuous, 
         width = 8, height = 6, dpi = 300, bg = "white")
} else {
  cat("Continuous endpoint not loaded.\n")
}
```

**Interpretation:** 

- **Population estimator (purple)**: Completely shrinks estimates toward the population mean, missing the heterogeneity signal. Credible intervals are narrow but fail to cover the truth (extreme undercoverage ~54%).

- **Subgroup estimator (orange)**: Correctly captures the heterogeneity with estimates close to the truth. Maintains nominal coverage (~95%) but has wider intervals.

- **GM - R2D2 Mid (green)**: Applies partial shrinkage, improving precision while still capturing most of the heterogeneity signal. Coverage drops to 80-90% in these outlier subgroups but avoids the extreme undercoverage of the population estimator.

- **OVAT - Hierarchical (red)**: Similar to subgroup estimator with nominal coverage, using hierarchical priors to stabilize estimates.

---

## Heterogeneous Subgroup Identification (Scenario 2)

This section analyzes how well each estimator identifies the heterogeneous subgroup (x4) in Scenario 2, where one subgroup has a different treatment effect.

### Time-to-Event (TTE) Endpoint

```{r heterogeneous_id_tte}
het_id_tte <- analyze_heterogeneous_identification(endpoint_results$tte$merged_data, "tte")

kbl(het_id_tte %>% dplyr::select(estimator_display, identification_rate, x4a_abs_bias, x4a_coverage),
    caption = "Heterogeneous Subgroup Identification - TTE Endpoint (Scenario 2)",
    col.names = c("Estimator", "Identification Rate", "Absolute Bias (x4a)", "Coverage (x4a)"),
    digits = 3,
    booktabs = TRUE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE) %>%
  footnote(
    general = "Identification Rate: Proportion of replications where x4a subgroups (x4=a) had the most extreme estimate. Bias and coverage computed only for x4a subgroups. Based on 1000 replications.",
    general_title = ""
  )
```

---

### Binary Endpoint

```{r heterogeneous_id_binary}
het_id_binary <- analyze_heterogeneous_identification(endpoint_results$binary$merged_data, "binary")

kbl(het_id_binary %>% dplyr::select(estimator_display, identification_rate, x4a_abs_bias, x4a_coverage),
    caption = "Heterogeneous Subgroup Identification - Binary Endpoint (Scenario 2)",
    col.names = c("Estimator", "Identification Rate", "Absolute Bias (x4a)", "Coverage (x4a)"),
    digits = 3,
    booktabs = TRUE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE) %>%
  footnote(
    general = "Identification Rate: Proportion of replications where x4a subgroups (x4=a) had the most extreme estimate. Bias and coverage computed only for x4a subgroups. Based on 1000 replications.",
    general_title = ""
  )
```

---

### Count Endpoint

```{r heterogeneous_id_count}
het_id_count <- analyze_heterogeneous_identification(endpoint_results$count$merged_data, "count")

kbl(het_id_count %>% dplyr::select(estimator_display, identification_rate, x4a_abs_bias, x4a_coverage),
    caption = "Heterogeneous Subgroup Identification - Count Endpoint (Scenario 2)",
    col.names = c("Estimator", "Identification Rate", "Absolute Bias (x4a)", "Coverage (x4a)"),
    digits = 3,
    booktabs = TRUE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE) %>%
  footnote(
    general = "Identification Rate: Proportion of replications where x4a subgroups (x4=a) had the most extreme estimate. Bias and coverage computed only for x4a subgroups. Based on 1000 replications.",
    general_title = ""
  )
```

---

### Continuous Endpoint

```{r heterogeneous_id_continuous}
het_id_continuous <- analyze_heterogeneous_identification(endpoint_results$continuous$merged_data, "continuous")

kbl(het_id_continuous %>% dplyr::select(estimator_display, identification_rate, x4a_abs_bias, x4a_coverage),
    caption = "Heterogeneous Subgroup Identification - Continuous Endpoint (Scenario 2)",
    col.names = c("Estimator", "Identification Rate", "Absolute Bias (x4a)", "Coverage (x4a)"),
    digits = 3,
    booktabs = TRUE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE) %>%
  footnote(
    general = "Identification Rate: Proportion of replications where x4a subgroups (x4=a) had the most extreme estimate. Bias and coverage computed only for x4a subgroups. Based on 1000 replications.",
    general_title = ""
  )
```

---

## Performance Tables (All Endpoints)

The following tables present RMSE, absolute bias, and coverage of 95% confidence/credible intervals for all estimators, stratified by subgroup heterogeneity.

### Time-to-Event (TTE) Endpoint

```{r table_tte}
if ("tte" %in% names(endpoint_results)) {
  create_performance_table(subgroup_performance_list$tte, endpoint_results$tte$params)
} else {
  cat("TTE endpoint not loaded.\n")
}
```

---

### Binary Endpoint

```{r table_binary}
if ("binary" %in% names(endpoint_results)) {
  create_performance_table(subgroup_performance_list$binary, endpoint_results$binary$params)
} else {
  cat("Binary endpoint not loaded.\n")
}
```

---

### Count Endpoint

```{r table_count}
if ("count" %in% names(endpoint_results)) {
  create_performance_table(subgroup_performance_list$count, endpoint_results$count$params)
} else {
  cat("Count endpoint not loaded.\n")
}
```

---

### Continuous Endpoint

```{r table_continuous}
if ("continuous" %in% names(endpoint_results)) {
  create_performance_table(subgroup_performance_list$continuous%>%filter(estimator_name=="Global_full_hierarchical"), endpoint_results$continuous$params)
} else {
  cat("Continuous endpoint not loaded.\n")
}
```

---

# Additional TTE-Specific Visualizations

This section provides extra exploratory plots for the Time-to-Event endpoint.

## RMSE Distribution by Subgroup (TTE, Scenario 3)

```{r tte_rmse_by_subgroup, fig.width=12, fig.height=6}
tte_subgroup_perf <- subgroup_performance_list$tte %>%
  filter(scenario_no == 3, !grepl("r2d2_mid_unshrunk_x4", estimator_name))

ggplot(tte_subgroup_perf, 
       aes(x = RMSE, y = fct_rev(join_key), color = estimator_display)) +
  geom_jitter(size = 3, width = 0, height = 0.2) + 
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  theme_bw() +
  theme(text = element_text(size = 12),
        legend.position = "bottom") +
  labs(
    title = "RMSE Distribution by Subgroup (TTE, Scenario 3)",
    subtitle = "Negative treatment effect (except 1 subgroup)",
    y = "Subgroup",
    x = "Root Mean Squared Error",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))
} else {
  cat("TTE endpoint data not available for RMSE by subgroup plot.\n")
}
```

---

## RMSE Across All Scenarios (TTE)

```{r tte_rmse_all_scenarios, fig.width=14, fig.height=10}
if (!is.null(subgroup_performance_list$tte)) {
  tte_subgroup_perf_all <- subgroup_performance_list$tte %>%
    filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name))

scenario_labels <- c(
  `1` = "Scenario 1: Positive (homogeneous)",
  `2` = "Scenario 2: Positive (except 1 subgroup)",
  `3` = "Scenario 3: Negative (except 1 subgroup)",
  `4` = "Scenario 4: Mild heterogeneity",
  `5` = "Scenario 5: Strong heterogeneity",
  `6` = "Scenario 6: Misspecified"
)

ggplot(tte_subgroup_perf_all, 
       aes(x = RMSE, y = fct_rev(join_key), color = estimator_display)) +
  geom_jitter(size = 2.5, width = 0, height = 0.2, alpha = 0.7) + 
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  facet_wrap(~scenario_no, nrow = 2, labeller = as_labeller(scenario_labels)) +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 10)) +
  labs(
    title = "RMSE Distribution Across All Scenarios (TTE Endpoint)",
    y = "Subgroup",
    x = "Root Mean Squared Error",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))

# Save RMSE plot
ggsave(file.path(plots_path, "tte_rmse_all_scenarios.png"), width = 14, height = 10, dpi = 300, bg = "white")
} else {
  cat("TTE endpoint data not available for RMSE across all scenarios plot.\n")
}
```

---

## Bias Across All Scenarios (TTE)

```{r tte_bias_all_scenarios, fig.width=14, fig.height=10}
if (!is.null(subgroup_performance_list$tte)) {
  tte_subgroup_perf_all <- subgroup_performance_list$tte %>%
    filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name))
  
ggplot(tte_subgroup_perf_all, 
       aes(x = abs(bias), y = fct_rev(join_key), color = estimator_display)) +
  geom_jitter(size = 2.5, width = 0, height = 0.2, alpha = 0.7) + 
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  facet_wrap(~scenario_no, nrow = 2, labeller = as_labeller(scenario_labels)) +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 10)) +
  labs(
    title = "Absolute Bias Distribution Across All Scenarios (TTE Endpoint)",
    y = "Subgroup",
    x = "Absolute Bias",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))

# Save Bias plot
ggsave(file.path(plots_path, "tte_bias_all_scenarios.png"), width = 14, height = 10, dpi = 300, bg = "white")
} else {
  cat("TTE endpoint data not available for bias plot.\n")
}
```

---

## Bias vs RMSE Scatter (TTE)

```{r tte_bias_rmse, fig.width=12, fig.height=8}
if (!is.null(subgroup_performance_list$tte)) {
  tte_summary <- subgroup_performance_list$tte %>%
    filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name)) %>%
    group_by(scenario_no, estimator_display) %>%
    summarize(
      mean_rmse = mean(RMSE, na.rm = TRUE),
      mean_abs_bias = mean(abs(bias), na.rm = TRUE),
      .groups = 'drop'
    )

ggplot(tte_summary, aes(x = mean_abs_bias, y = mean_rmse, 
                        color = estimator_display)) +
  geom_point(size = 4) +
  facet_wrap(~scenario_no, nrow = 2, labeller = as_labeller(scenario_labels)) +
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 10)) +
  labs(
    title = "Bias-RMSE Trade-off (TTE Endpoint)",
    subtitle = "Average across subgroups within each scenario",
    x = "Mean Absolute Bias",
    y = "Mean RMSE",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))
} else {
  cat("TTE endpoint data not available for bias vs RMSE scatter plot.\n")
}
```

---

## Coverage by Heterogeneity Status (TTE)

```{r tte_coverage, fig.width=12, fig.height=6}
if (!is.null(subgroup_performance_list$tte)) {
  tte_coverage_summary <- subgroup_performance_list$tte %>%
    filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name), !is.na(coverage)) %>%
    group_by(estimator_display, heterogeneous) %>%
    summarize(
      mean_coverage = mean(coverage, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(
      heterogeneity_status = ifelse(heterogeneous, "Heterogeneous", "Homogeneous")
    )

ggplot(tte_coverage_summary, aes(x = estimator_display, y = mean_coverage, 
                                 fill = heterogeneity_status)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_hline(yintercept = 0.95, linetype = "dashed", color = "red", size = 1) +
  scale_fill_brewer(palette = "Pastel1") +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom") +
  labs(
    title = "Coverage of 95% Credible/Confidence Intervals (TTE)",
    subtitle = "Dashed line indicates nominal 95% coverage",
    x = "Estimator",
    y = "Mean Coverage",
    fill = "Subgroup Type"
  )
} else {
  cat("TTE endpoint data not available for coverage plot.\n")
}
```

---

# Additional Binary Endpoint Visualizations

## RMSE Distribution by Subgroup (Binary, Scenario 3)

```{r binary_rmse_by_subgroup, fig.width=12, fig.height=6}
if (!is.null(subgroup_performance_list$binary)) {
  binary_subgroup_perf <- subgroup_performance_list$binary %>%
    filter(scenario_no == 3, !grepl("r2d2_mid_unshrunk_x4", estimator_name))

ggplot(binary_subgroup_perf, 
       aes(x = RMSE, y = fct_rev(join_key), color = estimator_display)) +
  geom_jitter(size = 3, width = 0, height = 0.2) + 
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  theme_bw() +
  theme(text = element_text(size = 12),
        legend.position = "bottom") +
  labs(
    title = "RMSE Distribution by Subgroup (Binary, Scenario 3)",
    subtitle = "Negative treatment effect (except 1 subgroup)",
    y = "Subgroup",
    x = "Root Mean Squared Error",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))
```

---

## RMSE Across All Scenarios (Binary)

```{r binary_rmse_all_scenarios, fig.width=14, fig.height=10}
binary_subgroup_perf_all <- subgroup_performance_list$binary %>%
  filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name))

ggplot(binary_subgroup_perf_all, 
       aes(x = RMSE, y = fct_rev(join_key), color = estimator_display)) +
  geom_jitter(size = 2.5, width = 0, height = 0.2, alpha = 0.7) + 
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  facet_wrap(~scenario_no, nrow = 2, labeller = as_labeller(scenario_labels)) +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 10)) +
  labs(
    title = "RMSE Distribution Across All Scenarios (Binary Endpoint)",
    y = "Subgroup",
    x = "Root Mean Squared Error",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))

# Save RMSE plot
ggsave(file.path(plots_path, "binary_rmse_all_scenarios.png"), width = 14, height = 10, dpi = 300, bg = "white")
```

---

## Bias Across All Scenarios (Binary)

```{r binary_bias_all_scenarios, fig.width=14, fig.height=10}
ggplot(binary_subgroup_perf_all, 
       aes(x = abs(bias), y = fct_rev(join_key), color = estimator_display)) +
  geom_jitter(size = 2.5, width = 0, height = 0.2, alpha = 0.7) + 
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  facet_wrap(~scenario_no, nrow = 2, labeller = as_labeller(scenario_labels)) +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 10)) +
  labs(
    title = "Absolute Bias Distribution Across All Scenarios (Binary Endpoint)",
    y = "Subgroup",
    x = "Absolute Bias",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))

# Save Bias plot
ggsave(file.path(plots_path, "binary_bias_all_scenarios.png"), width = 14, height = 10, dpi = 300, bg = "white")
```

---

## Bias vs RMSE Scatter (Binary)

```{r binary_bias_rmse, fig.width=12, fig.height=8}
binary_summary <- subgroup_performance_list$binary %>%
  filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name)) %>%
  group_by(scenario_no, estimator_display) %>%
  summarize(
    mean_rmse = mean(RMSE, na.rm = TRUE),
    mean_abs_bias = mean(abs(bias), na.rm = TRUE),
    .groups = 'drop'
  )

ggplot(binary_summary, aes(x = mean_abs_bias, y = mean_rmse, 
                        color = estimator_display)) +
  geom_point(size = 4) +
  facet_wrap(~scenario_no, nrow = 2, labeller = as_labeller(scenario_labels)) +
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 10)) +
  labs(
    title = "Bias-RMSE Trade-off (Binary Endpoint)",
    subtitle = "Average across subgroups within each scenario",
    x = "Mean Absolute Bias",
    y = "Mean RMSE",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))
```

---

## Coverage by Heterogeneity Status (Binary)

```{r binary_coverage, fig.width=12, fig.height=6}
binary_coverage_summary <- subgroup_performance_list$binary %>%
  filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name), !is.na(coverage)) %>%
  group_by(estimator_display, heterogeneous) %>%
  summarize(
    mean_coverage = mean(coverage, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    heterogeneity_status = ifelse(heterogeneous, "Heterogeneous", "Homogeneous")
  )

ggplot(binary_coverage_summary, aes(x = estimator_display, y = mean_coverage, 
                                 fill = heterogeneity_status)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_hline(yintercept = 0.95, linetype = "dashed", color = "red", size = 1) +
  scale_fill_brewer(palette = "Pastel1") +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom") +
  labs(
    title = "Coverage of 95% Credible/Confidence Intervals (Binary)",
    subtitle = "Dashed line indicates nominal 95% coverage",
    x = "Estimator",
    y = "Mean Coverage",
    fill = "Subgroup Type"
  )
```

---

# Additional Count Endpoint Visualizations

## RMSE Distribution by Subgroup (Count, Scenario 3)

```{r count_rmse_by_subgroup, fig.width=12, fig.height=6}
count_subgroup_perf <- subgroup_performance_list$count %>%
  filter(scenario_no == 3, !grepl("r2d2_mid_unshrunk_x4", estimator_name))

ggplot(count_subgroup_perf, 
       aes(x = RMSE, y = fct_rev(join_key), color = estimator_display)) +
  geom_jitter(size = 3, width = 0, height = 0.2) + 
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  theme_bw() +
  theme(text = element_text(size = 12),
        legend.position = "bottom") +
  labs(
    title = "RMSE Distribution by Subgroup (Count, Scenario 3)",
    subtitle = "Negative treatment effect (except 1 subgroup)",
    y = "Subgroup",
    x = "Root Mean Squared Error",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))
```

---

## RMSE Across All Scenarios (Count)

```{r count_rmse_all_scenarios, fig.width=14, fig.height=10}
count_subgroup_perf_all <- subgroup_performance_list$count %>%
  filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name))

ggplot(count_subgroup_perf_all, 
       aes(x = RMSE, y = fct_rev(join_key), color = estimator_display)) +
  geom_jitter(size = 2.5, width = 0, height = 0.2, alpha = 0.7) + 
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  facet_wrap(~scenario_no, nrow = 2, labeller = as_labeller(scenario_labels)) +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 10)) +
  labs(
    title = "RMSE Distribution Across All Scenarios (Count Endpoint)",
    y = "Subgroup",
    x = "Root Mean Squared Error",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))

# Save RMSE plot
ggsave(file.path(plots_path, "count_rmse_all_scenarios.png"), width = 14, height = 10, dpi = 300, bg = "white")
```

---

## Bias Across All Scenarios (Count)

```{r count_bias_all_scenarios, fig.width=14, fig.height=10}
ggplot(count_subgroup_perf_all, 
       aes(x = abs(bias), y = fct_rev(join_key), color = estimator_display)) +
  geom_jitter(size = 2.5, width = 0, height = 0.2, alpha = 0.7) + 
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  facet_wrap(~scenario_no, nrow = 2, labeller = as_labeller(scenario_labels)) +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 10)) +
  labs(
    title = "Absolute Bias Distribution Across All Scenarios (Count Endpoint)",
    y = "Subgroup",
    x = "Absolute Bias",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))

# Save Bias plot
ggsave(file.path(plots_path, "count_bias_all_scenarios.png"), width = 14, height = 10, dpi = 300, bg = "white")
```

---

## Bias vs RMSE Scatter (Count)

```{r count_bias_rmse, fig.width=12, fig.height=8}
count_summary <- subgroup_performance_list$count %>%
  filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name)) %>%
  group_by(scenario_no, estimator_display) %>%
  summarize(
    mean_rmse = mean(RMSE, na.rm = TRUE),
    mean_abs_bias = mean(abs(bias), na.rm = TRUE),
    .groups = 'drop'
  )

ggplot(count_summary, aes(x = mean_abs_bias, y = mean_rmse, 
                        color = estimator_display)) +
  geom_point(size = 4) +
  facet_wrap(~scenario_no, nrow = 2, labeller = as_labeller(scenario_labels)) +
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 10)) +
  labs(
    title = "Bias-RMSE Trade-off (Count Endpoint)",
    subtitle = "Average across subgroups within each scenario",
    x = "Mean Absolute Bias",
    y = "Mean RMSE",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))
```

---

## Coverage by Heterogeneity Status (Count)

```{r count_coverage, fig.width=12, fig.height=6}
count_coverage_summary <- subgroup_performance_list$count %>%
  filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name), !is.na(coverage)) %>%
  group_by(estimator_display, heterogeneous) %>%
  summarize(
    mean_coverage = mean(coverage, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    heterogeneity_status = ifelse(heterogeneous, "Heterogeneous", "Homogeneous")
  )

ggplot(count_coverage_summary, aes(x = estimator_display, y = mean_coverage, 
                                 fill = heterogeneity_status)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_hline(yintercept = 0.95, linetype = "dashed", color = "red", size = 1) +
  scale_fill_brewer(palette = "Pastel1") +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom") +
  labs(
    title = "Coverage of 95% Credible/Confidence Intervals (Count)",
    subtitle = "Dashed line indicates nominal 95% coverage",
    x = "Estimator",
    y = "Mean Coverage",
    fill = "Subgroup Type"
  )
```

---

# Additional Continuous Endpoint Visualizations

## RMSE Distribution by Subgroup (Continuous, Scenario 3)

```{r continuous_rmse_by_subgroup, fig.width=12, fig.height=6}
continuous_subgroup_perf <- subgroup_performance_list$continuous %>%
  filter(scenario_no == 3, !grepl("r2d2_mid_unshrunk_x4", estimator_name))

ggplot(continuous_subgroup_perf, 
       aes(x = RMSE, y = fct_rev(join_key), color = estimator_display)) +
  geom_jitter(size = 3, width = 0, height = 0.2) + 
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  theme_bw() +
  theme(text = element_text(size = 12),
        legend.position = "bottom") +
  labs(
    title = "RMSE Distribution by Subgroup (Continuous, Scenario 3)",
    subtitle = "Negative treatment effect (except 1 subgroup)",
    y = "Subgroup",
    x = "Root Mean Squared Error",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))
```

---

## RMSE Across All Scenarios (Continuous)

```{r continuous_rmse_all_scenarios, fig.width=14, fig.height=10}
continuous_subgroup_perf_all <- subgroup_performance_list$continuous %>%
  filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name))

ggplot(continuous_subgroup_perf_all, 
       aes(x = RMSE, y = fct_rev(join_key), color = estimator_display)) +
  geom_jitter(size = 2.5, width = 0, height = 0.2, alpha = 0.7) + 
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  facet_wrap(~scenario_no, nrow = 2, labeller = as_labeller(scenario_labels)) +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 10)) +
  labs(
    title = "RMSE Distribution Across All Scenarios (Continuous Endpoint)",
    y = "Subgroup",
    x = "Root Mean Squared Error",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))

# Save RMSE plot
ggsave(file.path(plots_path, "continuous_rmse_all_scenarios.png"), width = 14, height = 10, dpi = 300, bg = "white")
```

---

## Bias Across All Scenarios (Continuous)

```{r continuous_bias_all_scenarios, fig.width=14, fig.height=10}
ggplot(continuous_subgroup_perf_all, 
       aes(x = abs(bias), y = fct_rev(join_key), color = estimator_display)) +
  geom_jitter(size = 2.5, width = 0, height = 0.2, alpha = 0.7) + 
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  facet_wrap(~scenario_no, nrow = 2, labeller = as_labeller(scenario_labels)) +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 10)) +
  labs(
    title = "Absolute Bias Distribution Across All Scenarios (Continuous Endpoint)",
    y = "Subgroup",
    x = "Absolute Bias",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))

# Save Bias plot
ggsave(file.path(plots_path, "continuous_bias_all_scenarios.png"), width = 14, height = 10, dpi = 300, bg = "white")
```

---

## Bias vs RMSE Scatter (Continuous)

```{r continuous_bias_rmse, fig.width=12, fig.height=8}
continuous_summary <- subgroup_performance_list$continuous %>%
  filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name)) %>%
  group_by(scenario_no, estimator_display) %>%
  summarize(
    mean_rmse = mean(RMSE, na.rm = TRUE),
    mean_abs_bias = mean(abs(bias), na.rm = TRUE),
    .groups = 'drop'
  )

ggplot(continuous_summary, aes(x = mean_abs_bias, y = mean_rmse, 
                        color = estimator_display)) +
  geom_point(size = 4) +
  facet_wrap(~scenario_no, nrow = 2, labeller = as_labeller(scenario_labels)) +
  scale_colour_manual(values = c(
    "Population (full shrinkage)" = "#5E3C99",
    "Subgroup (no shrinkage)" = "#FF7F00",
    "GM - Horseshoe (Low)" = "#A6CEE3",
    "GM - Horseshoe (Mid)" = "#377EB8",
    "GM - Horseshoe (Strong)" = "#08519C",
    "GM - R2D2 (Low)" = "#A1D99B",
    "GM - R2D2 (Mid)" = "#31A354",
    "GM - R2D2 (Strong)" = "#006D2C",
    "OVAT - Hierarchical" = "#E41A1C"
  )) +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom",
        strip.text = element_text(face = "bold", size = 10)) +
  labs(
    title = "Bias-RMSE Trade-off (Continuous Endpoint)",
    subtitle = "Average across subgroups within each scenario",
    x = "Mean Absolute Bias",
    y = "Mean RMSE",
    color = "Estimator"
  ) +
  guides(color = guide_legend(ncol = 3))
```

---

## Coverage by Heterogeneity Status (Continuous)

```{r continuous_coverage, fig.width=12, fig.height=6}
continuous_coverage_summary <- subgroup_performance_list$continuous %>%
  filter(!grepl("r2d2_mid_unshrunk_x4", estimator_name), !is.na(coverage)) %>%
  group_by(estimator_display, heterogeneous) %>%
  summarize(
    mean_coverage = mean(coverage, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(
    heterogeneity_status = ifelse(heterogeneous, "Heterogeneous", "Homogeneous")
  )

ggplot(continuous_coverage_summary, aes(x = estimator_display, y = mean_coverage, 
                                 fill = heterogeneity_status)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_hline(yintercept = 0.95, linetype = "dashed", color = "red", size = 1) +
  scale_fill_brewer(palette = "Pastel1") +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(size = 11),
        legend.position = "bottom") +
  labs(
    title = "Coverage of 95% Credible/Confidence Intervals (Continuous)",
    subtitle = "Dashed line indicates nominal 95% coverage",
    x = "Estimator",
    y = "Mean Coverage",
    fill = "Subgroup Type"
  )
```

---

# Summary

This analysis presents comprehensive simulation results across all four endpoint types. Key findings:

1. **Standardized RMSE plots** show relative performance of all estimators compared to the baseline subgroup estimator across six simulation scenarios.

2. **Performance tables** quantify RMSE, bias, and coverage metrics, stratified by subgroup heterogeneity (homogeneous vs heterogeneous subgroups).

3. **TTE-specific visualizations** provide additional insights into:
   - RMSE distribution across individual subgroups
   - Bias-RMSE trade-offs
   - Coverage performance by heterogeneity status

The results demonstrate the comparative performance of population, subgroup, Global (Horseshoe/R2D2), and OVAT approaches across different endpoint types and simulation scenarios.

---

**Analysis Date:** `r Sys.Date()`

**R Version:** `r R.version.string`

