---
title: "Global_results_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# --- 2. LOAD LIBRARIES ---
library(dplyr)
library(tidyr)
library(stringr)
library(purrr)
library(ggplot2)
library(knitr)
library(kableExtra)
library(checkmate)

# --- MASTER ENDPOINT PARAMETER LIST ---
# Define all endpoint parameters in one named list
all_endpoint_params <- list(
  "tte" = list(
    folder = "TTE",
    truth_list_name = "simul_parameter",
    truth_overall_name = "true_overall_results",
    truth_subgroup_name = "true_subgroup_ahr", # exp-scale
    truth_metric_exp = "AHR", # from true_overall_results
    est_metric = "AHR", # from naive results
    est_col = "estimate_ahr",
    ci_low = "lower_ci_ahr",
    ci_upper = "upper_ci_ahr",
    log_truth_col = "true_log_ahr"
  ),
  "binary" = list(
    folder = "Binary",
    truth_list_name = "simul_truth",
    truth_overall_name = "truth_overall",
    truth_subgroup_name = "truth_subgroup", # log-scale
    truth_metric_exp = "exp_value",
    est_metric = "OR",
    est_col = "estimate",
    ci_low = "lower_ci_ahr",
    ci_up = "upper_ci_ahr",
    log_truth_col = "value"
  ),
  "count" = list(
    folder = "Count",
    truth_list_name = "simul_truth",
    truth_overall_name = "truth_overall",
    truth_subgroup_name = "truth_subgroup", # log-scale
    truth_metric_exp = "exp_value",
    est_metric = "RR",
    est_col = "estimate", # log-scale
    ci_low = "lower_ci",
    ci_up = "upper_ci",
    log_truth_col = "value"
  ),
  "continuous" = list(
    folder = "Continuous",
    truth_list_name = "simul_truth",
    truth_overall_name = "truth_overall",
    truth_subgroup_name = "truth_subgroup", # log-scale
    truth_metric_exp = "value", # This is the mean-diff, no exp
    est_metric = "MeanDiff",
    est_col = "estimate", # log-scale
    ci_low = "lower_ci",
    ci_up = "upper_ci",
    log_truth_col = "value"
  )
)

# --- Helper Functions (defined once) ---
display <- function(x, digits = 2) {
  formatC(x, format = "f", digits = digits)
}

getPercentage <- function(x, digits = 0) {
  val <- 100 * x
  ifelse(is.na(val),
    "NA",
    paste(formatC(val, digits = digits, format = "f"), "%", sep = "")
  )
}
```


```{r tte_analysis}
# --- 3. DEFINE TTE PARAMETERS ---
ENDPOINT_ID <- 'tte'
ep_params <- all_endpoint_params[[ENDPOINT_ID]]
message(paste("--- Analyzing Endpoint:", ENDPOINT_ID, "---"))

# --- 4. FIND AND LOAD TTE RESULTS FILES ---
results_path <- file.path(ep_params$folder, "Results")
all_files <- list.files(results_path, pattern = "\\.rds$", full.names = TRUE)

# Helper function to load, validate, and add file metadata
load_and_validate_rds <- function(file_path) {
  message(paste("Loading:", basename(file_path)))
  df <- readRDS(file_path)
  
  if ("scenario_id" %in% names(df)) {
    n_sims <- df %>% distinct(scenario_id, replication_id) %>% nrow()
  } else if ("scenario_no" %in% names(df)) {
    n_sims <- df %>% distinct(scenario_no, simul_no) %>% nrow()
  } else {
    warning(paste("Could not validate file:", basename(file_path)))
    return(NULL)
  }
  
  if (n_sims != 6000) {
    warning(sprintf("File %s is incomplete! Expected 6000 sims, found %d.", 
                    basename(file_path), n_sims))
  } else {
    message(paste("  ...Validation OK: 6000 simulations found."))
  }
  
  df %>% mutate(
    file_name = basename(file_path),
    estimator_name = str_remove(file_name, paste0("^", ENDPOINT_ID, "_")) %>%
      str_remove("\\.rds$")
  )
}

all_results_list <- lapply(all_files, load_and_validate_rds)

# --- 5. LOAD TTE "TRUTH" DATA ---
truth_file <- file.path(ep_params$folder, "Scenarios", "truth.RData")
load(truth_file) # This loads `simul_parameter`
message(paste("Loaded truth data from:", truth_file))

# --- 6. STANDARDIZE TTE "TRUTH" DATA ---
# TTE-SPECIFIC LOGIC: Uses `simul_parameter`
real_params_tidy <- simul_parameter[[ep_params$truth_subgroup_name]] %>%
  mutate(scenario_no = as.character(row_number())) %>%
  pivot_longer(
    cols = -scenario_no,
    names_to = "subgroup_real",
    values_to = "truth_exp" # This is real_ahr
  ) %>%
  mutate(
    join_key = gsub("x_|\\.", "", subgroup_real),
    truth_log = log(truth_exp)
  ) %>%
  dplyr::select(scenario_no, join_key, truth_log, truth_exp)
  
true_population_results <- simul_parameter[[ep_params$truth_overall_name]] %>%
  mutate(
    scenario_no = as.character(1:6),
    truth_population_exp = !!sym(ep_params$truth_metric_exp),
    truth_population_log = log(truth_population_exp)
  ) %>%
  dplyr::select(scenario_no, truth_population_exp, truth_population_log)

# --- 7. STANDARDIZE TTE RESULTS ---
standardized_results_list <- lapply(all_results_list, function(df) {
  if (is.null(df)) return(NULL)
  estimator_type <- df$estimator_name[1]
  
  if (estimator_type %in% c("population", "subgroup")) {
    df %>%
      mutate(
        join_key = gsub("S_", "", subgroup) %>% gsub("Overall", "Overall", .),
        scenario_id = as.integer(scenario_no),
        replication_id = as.integer(simul_no),
        estimate_log = estimate,
        ci_lower = lower_ci,
        ci_upper = upper_ci,
        estimator_name = estimator
      ) %>%
      dplyr::select(scenario_id, replication_id, estimator_name, join_key, 
                    estimate_log, ci_lower, ci_upper)
  } else {
    df %>%
      filter(Subgroup != "Overall") %>% 
      mutate(
        join_key = gsub("x_", "", Subgroup),
        estimator_name = paste(model_type, prior_name, sep = "_")
      ) %>%     
      mutate(
        join_key = gsub(": ", "", join_key)
      ) %>%
      rename(
        estimate_log = Median, # This is misnamed in the Rmd, it's log-scale
        ci_lower = CI_Lower,
        ci_up = CI_Upper
      ) %>%
      # TTE-SPECIFIC LOGIC: Estimates are on exp-scale, so log them
      mutate(
        estimate_log = log(estimate_log),
        ci_lower = log(ci_lower),
        ci_upper = log(ci_upper)
      ) %>%
      dplyr::select(scenario_id, replication_id, estimator_name, join_key, 
                    estimate_log, ci_lower, ci_upper)
  }
})

# --- 8. COMBINE AND MERGE TTE DATA ---
all_estimators_df <- bind_rows(standardized_results_list)
all_estimators_df$scenario_no <- as.character(all_estimators_df$scenario_id)
merged_df <- left_join(all_estimators_df, real_params_tidy, by = c("scenario_no", "join_key"))
merged_df_with_pop <- left_join(merged_df, true_population_results, by = "scenario_no")
message("All TTE data loaded, standardized, and merged.")

# --- 9. CALCULATE TTE RMSE ---
rmse_results <- merged_df %>%
  group_by(scenario_no, estimator_name) %>%
  summarise(
    rmse = sqrt(mean((estimate_log - truth_log)^2, na.rm = TRUE)),
    .groups = 'drop'
  )

# --- 10. PLOT TTE RMSE ---
scenario_labels <- c(
 `1` = "Positive\n(homogeneous)", `2` = "Positive\n(except 1 subgroup)",
 `3` = "Negative\n(heterogeneity)", `4` = "Mild\nheterogeneity)",
 `5` = "Strong\nheterogeneity)", `6` = "Misspecified"
)
plot_data <- rmse_results %>%
  mutate(scenario_name = factor(scenario_no, levels = names(scenario_labels), labels = scenario_labels))

final_plot <- ggplot(
  data = plot_data,
  aes(x = scenario_name, y = rmse, group = estimator_name, color = estimator_name)
) +
  geom_line(size = 1.2) + geom_point(size = 3) +
  scale_color_brewer(palette = "Set1") +
  labs(
    title = paste("Overall RMSE Across Simulation Scenarios (Endpoint:", ep_params$folder, ")"),
    subtitle = paste("Performance of various estimators of the subgroup", paste0("log(", ep_params$est_metric, ")")),
    y = "RMSE", x = "Simulation Scenario", color = "Estimator"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.title = element_text(size = 12),
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )
print(final_plot)

# --- 11. CALCULATE TTE SUBGROUP PERFORMANCE METRICS ---
subgroupPerformance <- merged_df_with_pop |>
  group_by(scenario_no, join_key, estimator_name) |>
  summarize(
    truth_log = first(truth_log),
    truth_exp = first(truth_exp),
    truth_population_log = first(truth_population_log),
    bias = mean(estimate_log - truth_log, na.rm = TRUE),
    RMSE = sqrt(mean((estimate_log - truth_log)^2, na.rm = TRUE)),
    coverage = mean((truth_log >= ci_lower) & (truth_log <= ci_upper), na.rm = TRUE)
  ) |>
  ungroup() |>
  mutate(
    heterogeneous = (abs(truth_log - truth_population_log) > log(1.1))
  )

subgroupPerformance <- subgroupPerformance %>%
  mutate(coverage = if_else(is.nan(coverage), NA_real_, coverage))

# --- 12. GENERATE TTE TABLE DATA ---
# (This section is identical, just operates on the TTE subgroupPerformance df)
sum_RMSEbias <- subgroupPerformance |>
  group_by(estimator_name) |>
  summarize(
    RMSE = paste(display(mean(RMSE, na.rm = TRUE), 2), " (", display(min(RMSE, na.rm = TRUE), 2), "-", display(max(RMSE, na.rm = TRUE), 2), ")", sep = ""),
    abs_bias = paste(display(mean(abs(bias), na.rm = TRUE), 2), " (", display(min(abs(bias), na.rm = TRUE), 2), "-", display(max(abs(bias), na.rm = TRUE), 2), ")", sep = "")
  ) |>
  arrange(estimator_name)

sum_coverage <- subgroupPerformance |>
  group_by(estimator_name) |>
  summarize(
    coverage = ifelse(
      all(is.na(coverage)), "NA",
      paste(getPercentage(mean(coverage, na.rm = TRUE)), " (", getPercentage(min(coverage, na.rm = TRUE)), "-", getPercentage(max(coverage, na.rm = TRUE)), ")", sep = "")
    )
  ) |>
  arrange(estimator_name)

sum_RMSEbias_het <- subgroupPerformance |>
  group_by(heterogeneous, estimator_name) |>
  summarize(
    RMSE = paste(display(mean(RMSE, na.rm = TRUE), 2), " (", display(min(RMSE, na.rm = TRUE), 2), "-", display(max(RMSE, na.rm = TRUE), 2), ")", sep = ""),
    abs_bias = paste(display(mean(abs(bias), na.rm = TRUE), 2), " (", display(min(abs(bias), na.rm = TRUE), 2), "-", display(max(abs(bias), na.rm = TRUE), 2), ")", sep = "")
  ) |>
  ungroup() |>
  arrange(estimator_name)

sum_coverage_het <- subgroupPerformance |>
  group_by(heterogeneous, estimator_name) |>
  summarize(
    coverage = ifelse(
      all(is.na(coverage)), "NA",
      paste(getPercentage(mean(coverage, na.rm = TRUE)), " (", getPercentage(min(coverage, na.rm = TRUE)), "-", getPercentage(max(coverage, na.rm = TRUE)), ")", sep = "")
    )
  ) |>
  ungroup() |>
  arrange(estimator_name)

estimator_names <- sort(unique(subgroupPerformance$estimator_name))
estimator_rows <- paste("- ", estimator_names, sep = "")
n_estimators <- length(estimator_names)

estimators_with_coverage <- sum_coverage$estimator_name[sum_coverage$coverage != "NA"]
estimator_rows_coverage <- paste("- ", estimators_with_coverage, sep = "")
n_estimators_coverage <- length(estimators_with_coverage)

r <- data.frame(
  Criterion = c(
    "Root mean squared error (RMSE)", estimator_rows,
    "Absolute bias", estimator_rows,
    "Coverage of 95% CI/credible interval", estimator_rows_coverage
  ),
  overall = c(
    " ", sum_RMSEbias$RMSE,
    " ", sum_RMSEbias$abs_bias,
    " ", sum_coverage$coverage[sum_coverage$coverage != "NA"]
  ),
  homo = c(
    " ", with(sum_RMSEbias_het, RMSE[!heterogeneous]),
    " ", with(sum_RMSEbias_het, abs_bias[!heterogeneous]),
    " ", with(sum_coverage_het, coverage[!heterogeneous & coverage != "NA"])
  ),
  het = c(
    " ", with(sum_RMSEbias_het, RMSE[heterogeneous]),
    " ", with(sum_RMSEbias_het, abs_bias[heterogeneous]),
    " ", with(sum_coverage_het, coverage[heterogeneous & coverage != "NA"])
  )
)

n_scenarios <- n_distinct(subgroupPerformance$scenario_no)
n_subgroups_per_scenario <- n_distinct(subgroupPerformance$join_key)
total_subgroups <- n_scenarios * n_subgroups_per_scenario
count_het <- subgroupPerformance |>
  filter(estimator_name == estimator_names[1]) |> 
  group_by(scenario_no) |> 
  summarise(total_het = sum(heterogeneous))
total_het <- sum(count_het$total_het)
total_homo <- total_subgroups - total_het

# --- 13. CREATE TTE KABLE TABLE ---
kbl(r,
  caption = paste("Performance Metrics for Endpoint:", ep_params$folder),
  booktabs = T,
  linesep = c(
    "", rep("", n_estimators),
    "\\addlinespace", rep("", n_estimators),
    "\\addlinespace", rep("", n_estimators_coverage)
  ),
  col.names = c("Criterion", "All subgroups", "Homogeneous subgroups", "Heterogeneous subgroups")
) |>
  footnote(
    general = c(
      paste("Summary is across", total_subgroups, "subgroups (", n_subgroups_per_scenario, "subgroups x", n_scenarios, "scenarios) including", total_homo, "homogeneous and", total_het, "heterogeneous subgroups."),
      "The Monte Carlo standard error of the estimated coverage is estimated to be ~0.7% given 1'000 simulations and true coverage of 95%."
    ),
    general_title = ""
  )

```
