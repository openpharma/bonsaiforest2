---
title: "Scenarios_generation"
output: html_document
---

# Scenarios Generation

In this file we generate the data for each one of the 6 scenarios we want to study for the 4 different endpoints.

## Library and functions loading
```{r}
# Ensure all required libraries are loaded
library(checkmate)
library(MASS) # Used by simul_covariates

# --- LOAD ALL FUNCTIONS ---
source('functions.R')

# --- REPRODUCIBILITY ---
# Set seed for all random generation, as seen in the legacy code
RNGkind('Mersenne-Twister')
set.seed(0)
rnorm(25, mean = 0, sd = 0.3)
```

## Parameters definition
```{r}
# --- LOOP PARAMETERS ---
# Edit 'endpoints' to generate specific endpoints or all:
# c("binary", "count", "continuous") for new endpoints only
# c("binary") for testing single endpoint
# TTE uses exact Wolbers et al. (2025) data via simul_scenario()
endpoints <- c("tte", "binary", "count", "continuous")
scenarios <- as.character(1:6)  # All 6 scenarios

# --- COMMON PARAMETERS ---
# Number of replications (simulated datasets) per scenario
n_datasets <- 1000

# --- TTE-SPECIFIC PARAMETERS ---
# (Only used if endpoint == "tte")
# TTE uses exact Wolbers et al. (2025) data via simul_scenario() function
tte_params <- list(
  n_patients = 1000,
  n_events = 247,
  sigma_aft = 0.85,    # AFT Weibull scale parameter
  recr_duration = 3,   # Recruitment period (years)
  rate_cens = 0.02,    # Censoring rate
  add_uncensored_pfs = FALSE,
  inflation_factor = 1
)
# --- DEFINE SUBGROUP INTERACTION NAMES ---
# All possible treatment-by-subgroup interaction terms
# Based on 10 categorical variables with 2-3 levels each (total 25 combinations)
group_coefs_names <- c(
  "x_1a_arm", "x_1b_arm", "x_2a_arm", "x_2b_arm",
  "x_3a_arm", "x_3b_arm", "x_4a_arm", "x_4b_arm", "x_4c_arm", "x_5a_arm",
  "x_5b_arm", "x_5c_arm", "x_5d_arm", "x_6a_arm", "x_6b_arm", "x_7a_arm",
  "x_7b_arm", "x_8a_arm", "x_8b_arm", "x_8c_arm", "x_9a_arm", "x_9b_arm",
  "x_10a_arm", "x_10b_arm", "x_10c_arm"
)  # Total: 25 interaction terms

```

## Loop for data generation
```{r}
for (ep in endpoints) {
  
  # Get the correct folder name (capitalization matters)
  endpoint_folder <- switch(ep,
    "tte" = "TTE",
    "binary" = "Binary",
    "count" = "Count",
    "continuous" = "Continuous"
  )
  
  for (scen in scenarios) {
    
    # --- 1. Log Start ---
    message("------------------------------------------------------")
    message(paste("ðŸš€ Starting:", ep, "- Scenario", scen))
    
    # --- 2. Set Up Function Arguments ---
    # Construct arguments for simul_study_data() function
    call_args <- list(
      endpoint = ep,
      scenario = scen,
      n_datasets = n_datasets
    )
    
    # TTE uses different function (simul_scenario) with specific parameters
    if (ep == "tte") {
      call_args <- c(call_args, tte_params)
    }
    # Binary, Count, Continuous: use .simul_new_endpoint_single() internally
    
    # --- 3. Generate Data ---
    # Call simul_study_data() which dispatches to appropriate generator:
    #   - simul_scenario() for TTE (uses Wolbers et al. 2025 exact data)
    #   - .simul_new_endpoint_single() for Binary/Count/Continuous (new generation)
    message("   ...generating data...")
    dataset_list <- do.call(simul_study_data, call_args)
    
    
    # --- 4. Define Save Path and Save ---
    file_name <- paste0("scenario", scen, ".rds")
    
    # Construct the full relative path
    save_path <- file.path(endpoint_folder, "Scenarios", file_name)
    
    # Save the resulting list (e.g., of 1000 data.frames) as a single .rds file
    message(paste("   ...saving to", save_path))
    saveRDS(dataset_list, file = save_path)
    
    message(paste("âœ… Completed:", ep, "- Scenario", scen))
  }
}

message("------------------------------------------------------")
message("ðŸŽ‰ All simulations generated and saved successfully! ðŸŽ‰")
```

