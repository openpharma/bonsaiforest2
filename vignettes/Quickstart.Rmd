---
title: "Quickstart"
author: Miriam Pedrera Gomez, Isaac Gravestock, and Marcel Wolbers
output: 
  bookdown::html_document2:
    toc: true
    toc_depth: 4
    number_sections: true
    citation_package: natbib
    base_format: rmarkdown::html_vignette
bibliography: "references.bib"
link-citations: true   
linkcolor: blue
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{Quickstart}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

# Introduction

The `bonsaiforest2` package consists of 3 core functions which are typically called in sequence:

1.  `run_brms_analysis()` - Prepares the model formula and fits the Bayesian model using `brms`.
2.  `summary_subgroup_effects()` - Calculates the marginal overall and subgroup treatment effects.
3.  `plot()` - Creates a forest plot from the summary object.

This introductory vignette describes how to run these functions on a simulated dataset. 

This example makes use of Bayesian modeling, which requires the installation of the 
[`brms`](https://paulbuerkner.com/brms/) package and a working Stan installation (e.g., via 
[`cmdstanr`](https://mc-stan.org/cmdstanr/)).

```{r setup, eval=FALSE, message=FALSE, warning=FALSE}
install.packages("brms")
install.packages("cmdstanr")
cmdstanr::install_cmdstan()
```

# The Data

We will use a simulated example dataset representing a clinical trial for blood pressure. The relevant endpoint is the change in Systolic Blood Pressure (SBP) from baseline (`sbp_change`).

We consider an **analysis model** where we want to find the treatment effect (`trt`) on `sbp_change`. The model will adjust for `baseline_sbp` as a **prognostic** variable (predictor of the outcome) and explore `region` and `comorbidity` as **predictive** variables (potential treatment effect modifiers).

First, let's load the libraries and create the data.

```{r load-packages, message=FALSE, warning=FALSE}
# Load the main package
library(bonsaiforest2)

# Load other required packages
library(brms)
library(dplyr)
```

```{r ex-data}
# Create the example data
set.seed(123)
n_patients <- 200
continuous_data <- data.frame(
  id = 1:n_patients,
  sbp_change = rnorm(n_patients, mean = -5, sd = 10),
  trt = sample(0:1, n_patients, replace = TRUE),
  baseline_sbp = rnorm(n_patients, mean = 140, sd = 15),
  region = factor(sample(c("USA", "EU", "APAC"), n_patients, replace = TRUE)),
  comorbidity = factor(sample(c("Yes", "No"), n_patients, replace = TRUE, prob = c(0.4, 0.6)))
)

# `bonsaiforest2` expects the treatment variable to be a factor
continuous_data$trt <- factor(continuous_data$trt, levels = c(0, 1))

print(head(continuous_data))
```

# `run_brms_analysis()`

The `run_brms_analysis()` function is the first step. It builds the model formula and fits the `brms` model, applying shrinkage priors to exploratory terms.

**Key Arguments:**

-   `data`: Your input `data.frame`.
-   `response_formula_str`: Defines the outcome and main treatment effect (e.g., `"outcome ~ trt"`).
-   `response_type`: `"continuous"`, `"binary"`, `"count"`, or `"survival"`.
-   `shrunk_predictive_formula_str`: Treatment interactions to estimate with shrinkage (e.g., `"~ region:trt + sex:trt"`).
-   `unshrunk_prognostic_formula_str`: Main effects (not treatment interactions) to estimate without strong shrinkage (e.g., `"~ age"`).
-   `shrunk_prognostic_formula_str`: Main effects to estimate with shrinkage.
-   `unshrunk_predictive_formula_str`: Treatment interactions to estimate without strong shrinkage (e.g., `"~ prespecified_marker:trt"`).
-   `prognostic_effect_priors`, `predictive_effect_priors`: Lists specifying priors for shrunk/unshrunk terms.
-   `stanvars`: Optional object from `brms::stanvar()` for custom Stan code (e.g., for hierarchical priors).
-   `...`: Other arguments passed directly to `brms::brm()` (like `chains`, `iter`, `cores`).

For this example, we will:

-   Define the response as `sbp_change ~ trt`.
-   Adjust for `baseline_sbp` as an **unshrunk prognostic** variable.
-   Explore `region` and `comorbidity` as **shrunk predictive** variables. We also include `~ 1` in the shrunk predictive formula to apply shrinkage to the overall treatment effect (intercept of the interactions).

```{r ex-fit, message=FALSE, warning=FALSE}
# iter and chains are set low for a quick example.
# For a real analysis, use more iterations (e.g., iter = 2000).
continuous_model_fit <- run_brms_analysis(
  data = continuous_data,
  response_formula_str = "sbp_change ~ trt",
  response_type = "continuous",
  unshrunk_prognostic_formula_str = "~ baseline_sbp",
  # Shrink intercept (1), region interaction, and comorbidity interaction
  shrunk_predictive_formula_str = "~ 1 + region:trt + comorbidity:trt",
  chains = 1, iter = 200, warmup = 100, cores = 1,
  refresh = 0, backend = "cmdstanr" # Use cmdstanr if available
)

print(continuous_model_fit)
```

# `summary_subgroup_effects()`

The next step is to use the fitted model to generate interpretable subgroup effects. This is done with `summary_subgroup_effects()`.

This function uses **G-computation** to estimate the *marginal* treatment effect for each subgroup (e.g., "what is the average effect for all patients in the 'EU' region?"), averaging over all other covariates like `baseline_sbp` and `comorbidity`.

Its main inputs are the `brms_fit` object from the previous step and the `original_data`.

```{r ex-summary}
continuous_summary <- summary_subgroup_effects(
  brms_fit = continuous_model_fit,
  original_data = continuous_data, # Pass the original data
  trt_var = "trt",
  response_type = "continuous"     # Must match fitting
  # subgroup_vars = "auto" is the default and finds all interactions
)

print(continuous_summary)
```

# `plot()`

Finally, the `plot()` function takes the `subgroup_summary` object and creates a forest plot for easy interpretation.

```{r ex-plot, fig.show='hold'}
# Generate and display the plot
plot(continuous_summary, title = "Continuous: Subgroup Effects on SBP Change")
```

This plot displays the marginal treatment effect (mean difference in `sbp_change`) for the overall population and for each subgroup level. The estimates are "shrunk" towards the overall effect, providing more stable results than fitting separate models for each subgroup.

# Code

We report below all the code for the main workflow presented in this vignette.

```{r full-code, eval=FALSE, echo=TRUE}
library(bonsaiforest2)
library(brms)
library(dplyr)
library(ggplot2)

# --- 2. The Data ---
set.seed(123)
n_patients <- 200
continuous_data <- data.frame(
  id = 1:n_patients,
  sbp_change = rnorm(n_patients, mean = -5, sd = 10),
  trt = sample(0:1, n_patients, replace = TRUE),
  baseline_sbp = rnorm(n_patients, mean = 140, sd = 15),
  region = factor(sample(c("NA", "EU", "APAC"), n_patients, replace = TRUE)),
  comorbidity = factor(sample(c("Yes", "No"), n_patients, replace = TRUE, prob = c(0.4, 0.6)))
)
continuous_data$trt <- factor(continuous_data$trt, levels = c(0, 1))


# --- 3. run_brms_analysis() ---
# (Use iter = 2000, chains = 4 for a real analysis)
continuous_model_fit <- run_brms_analysis(
  data = continuous_data,
  response_formula_str = "sbp_change ~ trt",
  response_type = "continuous",
  unshrunk_prognostic_formula_str = "~ baseline_sbp",
  shrunk_predictive_formula_str = "~ 1 + region:trt + comorbidity:trt",
  chains = 1, iter = 200, warmup = 100, cores = 1,
  refresh = 0, backend = "cmdstanr"
)


# --- 4. summary_subgroup_effects() ---
continuous_summary <- summary_subgroup_effects(
  brms_fit = continuous_model_fit,
  original_data = continuous_data,
  trt_var = "trt",
  response_type = "continuous"
)


# --- 5. plot() ---
plot(continuous_summary, title = "Continuous: Subgroup Effects on SBP Change")
```
