---
title: "Quickstart"
author: Miriam Pedrera Gomez, Isaac Gravestock, and Marcel Wolbers
output: 
  bookdown::html_document2:
    toc: true
    toc_depth: 4
    number_sections: true
    citation_package: natbib
    base_format: rmarkdown::html_vignette
bibliography: "references.bib"
link-citations: true   
linkcolor: blue
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{Quickstart}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

# Introduction

The `bonsaiforest2` package consists of 3 core functions which are typically called in sequence:

1.  `run_brms_analysis()` - Prepares the model formula and fits the Bayesian model using `brms`.
2.  `summary_subgroup_effects()` - Calculates the marginal subgroup treatment effects.
3.  `plot()` - Creates a forest plot from the summary object.

The package enables the implementation of both **global models** [@wolbers2025using], that estimate all prognostic and predictive effects in a single unified model using colon notation (e.g., `~ 0 + trt:subgroup`), and **one-way models** [@wang2024bayesian], that estimate treatment slopes varying by subgroup using random effects notation (e.g., `~ (0 + trt || subgroup)`).

This vignette demonstrates how to use the package to fit and compare these different modeling formulas. You'll learn how to:

-   Fit one-way models (random effects with treatment slopes varying by subgroup)
-   Fit global models (all subgroup variables in one unified model)
-   Generate summaries of subgroup treatment effects
-   Visualize and compare results from different model specifications

This example makes use of Bayesian modeling, which requires the installation of the [`brms`](https://paulbuerkner.com/brms/) package and a working Stan installation (e.g., via [`cmdstanr`](https://mc-stan.org/cmdstanr/)).

# The Data

We will use a simulated example dataset with a continuous response variable. The relevant outcome is `y`.

We consider a model where we want to find the treatment effect (`trt`) on `y`. The model will adjust for `baseline` as a **prognostic** variable (predictor of the outcome) and explore **multiple subgroup variables** as **predictive** variables (potential treatment effect modifiers):

-   `X1`: Subgroup 1 (categories: A, B, C)
-   `X2`: Subgroup 2 (categories: A, B)
-   `X3`: Subgroup 3 (categories: A, B, C)
-   `X4`: Subgroup 4 (categories: A, B)
-   `X5`: Subgroup 5 (categories: A, B)

First, let's load the libraries and create the data.

```{r load-packages, message=FALSE, warning=FALSE}
# Load the main package
library(bonsaiforest2)
library(brms)

```

```{r ex-data}
# Create the example data with multiple subgroup variables and treatment effects
set.seed(123)
n <- 500

data <- data.frame(
  id = 1:n,
  trt = rep(0:1, length.out = n),  # Numeric treatment 0/1
  baseline = rnorm(n, mean = 100, sd = 15),
  X1 = factor(sample(c("A", "B", "C"), n, replace = TRUE)),
  X2 = factor(sample(c("A", "B"), n, replace = TRUE)),
  X3 = factor(sample(c("A", "B", "C"), n, replace = TRUE)),
  X4 = factor(sample(c("A", "B"), n, replace = TRUE)),
  X5 = factor(sample(c("A", "B"), n, replace = TRUE))
)

# Generate outcome with baseline effect and heterogeneous treatment effects
data$y <- 50 + 
  0.2 * data$baseline + 
  data$trt * (-5 +                                    # Base treatment effect
    2 * (as.numeric(data$X1 == "A") - 0.33) +        # Heterogeneity by X1
    1.5 * (as.numeric(data$X3 == "B") - 0.33)        # Heterogeneity by X3
  ) + 
  rnorm(n, 0, 10)

print(head(data))
```

# One-way Models

This section demonstrates how to fit separate models, each examining one subgroup variable at a time. In one-way models, we specify treatment effects as random slopes using pipe-pipe notation (e.g., `~ (0 + trt || subgroup)`), which allows treatment effects to vary by subgroup with automatic hierarchical regularization via random effects.

## One-way Model: X1 Only

```{r oneway-X1, message=FALSE, warning=FALSE}
# Fit model with only X1 as subgroup variable using one-way approach
# Random effects notation (0 + trt || X1) estimates varying treatment slopes by X1
oneway_X1 <- run_brms_analysis(
  data = data,
  response_type = "continuous",
  response_formula = y ~ trt,
  unshrunk_terms_formula = ~ baseline,
  shrunk_prognostic_formula = NULL,
  shrunk_predictive_formula = ~ (0 + trt || X1),
  intercept_prior = "normal(0, 10)",
  unshrunk_prior = "normal(0, 2.5)",
  shrunk_predictive_prior = set_prior("normal(0, 1)", class = "sd"),
  chains = 2, iter = 2000, warmup = 1000, cores = 2,
  refresh = 0, backend = "cmdstanr"
)

summary_oneway_X1 <- summary_subgroup_effects(brms_fit = oneway_X1)
print(summary_oneway_X1)
```

## One-way Model: X2 Only

```{r oneway-X2, message=FALSE, warning=FALSE}
oneway_X2 <- run_brms_analysis(
  data = data,
  response_type = "continuous",
  response_formula = y ~ trt,
  unshrunk_terms_formula = ~ baseline,
  shrunk_prognostic_formula = NULL,
  shrunk_predictive_formula = ~ (0 + trt || X2),
  intercept_prior = "normal(0, 10)",
  unshrunk_prior = "normal(0, 2.5)",
  shrunk_predictive_prior = set_prior("normal(0, 1)", class = "sd"),
  chains = 2, iter = 2000, warmup = 1000, cores = 2,
  refresh = 0, backend = "cmdstanr"
)

summary_oneway_X2 <- summary_subgroup_effects(brms_fit = oneway_X2)
```

## One-way Model: X3 Only

```{r oneway-X3, message=FALSE, warning=FALSE}
oneway_X3 <- run_brms_analysis(
  data = data,
  response_type = "continuous",
  response_formula = y ~ trt,
  unshrunk_terms_formula = ~ baseline,
  shrunk_prognostic_formula = NULL,
  shrunk_predictive_formula = ~ (0 + trt || X3),
  intercept_prior = "normal(0, 10)",
  unshrunk_prior = "normal(0, 2.5)",
  shrunk_predictive_prior = set_prior("normal(0, 1)", class = "sd"),
  chains = 2, iter = 2000, warmup = 1000, cores = 2,
  refresh = 0, backend = "cmdstanr"
)

summary_oneway_X3 <- summary_subgroup_effects(brms_fit = oneway_X3)
```

## One-way Model: X4 Only

```{r oneway-X4, message=FALSE, warning=FALSE}
oneway_X4 <- run_brms_analysis(
  data = data,
  response_type = "continuous",
  response_formula = y ~ trt,
  unshrunk_terms_formula = ~ baseline,
  shrunk_prognostic_formula = NULL,
  shrunk_predictive_formula = ~ (0 + trt || X4),
  intercept_prior = "normal(0, 10)",
  unshrunk_prior = "normal(0, 2.5)",
  shrunk_predictive_prior = set_prior("normal(0, 1)", class = "sd"),
  chains = 2, iter = 2000, warmup = 1000, cores = 2,
  refresh = 0, backend = "cmdstanr"
)

summary_oneway_X4 <- summary_subgroup_effects(brms_fit = oneway_X4)
```

## One-way Model: X5 Only

```{r oneway-X5, message=FALSE, warning=FALSE}
oneway_X5 <- run_brms_analysis(
  data = data,
  response_type = "continuous",
  response_formula = y ~ trt,
  unshrunk_terms_formula = ~ baseline,
  shrunk_prognostic_formula = NULL,
  shrunk_predictive_formula = ~ (0 + trt || X5),
  intercept_prior = "normal(0, 10)",
  unshrunk_prior = "normal(0, 2.5)",
  shrunk_predictive_prior = set_prior("normal(0, 1)", class = "sd"),
  chains = 2, iter = 2000, warmup = 1000, cores = 2,
  refresh = 0, backend = "cmdstanr"
)

summary_oneway_X5 <- summary_subgroup_effects(brms_fit = oneway_X5)
```

## One-way Models: Visualizing All Models

You can combine and visualize results from multiple models using `combine_summaries()`:

```{r compare-all-oneway, fig.width=9, fig.height=8}
# Combine all one-way models
combined_oneway <- combine_summaries(list(
  "X1" = summary_oneway_X1,
  "X2" = summary_oneway_X2,
  "X3" = summary_oneway_X3,
  "X4" = summary_oneway_X4,
  "X5" = summary_oneway_X5
))

plot(combined_oneway, title = "One-way Models: All Subgroup Variables")
```

# Global Model

This section demonstrates how to fit a single model that includes all subgroup variables simultaneously using the global approach. All treatment-by-subgroup interactions are estimated in one unified model with colon notation (e.g., `~ 0 + trt:subgroup`) and strong regularization (Horseshoe prior) applied to the interaction terms.

## Global Model: All Subgroups

```{r global-fit, message=FALSE, warning=FALSE}
# Fit a single unified model with ALL subgroup variables simultaneously using global approach
# - Unshrunk terms: baseline with reference coding
# - Shrunk prognostic effects: subgroup main effects with strong regularization using one-hot encoding
# - Shrunk predictive effects: treatment interactions with strong regularization using one-hot encoding
global_shrinkage_model <- run_brms_analysis(
  data = data,
  response_type = "continuous",
  response_formula = y ~ trt,
  unshrunk_terms_formula = ~ baseline,
  shrunk_prognostic_formula = ~ 0 + X1 + X2 + X3 + X4 + X5,
  shrunk_predictive_formula = ~ 0 + trt:X1 + trt:X2 + trt:X3 + trt:X4 + trt:X5,
  intercept_prior = "normal(0, 10)",
  unshrunk_prior = "normal(0, 2.5)",
  shrunk_prognostic_prior = "horseshoe(scale_global = 1)",
  shrunk_predictive_prior = "horseshoe(scale_global = 0.5)",
  chains = 2, iter = 2000, warmup = 1000, cores = 2,
  refresh = 0, backend = "cmdstanr"
)
```

## Global Model: Summary of Subgroup Effects

Use `summary_subgroup_effects()` to generate marginal treatment effects for each subgroup. The function automatically extracts all treatment interactions from the fitted model:

```{r global-summary}
global_summary <- summary_subgroup_effects(brms_fit = global_shrinkage_model)

# Print the summary of subgroup-specific treatment effects
print(global_summary)
```

## Global Model: Visualization

Use the `plot()` function to create a forest plot from the summary object:

```{r global-plot, fig.width=8, fig.height=10}
plot(global_summary, title = "Global Model: All Subgroup Variables")
```

# Comparing Multiple Models in One Plot

The `plot()` function supports comparing multiple models side-by-side. Pass a named list of `subgroup_summary` objects to create a comparative forest plot.

## Example: Comparing One-way vs Global Models

```{r compare-models, fig.width=9, fig.height=7}
# Combine summaries for comparison
combined <- combine_summaries(list(
  "One-way" = combined_oneway,
  "Global" = global_summary
))

# Plot the comparison
plot(combined, title = "Comparing One-way vs Global Models")
```
