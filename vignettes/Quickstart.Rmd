---
title: "Quickstart"
author: Miriam Pedrera Gomez, Isaac Gravestock, and Marcel Wolbers
output: 
  bookdown::html_document2:
    toc: true
    toc_depth: 4
    number_sections: true
    citation_package: natbib
    base_format: rmarkdown::html_vignette
bibliography: "references.bib"
link-citations: true   
linkcolor: blue
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{Quickstart}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

# Introduction

The `bonsaiforest2` package consists of 3 core functions which are typically called in sequence:

1.  `run_brms_analysis()` - Prepares the model formula and fits the Bayesian model using `brms`.
2.  `summary_subgroup_effects()` - Calculates the marginal subgroup treatment effects.
3.  `plot()` - Creates a forest plot from the summary object.

The package enables the implementation of both a **global modeling approach** [@wolbers2025using], that estimates all prognostic and predictive effects in a single model, and a **One-Variable-At-a-Time (OVAT)** approach [@wang2024bayesian], that estimates the predictive effects using a different model for each subgrouping variable.

This vignette demonstrates how to use the package to fit and compare these different modeling formulas. You'll learn how to:

-   Fit OVAT models (one model per subgroup variable)
-   Fit a global model (all subgroup variables in one model)
-   Generate summaries of subgroup treatment effects
-   Visualize and compare results from different model specifications

This example makes use of Bayesian modeling, which requires the installation of the [`brms`](https://paulbuerkner.com/brms/) package and a working Stan installation (e.g., via [`cmdstanr`](https://mc-stan.org/cmdstanr/)).

# The Data

We will use a simulated example dataset representing a clinical trial for blood pressure. The relevant endpoint is the change in Systolic Blood Pressure (SBP) from baseline (`sbp_change`).

We consider a model where we want to find the treatment effect (`trt`) on `sbp_change`. The model will adjust for `baseline_sbp` as a **prognostic** variable (predictor of the outcome) and explore **multiple subgroup variables** as **predictive** variables (potential treatment effect modifiers):

-   `region`: Geographic region (USA, EU, APAC)
-   `comorbidity`: Presence of comorbidities (Yes, No)
-   `age_group`: Age category (\< 50, 50-65, \> 65)
-   `sex`: Biological sex (M, F)
-   `diabetes`: Diabetes status (Yes, No)

First, let's load the libraries and create the data.

```{r load-packages, message=FALSE, warning=FALSE}
# Load the main package
library(bonsaiforest2)
library(brms)

```

```{r ex-data}
# Create the example data with multiple subgroup variables
set.seed(123)
n_patients <- 300

continuous_data <- data.frame(
  id = 1:n_patients,
  sbp_change = rnorm(n_patients, mean = -5, sd = 10),
  trt = sample(0:1, n_patients, replace = TRUE),
  baseline_sbp = rnorm(n_patients, mean = 140, sd = 15),
  region = factor(sample(c("USA", "EU", "APAC"), n_patients, replace = TRUE)),
  comorbidity = factor(sample(c("Yes", "No"), n_patients, replace = TRUE, prob = c(0.4, 0.6))),
  age_group = factor(sample(c("<50", "50-65", ">65"), n_patients, replace = TRUE, prob = c(0.3, 0.4, 0.3))),
  sex = factor(sample(c("M", "F"), n_patients, replace = TRUE)),
  diabetes = factor(sample(c("Yes", "No"), n_patients, replace = TRUE, prob = c(0.3, 0.7)))
)

continuous_data$trt <- factor(continuous_data$trt, levels = c(0, 1))

print(head(continuous_data))
```

# OVAT: One Variable At a Time

This section demonstrates how to fit separate models, each examining one subgroup variable at a time. We'll fit a model for each of our 5 subgroup variables.

## OVAT: Region Only

```{r ovat-region, message=FALSE, warning=FALSE}
# Write the sigma specified in the trial protocol
priors <- c(
  prior(normal(0, 5), class = "sd", coef = "Intercept", group = "SEX"),
  prior(normal(0, 5), class = "sd", coef = "TRT01PN", group = "SEX"),
  prior(gamma(2, 0.1), class = "shape")
)

sigma_ref <- 2

# Fit model with only region as subgroup variable
ovat_region <- run_brms_analysis(
  data = continuous_data,
  response_formula = sbp_change ~ trt,
  response_type = "continuous",
  unshrunk_terms_formula = ~ baseline_sbp,
  shrunk_predictive_formula = ~ 0+ (1+trt||region),
  sigma_ref = sigma_ref,
  chains = 1, iter = 2000, warmup = 1000, cores = 1,
  refresh = 0, backend = "cmdstanr"
)

summary_ovat_region <- summary_subgroup_effects(brms_fit = ovat_region)
```

## OVAT: Comorbidity Only

```{r ovat-comorbidity, message=FALSE, warning=FALSE}
ovat_comorbidity <- run_brms_analysis(
  data = continuous_data,
  response_formula = sbp_change ~ trt,
  response_type = "continuous",
  unshrunk_terms_formula = ~ baseline_sbp,
  shrunk_predictive_formula = ~ 0 + (1+trt||comorbidity),
  sigma_ref = sigma_ref,
  chains = 1, iter = 2000, warmup = 1000, cores = 1,
  refresh = 0, backend = "cmdstanr"
)

summary_ovat_comorbidity <- summary_subgroup_effects(brms_fit = ovat_comorbidity)
```

## OVAT: Age Group Only

```{r ovat-age, message=FALSE, warning=FALSE}
ovat_age <- run_brms_analysis(
  data = continuous_data,
  response_formula = sbp_change ~ trt,
  response_type = "continuous",
  unshrunk_terms_formula = ~ baseline_sbp,
  shrunk_predictive_formula = ~ 0 + (1+trt||age_group),
  sigma_ref = sigma_ref,
  chains = 1, iter = 2000, warmup = 1000, cores = 1,
  refresh = 0, backend = "cmdstanr"
)

summary_ovat_age <- summary_subgroup_effects(brms_fit = ovat_age, subgroup_vars = "age_group")
```

## OVAT: Sex Only

```{r ovat-sex, message=FALSE, warning=FALSE}
ovat_sex <- run_brms_analysis(
  data = continuous_data,
  response_formula = sbp_change ~ trt,
  response_type = "continuous",
  unshrunk_terms_formula = ~ baseline_sbp,
  shrunk_predictive_formula = ~ 0 + (1+trt||sex),
  sigma_ref = sigma_ref,
  chains = 1, iter = 2000, warmup = 1000, cores = 1,
  refresh = 0, backend = "cmdstanr"
)

summary_ovat_sex <- summary_subgroup_effects(brms_fit = ovat_sex)
```

## OVAT: Diabetes Only

```{r ovat-diabetes, message=FALSE, warning=FALSE}
ovat_diabetes <- run_brms_analysis(
  data = continuous_data,
  response_formula = sbp_change ~ trt,
  response_type = "continuous",
  unshrunk_terms_formula = ~ baseline_sbp,
  shrunk_predictive_formula = ~ 0 + (1+trt||diabetes),
  sigma_ref = sigma_ref,
  chains = 1, iter = 2000, warmup = 1000, cores = 1,
  refresh = 0, backend = "cmdstanr"
)

summary_ovat_diabetes <- summary_subgroup_effects(brms_fit = ovat_diabetes)
```

## OVAT: Visualizing All Models

You can combine and visualize results from multiple models using `combine_summaries()`:

```{r compare-all-ovat, fig.width=9, fig.height=8}
# Combine all OVAT models
combined_ovat <- combine_summaries(list(
  "Region" = summary_ovat_region,
  "Comorbidity" = summary_ovat_comorbidity,
  "Age Group" = summary_ovat_age,
  "Sex" = summary_ovat_sex,
  "Diabetes" = summary_ovat_diabetes
))

plot(combined_ovat, title = "OVAT: All Subgroup Variables")
```

# Global Modeling Approach

This section demonstrates how to fit a single model that includes all subgroup variables simultaneously.

## Global Model: All Subgroups

```{r global-fit, message=FALSE, warning=FALSE}
# Fit a single model with ALL subgroup variables
global_model <- run_brms_analysis(
  data = continuous_data,
  response_formula = sbp_change ~ trt,
  response_type = "continuous",
  unshrunk_terms_formula = ~ baseline_sbp + region + comorbidity + age_group + sex + diabetes,
  shrunk_predictive_formula = ~ 0 + trt:region+trt:comorbidity + trt:age_group + trt:sex + trt:diabetes,
  shrunk_predictive_prior = "horseshoe(1)",
  sigma_ref = sigma_ref,
  chains = 1, iter = 2000, warmup = 1000, cores = 1,
  refresh = 0, backend = "cmdstanr"
)
```

## Global Model: Summary of Subgroup Effects

Use `summary_subgroup_effects()` to generate marginal treatment effects for each subgroup. The function automatically extracts all necessary parameters from the fitted model:

```{r global-summary}
global_summary <- summary_subgroup_effects(
  brms_fit = global_model
)

print(global_summary)
```

## Global Model: Visualization

Use the `plot()` function to create a forest plot from the summary object:

```{r global-plot, fig.width=8, fig.height=10}
plot(global_summary, title = "Global Model: All Subgroup Variables")
```

# Comparing Multiple Models in One Plot

The `plot()` function supports comparing multiple models side-by-side. Pass a named list of `subgroup_summary` objects to create a comparative forest plot.

## Example: Comparing OVAT vs Global Model

```{r compare-models, fig.width=9, fig.height=7}
# Combine summaries for comparison
combined <- combine_summaries(list(
  "OVAT" = combined_ovat,
  "Global Model" = global_summary
))

# Plot the comparison
plot(combined, title = "Comparing OVAT vs Global Model")
```
